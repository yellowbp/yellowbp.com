<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="renderer" content="webkit">

  
  <title>小程序支付(前后端) | bp的Blog</title>

  <link rel="shortcut icon" href="/images/favicon.png">
  
  <meta name="description" content="微信小程序支付 在讲微信小程序支付之前，要说明的一点就是：小程序需要先上线了，才能去申请的。  在开发微信小程序支付的功能前，先熟悉下微信小程序支付的业务流程图：(这里的商户系统，你可以理解成你java的后台)   想了解详细的流程的还是要详细阅读一下微信官方的开发文档        那我简单讲一下小程序的支付流程:  小程序调用登录接口(wx.login)，获取到用户的openid 小程序调用j">
<meta name="keywords" content="javaWeb">
<meta property="og:type" content="article">
<meta property="og:title" content="小程序支付(前后端)">
<meta property="og:url" content="https://yellowbp.github.io/2019/12/16/小程序支付/index.html">
<meta property="og:site_name" content="bp的Blog">
<meta property="og:description" content="微信小程序支付 在讲微信小程序支付之前，要说明的一点就是：小程序需要先上线了，才能去申请的。  在开发微信小程序支付的功能前，先熟悉下微信小程序支付的业务流程图：(这里的商户系统，你可以理解成你java的后台)   想了解详细的流程的还是要详细阅读一下微信官方的开发文档        那我简单讲一下小程序的支付流程:  小程序调用登录接口(wx.login)，获取到用户的openid 小程序调用j">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://wxpayimage.oss-cn-shenzhen.aliyuncs.com/%E6%94%AF%E4%BB%98%E4%B8%9A%E5%8A%A1%E6%97%B6%E5%BA%8F%E5%9B%BE.jpg">
<meta property="og:updated_time" content="2021-02-10T06:40:11.852Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="小程序支付(前后端)">
<meta name="twitter:description" content="微信小程序支付 在讲微信小程序支付之前，要说明的一点就是：小程序需要先上线了，才能去申请的。  在开发微信小程序支付的功能前，先熟悉下微信小程序支付的业务流程图：(这里的商户系统，你可以理解成你java的后台)   想了解详细的流程的还是要详细阅读一下微信官方的开发文档        那我简单讲一下小程序的支付流程:  小程序调用登录接口(wx.login)，获取到用户的openid 小程序调用j">
<meta name="twitter:image" content="https://wxpayimage.oss-cn-shenzhen.aliyuncs.com/%E6%94%AF%E4%BB%98%E4%B8%9A%E5%8A%A1%E6%97%B6%E5%BA%8F%E5%9B%BE.jpg">

  <meta name="format-detection" content="telephone=no,email=no">
  <meta name="theme-color" content="#9C27B0">
  <meta name="description" content>
  <meta name="keywords" content=",javaWeb">

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="bp的Blog">
  <meta name="msapplication-starturl" content="https://yellowbp.github.io/2019/12/16/小程序支付/">
  <meta name="msapplication-navbutton-color" content="#9C27B0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="bp的Blog">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/images/favicon.png">

  
    <meta property="article:published_time" content="Mon Dec 16 2019 15:30:00 GMT+0800">
    <meta property="article:modified_time" content="Wed Feb 10 2021 14:40:11 GMT+0800">
  

  
    <link rel="canonical" href="https://yellowbp.github.io/2019/12/16/小程序支付/">
  

  <meta name="google-site-verification" content="fXjtlIfaDc_X-0P11rO3bEp1Nk4IKXphoJv0GqGZCco">
  <meta name="baidu-site-verification" content="I3t1wfwZvd">

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create','UA-139531378-1','auto');ga('send','pageview');
</script>
  <script>
  var _hmt = _hmt || [];
  (function() {var hm = document.createElement('script');
  hm.src = 'https://hm.baidu.com/hm.js?1054d51c0b66f1d168829173682c8159';
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script>
  

  <link rel="stylesheet" href="/css/mdui.css">
<link rel="stylesheet" href="/css/style.css">
</head>
<body class="mdui-appbar-with-toolbar mdui-drawer-body-left mdui-theme-primary-brown mdui-theme-accent-blue">
  <script>var a=localStorage.getItem("mdui-theme-layout-dark");if(a){document.getElementsByTagName("body")[0].className+=" mdui-theme-layout-dark"};</script>
  <header id="header" class="mdui-appbar mdui-appbar-fixed mdui-appbar-scroll-hide mdui-appbar-inset">
  <div class="mdui-toolbar mdui-color-theme">
    <a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-drawer="{target: '#sidebar', swipe: true}"><i class="mdui-icon material-icons">menu</i></a>
    <a href="/" class="mdui-typo-headline">bp的Blog</a>
    <div class="mdui-toolbar-spacer"></div>
    <a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-dialog="{target: '#search'}" mdui-tooltip="{content: '搜索'}"><i class="mdui-icon material-icons">search</i></a>
    
  </div>
</header>
<div class="mdui-dialog" id="search">
  
    <div class="search-form">
      <input type="search" class="search-form-input" placeholder="请输入关键字">
    </div>
    <div class="search-result" data-resource="/search.xml"></div>
  
</div>
  <aside id="sidebar" class="mdui-drawer mdui-drawer-full-height">
  <div class="mdui-grid-tile">
    <img src="/images/Gradient1.jpg" style="height: 160px;">
    <img src="/images/headPic.jpg" class="avatar-animation" style="position: absolute; top: 10%; left: 24px; width: 64px; height: 64px; border: 2px solid #fff; border-radius: 50%;">
    <div class="mdui-grid-tile-actions">
      <div class="mdui-grid-tile-text">
        <div class="mdui-grid-tile-title">hbp
        </div>
        <div class="mdui-grid-tile-subtitle"><i class="mdui-icon material-icons">art_track</i>要想快，先会慢</div>
      </div>
      
        <div class="mdui-grid-tile-buttons">
          <a href="mailto:347070556@qq.com" class="mdui-btn mdui-btn-icon" mdui-tooltip="{content: '347070556@qq.com'}"><i class="mdui-icon material-icons">email</i></a>
        </div>
      
    </div>
  </div>

  <div class="mdui-list" mdui-collapse="{accordion: true}">
    <a href="/" class="mdui-list-item mdui-ripple">
      <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-blue">home</i>
      <div class="mdui-list-item-content">主页</div>
    </a>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-deep-orange">inbox</i>
        <div class="mdui-list-item-content">归档</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/archives/2021/07/">七月 2021<span class="mdui-ripple sidebar_archives-count">13</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/06/">六月 2021<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/05/">五月 2021<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/04/">四月 2021<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/03/">三月 2021<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/02/">二月 2021<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/01/">一月 2021<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2020/03/">三月 2020<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/12/">十二月 2019<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/11/">十一月 2019<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/10/">十月 2019<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/09/">九月 2019<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/08/">八月 2019<span class="mdui-ripple sidebar_archives-count">6</span></a>
        
      </div>
    </div>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-green">chrome_reader_mode</i>
        <div class="mdui-list-item-content">分类</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/categories/Spring/">Spring<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/Spring-Cloud-Alibaba/">Spring Cloud Alibaba<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/docker/">docker<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/git/">git<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/java基础/">java基础<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/linux/">linux<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/mybatis/">mybatis<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/redis/">redis<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/servlet/">servlet<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/基础/">基础<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/安全框架/">安全框架<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/工具类/">工具类<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/技术/">技术<span class="mdui-ripple sidebar_archives-count">24</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/搭建/">搭建<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/数据库/">数据库<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/服务器/">服务器<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/测试/">测试<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/电脑硬件/">电脑硬件<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/规范/">规范<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/部署/">部署<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/重装/">重装<span class="mdui-ripple sidebar_archives-count">1</span></a>
        
      </div>
    </div>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-brown">bookmark</i>
        <div class="mdui-list-item-content">标签</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/tags/Spring/">Spring<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/algorithm/">algorithm<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/excel/">excel<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/git/">git<span class="mdui-ripple sidebar_archives-count">8</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/hexo/">hexo<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/javaWeb/">javaWeb<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/java基础/">java基础<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/linux/">linux<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/mysql/">mysql<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/nginx/">nginx<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/redis/">redis<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/servlet/">servlet<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/spring/">spring<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/win7/">win7<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/其他/">其他<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/分布式/">分布式<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/接口文档/">接口文档<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/笔记本选购/">笔记本选购<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/自动化构建工具/">自动化构建工具<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/设计模式/">设计模式<span class="mdui-ripple sidebar_archives-count">1</span></a>
        
      </div>
    </div>
    <a href="/about" class="mdui-list-item mdui-ripple">
      <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-purple">person</i>
      <div class="mdui-list-item-content">关于</div>
    </a>
  </div>

  <div class="mdui-divider"></div>

  <div class="mdui-list" mdui-collapse="{accordion: true}">
    
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <div class="mdui-list-item-content">友情链接</div>
        <i class="mdui-list-item-icon mdui-icon material-icons">link</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        
          <a href="javascript:;" class="mdui-list-item mdui-ripple mdui-p-l-2 mdui-text-color-theme" style="justify-content: center;">链接为空</a>
        
      </div>
    </div>
  </div>
</aside>
  <main id="main" class="mdui-m-t-5 fadeIn animated">
  <link rel="stylesheet" href="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.css">
  <style>#main article .mdui-card-content .center-block{display:block!important;margin-right:auto!important;margin-left:auto!important}</style>
  <article class="mdui-card mdui-m-b-5">
    <header class="mdui-card-media">
      <img src="/images/random/material-8.png" style="max-height: 240px;">
      <div class="mdui-card-media-covered">
        <div class="mdui-card-primary">
          <div class="mdui-card-primary-title">小程序支付(前后端)</div>
          <div class="mdui-card-primary-subtitle"><i class="iconfont">&#xe697;</i> 2019-12-16 / 
          <i class="iconfont">&#xe601;</i> Peyton Wong
          <span id="busuanzi_container_page_pv">
            本文总阅读量<span id="busuanzi_value_page_pv"></span>次
          </span>
          </div>
        </div>
      </div>
      <div class="mdui-card-menu">
        
        
      </div>
    </header>
    <div class="mdui-card-content mdui-typo">
      <h1 id="微信小程序支付"><a href="#微信小程序支付" class="headerlink" title="微信小程序支付"></a>微信小程序支付</h1><blockquote>
<p>在讲微信小程序支付之前，要说明的一点就是：小程序需要先<strong>上线</strong>了，才能去申请的。</p>
</blockquote>
<p><strong>在开发微信小程序支付的功能前，先熟悉下微信小程序支付的业务流程图：(这里的商户系统，你可以理解成你java的后台)</strong></p>
<p><img src="https://wxpayimage.oss-cn-shenzhen.aliyuncs.com/%E6%94%AF%E4%BB%98%E4%B8%9A%E5%8A%A1%E6%97%B6%E5%BA%8F%E5%9B%BE.jpg" alt></p>
<blockquote>
<p><strong>想了解详细的流程的还是要详细阅读一下</strong><a href="https://pay.weixin.qq.com/wiki/doc/api/wxa/wxa_api.php?chapter=7_10&index=1" target="_blank" rel="noopener">微信官方的开发文档 </a></p>
</blockquote>
<br>



<blockquote>
<p><font size="4"><strong>那我简单讲一下小程序的支付流程:</strong></font></p>
<ol>
<li>小程序调用登录接口(wx.login)，获取到用户的openid</li>
<li>小程序调用java后台的支付统一下单接口后，后台会进行2次的签名并返回支付所需要的参数<ul>
<li>nonceStr</li>
<li>package</li>
<li>timeStamp</li>
<li>signType</li>
<li>paySign</li>
</ul>
</li>
<li>小程序端发起最终支付，调用微信付款wx.requestPayment(把上述的5个参数传进去)</li>
<li>付完款之后，便<strong>自动</strong>回调方法，返回支付结果（也就是我们平时看到的支付记录）</li>
</ol>
</blockquote>
<br>

<h2 id="一、准备需要申请的固定参数"><a href="#一、准备需要申请的固定参数" class="headerlink" title="一、准备需要申请的固定参数"></a>一、准备需要申请的固定参数</h2><ol>
<li>mch_id          //小程序已关联的商户号</li>
<li>key                 //商户密钥(需要自行<a href="https://pay.weixin.qq.com/index.php/core/home/login?return_url=%2F" target="_blank" rel="noopener">登录商户平台</a>自行设置)</li>
</ol>
<br>

<h2 id="二、代码"><a href="#二、代码" class="headerlink" title="二、代码"></a>二、代码</h2><p>1小程序端代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//获取openId</span></span><br><span class="line">   getOpenId: function(code) &#123;</span><br><span class="line">     <span class="keyword">var</span> that = <span class="keyword">this</span>;</span><br><span class="line">     wx.request(&#123;</span><br><span class="line">       url: <span class="string">"https://xxxx/getOpenId"</span>,</span><br><span class="line">       data: &#123;</span><br><span class="line">         code: code</span><br><span class="line">       &#125;,</span><br><span class="line">       header: &#123;</span><br><span class="line">         <span class="string">"content-type"</span>: <span class="string">"application/x-www-form-urlencoded"</span></span><br><span class="line">       &#125;,</span><br><span class="line">       success: function(res) &#123;</span><br><span class="line">         console.log(res)</span><br><span class="line"></span><br><span class="line">         that.setData(&#123;</span><br><span class="line">           openid: res.data.data.openid,</span><br><span class="line">           session_key: res.data.data.session_key</span><br><span class="line">         &#125;)</span><br><span class="line">         that.generateOrder(res.data.data.openid)</span><br><span class="line">       &#125;,</span><br><span class="line">       fail: function() &#123;</span><br><span class="line">         <span class="comment">// fail</span></span><br><span class="line">       &#125;,</span><br><span class="line">       complete: function() &#123;</span><br><span class="line">         <span class="comment">// complete</span></span><br><span class="line">       &#125;</span><br><span class="line">     &#125;)</span><br><span class="line">   &#125;,</span><br></pre></td></tr></table></figure>

<br>

<h4 id="1-获取openid"><a href="#1-获取openid" class="headerlink" title="1.获取openid"></a>1.获取openid</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 通过小程序凭证(code)进而换取用户登录态信息</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@param</span> code</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@ApiOperation</span>(value = <span class="string">"openid"</span>, notes = <span class="string">"获取openId和sessionKey的接口"</span>)</span><br><span class="line">   <span class="meta">@GetMapping</span>(<span class="string">"/getOpenId"</span>)</span><br><span class="line">   <span class="meta">@ResponseBody</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">getOpenId</span><span class="params">(String code)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">       String url = <span class="string">"https://api.weixin.qq.com/sns/jscode2session?appid="</span> + WxConstant.appid + <span class="string">"&amp;secret="</span> + WxConstant.secret + <span class="string">"&amp;js_code="</span> + code + <span class="string">"&amp;grant_type=authorization_code"</span>;</span><br><span class="line"></span><br><span class="line">       Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">       String data = WxHttpUtil.sendGet(url, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">       JSONObject jo = JSON.parseObject(data);</span><br><span class="line"></span><br><span class="line">       map.put(<span class="string">"code"</span>, <span class="number">0</span>);</span><br><span class="line">       map.put(<span class="string">"data"</span>, jo);</span><br><span class="line">       map.put(<span class="string">"msg"</span>, <span class="string">"调用成功"</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> map;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<br>

<ol start="2">
<li>小程序端代码</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//调用java后台的统一下单接口。生成预订单</span></span><br><span class="line"> generateOrder: function(openid) &#123;</span><br><span class="line">   <span class="keyword">var</span> that = <span class="keyword">this</span></span><br><span class="line">   wx.request(&#123;</span><br><span class="line">     url: <span class="string">'https:/xxxxxxx/wxPay'</span>, <span class="comment">//后台请求地址</span></span><br><span class="line">     method: <span class="string">'POST'</span>,</span><br><span class="line">     data: &#123;</span><br><span class="line">       openid: openid</span><br><span class="line">     &#125;,</span><br><span class="line">     header:&#123;</span><br><span class="line">       <span class="string">'content-type'</span>: <span class="string">'application/x-www-form-urlencoded'</span>,</span><br><span class="line">     &#125;,</span><br><span class="line">     success: function(res) &#123;</span><br><span class="line">       console.log(res)</span><br><span class="line">       <span class="keyword">var</span> param = &#123;</span><br><span class="line">         <span class="string">"timeStamp"</span>: res.data.timeStamp,</span><br><span class="line">         <span class="string">"package"</span>: res.data.<span class="keyword">package</span>,</span><br><span class="line">         <span class="string">"paySign"</span>: res.data.paySign,</span><br><span class="line">         <span class="string">"signType"</span>: <span class="string">"MD5"</span>,</span><br><span class="line">         <span class="string">"nonceStr"</span>: res.data.nonceStr</span><br><span class="line">       &#125;;</span><br><span class="line">       <span class="comment">//发起支付</span></span><br><span class="line">       that.pay(param);</span><br><span class="line">     &#125;,</span><br><span class="line">     fail: function(res) &#123;&#125;</span><br><span class="line">   &#125;)</span><br><span class="line"> &#125;,</span><br></pre></td></tr></table></figure>

<br>

<h4 id="2-小程序要调用的统一下单接口（两次的签名都在此方法中完成）"><a href="#2-小程序要调用的统一下单接口（两次的签名都在此方法中完成）" class="headerlink" title="2.小程序要调用的统一下单接口（两次的签名都在此方法中完成）"></a>2.小程序要调用的统一下单接口（两次的签名都在此方法中完成）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 发起微信支付，统一下单接口，生成预订单</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> openid</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> money </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@RequestMapping</span>(<span class="string">"/wxPay"</span>)</span><br><span class="line">  <span class="meta">@ResponseBody</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">wxPay</span><span class="params">(String openid , <span class="keyword">double</span> money , HttpServletRequest request)</span></span>&#123;</span><br><span class="line">      <span class="keyword">try</span>&#123;</span><br><span class="line"></span><br><span class="line">          <span class="comment">//生成的32位随机字符串</span></span><br><span class="line">          String nonce_str = StringUtil.getRandomStringByLength(<span class="number">32</span>);</span><br><span class="line"></span><br><span class="line">          <span class="comment">//商品名称(可自拟)</span></span><br><span class="line">          String body = <span class="string">"餐价"</span>;</span><br><span class="line"></span><br><span class="line">          <span class="comment">//商户订单号</span></span><br><span class="line">          String out_trade_no = StringUtil.getOrderIdByUUId();</span><br><span class="line"></span><br><span class="line">	<span class="comment">//TODO 这里的标价金额的单位为分！！ 比如如果price为1的话，表示1分钱，而不是1元</span></span><br><span class="line">          <span class="comment">//TODO 并且是要int类型的（微信开发文档有说明），因为下方签名的时候需要转成String类型，所以我提前转了，并截取小数点之后的位数</span></span><br><span class="line">          String price  = String.valueOf((money*<span class="number">100</span>)).substring(<span class="number">0</span>,String.valueOf((money*<span class="number">100</span>)).indexOf(<span class="string">"."</span>));</span><br><span class="line"></span><br><span class="line">          <span class="comment">//组装参数，用户生成统一下单接口的签名</span></span><br><span class="line">          Map&lt;String, String&gt; packageParams = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">          packageParams.put(<span class="string">"appid"</span>, WxConstant.appid);</span><br><span class="line">          packageParams.put(<span class="string">"body"</span>, body);</span><br><span class="line">          packageParams.put(<span class="string">"mch_id"</span>, WxConstant.mch_id);</span><br><span class="line">          packageParams.put(<span class="string">"nonce_str"</span>, nonce_str);</span><br><span class="line">          packageParams.put(<span class="string">"out_trade_no"</span>, out_trade_no);<span class="comment">//订单号</span></span><br><span class="line">          packageParams.put(<span class="string">"total_fee"</span>, price);<span class="comment">//TODO 支付金额，这边需要转成字符串类型，否则后面的签名会失败</span></span><br><span class="line">          packageParams.put(<span class="string">"spbill_create_ip"</span>, WxConstant.spbill_create_ip);</span><br><span class="line">          packageParams.put(<span class="string">"notify_url"</span>, WxConstant.notify_url);<span class="comment">//支付成功后的回调地址,用户成功支付之后，便会自动根据这个url自动回调，小程序不需要调用这个方法</span></span><br><span class="line">          packageParams.put(<span class="string">"trade_type"</span>, WxConstant.TRADETYPE);<span class="comment">//支付类型</span></span><br><span class="line">          packageParams.put(<span class="string">"openid"</span>, openid);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 把数组所有元素，按照“参数=参数值”的模式用“&amp;”字符拼接成字符串</span></span><br><span class="line">          String prestr = PayUtil.createLinkString(packageParams);</span><br><span class="line"></span><br><span class="line">          <span class="comment">//MD5运算生成签名，这里是第一次签名，用于调用统一下单接口</span></span><br><span class="line">          String mysign = PayUtil.sign(prestr, WxConstant.key, <span class="string">"utf-8"</span>).toUpperCase();</span><br><span class="line"></span><br><span class="line">          <span class="comment">//拼接统一下单接口使用的xml数据，要将上一步生成的签名一起拼接进去</span></span><br><span class="line">          String xml = <span class="string">"&lt;xml&gt;"</span> + <span class="string">"&lt;appid&gt;"</span> + WxConstant.appid + <span class="string">"&lt;/appid&gt;"</span></span><br><span class="line">                  + <span class="string">"&lt;body&gt;"</span> + body + <span class="string">"&lt;/body&gt;"</span></span><br><span class="line">                  + <span class="string">"&lt;mch_id&gt;"</span> + WxConstant.mch_id + <span class="string">"&lt;/mch_id&gt;"</span></span><br><span class="line">                  + <span class="string">"&lt;nonce_str&gt;"</span> + nonce_str + <span class="string">"&lt;/nonce_str&gt;"</span></span><br><span class="line">                  + <span class="string">"&lt;notify_url&gt;"</span> + WxConstant.notify_url + <span class="string">"&lt;/notify_url&gt;"</span></span><br><span class="line">                  + <span class="string">"&lt;openid&gt;"</span> + openid + <span class="string">"&lt;/openid&gt;"</span></span><br><span class="line">                  + <span class="string">"&lt;out_trade_no&gt;"</span> + out_trade_no + <span class="string">"&lt;/out_trade_no&gt;"</span></span><br><span class="line">                  + <span class="string">"&lt;spbill_create_ip&gt;"</span> + WxConstant.spbill_create_ip + <span class="string">"&lt;/spbill_create_ip&gt;"</span></span><br><span class="line">                  + <span class="string">"&lt;total_fee&gt;"</span> + price + <span class="string">"&lt;/total_fee&gt;"</span></span><br><span class="line">                  + <span class="string">"&lt;trade_type&gt;"</span> + WxConstant.TRADETYPE + <span class="string">"&lt;/trade_type&gt;"</span></span><br><span class="line">                  + <span class="string">"&lt;sign&gt;"</span> + mysign + <span class="string">"&lt;/sign&gt;"</span></span><br><span class="line">                  + <span class="string">"&lt;/xml&gt;"</span>;</span><br><span class="line"></span><br><span class="line">          System.out.println(<span class="string">"调试模式_统一下单接口 请求XML数据："</span> + xml);</span><br><span class="line"></span><br><span class="line">          <span class="comment">//调用统一下单接口，并接受返回的结果</span></span><br><span class="line">          String result = PayUtil.httpRequest(WxConstant.pay_url, <span class="string">"POST"</span>, xml);</span><br><span class="line"></span><br><span class="line">          System.out.println(<span class="string">"调试模式_统一下单接口 返回XML数据："</span> + result);</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 将解析结果存储在HashMap中</span></span><br><span class="line">          Map map = PayUtil.doXMLParse(result);</span><br><span class="line"></span><br><span class="line">          String return_code = (String) map.get(<span class="string">"return_code"</span>);<span class="comment">//返回状态码</span></span><br><span class="line"></span><br><span class="line">          Map&lt;String, Object&gt; response = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();<span class="comment">//返回给小程序端需要的参数</span></span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span>(return_code.equals(<span class="string">"SUCCESS"</span>))&#123;</span><br><span class="line">              String prepay_id = (String) map.get(<span class="string">"prepay_id"</span>);<span class="comment">//返回的预付单信息</span></span><br><span class="line">              response.put(<span class="string">"nonceStr"</span>, nonce_str);</span><br><span class="line">              response.put(<span class="string">"package"</span>, <span class="string">"prepay_id="</span> + prepay_id);</span><br><span class="line">              Long timeStamp = System.currentTimeMillis() / <span class="number">1000</span>;</span><br><span class="line">              response.put(<span class="string">"timeStamp"</span>, timeStamp + <span class="string">""</span>);<span class="comment">//这边要将返回的时间戳转化成字符串，不然小程序端调用wx.requestPayment方法会报签名错误</span></span><br><span class="line">              <span class="comment">//拼接签名需要的参数</span></span><br><span class="line">              String stringSignTemp = <span class="string">"appId="</span> + WxConstant.appid + <span class="string">"&amp;nonceStr="</span> + nonce_str + <span class="string">"&amp;package=prepay_id="</span> + prepay_id+ <span class="string">"&amp;signType=MD5&amp;timeStamp="</span> + timeStamp;</span><br><span class="line">              <span class="comment">//再次签名，这个签名用于小程序端调用wx.requesetPayment方法</span></span><br><span class="line">              String paySign = PayUtil.sign(stringSignTemp, WxConstant.key, <span class="string">"utf-8"</span>).toUpperCase();</span><br><span class="line"></span><br><span class="line">              response.put(<span class="string">"paySign"</span>, paySign);</span><br><span class="line">          &#125;</span><br><span class="line">          response.put(<span class="string">"signType"</span>, <span class="string">"MD5"</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span> response;</span><br><span class="line">      &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">          e.printStackTrace();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-WxConstantUtil工具类"><a href="#3-WxConstantUtil工具类" class="headerlink" title="3.WxConstantUtil工具类"></a>3.WxConstantUtil工具类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WxConstant</span> </span>&#123;		</span><br><span class="line">		<span class="comment">//小程序appid</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String appid = <span class="string">"xxxxxxxxxxxxxxx"</span>;</span><br><span class="line">        <span class="comment">//小程序私钥</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String secret = <span class="string">"xxxxxxxxxxxxxxx"</span>;</span><br><span class="line">        <span class="comment">//微信支付的商户id</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String mch_id = <span class="string">"xxxxxxxxxxxxxxx"</span>;</span><br><span class="line">        <span class="comment">//微信支付的商户密钥</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String key = <span class="string">"xxxxxxxxxxxxxxx"</span>;</span><br><span class="line">        <span class="comment">//支付成功后的服务器回调url TODO 这个地方的url需要根据你实际情况来：是写你回调的接口方法的url（如我的第6点）</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String notify_url = <span class="string">"https://www.xxx.xx/xxxx/xxxx/wxNotify"</span>;</span><br><span class="line">        <span class="comment">//交易类型，小程序支付的固定值为JSAPI</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String TRADETYPE = <span class="string">"JSAPI"</span>;</span><br><span class="line">        <span class="comment">//微信统一下单接口地址</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String pay_url = <span class="string">"https://api.mch.weixin.qq.com/pay/unifiedorder"</span>;</span><br><span class="line">        <span class="comment">//终端服务器公网ip地址</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String spbill_create_ip = <span class="string">"xxx.xx.xxx.xxx"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>StringUtil工具类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取一定长度的随机字符串，范围0-9，a-z</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> length：指定字符串长度</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 一定长度的随机字符串</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getRandomStringByLength</span><span class="params">(<span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        String base = <span class="string">"abcdefghijklmnopqrstuvwxyz0123456789"</span>;</span><br><span class="line">        Random random = <span class="keyword">new</span> Random();</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            <span class="keyword">int</span> number = random.nextInt(base.length());</span><br><span class="line">            sb.append(base.charAt(number));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 用来生成不重复的订单号,一共是11位</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getOrderIdByUUId</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span> machineId = <span class="number">1</span>;<span class="comment">//最大支持1-9个集群机器部署</span></span><br><span class="line">        <span class="keyword">int</span> hashCodev = UUID.randomUUID().toString().hashCode();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(hashCodev &lt; <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="comment">//有可能是负数</span></span><br><span class="line">            hashCodev = -hashCodev;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//"%010d"的意思：0代表不足位数的补0，这样可以确保相同的位数，10是位数也就是要得到到的字符串长度是11，d代表数字。</span></span><br><span class="line">        <span class="keyword">return</span> machineId + String.format(<span class="string">"%010d"</span>, hashCodev);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="4-PayUtil工具类"><a href="#4-PayUtil工具类" class="headerlink" title="4.PayUtil工具类"></a>4.PayUtil工具类</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.BufferedReader;</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.InputStreamReader;</span><br><span class="line"><span class="keyword">import</span> java.io.OutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.UnsupportedEncodingException;</span><br><span class="line"><span class="keyword">import</span> java.net.HttpURLConnection;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.security.SignatureException;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Collections;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Iterator;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.codec.digest.DigestUtils;</span><br><span class="line"><span class="keyword">import</span> org.jdom.Document;</span><br><span class="line"><span class="keyword">import</span> org.jdom.Element;</span><br><span class="line"><span class="keyword">import</span> org.jdom.JDOMException;</span><br><span class="line"><span class="keyword">import</span> org.jdom.input.SAXBuilder;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.Node;</span><br><span class="line"><span class="keyword">import</span> org.w3c.dom.NodeList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.XMLConstants;</span><br><span class="line"><span class="keyword">import</span> javax.xml.parsers.DocumentBuilderFactory;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PayUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 签名字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> text 需要签名的字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> key 密钥</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> input_charset 编码格式</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 签名结果</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">sign</span><span class="params">(String text, String key, String input_charset)</span> </span>&#123;</span><br><span class="line">        text = text + <span class="string">"&amp;key="</span> + key;</span><br><span class="line">        <span class="keyword">return</span> DigestUtils.md5Hex(getContentBytes(text, input_charset));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> content</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> charset</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> UnsupportedEncodingException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] getContentBytes(String content, String charset) &#123;</span><br><span class="line">        <span class="keyword">if</span> (charset == <span class="keyword">null</span> || <span class="string">""</span>.equals(charset)) &#123;</span><br><span class="line">            <span class="keyword">return</span> content.getBytes();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> content.getBytes(charset);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"MD5签名过程中出现错误,指定的编码集不对,您目前指定的编码集是:"</span> + charset);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 除去数组中的空值和签名参数</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> sArray 签名参数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 去掉空值与签名参数后的新签名参数组</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String, String&gt; <span class="title">paraFilter</span><span class="params">(Map&lt;String, String&gt; sArray)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; result = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">        <span class="keyword">if</span> (sArray == <span class="keyword">null</span> || sArray.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (String key : sArray.keySet()) &#123;</span><br><span class="line">            String value = sArray.get(key);</span><br><span class="line">            <span class="keyword">if</span> (value == <span class="keyword">null</span> || value.equals(<span class="string">""</span>) || key.equalsIgnoreCase(<span class="string">"sign"</span>)</span><br><span class="line">                    || key.equalsIgnoreCase(<span class="string">"sign_type"</span>)) &#123;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            result.put(key, value);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 把数组所有元素排序，并按照“参数=参数值”的模式用“&amp;”字符拼接成字符串</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> params 需要排序并参与字符拼接的参数组</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 拼接后字符串</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">createLinkString</span><span class="params">(Map&lt;String, String&gt; params)</span> </span>&#123;</span><br><span class="line">        List&lt;String&gt; keys = <span class="keyword">new</span> ArrayList&lt;String&gt;(params.keySet());</span><br><span class="line">        Collections.sort(keys);</span><br><span class="line">        String prestr = <span class="string">""</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; keys.size(); i++) &#123;</span><br><span class="line">            String key = keys.get(i);</span><br><span class="line">            String value = params.get(key);</span><br><span class="line">            <span class="keyword">if</span> (i == keys.size() - <span class="number">1</span>) &#123;<span class="comment">// 拼接时，不包括最后一个&amp;字符</span></span><br><span class="line">                prestr = prestr + key + <span class="string">"="</span> + value;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                prestr = prestr + key + <span class="string">"="</span> + value + <span class="string">"&amp;"</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> prestr;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> requestUrl 请求地址</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> requestMethod 请求方法</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> outputStr 参数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">httpRequest</span><span class="params">(String requestUrl,String requestMethod,String outputStr)</span></span>&#123;</span><br><span class="line">        <span class="comment">// 创建SSLContext</span></span><br><span class="line">        StringBuffer buffer = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            URL url = <span class="keyword">new</span> URL(requestUrl);</span><br><span class="line">            HttpURLConnection conn = (HttpURLConnection) url.openConnection();</span><br><span class="line">            conn.setRequestMethod(requestMethod);</span><br><span class="line">            conn.setDoOutput(<span class="keyword">true</span>);</span><br><span class="line">            conn.setDoInput(<span class="keyword">true</span>);</span><br><span class="line">            conn.connect();</span><br><span class="line">            <span class="comment">//往服务器端写内容</span></span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">null</span> !=outputStr)&#123;</span><br><span class="line">                OutputStream os=conn.getOutputStream();</span><br><span class="line">                os.write(outputStr.getBytes(<span class="string">"utf-8"</span>));</span><br><span class="line">                os.close();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 读取服务器端返回的内容</span></span><br><span class="line">            InputStream is = conn.getInputStream();</span><br><span class="line">            InputStreamReader isr = <span class="keyword">new</span> InputStreamReader(is, <span class="string">"utf-8"</span>);</span><br><span class="line">            BufferedReader br = <span class="keyword">new</span> BufferedReader(isr);</span><br><span class="line">            buffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">            String line = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">while</span> ((line = br.readLine()) != <span class="keyword">null</span>) &#123;</span><br><span class="line">                buffer.append(line);</span><br><span class="line">            &#125;</span><br><span class="line">            br.close();</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> buffer.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">urlEncodeUTF8</span><span class="params">(String source)</span></span>&#123;</span><br><span class="line">        String result=source;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            result=java.net.URLEncoder.encode(source, <span class="string">"UTF-8"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException e) &#123;</span><br><span class="line">            <span class="comment">// TODO Auto-generated catch block</span></span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析xml,返回第一级元素键值对。如果第一级元素有子节点，则此节点的值是子节点的xml数据。</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> strxml</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> JDOMException</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IOException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title">doXMLParse</span><span class="params">(String strxml)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">null</span> == strxml || <span class="string">""</span>.equals(strxml)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/*=============  !!!!注意，修复了微信官方反馈的漏洞，更新于2018-10-16  ===========*/</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Map&lt;String, String&gt; data = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span><br><span class="line">            <span class="comment">// TODO 在这里更换</span></span><br><span class="line">            DocumentBuilderFactory documentBuilderFactory = DocumentBuilderFactory.newInstance();</span><br><span class="line">            documentBuilderFactory.setFeature(<span class="string">"http://apache.org/xml/features/disallow-doctype-decl"</span>, <span class="keyword">true</span>);</span><br><span class="line">            documentBuilderFactory.setFeature(<span class="string">"http://xml.org/sax/features/external-general-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            documentBuilderFactory.setFeature(<span class="string">"http://xml.org/sax/features/external-parameter-entities"</span>, <span class="keyword">false</span>);</span><br><span class="line">            documentBuilderFactory.setFeature(<span class="string">"http://apache.org/xml/features/nonvalidating/load-external-dtd"</span>, <span class="keyword">false</span>);</span><br><span class="line">            documentBuilderFactory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, <span class="keyword">true</span>);</span><br><span class="line">            documentBuilderFactory.setXIncludeAware(<span class="keyword">false</span>);</span><br><span class="line">            documentBuilderFactory.setExpandEntityReferences(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">            InputStream stream = <span class="keyword">new</span> ByteArrayInputStream(strxml.getBytes(<span class="string">"UTF-8"</span>));</span><br><span class="line">            org.w3c.dom.Document doc = documentBuilderFactory.newDocumentBuilder().parse(stream);</span><br><span class="line">            doc.getDocumentElement().normalize();</span><br><span class="line">            NodeList nodeList = doc.getDocumentElement().getChildNodes();</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> idx = <span class="number">0</span>; idx &lt; nodeList.getLength(); ++idx) &#123;</span><br><span class="line">                Node node = nodeList.item(idx);</span><br><span class="line">                <span class="keyword">if</span> (node.getNodeType() == Node.ELEMENT_NODE) &#123;</span><br><span class="line">                    org.w3c.dom.Element element = (org.w3c.dom.Element) node;</span><br><span class="line">                    data.put(element.getNodeName(), element.getTextContent());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                stream.close();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">                <span class="comment">// do nothing</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            <span class="keyword">throw</span> ex;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取子结点的xml</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> children</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> String</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">getChildrenText</span><span class="params">(List children)</span> </span>&#123;</span><br><span class="line">        StringBuffer sb = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">        <span class="keyword">if</span>(!children.isEmpty()) &#123;</span><br><span class="line">            Iterator it = children.iterator();</span><br><span class="line">            <span class="keyword">while</span>(it.hasNext()) &#123;</span><br><span class="line">                Element e = (Element) it.next();</span><br><span class="line">                String name = e.getName();</span><br><span class="line">                String value = e.getTextNormalize();</span><br><span class="line">                List list = e.getChildren();</span><br><span class="line">                sb.append(<span class="string">"&lt;"</span> + name + <span class="string">"&gt;"</span>);</span><br><span class="line">                <span class="keyword">if</span>(!list.isEmpty()) &#123;</span><br><span class="line">                    sb.append(getChildrenText(list));</span><br><span class="line">                &#125;</span><br><span class="line">                sb.append(value);</span><br><span class="line">                sb.append(<span class="string">"&lt;/"</span> + name + <span class="string">"&gt;"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> sb.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> InputStream <span class="title">String2Inputstream</span><span class="params">(String str)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ByteArrayInputStream(str.getBytes());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<br>

<ol start="3">
<li>小程序发起最终支付，调用微信支付</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">pay: function(param) &#123;</span><br><span class="line">     <span class="keyword">var</span> that = <span class="keyword">this</span>;</span><br><span class="line">     wx.requestPayment(&#123;</span><br><span class="line">       timeStamp: param.timeStamp,</span><br><span class="line">       nonceStr: param.nonceStr,</span><br><span class="line">       <span class="keyword">package</span>: param.<span class="keyword">package</span>,</span><br><span class="line">       signType: param.signType,</span><br><span class="line">       paySign: param.paySign,</span><br><span class="line">       success: function(res) &#123;</span><br><span class="line">         console.log(<span class="string">"success"</span>);</span><br><span class="line">         console.log(res);</span><br><span class="line">       &#125;,</span><br><span class="line">       fail: function(res) &#123;</span><br><span class="line">         console.log(<span class="string">"fail"</span>)</span><br><span class="line">         console.log(res);</span><br><span class="line">       &#125;,</span><br><span class="line">       complete: function(res) &#123;</span><br><span class="line">         console.log(<span class="string">"complete"</span>);</span><br><span class="line">         console.log(res)</span><br><span class="line">       &#125;</span><br><span class="line">     &#125;)</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<br>

<h4 id="5-java的回调方法（这一步小程序不需要调用，用户支付成功之后，便会自动调用）"><a href="#5-java的回调方法（这一步小程序不需要调用，用户支付成功之后，便会自动调用）" class="headerlink" title="5.java的回调方法（这一步小程序不需要调用，用户支付成功之后，便会自动调用）"></a>5.java的回调方法（这一步小程序不需要调用，用户支付成功之后，便会自动调用）</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@Description</span>: 回调微信支付的报文</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/wxNotify"</span>)</span><br><span class="line">    <span class="meta">@ResponseBody</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">wxNotify</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        BufferedReader br = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader((ServletInputStream)request.getInputStream()));</span><br><span class="line">        String line = <span class="keyword">null</span>;</span><br><span class="line">        StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">        <span class="keyword">while</span>((line = br.readLine()) != <span class="keyword">null</span>)&#123;</span><br><span class="line">            sb.append(line);</span><br><span class="line">        &#125;</span><br><span class="line">        br.close();</span><br><span class="line">        <span class="comment">//sb为微信返回的xml</span></span><br><span class="line">        String notityXml = sb.toString();</span><br><span class="line">        String resXml = <span class="string">""</span>;</span><br><span class="line"><span class="comment">//        System.out.println("接收到的报文：" + notityXml);</span></span><br><span class="line"></span><br><span class="line">        Map map = PayUtil.doXMLParse(notityXml);</span><br><span class="line"></span><br><span class="line">        String returnCode = (String) map.get(<span class="string">"return_code"</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">"SUCCESS"</span>.equals(returnCode))&#123;</span><br><span class="line">            <span class="comment">//验证签名是否正确</span></span><br><span class="line">            Map&lt;String, String&gt; validParams = PayUtil.paraFilter(map);  <span class="comment">//回调验签时需要去除sign和空值参数</span></span><br><span class="line">            String validStr = PayUtil.createLinkString(validParams);<span class="comment">//把数组所有元素，按照“参数=参数值”的模式用“&amp;”字符拼接成字符串</span></span><br><span class="line">            String sign = PayUtil.sign(validStr, WxConstant.key, <span class="string">"utf-8"</span>).toUpperCase();<span class="comment">//拼装生成服务器端验证的签名</span></span><br><span class="line">            <span class="comment">//根据微信官网的介绍，此处不仅对回调的参数进行验签，还需要对返回的金额与系统订单的金额进行比对等</span></span><br><span class="line">            <span class="keyword">if</span>(sign.equals(map.get(<span class="string">"sign"</span>)))&#123;</span><br><span class="line">                <span class="comment">/**此处添加自己的业务逻辑代码start**/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                <span class="comment">/**此处添加自己的业务逻辑代码end**/</span></span><br><span class="line">                <span class="comment">//通知微信服务器已经支付成功</span></span><br><span class="line">                resXml = <span class="string">"&lt;xml&gt;"</span> + <span class="string">"&lt;return_code&gt;&lt;![CDATA[SUCCESS]]&gt;&lt;/return_code&gt;"</span></span><br><span class="line">                        + <span class="string">"&lt;return_msg&gt;&lt;![CDATA[OK]]&gt;&lt;/return_msg&gt;"</span> + <span class="string">"&lt;/xml&gt; "</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            resXml = <span class="string">"&lt;xml&gt;"</span> + <span class="string">"&lt;return_code&gt;&lt;![CDATA[FAIL]]&gt;&lt;/return_code&gt;"</span></span><br><span class="line">                    + <span class="string">"&lt;return_msg&gt;&lt;![CDATA[报文为空]]&gt;&lt;/return_msg&gt;"</span> + <span class="string">"&lt;/xml&gt; "</span>;</span><br><span class="line">        &#125;</span><br><span class="line"><span class="comment">//        System.out.println(resXml);</span></span><br><span class="line"><span class="comment">//        System.out.println("微信支付回调数据结束");</span></span><br><span class="line"></span><br><span class="line">        BufferedOutputStream out = <span class="keyword">new</span> BufferedOutputStream(</span><br><span class="line">                response.getOutputStream());</span><br><span class="line">        out.write(resXml.getBytes());</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<br>

<blockquote>
<p><strong><font color="blue">微信支付就这样愉快地完成辽</font></strong></p>
</blockquote>

      <blockquote class="mdui-m-t-5">
        
          <strong>本文遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">CC BY-NC-SA 4.0</a> 许可协议，转载请附上原文出处链接和本声明。</strong><br>
        
        <strong>本文链接：</strong><a href="https://yellowbp.github.io/2019/12/16/小程序支付/">https://yellowbp.github.io/2019/12/16/小程序支付/</a>
      </blockquote>
      
    </div>
    <footer class="mdui-card-actions">
      
        <a class="mdui-ripple article_categories-link" href="/categories/技术/">技术</a>
      
      
        <a class="mdui-ripple article_tags-link" href="/tags/javaWeb/">javaWeb</a>
      
    </footer>
    
  </article>
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script>$("#main article .mdui-card-content img.fancybox").on("click",function(e){$.fancybox.open({src:$(this).attr("src")});});</script>


  <nav id="paginator">
    
      <a rel="prev" class="extend prev" href="/2019/12/16/笔记本选购指南/">
        <button aria-label="prev" class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_back</i></button>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上一篇
      </a>
    
    <div class="spacer"></div>
    
      <a rel="next" class="extend next" href="/2019/11/26/递归/">
        下一篇&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <button aria-label="next" class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_forward</i></button>
      </a>
    
  </nav>


  <div id="comment" class="mdui-m-t-5">
    <style>#pop_ad,#feedAv{display:none!important;position:absolute!important;z-index:-9999;left:-1000px;opacity:0!important}</style>
<div id="SOHUCS" sid="ckrq4spp7004tsctw9gpteqio"></div>
<script type="text/javascript">
(function(){
var appid = 'cyubhC2Dq';
var conf = 'prod_e4cce65003c5bed049fefcb8a6f09e12';
var width = window.innerWidth || document.documentElement.clientWidth;
if (width < 960) {
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="http://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("http://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>
  </div>



  <div style="position: fixed !important; right: 16px; top: 30%;">
    <button class="mdui-fab mdui-fab-mini mdui-ripple" mdui-menu="{target: '#toc'}"><i class="mdui-icon material-icons">format_list_numbered</i></button>
    <ul class="mdui-menu" id="toc">
      <li class="mdui-menu-item" disabled><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#微信小程序支付"><span class="toc-number">1.</span> <span class="toc-text">微信小程序支付</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#一、准备需要申请的固定参数"><span class="toc-number">1.1.</span> <span class="toc-text">一、准备需要申请的固定参数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、代码"><span class="toc-number">1.2.</span> <span class="toc-text">二、代码</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-获取openid"><span class="toc-number">1.2.0.1.</span> <span class="toc-text">1.获取openid</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-小程序要调用的统一下单接口（两次的签名都在此方法中完成）"><span class="toc-number">1.2.0.2.</span> <span class="toc-text">2.小程序要调用的统一下单接口（两次的签名都在此方法中完成）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-WxConstantUtil工具类"><span class="toc-number">1.2.0.3.</span> <span class="toc-text">3.WxConstantUtil工具类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-PayUtil工具类"><span class="toc-number">1.2.0.4.</span> <span class="toc-text">4.PayUtil工具类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-java的回调方法（这一步小程序不需要调用，用户支付成功之后，便会自动调用）"><span class="toc-number">1.2.0.5.</span> <span class="toc-text">5.java的回调方法（这一步小程序不需要调用，用户支付成功之后，便会自动调用）</span></a></li></ol></li></ol></li></ol></li></ol></li>
    </ul>
  </div>
</main>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<footer id="footer" class="mdui-m-t-5 mdui-p-y-3 mdui-color-theme">
  <div class="mdui-p-y-0 mdui-text-center">
    
    
    
    
    
    
    
      <a href="https://github.com/yellowbp" target="_blank"><i class="mdui-p-a-1 mdui-icon iconfont mdui-text-color-theme-a100">&#xe7ab;</i></a>
    
    
    
    
    
      <a href="tencent://message/?uin=1432440963&Menu=yes" target="_blank"><i class="mdui-p-a-1 mdui-icon iconfont mdui-text-color-theme-a100">&#xe651;</i></a>
    
    
  </div>
  <div class="mdui-p-y-1 mdui-text-center">
    Copyright &copy; 2019 - 2021 hbp<br>
    Powered by <a href="https://hexo.io/" target="_blank" class="mdui-text-color-theme-accent">Hexo</a>hbp All rights reserved.
    
    <br>
    <span id="busuanzi_container_site_uv">
    本网站总访问量<span id="busuanzi_value_site_uv"></span>次
    </span>
  </div>
</footer>
  <button id="gotop" class="mdui-fab mdui-fab-fixed mdui-fab-hide mdui-ripple mdui-color-theme-accent"><i class="mdui-icon material-icons">arrow_upward</i></button>
  <script async src="http://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <script src="/js/mdui.js"></script>
<script src="/js/script.js"></script>
</body>
</html>