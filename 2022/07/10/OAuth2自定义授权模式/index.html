<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="renderer" content="webkit">

  
  <title>OAuth2自定义授权模式 | bp的Blog</title>

  <link rel="shortcut icon" href="/images/favicon.png">
  
  <meta name="description" content="OAuth2自定义授权模式本篇文章介绍一下Spring Security如何扩展新的授权类型，也是实际开发中非常重要的知识点。 为什么需要自定义授权类型前面介绍OAuth2的基础知识时介绍过默认支持的4种授权类型，分别如下：  授权码模式 简化模式 客户端模式 密码模式  实际生产中上述四种授权类型根本不够用，比如常见的授权类型如下：  微信认证 QQ认证 手机号+验证码认证 图形验证码认证 邮箱">
<meta name="keywords" content="redis">
<meta property="og:type" content="article">
<meta property="og:title" content="OAuth2自定义授权模式">
<meta property="og:url" content="https://yellowbp.github.io/2022/07/10/OAuth2自定义授权模式/index.html">
<meta property="og:site_name" content="bp的Blog">
<meta property="og:description" content="OAuth2自定义授权模式本篇文章介绍一下Spring Security如何扩展新的授权类型，也是实际开发中非常重要的知识点。 为什么需要自定义授权类型前面介绍OAuth2的基础知识时介绍过默认支持的4种授权类型，分别如下：  授权码模式 简化模式 客户端模式 密码模式  实际生产中上述四种授权类型根本不够用，比如常见的授权类型如下：  微信认证 QQ认证 手机号+验证码认证 图形验证码认证 邮箱">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://oauth2images.oss-cn-guangzhou.aliyuncs.com/oauth2/%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="https://oauth2images.oss-cn-guangzhou.aliyuncs.com/oauth2/tokenGranters.png">
<meta property="og:image" content="https://oauth2images.oss-cn-guangzhou.aliyuncs.com/oauth2/%E9%AA%8C%E8%AF%81%E7%A0%81%E6%A8%A1%E5%BC%8F%E6%89%A9%E5%B1%95.png">
<meta property="og:updated_time" content="2022-08-22T12:16:54.683Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="OAuth2自定义授权模式">
<meta name="twitter:description" content="OAuth2自定义授权模式本篇文章介绍一下Spring Security如何扩展新的授权类型，也是实际开发中非常重要的知识点。 为什么需要自定义授权类型前面介绍OAuth2的基础知识时介绍过默认支持的4种授权类型，分别如下：  授权码模式 简化模式 客户端模式 密码模式  实际生产中上述四种授权类型根本不够用，比如常见的授权类型如下：  微信认证 QQ认证 手机号+验证码认证 图形验证码认证 邮箱">
<meta name="twitter:image" content="https://oauth2images.oss-cn-guangzhou.aliyuncs.com/oauth2/%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F%E6%B5%81%E7%A8%8B.png">

  <meta name="format-detection" content="telephone=no,email=no">
  <meta name="theme-color" content="#9C27B0">
  <meta name="description" content>
  <meta name="keywords" content=",redis">

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="bp的Blog">
  <meta name="msapplication-starturl" content="https://yellowbp.github.io/2022/07/10/OAuth2自定义授权模式/">
  <meta name="msapplication-navbutton-color" content="#9C27B0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="bp的Blog">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/images/favicon.png">

  
    <meta property="article:published_time" content="Sun Jul 10 2022 17:34:59 GMT+0800">
    <meta property="article:modified_time" content="Mon Aug 22 2022 20:16:54 GMT+0800">
  

  
    <link rel="canonical" href="https://yellowbp.github.io/2022/07/10/OAuth2自定义授权模式/">
  

  <meta name="google-site-verification" content="fXjtlIfaDc_X-0P11rO3bEp1Nk4IKXphoJv0GqGZCco">
  <meta name="baidu-site-verification" content="I3t1wfwZvd">

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create','UA-139531378-1','auto');ga('send','pageview');
</script>
  <script>
  var _hmt = _hmt || [];
  (function() {var hm = document.createElement('script');
  hm.src = 'https://hm.baidu.com/hm.js?1054d51c0b66f1d168829173682c8159';
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script>
  

  <link rel="stylesheet" href="/css/mdui.css">
<link rel="stylesheet" href="/css/style.css">
</head>
<body class="mdui-appbar-with-toolbar mdui-drawer-body-left mdui-theme-primary-brown mdui-theme-accent-blue">
  <script>var a=localStorage.getItem("mdui-theme-layout-dark");if(a){document.getElementsByTagName("body")[0].className+=" mdui-theme-layout-dark"};</script>
  <header id="header" class="mdui-appbar mdui-appbar-fixed mdui-appbar-scroll-hide mdui-appbar-inset">
  <div class="mdui-toolbar mdui-color-theme">
    <a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-drawer="{target: '#sidebar', swipe: true}"><i class="mdui-icon material-icons">menu</i></a>
    <a href="/" class="mdui-typo-headline">bp的Blog</a>
    <div class="mdui-toolbar-spacer"></div>
    <a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-dialog="{target: '#search'}" mdui-tooltip="{content: '搜索'}"><i class="mdui-icon material-icons">search</i></a>
    
  </div>
</header>
<div class="mdui-dialog" id="search">
  
    <div class="search-form">
      <input type="search" class="search-form-input" placeholder="请输入关键字">
    </div>
    <div class="search-result" data-resource="/search.xml"></div>
  
</div>
  <aside id="sidebar" class="mdui-drawer mdui-drawer-full-height">
  <div class="mdui-grid-tile">
    <img src="/images/Gradient1.jpg" style="height: 160px;">
    <img src="/images/headPic.jpg" class="avatar-animation" style="position: absolute; top: 10%; left: 24px; width: 64px; height: 64px; border: 2px solid #fff; border-radius: 50%;">
    <div class="mdui-grid-tile-actions">
      <div class="mdui-grid-tile-text">
        <div class="mdui-grid-tile-title">hbp
        </div>
        <div class="mdui-grid-tile-subtitle"><i class="mdui-icon material-icons">art_track</i>要想快，先会慢</div>
      </div>
      
        <div class="mdui-grid-tile-buttons">
          <a href="mailto:347070556@qq.com" class="mdui-btn mdui-btn-icon" mdui-tooltip="{content: '347070556@qq.com'}"><i class="mdui-icon material-icons">email</i></a>
        </div>
      
    </div>
  </div>

  <div class="mdui-list" mdui-collapse="{accordion: true}">
    <a href="/" class="mdui-list-item mdui-ripple">
      <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-blue">home</i>
      <div class="mdui-list-item-content">主页</div>
    </a>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-deep-orange">inbox</i>
        <div class="mdui-list-item-content">归档</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/archives/2022/08/">八月 2022<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2022/07/">七月 2022<span class="mdui-ripple sidebar_archives-count">10</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2022/05/">五月 2022<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2022/04/">四月 2022<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2022/03/">三月 2022<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2022/02/">二月 2022<span class="mdui-ripple sidebar_archives-count">13</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/10/">十月 2021<span class="mdui-ripple sidebar_archives-count">9</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/09/">九月 2021<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/08/">八月 2021<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/07/">七月 2021<span class="mdui-ripple sidebar_archives-count">10</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/06/">六月 2021<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/05/">五月 2021<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/04/">四月 2021<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/03/">三月 2021<span class="mdui-ripple sidebar_archives-count">12</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/02/">二月 2021<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/01/">一月 2021<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2020/03/">三月 2020<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/12/">十二月 2019<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/11/">十一月 2019<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/10/">十月 2019<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/09/">九月 2019<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/08/">八月 2019<span class="mdui-ripple sidebar_archives-count">5</span></a>
        
      </div>
    </div>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-green">chrome_reader_mode</i>
        <div class="mdui-list-item-content">分类</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/categories/ElasticSearch/">ElasticSearch<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/OAuth2/">OAuth2<span class="mdui-ripple sidebar_archives-count">8</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/Redis/">Redis<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/Spring/">Spring<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/SpringBoot/">SpringBoot<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/SpringCloud-Alibaba/">SpringCloud Alibaba<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/SpringMVC/">SpringMVC<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/docker/">docker<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/excel/">excel<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/git/">git<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/java8/">java8<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/java基础/">java基础<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/jenkins/">jenkins<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/jenkins/docker/">docker<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/jwt/">jwt<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/k8s/">k8s<span class="mdui-ripple sidebar_archives-count">10</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/linux/">linux<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/maven/">maven<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/mq/">mq<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/mybatis/">mybatis<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/mysql/">mysql<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/nginx/">nginx<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/redis/">redis<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/servlet/">servlet<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/spring/">spring<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/ssm/">ssm<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/web开发基础/">web开发基础<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/yaml/">yaml<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/上传下载文件/">上传下载文件<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/乱码/">乱码<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/参数校验/">参数校验<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/发短信/">发短信<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/小程序/">小程序<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/工具类/">工具类<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/开发软件/">开发软件<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/技术/">技术<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/搭建博客/">搭建博客<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/电脑硬件/">电脑硬件<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/算法/">算法<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/缓存/">缓存<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/规范/">规范<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/认证授权/">认证授权<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/设计模式/">设计模式<span class="mdui-ripple sidebar_archives-count">6</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/部署/">部署<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/重装/">重装<span class="mdui-ripple sidebar_archives-count">1</span></a>
        
      </div>
    </div>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-brown">bookmark</i>
        <div class="mdui-list-item-content">标签</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/tags/Spring/">Spring<span class="mdui-ripple sidebar_archives-count">22</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/algorithm/">algorithm<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/excel/">excel<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/git/">git<span class="mdui-ripple sidebar_archives-count">13</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/hexo/">hexo<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/javaWeb/">javaWeb<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/java基础/">java基础<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/jwt/">jwt<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/linux/">linux<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/mq/">mq<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/mysql/">mysql<span class="mdui-ripple sidebar_archives-count">6</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/nginx/">nginx<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/redis/">redis<span class="mdui-ripple sidebar_archives-count">9</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/servlet/">servlet<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/spring/">spring<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/web开发基础/">web开发基础<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/win7/">win7<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/其他/">其他<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/分布式/">分布式<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/接口文档/">接口文档<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/笔记本选购/">笔记本选购<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/自动化构建工具/">自动化构建工具<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/设计模式/">设计模式<span class="mdui-ripple sidebar_archives-count">6</span></a>
        
      </div>
    </div>
    <a href="/about" class="mdui-list-item mdui-ripple">
      <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-purple">person</i>
      <div class="mdui-list-item-content">关于</div>
    </a>
  </div>

  <div class="mdui-divider"></div>

  <div class="mdui-list" mdui-collapse="{accordion: true}">
    
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <div class="mdui-list-item-content">友情链接</div>
        <i class="mdui-list-item-icon mdui-icon material-icons">link</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        
          <a href="javascript:;" class="mdui-list-item mdui-ripple mdui-p-l-2 mdui-text-color-theme" style="justify-content: center;">链接为空</a>
        
      </div>
    </div>
  </div>
</aside>
  <main id="main" class="mdui-m-t-5 fadeIn animated">
  <link rel="stylesheet" href="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.css">
  <style>#main article .mdui-card-content .center-block{display:block!important;margin-right:auto!important;margin-left:auto!important}</style>
  <article class="mdui-card mdui-m-b-5">
    <header class="mdui-card-media">
      <img src="/images/random/material-19.png" style="max-height: 240px;">
      <div class="mdui-card-media-covered">
        <div class="mdui-card-primary">
          <div class="mdui-card-primary-title">OAuth2自定义授权模式</div>
          <div class="mdui-card-primary-subtitle"><i class="iconfont">&#xe697;</i> 2022-07-10 / 
          <i class="iconfont">&#xe601;</i> hbp
          <span id="busuanzi_container_page_pv">
            本文总阅读量<span id="busuanzi_value_page_pv"></span>次
          </span>
          </div>
        </div>
      </div>
      <div class="mdui-card-menu">
        
        
      </div>
    </header>
    <div class="mdui-card-content mdui-typo">
      <h1 id="OAuth2自定义授权模式"><a href="#OAuth2自定义授权模式" class="headerlink" title="OAuth2自定义授权模式"></a>OAuth2自定义授权模式</h1><p>本篇文章介绍一下Spring Security如何扩展新的授权类型，也是实际开发中非常重要的知识点。</p>
<h2 id="为什么需要自定义授权类型"><a href="#为什么需要自定义授权类型" class="headerlink" title="为什么需要自定义授权类型"></a>为什么需要自定义授权类型</h2><p>前面介绍OAuth2的基础知识时介绍过默认支持的4种授权类型，分别如下：</p>
<ul>
<li>授权码模式</li>
<li>简化模式</li>
<li>客户端模式</li>
<li>密码模式</li>
</ul>
<p>实际生产中上述四种授权类型根本不够用，比如常见的授权类型如下：</p>
<ul>
<li>微信认证</li>
<li>QQ认证</li>
<li>手机号+验证码认证</li>
<li>图形验证码认证</li>
<li>邮箱认证</li>
</ul>
<p>因此我们必须懂得OAuth2.0如何自定义授权类型</p>
<h2 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h2><p>Spring Security 定制授权类型其实很简单，主要是掌握其中的思路，下面是<strong>密码模式</strong>的授权时序图</p>
<p><img src="https://oauth2images.oss-cn-guangzhou.aliyuncs.com/oauth2/%E5%AF%86%E7%A0%81%E6%A8%A1%E5%BC%8F%E6%B5%81%E7%A8%8B.png" alt="密码模式流程"></p>
<p>根据上述流程图可以跟着源码进去看看，不难发现有几个如下重要点：</p>
<ul>
<li><p>每种授权类型都对应一个实现类 <strong>TokenGranter</strong>，其中定义着授权类型（refrsh_token其实不算是授权类型）</p>
<img src="https://oauth2images.oss-cn-guangzhou.aliyuncs.com/oauth2/tokenGranters.png" alt="tokenGranters" style="zoom:80%;"></li>
<li><p>所有 <code>TokenGranter</code> 实现类都通过 <code>CompositeTokenGranter</code> 中的 <code>tokenGranters</code> 集合存起来。</p>
</li>
<li><p>然后通过判断 <code>grantType</code> 参数来定位具体使用那个 <code>TokenGranter</code> 实现类来处理授权。</p>
</li>
<li><p>每种授权方式都对应一个<strong>AuthenticationProvider</strong></p>
</li>
<li><p><code>TokenGranter</code> 类会 new 一个 <strong>AuthenticationToken</strong>实现类，如 <code>UsernamePasswordAuthenticationToken</code> 传给 <code>ProviderManager</code> 类。</p>
</li>
</ul>
<p>因此想要自定义一个授权类型，必须构建自己的<strong>TokenGranter</strong>、<strong>AuthenticationProvider</strong>、<strong>AuthenticationToken</strong>。</p>
<h2 id="验证码授权模式扩展"><a href="#验证码授权模式扩展" class="headerlink" title="验证码授权模式扩展"></a>验证码授权模式扩展</h2><p>验证码授权模式是在密码模式基础添加个验证码校验，简单点的方法：完全可以使用过滤器实现，但如果想不开的话那就试下扩展吧</p>
<h3 id="验证码时序图"><a href="#验证码时序图" class="headerlink" title="验证码时序图"></a>验证码时序图</h3><p><img src="https://oauth2images.oss-cn-guangzhou.aliyuncs.com/oauth2/%E9%AA%8C%E8%AF%81%E7%A0%81%E6%A8%A1%E5%BC%8F%E6%89%A9%E5%B1%95.png" alt="验证码模式扩展"></p>
<p>比较可知两者的区别基本就是授权者 Granter 的区别，后续的 Provider 获取用户认证信息和密码等判断完全一致，具体新增的验证码模式授权者 <code>CaptchaTokenGranter</code> 和密码模式的授权者 <code>ResourceOwnerPasswordTokenGranter</code> 区别在于前者的 <code>getOAuth2Authentication()</code> 方法获取认证信息添加了校验验证码的逻辑</p>
<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><p>从原理得知只需重写 <code>Granter</code> 为其添加校验验证码的能力，所以复制密码模式的授权者 <code>ResourceOwnerPasswordTokenGranter</code> 然后重名为 <code>CaptchaTokenGranter</code>，稍加改动成为验证码模式的授权者。</p>
<h4 id="自定义-TokenGranter"><a href="#自定义-TokenGranter" class="headerlink" title="自定义 TokenGranter"></a>自定义 TokenGranter</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证码授权模式 授权者</span></span><br><span class="line"><span class="comment"> * getOAuth2Authentication方法是仿写密码模式的 ResourceOwnerPasswordTokenGranter 授权者</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CaptchaTokenGranter</span> <span class="keyword">extends</span> <span class="title">AbstractTokenGranter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String GRANT_TYPE = <span class="string">"captcha"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationManager authenticationManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisUtils redisUtils;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">CaptchaTokenGranter</span><span class="params">(AuthenticationManager authenticationManager, </span></span></span><br><span class="line"><span class="function"><span class="params">                                  AuthorizationServerTokenServices tokenServices, </span></span></span><br><span class="line"><span class="function"><span class="params">                                  ClientDetailsService clientDetailsService, </span></span></span><br><span class="line"><span class="function"><span class="params">                                  OAuth2RequestFactory requestFactory, </span></span></span><br><span class="line"><span class="function"><span class="params">                                  String grantType,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  RedisUtils redisUtils)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(tokenServices, clientDetailsService, requestFactory, grantType);</span><br><span class="line">        <span class="keyword">this</span>.authenticationManager = authenticationManager;</span><br><span class="line">        <span class="keyword">this</span>.redisUtils = redisUtils;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> OAuth2Authentication <span class="title">getOAuth2Authentication</span><span class="params">(ClientDetails client, TokenRequest tokenRequest)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; parameters = <span class="keyword">new</span> LinkedHashMap&lt;&gt;(tokenRequest.getRequestParameters());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证码校验</span></span><br><span class="line">        String validateCode = parameters.get(<span class="string">"validateCode"</span>);</span><br><span class="line">        String uuid = parameters.get(<span class="string">"uuid"</span>);</span><br><span class="line">        Assert.isNull(StringUtils.isNotBlank(validateCode), <span class="string">"验证码不能为空"</span>);</span><br><span class="line">        String validCodeKey = AuthConstants.VALIDATION_CODE_KEY_PREFIX + uuid;</span><br><span class="line">        <span class="comment">// 从缓存中取出正确的验证码进行校验</span></span><br><span class="line">        String correctValidCode;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            correctValidCode = String.valueOf(redisUtils.get(validCodeKey));</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            redisUtils.delete(validCodeKey);</span><br><span class="line">        &#125;</span><br><span class="line">        Assert.isTrue(StringUtils.isNotBlank(correctValidCode), <span class="string">"验证码过期"</span>);</span><br><span class="line">        Assert.isTrue(validateCode.equals(correctValidCode), <span class="string">"验证码错误"</span>);</span><br><span class="line">        String username = parameters.get(<span class="string">"username"</span>);</span><br><span class="line">        String password = parameters.get(<span class="string">"password"</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 移除后续无用参数</span></span><br><span class="line">        parameters.remove(<span class="string">"password"</span>);</span><br><span class="line">        parameters.remove(<span class="string">"uuid"</span>);</span><br><span class="line">        parameters.remove(<span class="string">"validateCode"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 和密码模式一样的逻辑</span></span><br><span class="line">        Authentication userAuth = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(username, password);</span><br><span class="line">        ((AbstractAuthenticationToken) userAuth).setDetails(parameters);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            userAuth = authenticationManager.authenticate(userAuth);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AccountStatusException | BadCredentialsException ase) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidGrantException(ase.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (userAuth == <span class="keyword">null</span> || !userAuth.isAuthenticated()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidGrantException(<span class="string">"Could not authenticate user: "</span> + username);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        OAuth2Request storedOAuth2Request = getRequestFactory().createOAuth2Request(client, tokenRequest);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OAuth2Authentication(storedOAuth2Request, userAuth);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面相对密码模式的授权者做了两处改动，总结如下：</p>
<ol>
<li>修改 GRANT_TYPE 的值 <code>password</code> 为 <code>captcha</code>;</li>
<li>getOAuth2Authentication() 方法添加验证码校验逻辑。</li>
</ol>
<h4 id="AuthorizationServerConfig"><a href="#AuthorizationServerConfig" class="headerlink" title="AuthorizationServerConfig"></a>AuthorizationServerConfig</h4><p>在 AuthenticationServerConfig 认证授权配置类重写 TokenGranter 让其支持新增的验证码模式授权者 CaptchaTokenGranter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置授权（authorization）以及令牌（token）的访问端点和令牌服务(token services)</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> endpoints</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 获取原有默认的授权模式 (授权码模式、密码模式、客户端模式、简化模式)</span></span><br><span class="line">    List&lt;TokenGranter&gt; tokenGranters = <span class="keyword">new</span> ArrayList&lt;&gt;(Collections.singletonList(endpoints.getTokenGranter()));</span><br><span class="line">    <span class="comment">// 添加验证码授权模式授权者</span></span><br><span class="line">    tokenGranters.add(<span class="keyword">new</span> CaptchaTokenGranter(endpoints.getTokenServices(), endpoints.getClientDetailsService(), endpoints.getOAuth2RequestFactory(), authenticationManager, redisUtils));</span><br><span class="line">    </span><br><span class="line">    endpoints</span><br><span class="line">            <span class="comment">// 密码模式所需要的 authenticationManager</span></span><br><span class="line">            .authenticationManager(authenticationManager)</span><br><span class="line">            <span class="comment">// 令牌管理服务，无论哪种模式都需要</span></span><br><span class="line">            .tokenServices(tokenServices())</span><br><span class="line">            <span class="comment">// 所有 TokenGranter 实现类都通过 CompositeTokenGranter 中的 tokenGranters 集合存起来</span></span><br><span class="line">            .tokenGranter(<span class="keyword">new</span> CompositeTokenGranter(tokenGranters))</span><br><span class="line">            <span class="comment">// 访问令牌接口：/oauth/token 时，只允许POST提交</span></span><br><span class="line">            .allowedTokenEndpointRequestMethods(HttpMethod.POST);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Spring-Webflux整合验证码easy-captcha"><a href="#Spring-Webflux整合验证码easy-captcha" class="headerlink" title="Spring Webflux整合验证码easy-captcha"></a>Spring Webflux整合验证码easy-captcha</h4><p>验证码生成的功能主要是生成一个随机码将其缓存redis，返回redis的key标识（一般是uuid）和随机码的图片（base64方式）给前端。因为没有任何业务逻辑，故这里直接放在网关，除了利用 <code>WebFlux</code> 性能优势之外还能减少一次转发。</p>
<p>若想整合kaptcha：<a href="https://blog.csdn.net/cl939974883/article/details/124132246" target="_blank" rel="noopener">https://blog.csdn.net/cl939974883/article/details/124132246</a></p>
<h5 id="验证码处理器EasyCaptchaHandler"><a href="#验证码处理器EasyCaptchaHandler" class="headerlink" title="验证码处理器EasyCaptchaHandler"></a>验证码处理器EasyCaptchaHandler</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EasyCaptchaHandler</span> <span class="keyword">implements</span> <span class="title">HandlerFunction</span>&lt;<span class="title">ServerResponse</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EasyCaptchaProducer easyCaptchaProducer;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisUtils redisUtils;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;captcha.type:ARITHMETIC&#125;"</span>)</span><br><span class="line">    EasyCaptchaTypeEnum captchaType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证码在redis中的有效期 (单位：秒)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;captcha.ttl:120&#125;"</span>)</span><br><span class="line">    <span class="keyword">long</span> captchaValueTtl;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;ServerResponse&gt; <span class="title">handle</span><span class="params">(ServerRequest serverRequest)</span> </span>&#123;</span><br><span class="line">        Captcha captcha = easyCaptchaProducer.getCaptcha(captchaType);</span><br><span class="line">        String captchaValue = captcha.text();</span><br><span class="line">        <span class="comment">// 对于算数类型需要特殊处理一下</span></span><br><span class="line">        <span class="keyword">if</span> (captchaType == <span class="keyword">null</span> || captchaType == EasyCaptchaTypeEnum.ARITHMETIC) &#123;</span><br><span class="line">            <span class="keyword">if</span> (captcha.getCharType() - <span class="number">1</span> == EasyCaptchaTypeEnum.ARITHMETIC.ordinal() &amp;&amp; captchaValue.contains(<span class="string">"."</span>)) &#123;</span><br><span class="line">                captchaValue = captchaValue.split(<span class="string">"\\."</span>)[<span class="number">0</span>];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 验证码缓存至redis</span></span><br><span class="line">        String uuid = UUIDUtils.getSimpleUUID();</span><br><span class="line">        <span class="keyword">boolean</span> hasSuccess = redisUtils.set(SecurityConstants.VALIDATION_CODE_KEY_PREFIX + uuid, captchaValue, captchaValueTtl, TimeUnit.SECONDS);</span><br><span class="line">        Assert.isTrue(hasSuccess, <span class="string">"生成验证码失败"</span>);</span><br><span class="line">        <span class="comment">// 验证码转成base64编码</span></span><br><span class="line">        String captchaBase64 = captcha.toBase64();</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        map.put(<span class="string">"uuid"</span>, uuid);</span><br><span class="line">        map.put(<span class="string">"img"</span>, captchaBase64);</span><br><span class="line">        <span class="keyword">return</span> ServerResponse.ok().body(BodyInserters.fromValue(JsonResponseBuilder.ok(map)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="验证码类型枚举EasyCaptchaTypeEnum"><a href="#验证码类型枚举EasyCaptchaTypeEnum" class="headerlink" title="验证码类型枚举EasyCaptchaTypeEnum"></a>验证码类型枚举EasyCaptchaTypeEnum</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证码类型枚举</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> EasyCaptchaTypeEnum &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 算数</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ARITHMETIC,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 中文</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    CHINESE,</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 中文gif</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    CHINESE_GIF,</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * gif</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    GIF,</span><br><span class="line">    SPEC</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="验证码生成器EasyCaptchaProducer"><a href="#验证码生成器EasyCaptchaProducer" class="headerlink" title="验证码生成器EasyCaptchaProducer"></a>验证码生成器EasyCaptchaProducer</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证码生成器</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EasyCaptchaProducer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证码内容长度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> length = <span class="number">4</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证码宽度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> width = <span class="number">120</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证码高度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> height = <span class="number">36</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 验证码字体</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String fontName = <span class="string">"Verdana"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 字体风格</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Integer fontStyle = Font.PLAIN;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 字体大小</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> fontSize = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Captcha <span class="title">getCaptcha</span><span class="params">(EasyCaptchaTypeEnum codeType)</span> </span>&#123;</span><br><span class="line">        Captcha captcha;</span><br><span class="line">        <span class="keyword">switch</span> (codeType) &#123;</span><br><span class="line">            <span class="keyword">case</span> ARITHMETIC:</span><br><span class="line">                <span class="comment">// 算术类型</span></span><br><span class="line">                captcha = <span class="keyword">new</span> FixedArithmeticCaptcha(width, height);</span><br><span class="line">                <span class="comment">// 固定设置为两位，图片为算数运算表达式</span></span><br><span class="line">                captcha.setLen(<span class="number">2</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CHINESE:</span><br><span class="line">                captcha = <span class="keyword">new</span> ChineseCaptcha(width, height);</span><br><span class="line">                captcha.setLen(length);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> CHINESE_GIF:</span><br><span class="line">                captcha = <span class="keyword">new</span> ChineseGifCaptcha(width, height);</span><br><span class="line">                captcha.setLen(length);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> GIF:</span><br><span class="line">                <span class="comment">// 最后一位是位数</span></span><br><span class="line">                captcha = <span class="keyword">new</span> GifCaptcha(width, height);</span><br><span class="line">                captcha.setLen(length);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> SPEC:</span><br><span class="line">                captcha = <span class="keyword">new</span> SpecCaptcha(width, height);</span><br><span class="line">                captcha.setLen(length);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"验证码配置信息错误！"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        captcha.setFont(<span class="keyword">new</span> Font(fontName, fontStyle, fontSize));</span><br><span class="line">        <span class="keyword">return</span> captcha;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FixedArithmeticCaptcha</span> <span class="keyword">extends</span> <span class="title">ArithmeticCaptcha</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">FixedArithmeticCaptcha</span><span class="params">(<span class="keyword">int</span> width, <span class="keyword">int</span> height)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(width, height);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">char</span>[] alphas() &#123;</span><br><span class="line">            <span class="comment">// 生成随机数字和运算符</span></span><br><span class="line">            <span class="keyword">int</span> n1 = num(<span class="number">1</span>, <span class="number">10</span>), n2 = num(<span class="number">1</span>, <span class="number">10</span>);</span><br><span class="line">            <span class="keyword">int</span> opt = num(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 计算结果</span></span><br><span class="line">            <span class="keyword">int</span> res = <span class="keyword">new</span> <span class="keyword">int</span>[]&#123;n1 + n2, n1 - n2, n1 * n2&#125;[opt];</span><br><span class="line">            <span class="comment">// 转换为字符运算符</span></span><br><span class="line">            <span class="keyword">char</span> optChar = <span class="string">"+-x"</span>.charAt(opt);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">this</span>.setArithmeticString(String.format(<span class="string">"%s%c%s=?"</span>, n1, optChar, n2));</span><br><span class="line">            <span class="keyword">this</span>.chars = String.valueOf(res);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> chars.toCharArray();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="验证码访问接口"><a href="#验证码访问接口" class="headerlink" title="验证码访问接口"></a>验证码访问接口</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 验证码路由</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EasyCaptchaRouter</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RouterFunction&lt;ServerResponse&gt; <span class="title">easyCaptchaRouterFunction</span><span class="params">(EasyCaptchaHandler captchaHandler)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RouterFunctions</span><br><span class="line">                .route(RequestPredicates.GET(<span class="string">"/captcha"</span>)</span><br><span class="line">                        .and(RequestPredicates.accept(MediaType.TEXT_PLAIN)), captchaHandler);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="代码实现-1"><a href="#代码实现-1" class="headerlink" title="代码实现"></a>代码实现</h2><p>下面就以<strong>手机号+密码</strong>的登录方式定义一个类型：<strong>mobile_pwd</strong>，剩下的自己照葫芦画瓢。</p>
<h3 id="自定义UserDetailService"><a href="#自定义UserDetailService" class="headerlink" title="自定义UserDetailService"></a>自定义UserDetailService</h3><p>这个和密码授权类型类似，要实现一个方法从数据库中根据手机号查询用户的详细信息。</p>
<p>定义一个 <strong>MobileCodeUserDetailService</strong> 接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义的UserDetailService，从数据库中</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MobileCodeUserDetailService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据手机号查询用户信息</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> mobilePhone 手机号码</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> UsernameNotFoundException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">UserDetails <span class="title">loadUserByMobile</span><span class="params">(String mobilePhone)</span> <span class="keyword">throws</span> UsernameNotFoundException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>主要就是一个 <strong>loadUserByMobile()</strong> 方法，实现类如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmsCodeUserDetailServiceImpl</span> <span class="keyword">implements</span> <span class="title">SmsCodeUserDetailService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysUserRepository sysUserRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysUserRoleRepository sysUserRoleRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysRoleRepository sysRoleRepository;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByMobile</span><span class="params">(String mobile)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        SysUser user = sysUserRepository.findByMobileAndStatus(mobile, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (Objects.isNull(user))</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UsernameNotFoundException(<span class="string">"账号不存在！"</span>);</span><br><span class="line">        <span class="comment">//角色</span></span><br><span class="line">        List&lt;SysUserRole&gt; sysUserRoles = sysUserRoleRepository.findByUserId(user.getId());</span><br><span class="line">        <span class="comment">//该用户的所有权限（角色）</span></span><br><span class="line">        List&lt;String&gt; roles=<span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (SysUserRole userRole : sysUserRoles) &#123;</span><br><span class="line">            sysRoleRepository.findById(userRole.getRoleId()).ifPresent(o-&gt; roles.add(SysConstant.ROLE_PREFIX+o.getCode()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> SecurityUser.builder()</span><br><span class="line">                .userId(user.getUserId())</span><br><span class="line">                .username(user.getUsername())</span><br><span class="line">                .password(user.getPassword())</span><br><span class="line">                <span class="comment">//将角色放入authorities中</span></span><br><span class="line">                .authorities(AuthorityUtils.createAuthorityList(ArrayUtil.toArray(roles,String<span class="class">.<span class="keyword">class</span>)))</span></span><br><span class="line"><span class="class">                .<span class="title">build</span>()</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自定义Authentication"><a href="#自定义Authentication" class="headerlink" title="自定义Authentication"></a>自定义Authentication</h3><p>类似于密码模式的中<strong>UsernamePasswordAuthenticationToken</strong>，自定义一个<strong>MobilePasswordAuthenticationToken</strong>封装手机号和密码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义AuthenticationToken 封装信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MobilePasswordAuthenticationToken</span> <span class="keyword">extends</span> <span class="title">AbstractAuthenticationToken</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = SpringSecurityCoreVersion.SERIAL_VERSION_UID;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object principal;</span><br><span class="line">    <span class="keyword">private</span> Object credentials;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MobilePasswordAuthenticationToken</span><span class="params">(String mobile, String password)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">this</span>.principal = mobile;</span><br><span class="line">        <span class="keyword">this</span>.credentials = password;</span><br><span class="line">        setAuthenticated(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MobilePasswordAuthenticationToken</span><span class="params">(Object principal, Object credentials,</span></span></span><br><span class="line"><span class="function"><span class="params">                                             Collection&lt;? extends GrantedAuthority&gt; authorities)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(authorities);</span><br><span class="line">        <span class="keyword">this</span>.principal = principal;</span><br><span class="line">        <span class="keyword">this</span>.credentials = credentials;</span><br><span class="line">        <span class="keyword">super</span>.setAuthenticated(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getCredentials</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.credentials;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">getPrincipal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.principal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAuthenticated</span><span class="params">(<span class="keyword">boolean</span> isAuthenticated)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isAuthenticated) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">                    <span class="string">"Cannot set this token to trusted - use constructor which takes a GrantedAuthority list instead"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">super</span>.setAuthenticated(<span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">eraseCredentials</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.eraseCredentials();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自定义TokenGranter"><a href="#自定义TokenGranter" class="headerlink" title="自定义TokenGranter"></a>自定义TokenGranter</h3><p>每种授权类型都对应一种TokenGranter，其中会定义授权类型的名称，比如密码模式的<strong>ResourceOwnerPasswordTokenGranter</strong>，其中的GRANT_TYPE为password</p>
<p>自定义一个<strong>MobilePwdGranter</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义的授权模式，模式名称为：mobile_pwd</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MobilePwdGranter</span> <span class="keyword">extends</span> <span class="title">AbstractTokenGranter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String GRANT_TYPE = <span class="string">"mobile_pwd"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MobilePwdGranter</span><span class="params">(AuthenticationManager authenticationManager, AuthorizationServerTokenServices tokenServices</span></span></span><br><span class="line"><span class="function"><span class="params">            , ClientDetailsService clientDetailsService, OAuth2RequestFactory requestFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(tokenServices, clientDetailsService, requestFactory, GRANT_TYPE);</span><br><span class="line">        <span class="keyword">this</span>.authenticationManager = authenticationManager;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> OAuth2Authentication <span class="title">getOAuth2Authentication</span><span class="params">(ClientDetails client, TokenRequest tokenRequest)</span> </span>&#123;</span><br><span class="line">        Map&lt;String, String&gt; parameters = <span class="keyword">new</span> LinkedHashMap&lt;&gt;(tokenRequest.getRequestParameters());</span><br><span class="line">        String mobile = parameters.get(<span class="string">"mobile"</span>);</span><br><span class="line">        String password = parameters.get(<span class="string">"password"</span>);</span><br><span class="line">        <span class="comment">//将其中的密码移除</span></span><br><span class="line">        parameters.remove(<span class="string">"password"</span>);</span><br><span class="line">        Authentication userAuth = <span class="keyword">new</span> MobilePasswordAuthenticationToken(mobile, password);</span><br><span class="line">        ((AbstractAuthenticationToken) userAuth).setDetails(parameters);</span><br><span class="line">        <span class="comment">//调用AuthenticationManager进行认证，内部会根据MobileAuthenticationToken找到对应的Provider进行认证</span></span><br><span class="line">        userAuth = authenticationManager.authenticate(userAuth);</span><br><span class="line">        <span class="keyword">if</span> (userAuth == <span class="keyword">null</span> || !userAuth.isAuthenticated()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InvalidGrantException(<span class="string">"Could not authenticate mobile: "</span> + mobile);</span><br><span class="line">        &#125;</span><br><span class="line">        OAuth2Request storedOAuth2Request = getRequestFactory().createOAuth2Request(client, tokenRequest);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> OAuth2Authentication(storedOAuth2Request, userAuth);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="自定义AuthenticationProvider"><a href="#自定义AuthenticationProvider" class="headerlink" title="自定义AuthenticationProvider"></a>自定义AuthenticationProvider</h3><p>这个类就是真正的处理类，经过TokenGranter后，会找到对应的AuthenticationProvider，然后取出参数从数据库（<strong>UserDetailService</strong>）中查询对应的信息进行匹配</p>
<p>自定义<strong>MobilePasswordAuthenticationProvider</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义AuthenticationProvider，处理手机号。密码登录</span></span><br><span class="line"><span class="comment"> * 主要的逻辑：根据userDetailService从数据库中查询用户，对比密码</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MobilePasswordAuthenticationProvider</span> <span class="keyword">implements</span> <span class="title">AuthenticationProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> SmsCodeUserDetailService userDetailService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MobilePasswordAuthenticationProvider</span><span class="params">(SmsCodeUserDetailService userDetailService, PasswordEncoder passwordEncoder)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.userDetailService=userDetailService;</span><br><span class="line">        <span class="keyword">this</span>.passwordEncoder=passwordEncoder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> </span>&#123;</span><br><span class="line">        MobilePasswordAuthenticationToken authenticationToken = (MobilePasswordAuthenticationToken) authentication;</span><br><span class="line">        String mobile = (String) authenticationToken.getPrincipal();</span><br><span class="line">        String password = (String) authenticationToken.getCredentials();</span><br><span class="line">        <span class="comment">//查询数据库，加载用户详细信息</span></span><br><span class="line">        UserDetails user = userDetailService.loadUserByMobile(mobile);</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalAuthenticationServiceException(<span class="string">"手机号或密码错误"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!passwordEncoder.matches(password, user.getPassword())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BadCredentialsException(<span class="string">"手机号或密码错误"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        MobilePasswordAuthenticationToken authenticationResult = <span class="keyword">new</span> MobilePasswordAuthenticationToken(user, password, user.getAuthorities());</span><br><span class="line">        authenticationResult.setDetails(authenticationToken.getDetails());</span><br><span class="line">        <span class="keyword">return</span> authenticationResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Spring Security会根据这个方法判断当前Provider是否支持处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; authentication)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MobilePasswordAuthenticationToken<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">authentication</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="将自定义的MobilePasswordAuthenticationProvider注入IOC容器"><a href="#将自定义的MobilePasswordAuthenticationProvider注入IOC容器" class="headerlink" title="将自定义的MobilePasswordAuthenticationProvider注入IOC容器"></a>将自定义的MobilePasswordAuthenticationProvider注入IOC容器</h3><p>这里必须将自定义的MobilePasswordAuthenticationProvider注入到IOC容器，如果不注入，会报找不到能处理的AuthenticationProvider这个异常。</p>
<p>新建<strong>SmsCodeSecurityConfig</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SmsCodeSecurityConfig</span> <span class="keyword">extends</span> <span class="title">SecurityConfigurerAdapter</span>&lt;<span class="title">DefaultSecurityFilterChain</span>, <span class="title">HttpSecurity</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SmsCodeUserDetailService userDetailService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 短信验证码配置器</span></span><br><span class="line"><span class="comment">     *  所有的配置都可以移步到WebSecurityConfig</span></span><br><span class="line"><span class="comment">     *  builder.authenticationProvider() 相当于 auth.authenticationProvider();</span></span><br><span class="line"><span class="comment">     *  使用外部配置必须要在WebSecurityConfig中用http.apply(smsCodeSecurityConfig)将配置注入进去</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity builder)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//注入SmsCodeAuthenticationProvider</span></span><br><span class="line">        MobilePasswordAuthenticationProvider smsCodeAuthenticationProvider = <span class="keyword">new</span> MobilePasswordAuthenticationProvider(userDetailService,passwordEncoder);</span><br><span class="line">        builder.authenticationProvider(smsCodeAuthenticationProvider);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Security的全局配置指定SmsCodeSecurityConfig"><a href="#Security的全局配置指定SmsCodeSecurityConfig" class="headerlink" title="Security的全局配置指定SmsCodeSecurityConfig"></a>Security的全局配置指定SmsCodeSecurityConfig</h3><p>由于是分开配置，因此必须在全局配置中指定才会生效</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SmsCodeSecurityConfig smsCodeSecurityConfig;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加密算法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//todo 允许表单登录</span></span><br><span class="line">        http</span><br><span class="line">                <span class="comment">//注入自定义的授权配置类</span></span><br><span class="line">                .apply(smsCodeSecurityConfig)</span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                <span class="comment">//注销的接口需要放行</span></span><br><span class="line">                .antMatchers(<span class="string">"/oauth/logout"</span>).permitAll()</span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .loginProcessingUrl(<span class="string">"/login"</span>)</span><br><span class="line">                .permitAll()</span><br><span class="line">                .and()</span><br><span class="line">                .csrf()</span><br><span class="line">                .disable();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">//从数据库中查询用户信息</span></span><br><span class="line">        auth.userDetailsService(userDetailsService);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * AuthenticationManager对象在OAuth2认证服务中要使用，提前放入IOC容器中</span></span><br><span class="line"><span class="comment">     * Oauth的密码模式需要</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationManager <span class="title">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="加到CompositeTokenGranter集合中"><a href="#加到CompositeTokenGranter集合中" class="headerlink" title="加到CompositeTokenGranter集合中"></a>加到CompositeTokenGranter集合中</h3><p>需要将自定义的授权类型加到集合CompositeTokenGranter中，此处需要修改认证中心的配置类（<strong>AuthorizationServerConfig</strong>）中的代码，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 配置令牌访问的端点</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"ALL"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//将自定义的授权类型添加到tokenGranters中</span></span><br><span class="line">    List&lt;TokenGranter&gt; tokenGranters = <span class="keyword">new</span> ArrayList&lt;&gt;(Collections.singletonList(endpoints.getTokenGranter()));</span><br><span class="line">    tokenGranters.add(<span class="keyword">new</span> MobilePwdGranter(authenticationManager, tokenServices(), clientDetailsService,</span><br><span class="line">            <span class="keyword">new</span> DefaultOAuth2RequestFactory(clientDetailsService)));</span><br><span class="line"></span><br><span class="line">    endpoints</span><br><span class="line">            <span class="comment">//设置异常WebResponseExceptionTranslator，用于处理用户名，密码错误、授权类型不正确的异常</span></span><br><span class="line">            .exceptionTranslator(<span class="keyword">new</span> OAuthServerWebResponseExceptionTranslator())</span><br><span class="line">            <span class="comment">//授权码模式所需要的authorizationCodeServices</span></span><br><span class="line">            .authorizationCodeServices(authorizationCodeServices())</span><br><span class="line">            <span class="comment">//密码模式所需要的authenticationManager</span></span><br><span class="line">            .authenticationManager(authenticationManager)</span><br><span class="line">            <span class="comment">//令牌管理服务，无论哪种模式都需要</span></span><br><span class="line">            .tokenServices(tokenServices())</span><br><span class="line">            <span class="comment">//添加进入tokenGranter</span></span><br><span class="line">            .tokenGranter(<span class="keyword">new</span> CompositeTokenGranter(tokenGranters))</span><br><span class="line">            <span class="comment">//只允许POST提交访问令牌，uri：/oauth/token</span></span><br><span class="line">            .allowedTokenEndpointRequestMethods(HttpMethod.POST);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="oauth-client-details表中添加授权类型"><a href="#oauth-client-details表中添加授权类型" class="headerlink" title="oauth_client_details表中添加授权类型"></a>oauth_client_details表中添加授权类型</h3><p><strong>oauth_client_details</strong>这个表是存储客户端的详细信息的，需要在对应的客户端资源那一行中的<strong>authorized_grant_types</strong>这个字段中添加自定义的授权类型，多个用逗号分隔。</p>
<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3>
      <blockquote class="mdui-m-t-5">
        
          <strong>本文遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">CC BY-NC-SA 4.0</a> 许可协议，转载请附上原文出处链接和本声明。</strong><br>
        
        <strong>本文链接：</strong><a href="https://yellowbp.github.io/2022/07/10/OAuth2自定义授权模式/">https://yellowbp.github.io/2022/07/10/OAuth2自定义授权模式/</a>
      </blockquote>
      
    </div>
    <footer class="mdui-card-actions">
      
        <a class="mdui-ripple article_categories-link" href="/categories/OAuth2/">OAuth2</a>
      
      
        <a class="mdui-ripple article_tags-link" href="/tags/redis/">redis</a>
      
    </footer>
    
  </article>
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script>$("#main article .mdui-card-content img.fancybox").on("click",function(e){$.fancybox.open({src:$(this).attr("src")});});</script>


  <nav id="paginator">
    
      <a rel="prev" class="extend prev" href="/2022/07/10/OAuth2自定义token返回格式/">
        <button aria-label="prev" class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_back</i></button>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上一篇
      </a>
    
    <div class="spacer"></div>
    
      <a rel="next" class="extend next" href="/2022/07/10/JWT令牌注销失效/">
        下一篇&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <button aria-label="next" class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_forward</i></button>
      </a>
    
  </nav>


  <div id="comment" class="mdui-m-t-5">
    <style>#pop_ad,#feedAv{display:none!important;position:absolute!important;z-index:-9999;left:-1000px;opacity:0!important}</style>
<div id="SOHUCS" sid="cl74qc0fq008ajctwh9orjx3s"></div>
<script type="text/javascript">
(function(){
var appid = 'cyubhC2Dq';
var conf = 'prod_e4cce65003c5bed049fefcb8a6f09e12';
var width = window.innerWidth || document.documentElement.clientWidth;
if (width < 960) {
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="http://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("http://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>
  </div>



  <div style="position: fixed !important; right: 16px; top: 30%;">
    <button class="mdui-fab mdui-fab-mini mdui-ripple" mdui-menu="{target: '#toc'}"><i class="mdui-icon material-icons">format_list_numbered</i></button>
    <ul class="mdui-menu" id="toc">
      <li class="mdui-menu-item" disabled><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#OAuth2自定义授权模式"><span class="toc-number">1.</span> <span class="toc-text">OAuth2自定义授权模式</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#为什么需要自定义授权类型"><span class="toc-number">1.1.</span> <span class="toc-text">为什么需要自定义授权类型</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#原理"><span class="toc-number">1.2.</span> <span class="toc-text">原理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#验证码授权模式扩展"><span class="toc-number">1.3.</span> <span class="toc-text">验证码授权模式扩展</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#验证码时序图"><span class="toc-number">1.3.1.</span> <span class="toc-text">验证码时序图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#代码实现"><span class="toc-number">1.3.2.</span> <span class="toc-text">代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#自定义-TokenGranter"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">自定义 TokenGranter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AuthorizationServerConfig"><span class="toc-number">1.3.2.2.</span> <span class="toc-text">AuthorizationServerConfig</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Spring-Webflux整合验证码easy-captcha"><span class="toc-number">1.3.2.3.</span> <span class="toc-text">Spring Webflux整合验证码easy-captcha</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#验证码处理器EasyCaptchaHandler"><span class="toc-number">1.3.2.3.1.</span> <span class="toc-text">验证码处理器EasyCaptchaHandler</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#验证码类型枚举EasyCaptchaTypeEnum"><span class="toc-number">1.3.2.3.2.</span> <span class="toc-text">验证码类型枚举EasyCaptchaTypeEnum</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#验证码生成器EasyCaptchaProducer"><span class="toc-number">1.3.2.3.3.</span> <span class="toc-text">验证码生成器EasyCaptchaProducer</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#验证码访问接口"><span class="toc-number">1.3.2.3.4.</span> <span class="toc-text">验证码访问接口</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#代码实现-1"><span class="toc-number">1.4.</span> <span class="toc-text">代码实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义UserDetailService"><span class="toc-number">1.4.1.</span> <span class="toc-text">自定义UserDetailService</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义Authentication"><span class="toc-number">1.4.2.</span> <span class="toc-text">自定义Authentication</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义TokenGranter"><span class="toc-number">1.4.3.</span> <span class="toc-text">自定义TokenGranter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#自定义AuthenticationProvider"><span class="toc-number">1.4.4.</span> <span class="toc-text">自定义AuthenticationProvider</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#将自定义的MobilePasswordAuthenticationProvider注入IOC容器"><span class="toc-number">1.4.5.</span> <span class="toc-text">将自定义的MobilePasswordAuthenticationProvider注入IOC容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Security的全局配置指定SmsCodeSecurityConfig"><span class="toc-number">1.4.6.</span> <span class="toc-text">Security的全局配置指定SmsCodeSecurityConfig</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#加到CompositeTokenGranter集合中"><span class="toc-number">1.4.7.</span> <span class="toc-text">加到CompositeTokenGranter集合中</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#oauth-client-details表中添加授权类型"><span class="toc-number">1.4.8.</span> <span class="toc-text">oauth_client_details表中添加授权类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试"><span class="toc-number">1.4.9.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li></ol></li>
    </ul>
  </div>
</main>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<footer id="footer" class="mdui-m-t-5 mdui-p-y-3 mdui-color-theme">
  <div class="mdui-p-y-0 mdui-text-center">
    
    
    
    
    
    
    
      <a href="https://github.com/yellowbp" target="_blank"><i class="mdui-p-a-1 mdui-icon iconfont mdui-text-color-theme-a100">&#xe7ab;</i></a>
    
    
    
    
    
      <a href="tencent://message/?uin=1432440963&Menu=yes" target="_blank"><i class="mdui-p-a-1 mdui-icon iconfont mdui-text-color-theme-a100">&#xe651;</i></a>
    
    
  </div>
  <div class="mdui-p-y-1 mdui-text-center">
    Copyright &copy; 2019 - 2022 hbp<br>
    Powered by <a href="https://hexo.io/" target="_blank" class="mdui-text-color-theme-accent">Hexo</a>hbp All rights reserved.
    
    <br>
    <span id="busuanzi_container_site_uv">
    本网站总访问量<span id="busuanzi_value_site_uv"></span>次
    </span>
  </div>
</footer>
  <button id="gotop" class="mdui-fab mdui-fab-fixed mdui-fab-hide mdui-ripple mdui-color-theme-accent"><i class="mdui-icon material-icons">arrow_upward</i></button>
  <script async src="http://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <script src="/js/mdui.js"></script>
<script src="/js/script.js"></script>
</body>
</html>