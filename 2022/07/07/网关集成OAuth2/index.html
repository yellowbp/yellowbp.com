<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="renderer" content="webkit">

  
  <title>网关集成OAuth2 | bp的Blog</title>

  <link rel="shortcut icon" href="/images/favicon.png">
  
  <meta name="description" content="网关集成OAuth2案例架构    大致分为四个角色，如下：  客户端：需要访问微服务资源 网关：负责转发、校验token、鉴权 OAuth2.0认证授权服务：负责认证、授权、颁发令牌 微服务集合：提供资源的一系列服务。  大致流程如下： 1、客户端发出请求给网关获取令牌 2、网关收到请求，直接转发给认证服务 3、认证服务验证用户名、密码等一系列身份，通过则颁发令牌给客户端 4、客户端携带令牌请求">
<meta name="keywords" content="redis">
<meta property="og:type" content="article">
<meta property="og:title" content="网关集成OAuth2">
<meta property="og:url" content="https://yellowbp.github.io/2022/07/07/网关集成OAuth2/index.html">
<meta property="og:site_name" content="bp的Blog">
<meta property="og:description" content="网关集成OAuth2案例架构    大致分为四个角色，如下：  客户端：需要访问微服务资源 网关：负责转发、校验token、鉴权 OAuth2.0认证授权服务：负责认证、授权、颁发令牌 微服务集合：提供资源的一系列服务。  大致流程如下： 1、客户端发出请求给网关获取令牌 2、网关收到请求，直接转发给认证服务 3、认证服务验证用户名、密码等一系列身份，通过则颁发令牌给客户端 4、客户端携带令牌请求">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://oauth2images.oss-cn-guangzhou.aliyuncs.com/oauth2/OAuth2%E6%95%B4%E5%90%88%E7%BD%91%E5%85%B3%E6%9E%B6%E6%9E%84.png">
<meta property="og:image" content="https://oauth2images.oss-cn-guangzhou.aliyuncs.com/oauth2/%E7%BD%91%E5%85%B3%E6%A1%88%E4%BE%8B%E7%9B%AE%E5%BD%95.png">
<meta property="og:image" content="https://oauth2images.oss-cn-guangzhou.aliyuncs.com/oauth2/%E7%BD%91%E5%85%B3-%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA.png">
<meta property="og:image" content="https://oauth2images.oss-cn-guangzhou.aliyuncs.com/oauth2/%E7%BD%91%E5%85%B3%E7%9A%84%E6%9E%B6%E6%9E%84.png">
<meta property="og:image" content="https://oauth2images.oss-cn-guangzhou.aliyuncs.com/oauth2/additionalInformation.png">
<meta property="og:image" content="https://oauth2images.oss-cn-guangzhou.aliyuncs.com/oauth2/%E5%AF%86%E9%92%A5%E5%BA%93jks%E6%96%87%E4%BB%B6.png">
<meta property="og:image" content="https://oauth2images.oss-cn-guangzhou.aliyuncs.com/oauth2/%E5%85%AC%E9%92%A5%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95.png">
<meta property="og:updated_time" content="2022-08-22T12:18:59.181Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="网关集成OAuth2">
<meta name="twitter:description" content="网关集成OAuth2案例架构    大致分为四个角色，如下：  客户端：需要访问微服务资源 网关：负责转发、校验token、鉴权 OAuth2.0认证授权服务：负责认证、授权、颁发令牌 微服务集合：提供资源的一系列服务。  大致流程如下： 1、客户端发出请求给网关获取令牌 2、网关收到请求，直接转发给认证服务 3、认证服务验证用户名、密码等一系列身份，通过则颁发令牌给客户端 4、客户端携带令牌请求">
<meta name="twitter:image" content="https://oauth2images.oss-cn-guangzhou.aliyuncs.com/oauth2/OAuth2%E6%95%B4%E5%90%88%E7%BD%91%E5%85%B3%E6%9E%B6%E6%9E%84.png">

  <meta name="format-detection" content="telephone=no,email=no">
  <meta name="theme-color" content="#9C27B0">
  <meta name="description" content>
  <meta name="keywords" content=",redis">

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="bp的Blog">
  <meta name="msapplication-starturl" content="https://yellowbp.github.io/2022/07/07/网关集成OAuth2/">
  <meta name="msapplication-navbutton-color" content="#9C27B0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="bp的Blog">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/images/favicon.png">

  
    <meta property="article:published_time" content="Thu Jul 07 2022 10:11:13 GMT+0800">
    <meta property="article:modified_time" content="Mon Aug 22 2022 20:18:59 GMT+0800">
  

  
    <link rel="canonical" href="https://yellowbp.github.io/2022/07/07/网关集成OAuth2/">
  

  <meta name="google-site-verification" content="fXjtlIfaDc_X-0P11rO3bEp1Nk4IKXphoJv0GqGZCco">
  <meta name="baidu-site-verification" content="I3t1wfwZvd">

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create','UA-139531378-1','auto');ga('send','pageview');
</script>
  <script>
  var _hmt = _hmt || [];
  (function() {var hm = document.createElement('script');
  hm.src = 'https://hm.baidu.com/hm.js?1054d51c0b66f1d168829173682c8159';
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script>
  

  <link rel="stylesheet" href="/css/mdui.css">
<link rel="stylesheet" href="/css/style.css">
</head>
<body class="mdui-appbar-with-toolbar mdui-drawer-body-left mdui-theme-primary-brown mdui-theme-accent-blue">
  <script>var a=localStorage.getItem("mdui-theme-layout-dark");if(a){document.getElementsByTagName("body")[0].className+=" mdui-theme-layout-dark"};</script>
  <header id="header" class="mdui-appbar mdui-appbar-fixed mdui-appbar-scroll-hide mdui-appbar-inset">
  <div class="mdui-toolbar mdui-color-theme">
    <a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-drawer="{target: '#sidebar', swipe: true}"><i class="mdui-icon material-icons">menu</i></a>
    <a href="/" class="mdui-typo-headline">bp的Blog</a>
    <div class="mdui-toolbar-spacer"></div>
    <a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-dialog="{target: '#search'}" mdui-tooltip="{content: '搜索'}"><i class="mdui-icon material-icons">search</i></a>
    
  </div>
</header>
<div class="mdui-dialog" id="search">
  
    <div class="search-form">
      <input type="search" class="search-form-input" placeholder="请输入关键字">
    </div>
    <div class="search-result" data-resource="/search.xml"></div>
  
</div>
  <aside id="sidebar" class="mdui-drawer mdui-drawer-full-height">
  <div class="mdui-grid-tile">
    <img src="/images/Gradient1.jpg" style="height: 160px;">
    <img src="/images/headPic.jpg" class="avatar-animation" style="position: absolute; top: 10%; left: 24px; width: 64px; height: 64px; border: 2px solid #fff; border-radius: 50%;">
    <div class="mdui-grid-tile-actions">
      <div class="mdui-grid-tile-text">
        <div class="mdui-grid-tile-title">hbp
        </div>
        <div class="mdui-grid-tile-subtitle"><i class="mdui-icon material-icons">art_track</i>要想快，先会慢</div>
      </div>
      
        <div class="mdui-grid-tile-buttons">
          <a href="mailto:347070556@qq.com" class="mdui-btn mdui-btn-icon" mdui-tooltip="{content: '347070556@qq.com'}"><i class="mdui-icon material-icons">email</i></a>
        </div>
      
    </div>
  </div>

  <div class="mdui-list" mdui-collapse="{accordion: true}">
    <a href="/" class="mdui-list-item mdui-ripple">
      <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-blue">home</i>
      <div class="mdui-list-item-content">主页</div>
    </a>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-deep-orange">inbox</i>
        <div class="mdui-list-item-content">归档</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/archives/2022/08/">八月 2022<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2022/07/">七月 2022<span class="mdui-ripple sidebar_archives-count">10</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2022/05/">五月 2022<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2022/04/">四月 2022<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2022/03/">三月 2022<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2022/02/">二月 2022<span class="mdui-ripple sidebar_archives-count">13</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/10/">十月 2021<span class="mdui-ripple sidebar_archives-count">9</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/09/">九月 2021<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/08/">八月 2021<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/07/">七月 2021<span class="mdui-ripple sidebar_archives-count">10</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/06/">六月 2021<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/05/">五月 2021<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/04/">四月 2021<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/03/">三月 2021<span class="mdui-ripple sidebar_archives-count">12</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/02/">二月 2021<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/01/">一月 2021<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2020/03/">三月 2020<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/12/">十二月 2019<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/11/">十一月 2019<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/10/">十月 2019<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/09/">九月 2019<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/08/">八月 2019<span class="mdui-ripple sidebar_archives-count">5</span></a>
        
      </div>
    </div>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-green">chrome_reader_mode</i>
        <div class="mdui-list-item-content">分类</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/categories/ElasticSearch/">ElasticSearch<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/OAuth2/">OAuth2<span class="mdui-ripple sidebar_archives-count">8</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/Redis/">Redis<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/Spring/">Spring<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/SpringBoot/">SpringBoot<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/SpringCloud-Alibaba/">SpringCloud Alibaba<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/SpringMVC/">SpringMVC<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/docker/">docker<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/excel/">excel<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/git/">git<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/java8/">java8<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/java基础/">java基础<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/jenkins/">jenkins<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/jenkins/docker/">docker<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/jwt/">jwt<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/k8s/">k8s<span class="mdui-ripple sidebar_archives-count">10</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/linux/">linux<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/maven/">maven<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/mq/">mq<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/mybatis/">mybatis<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/mysql/">mysql<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/nginx/">nginx<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/redis/">redis<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/servlet/">servlet<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/spring/">spring<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/ssm/">ssm<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/web开发基础/">web开发基础<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/yaml/">yaml<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/上传下载文件/">上传下载文件<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/乱码/">乱码<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/参数校验/">参数校验<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/发短信/">发短信<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/小程序/">小程序<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/工具类/">工具类<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/开发软件/">开发软件<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/技术/">技术<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/搭建博客/">搭建博客<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/电脑硬件/">电脑硬件<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/算法/">算法<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/缓存/">缓存<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/规范/">规范<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/认证授权/">认证授权<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/设计模式/">设计模式<span class="mdui-ripple sidebar_archives-count">6</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/部署/">部署<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/重装/">重装<span class="mdui-ripple sidebar_archives-count">1</span></a>
        
      </div>
    </div>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-brown">bookmark</i>
        <div class="mdui-list-item-content">标签</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/tags/Spring/">Spring<span class="mdui-ripple sidebar_archives-count">22</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/algorithm/">algorithm<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/excel/">excel<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/git/">git<span class="mdui-ripple sidebar_archives-count">13</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/hexo/">hexo<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/javaWeb/">javaWeb<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/java基础/">java基础<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/jwt/">jwt<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/linux/">linux<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/mq/">mq<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/mysql/">mysql<span class="mdui-ripple sidebar_archives-count">6</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/nginx/">nginx<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/redis/">redis<span class="mdui-ripple sidebar_archives-count">9</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/servlet/">servlet<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/spring/">spring<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/web开发基础/">web开发基础<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/win7/">win7<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/其他/">其他<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/分布式/">分布式<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/接口文档/">接口文档<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/笔记本选购/">笔记本选购<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/自动化构建工具/">自动化构建工具<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/设计模式/">设计模式<span class="mdui-ripple sidebar_archives-count">6</span></a>
        
      </div>
    </div>
    <a href="/about" class="mdui-list-item mdui-ripple">
      <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-purple">person</i>
      <div class="mdui-list-item-content">关于</div>
    </a>
  </div>

  <div class="mdui-divider"></div>

  <div class="mdui-list" mdui-collapse="{accordion: true}">
    
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <div class="mdui-list-item-content">友情链接</div>
        <i class="mdui-list-item-icon mdui-icon material-icons">link</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        
          <a href="javascript:;" class="mdui-list-item mdui-ripple mdui-p-l-2 mdui-text-color-theme" style="justify-content: center;">链接为空</a>
        
      </div>
    </div>
  </div>
</aside>
  <main id="main" class="mdui-m-t-5 fadeIn animated">
  <link rel="stylesheet" href="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.css">
  <style>#main article .mdui-card-content .center-block{display:block!important;margin-right:auto!important;margin-left:auto!important}</style>
  <article class="mdui-card mdui-m-b-5">
    <header class="mdui-card-media">
      <img src="/images/random/material-18.png" style="max-height: 240px;">
      <div class="mdui-card-media-covered">
        <div class="mdui-card-primary">
          <div class="mdui-card-primary-title">网关集成OAuth2</div>
          <div class="mdui-card-primary-subtitle"><i class="iconfont">&#xe697;</i> 2022-07-07 / 
          <i class="iconfont">&#xe601;</i> hbp
          <span id="busuanzi_container_page_pv">
            本文总阅读量<span id="busuanzi_value_page_pv"></span>次
          </span>
          </div>
        </div>
      </div>
      <div class="mdui-card-menu">
        
        
      </div>
    </header>
    <div class="mdui-card-content mdui-typo">
      <h1 id="网关集成OAuth2"><a href="#网关集成OAuth2" class="headerlink" title="网关集成OAuth2"></a>网关集成OAuth2</h1><h2 id="案例架构"><a href="#案例架构" class="headerlink" title="案例架构"></a>案例架构</h2><img src="https://oauth2images.oss-cn-guangzhou.aliyuncs.com/oauth2/OAuth2%E6%95%B4%E5%90%88%E7%BD%91%E5%85%B3%E6%9E%B6%E6%9E%84.png" alt="OAuth2整合网关架构" style="zoom:80%;">



<p><strong>大致分为四个角色，如下</strong>：</p>
<ul>
<li><strong>客户端</strong>：需要访问微服务资源</li>
<li><strong>网关</strong>：负责转发、校验token、鉴权</li>
<li><strong>OAuth2.0认证授权服务</strong>：负责认证、授权、颁发令牌</li>
<li><strong>微服务集合</strong>：提供资源的一系列服务。</li>
</ul>
<p><strong>大致流程如下</strong>：</p>
<p>1、客户端发出请求给网关获取令牌</p>
<p>2、网关收到请求，直接转发给认证服务</p>
<p>3、认证服务验证用户名、密码等一系列身份，通过则颁发令牌给客户端</p>
<p>4、客户端携带令牌请求资源，请求直接到了网关层</p>
<p>5、网关对令牌进行校验（<strong>验签</strong>、<strong>过期时间校验</strong>….）、鉴权（对当前令牌携带的权限）和访问资源所需的权限进行比对，如果权限有交集则通过校验，直接转发给微服务</p>
<p>6、微服务进行逻辑处理</p>
<p>目录如下：</p>
<img src="https://oauth2images.oss-cn-guangzhou.aliyuncs.com/oauth2/%E7%BD%91%E5%85%B3%E6%A1%88%E4%BE%8B%E7%9B%AE%E5%BD%95.png" alt="网关案例目录" style="zoom:80%;">

<h2 id="认证授权服务搭建"><a href="#认证授权服务搭建" class="headerlink" title="认证授权服务搭建"></a>认证授权服务搭建</h2><p>这里将认证授权服务抽离出来。认证服务的搭建这里就不再细说了，与上篇大同小异</p>
<img src="https://oauth2images.oss-cn-guangzhou.aliyuncs.com/oauth2/%E7%BD%91%E5%85%B3-%E8%AE%A4%E8%AF%81%E6%9C%8D%E5%8A%A1%E6%90%AD%E5%BB%BA.png" alt="网关-认证服务搭建" style="zoom:67%;">

<h3 id="认证服务配置类"><a href="#认证服务配置类" class="headerlink" title="认证服务配置类"></a>认证服务配置类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * OAuth2认证授权配置类</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * 总结下来就是两个关键点，客户端信息配置和access_token生成配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableAuthorizationServer</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthenticationServerConfig</span> <span class="keyword">extends</span> <span class="title">AuthorizationServerConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 客户端存储策略</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ClientDetailsService clientDetailsService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> DataSource dataSource;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TokenStore tokenStore;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AuthenticationManager authenticationManager;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JwtAccessTokenConverter jwtAccessTokenConverter;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> OAuthServerAuthenticationEntryPoint authenticationEntryPoint;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取OAuth2客户端配置好的信息(client_id、client_secret)</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clients</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(ClientDetailsServiceConfigurer clients)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 使用JdbcClientDetailsService，从数据库中加载客户端的信息(里面已经包含有对应的sql语句，表机构由官方提供)</span></span><br><span class="line">        <span class="comment">// 这里的client_secret默认使用注入进来的 BCryptPasswordEncoder 进行加解密</span></span><br><span class="line">        clients.withClientDetails(<span class="keyword">new</span> JdbcClientDetailsService(dataSource));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置授权（authorization）以及令牌（token）的访问端点和令牌服务(token services)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> endpoints</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerEndpointsConfigurer endpoints)</span> </span>&#123;</span><br><span class="line">        endpoints</span><br><span class="line">                <span class="comment">// 密码模式所需要的 authenticationManager</span></span><br><span class="line">                .authenticationManager(authenticationManager)</span><br><span class="line">                <span class="comment">// 令牌管理服务，无论哪种模式都需要，我这里单独写了一个方法出来</span></span><br><span class="line">                .tokenServices(tokenServices())</span><br><span class="line">                <span class="comment">// 访问令牌接口：/oauth/token 时，只允许POST提交</span></span><br><span class="line">                .allowedTokenEndpointRequestMethods(HttpMethod.POST);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 令牌管理服务，用来创建、获取、刷新令牌，并可以对令牌进行相对应的配置</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthorizationServerTokenServices <span class="title">tokenServices</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DefaultTokenServices defaultTokenServices = <span class="keyword">new</span> DefaultTokenServices();</span><br><span class="line">        <span class="comment">// 客户端配置策略</span></span><br><span class="line">        defaultTokenServices.setClientDetailsService(clientDetailsService);</span><br><span class="line">        <span class="comment">// 支持令牌刷新</span></span><br><span class="line">        defaultTokenServices.setSupportRefreshToken(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// 设置令牌存储</span></span><br><span class="line">        defaultTokenServices.setTokenStore(tokenStore);</span><br><span class="line">        <span class="comment">// access_token的过期时间</span></span><br><span class="line">        defaultTokenServices.setAccessTokenValiditySeconds(<span class="number">60</span> * <span class="number">60</span>);</span><br><span class="line">        <span class="comment">// refresh_token的过期时间</span></span><br><span class="line">        defaultTokenServices.setRefreshTokenValiditySeconds(<span class="number">60</span> * <span class="number">60</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置令牌增强，使用 JwtAccessTokenConverter 进行token转jwt，否则access_token 跟 refresh_token 的值都是uuid</span></span><br><span class="line">        defaultTokenServices.setTokenEnhancer(jwtAccessTokenConverter);</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         *  refresh_token有两种使用方式：重复使用(true)、非重复使用(false)，默认为true</span></span><br><span class="line"><span class="comment">         *  1 重复使用：access_token过期刷新时， refresh_token过期时间未改变，仍以初次生成的时间为准</span></span><br><span class="line"><span class="comment">         *  2 非重复使用：access_token过期刷新时， refresh_token过期时间延续，在refresh_token有效期内刷新便永不失效达到无需再次登录的目的</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        defaultTokenServices.setReuseRefreshToken(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">return</span> defaultTokenServices;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置令牌访问的安全约束，比如对 /oauth/token 那些开放</span></span><br><span class="line"><span class="comment">     * 在securityConfig配置放行这些令牌接口是不行的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthorizationServerSecurityConfigurer security)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 自定义 ClientCredentialsTokenEndpointFilter过滤器，用于处理客户端id，密码错误的异常</span></span><br><span class="line">        OAuthServerClientCredentialsTokenEndpointFilter endpointFilter = <span class="keyword">new</span> OAuthServerClientCredentialsTokenEndpointFilter(security, authenticationEntryPoint);</span><br><span class="line">        endpointFilter.afterPropertiesSet();</span><br><span class="line">        security.addTokenEndpointAuthenticationFilter(endpointFilter);</span><br><span class="line">        security</span><br><span class="line">                <span class="comment">// 放行 /oauth/token_key 验证端口权限访问</span></span><br><span class="line">                .tokenKeyAccess(<span class="string">"permitAll()"</span>)</span><br><span class="line">                <span class="comment">// 放行 /oauth/check_token 验证端口认证权限访问</span></span><br><span class="line">                .checkTokenAccess(<span class="string">"permitAll()"</span>);</span><br><span class="line">                <span class="comment">// 表示支持 client_id 和 client_secret 做登录认证</span></span><br><span class="line">                <span class="comment">// 一定不要添加allowFormAuthenticationForClients，否则自定义的OAuthServerClientCredentialsTokenEndpointFilter不生效</span></span><br><span class="line">                <span class="comment">// .allowFormAuthenticationForClients();</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="客户端信息配置"><a href="#客户端信息配置" class="headerlink" title="客户端信息配置"></a>客户端信息配置</h3><p>客户端信息也放在了数据库中，前面的文章都是放在内存中</p>
<p>Spring Security OAuth2官方提供的客户端信息表 oauth_client_details 结构：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`oauth_client_details`</span> (</span><br><span class="line">  <span class="string">`client_id`</span> <span class="built_in">varchar</span>(<span class="number">48</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'客户端id'</span>,</span><br><span class="line">  <span class="string">`resource_ids`</span> <span class="built_in">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'资源的id，多个用逗号分隔'</span>,</span><br><span class="line">  <span class="string">`client_secret`</span> <span class="built_in">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'客户端的秘钥'</span>,</span><br><span class="line">  <span class="string">`scope`</span> <span class="built_in">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'客户端的权限，多个用逗号分隔'</span>,</span><br><span class="line">  <span class="string">`authorized_grant_types`</span> <span class="built_in">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'授权类型，五种，多个用逗号分隔'</span>,</span><br><span class="line">  <span class="string">`web_server_redirect_uri`</span> <span class="built_in">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'授权码模式的跳转uri'</span>,</span><br><span class="line">  <span class="string">`authorities`</span> <span class="built_in">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'权限，多个用逗号分隔'</span>,</span><br><span class="line">  <span class="string">`access_token_validity`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'access_token的过期时间，单位毫秒，覆盖掉硬编码'</span>,</span><br><span class="line">  <span class="string">`refresh_token_validity`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'refresh_token的过期时间，单位毫秒，覆盖掉硬编码'</span>,</span><br><span class="line">  <span class="string">`additional_information`</span> <span class="built_in">varchar</span>(<span class="number">4096</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'扩展字段，JSON'</span>,</span><br><span class="line">  <span class="string">`autoapprove`</span> <span class="built_in">varchar</span>(<span class="number">256</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'默认false，是否自动授权'</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`client_id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>

<p>添加一条客户端信息：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`oauth`</span>.<span class="string">`oauth_client_details`</span>(<span class="string">`client_id`</span>, <span class="string">`resource_ids`</span>, <span class="string">`client_secret`</span>, <span class="string">`scope`</span>, <span class="string">`authorized_grant_types`</span>, <span class="string">`web_server_redirect_uri`</span>, <span class="string">`authorities`</span>, <span class="string">`access_token_validity`</span>, <span class="string">`refresh_token_validity`</span>, <span class="string">`additional_information`</span>, <span class="string">`autoapprove`</span>) <span class="keyword">VALUES</span> (<span class="string">'customClientId'</span>, <span class="string">'res1'</span>, <span class="string">'$2a$10$HWuOIx8C.YvlhLwp2j5LYe/r8B04xtcFmuu6t1XEBrnr2JLGFcc0q'</span>, <span class="string">'all'</span>, <span class="string">'authorization_code,client_credentials,implicit,password,refresh_token,captcha'</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>);</span><br></pre></td></tr></table></figure>

<p>把客户端信息存储在数据库中，那么可以添加一个管理界面来维护这些客户端信息，这样便可灵活配置客户端接入认证平台、认证有效期</p>
<h3 id="Security安全配置类"><a href="#Security安全配置类" class="headerlink" title="Security安全配置类"></a>Security安全配置类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * security安全配置类</span></span><br><span class="line"><span class="comment"> * 主要是配置请求访问权限、定义认证管理器、密码加密配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置安全拦截策略</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> httpSecurity</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity httpSecurity)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ExpressionUrlAuthorizationConfigurer&lt;HttpSecurity&gt;.ExpressionInterceptUrlRegistry http = httpSecurity.authorizeRequests();</span><br><span class="line">        <span class="comment">// 放行的接口</span></span><br><span class="line">        <span class="keyword">for</span> (String url : ignoreUrlConfig().getUrls()) &#123;</span><br><span class="line">            http.antMatchers(url).permitAll();</span><br><span class="line">        &#125;</span><br><span class="line">        http.and()</span><br><span class="line">                .csrf().disable()</span><br><span class="line">                .authorizeRequests().anyRequest().authenticated();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加密算法：采用官方推荐的强散列BCryptPasswordEncoder加密</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 放行的接口集合</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IgnoreUrlConfig <span class="title">ignoreUrlConfig</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> IgnoreUrlConfig();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注入认证管理器(OAuth2的密码模式需要，若不使用密码模式，可不用注入)</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationManager <span class="title">authenticationManager</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.authenticationManager();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="网关服务搭建"><a href="#网关服务搭建" class="headerlink" title="网关服务搭建"></a>网关服务搭建</h2><p>网关使用的是<strong>Spring Cloud Gateway</strong></p>
<h3 id="案列架构"><a href="#案列架构" class="headerlink" title="案列架构"></a>案列架构</h3><img src="https://oauth2images.oss-cn-guangzhou.aliyuncs.com/oauth2/%E7%BD%91%E5%85%B3%E7%9A%84%E6%9E%B6%E6%9E%84.png" alt="网关的架构" style="zoom:67%;">

<h3 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h3><p>需要添加几个OAuth2.0相关的依赖</p>
<p>【<strong>注意</strong>】：不要加 spring-boot-starter-web 依赖，会与 spring-cloud-starter-gateway 依赖冲突</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.security<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-security-oauth2-resource-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-oauth2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="JWT令牌服务配置"><a href="#JWT令牌服务配置" class="headerlink" title="JWT令牌服务配置"></a>JWT令牌服务配置</h3><p>使用JWT令牌，配置要和认证服务的令牌配置相同</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 令牌配置</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccessTokenConfig</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 令牌存储策略</span></span><br><span class="line"><span class="comment">     * 这里使用的是JwtTokenStore，使用JWT的令牌生成方式，其实还有以下两个比较常用的方式：</span></span><br><span class="line"><span class="comment">     * - RedisTokenStore：将令牌存储到Redis中，此种方式相对于内存方式来说性能更好</span></span><br><span class="line"><span class="comment">     * - JdbcTokenStore：将令牌存储到数据库中，需要新建从对应的表，有兴趣的可以尝试(一般较少用到)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> TokenStore <span class="title">tokenStore</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">//使用JwtTokenStore生成JWT令牌</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> JwtTokenStore(jwtAccessTokenConverter());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * JwtAccessTokenConverter 生成token的令牌转换器，可以实现指定token的生成方式(JWT)和对JWT进行签名</span></span><br><span class="line"><span class="comment">     * 在JWT编码的令牌值和OAuth身份验证信息之间进行转换(JWT保存着用户的身份信息)</span></span><br><span class="line"><span class="comment">     * 这里暂时使用对称加密 (同时资源服务器中使用的也是同样的秘钥配置jwt转换器),实际工作中还是要使用非对称加密的方式，更加安全</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> JwtAccessTokenConverter <span class="title">jwtAccessTokenConverter</span><span class="params">()</span></span>&#123;</span><br><span class="line">        JwtAccessTokenConverter converter = <span class="keyword">new</span> JwtAccessTokenConverter();</span><br><span class="line">        <span class="comment">// 设置秘钥</span></span><br><span class="line">        converter.setSigningKey(TokenConstant.SIGN_KEY);</span><br><span class="line">        <span class="keyword">return</span> converter;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="认证管理器自定义"><a href="#认证管理器自定义" class="headerlink" title="认证管理器自定义"></a>认证管理器自定义</h3><p>新建一个<strong>JwtAuthenticationManager</strong>，需要实现<strong>ReactiveAuthenticationManager</strong>这个接口。</p>
<p>认证管理的作用就是获取传递过来的令牌，对其进行<strong>解析</strong>、<strong>验签</strong>、<strong>过期时间</strong>判定。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * JWT认证管理器，主要的作用就是对携带过来的token进行校验，比如过期时间，加密方式</span></span><br><span class="line"><span class="comment"> * 一旦token校验通过，则交给鉴权管理器进行鉴权</span></span><br><span class="line"><span class="comment"> * 抛出的异常交给 Gateway 的全局异常进行捕获处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtAuthenticationManager</span> <span class="keyword">implements</span> <span class="title">ReactiveAuthenticationManager</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用JWT令牌进行解析令牌</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenStore tokenStore;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Authentication&gt; <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Mono.justOrEmpty(authentication)</span><br><span class="line">                .filter(a -&gt; a <span class="keyword">instanceof</span> BearerTokenAuthenticationToken)</span><br><span class="line">                .cast(BearerTokenAuthenticationToken<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line">                .map(BearerTokenAuthenticationToken::getToken)</span><br><span class="line">                .flatMap((accessToken -&gt; &#123;</span><br><span class="line">                    <span class="comment">// 解析令牌</span></span><br><span class="line">                    OAuth2AccessToken oAuth2AccessToken = tokenStore.readAccessToken(accessToken);</span><br><span class="line">                    <span class="comment">// 根据access_token从数据库获取不到OAuth2AccessToken</span></span><br><span class="line">                    <span class="keyword">if</span> (oAuth2AccessToken == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> Mono.error(<span class="keyword">new</span> InvalidTokenException(<span class="string">"无效的token！"</span>));</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (oAuth2AccessToken.isExpired()) &#123;</span><br><span class="line">                        <span class="keyword">return</span> Mono.error(<span class="keyword">new</span> InvalidTokenException(<span class="string">"token已过期！"</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                    OAuth2Authentication oAuth2Authentication = tokenStore.readAuthentication(accessToken);</span><br><span class="line">                    <span class="keyword">if</span> (oAuth2Authentication == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> Mono.error(<span class="keyword">new</span> InvalidTokenException(<span class="string">"无效的token！"</span>));</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> Mono.just(oAuth2Authentication);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)).cast(Authentication<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>逻辑很简单，就是通过JWT令牌服务解析客户端传递的令牌，并对其进行校验，比如上传三处校验失败，抛出令牌无效的异常。</p>
<p><strong>抛出的异常如何处理？如何定制返回的结果？</strong></p>
<p>这里抛出的异常可以通过<strong>Spring Cloud Gateway</strong>的全局异常进行捕获</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用于网关的全局异常管理</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Order</span>(-1)：优先级一定要比ResponseStatusExceptionHandler低</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Order</span>(-<span class="number">1</span>)</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalErrorExceptionHandler</span> <span class="keyword">implements</span> <span class="title">ErrorWebExceptionHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(ServerWebExchange exchange, Throwable ex)</span> </span>&#123;</span><br><span class="line">        ServerHttpResponse response = exchange.getResponse();</span><br><span class="line">        <span class="keyword">if</span> (response.isCommitted()) &#123;</span><br><span class="line">            <span class="keyword">return</span> Mono.error(ex);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ApiResult apiResult = <span class="keyword">new</span> ApiResult(GlobalBusinessCodeEnum.UNAUTHORIZED.getCode(), GlobalBusinessCodeEnum.UNAUTHORIZED.getDesc());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// JOSN格式返回</span></span><br><span class="line">        response.getHeaders().setContentType(MediaType.APPLICATION_JSON);</span><br><span class="line">        <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> ResponseStatusException) &#123;</span><br><span class="line">            response.setStatusCode(((ResponseStatusException) ex).getStatus());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 处理TOKEN失效的异常</span></span><br><span class="line">        <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> InvalidTokenException) &#123;</span><br><span class="line">            apiResult = <span class="keyword">new</span> ApiResult(GlobalBusinessCodeEnum.TOKEN_INVALID.getCode(), GlobalBusinessCodeEnum.TOKEN_INVALID.getDesc());</span><br><span class="line">        &#125;</span><br><span class="line">        ApiResult finalResultMsg = apiResult;</span><br><span class="line">        <span class="keyword">return</span> response.writeWith(Mono.fromSupplier(() -&gt; &#123;</span><br><span class="line">            DataBufferFactory bufferFactory = response.bufferFactory();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">//todo 返回响应结果，根据业务需求，自己定制</span></span><br><span class="line">                <span class="keyword">return</span> bufferFactory.wrap(<span class="keyword">new</span> ObjectMapper().writeValueAsBytes(finalResultMsg));</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">"Error writing response"</span>, ex);</span><br><span class="line">                <span class="keyword">return</span> bufferFactory.wrap(<span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="鉴权管理器自定义"><a href="#鉴权管理器自定义" class="headerlink" title="鉴权管理器自定义"></a>鉴权管理器自定义</h3><p>经过认证管理器<strong>JwtAuthenticationManager</strong>认证成功后，就需要对令牌进行鉴权，如果该令牌无访问资源的权限，则不允通过。</p>
<p>新建<strong>JwtAccessManager</strong>，实现<strong>ReactiveAuthorizationManager</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 鉴权管理器，用于认证成功后(JwtAuthenticationManager)对用户的权限进行鉴权</span></span><br><span class="line"><span class="comment"> * <span class="doctag">TODO:</span>此处的逻辑：从redis中获取对应的uri的角色，与当前用户的token的携带的角色进行对比，如果包含则鉴权成功，如果没有权限，则交给RequestAccessDeniedHandler权限处理器</span></span><br><span class="line"><span class="comment"> * 企业中可能有不同的处理逻辑，可以根据业务需求更改鉴权的逻辑</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtAccessManager</span> <span class="keyword">implements</span> <span class="title">ReactiveAuthorizationManager</span>&lt;<span class="title">AuthorizationContext</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisUtils redisUtils;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;AuthorizationDecision&gt; <span class="title">check</span><span class="params">(Mono&lt;Authentication&gt; mono, AuthorizationContext authorizationContext)</span> </span>&#123;</span><br><span class="line">        ServerHttpRequest request = authorizationContext.getExchange().getRequest();</span><br><span class="line">        String methodType = request.getMethodValue();</span><br><span class="line">        String path = request.getURI().getPath();</span><br><span class="line">        <span class="comment">// 请求方法+uri 的组合可以确保api的唯一性</span></span><br><span class="line">        String api = methodType + <span class="string">":"</span> + path;</span><br><span class="line">        AntPathMatcher antPathMatcher = <span class="keyword">new</span> AntPathMatcher();</span><br><span class="line">        <span class="comment">// 1.从redis中获取全部资源-角色的关系列表</span></span><br><span class="line">        Map&lt;Object, Object&gt; allAuthorities = redisUtils.hashMapGet(SecurityConstants.OAUTH_URLS);</span><br><span class="line">        <span class="comment">// 拥有访问URL的角色</span></span><br><span class="line">        List&lt;String&gt; authorizedRoles = <span class="keyword">new</span> ArrayList&lt;&gt;(); </span><br><span class="line">        <span class="comment">// 从redis中匹配当前路径可访问的角色列表</span></span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;Object, Object&gt; entry : allAuthorities.entrySet()) &#123;</span><br><span class="line">            String url = entry.getKey().toString();</span><br><span class="line">            <span class="keyword">if</span> (antPathMatcher.match(url, api)) &#123;</span><br><span class="line">                authorizedRoles.addAll(Convert.toList(String<span class="class">.<span class="keyword">class</span>, <span class="title">entry</span>.<span class="title">getValue</span>()))</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 判断JWT中携带的用户角色是否有权限访问</span></span><br><span class="line">        <span class="keyword">return</span> mono</span><br><span class="line">                <span class="comment">// 判断是否认证成功</span></span><br><span class="line">                .filter(Authentication::isAuthenticated)</span><br><span class="line">                <span class="comment">// 取出令牌中的权限集合</span></span><br><span class="line">                .flatMapIterable(Authentication::getAuthorities)</span><br><span class="line">                .map(GrantedAuthority::getAuthority)</span><br><span class="line">                <span class="comment">// 比较两者权限，有交集，则放行</span></span><br><span class="line">                .any(authority -&gt; &#123;</span><br><span class="line">                    <span class="comment">// authority 是请求用户的角色编码，authorities是请求资源所需要角色的集合</span></span><br><span class="line">                    log.info(<span class="string">"访问路径：&#123;&#125;"</span>, api);</span><br><span class="line">                    log.info(<span class="string">"用户角色信息：&#123;&#125;"</span>, authority);</span><br><span class="line">                    log.info(<span class="string">"资源需要权限authorities：&#123;&#125;"</span>, authorizedRoles);</span><br><span class="line">                    <span class="keyword">return</span> CollectionUtil.isNotEmpty(authorizedRoles) &amp;&amp; authorizedRoles.contains(authority);</span><br><span class="line">                &#125;)</span><br><span class="line">                .map(AuthorizationDecision::<span class="keyword">new</span>)</span><br><span class="line">                .defaultIfEmpty(<span class="keyword">new</span> AuthorizationDecision(<span class="keyword">false</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里的逻辑很简单，就是<strong>取出令牌中的角色权限和当前请求资源URI的角色权限对比</strong>，如果有交集则通过</p>
<p>1处的代码是直接从Redis中取出资源URI对应的角色集合，因此实际开发中需要维护<strong>资源URI和角色的对应关系</strong>；</p>
<p>那么这里就会有两个问题：</p>
<p>a. 资源权限是什么样的数据格式</p>
<p>b. 数据什么时候初始化到缓存中</p>
<p><strong>资源权限数据格式</strong></p>
<p>把 url 和 role_code 的映射关系缓存到redis，大致意思的意思可以理解拥有url访问权限的角色编码有哪些。</p>
<p><strong>初始化缓存时机</strong></p>
<p>SpringBoot提供两个接口CommandLineRunner和ApplicationRunner用于容器启动后执行一些业务逻辑，比如数据初始化和预加载、MQ监听启动等。两个接口执行时机无差,唯一区别在于接口的参数不同。</p>
<p>那么这里的业务逻辑是在容器初始化完成之后将从MySQL读取到资源权限数据加载到Redis缓存中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 容器启动完成时加载角色权限规则至Redis缓存</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InitResourceRolesCache</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> IResourceService resourceService;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"InitResourceRolesCache run...."</span>);</span><br><span class="line">        resourceService.refreshUrlRoleRule();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">ResourceMapper</span>, <span class="title">ResourceDO</span>&gt; <span class="keyword">implements</span> <span class="title">IResourceService</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedisUtils redisUtils;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ResourceInfo&gt; <span class="title">listResourceRole</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> baseMapper.listResourceRole();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">refreshUrlRoleRule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        redisUtils.delete(PermissionConstant.URL_ROLE_KEY);</span><br><span class="line">        List&lt;ResourceInfo&gt; resourceInfos = listResourceRole();</span><br><span class="line">        <span class="keyword">if</span> (CollectionUtils.isNotEmpty(resourceInfos)) &#123;</span><br><span class="line">            <span class="comment">// 初始化URL【URL-&gt;角色(集合)】规则</span></span><br><span class="line">            List&lt;ResourceInfo&gt; uriList = resourceInfos.stream().filter(item -&gt; StringUtils.isNotBlank(item.getUri())).collect(Collectors.toList());</span><br><span class="line">            <span class="keyword">if</span> (CollectionUtils.isNotEmpty(uriList)) &#123;</span><br><span class="line">                Map&lt;String, List&lt;String&gt;&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">                uriList.forEach(item -&gt; &#123;</span><br><span class="line">                    String uri = item.getUri();</span><br><span class="line">                    String methodType = item.getMethodType();</span><br><span class="line">                    String api = methodType + <span class="string">":"</span> + uri;</span><br><span class="line">                    map.put(api, item.getRoles());</span><br><span class="line">                &#125;);</span><br><span class="line">                redisUtils.hashMapSet(PermissionConstant.URL_ROLE_KEY, map);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="令牌无效或过期时自定义返回结果"><a href="#令牌无效或过期时自定义返回结果" class="headerlink" title="令牌无效或过期时自定义返回结果"></a>令牌无效或过期时自定义返回结果</h3><p>在鉴权管理器中，如果令牌失效或者过期，则会<strong>直接</strong>返回，因此这里需要定制提示信息</p>
<p>新建一个<strong>RequestAuthenticationEntryPoint</strong>，实现<strong>ServerAuthenticationEntryPoint</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 用于处理没有登录或token过期时的自定义返回结果</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestAuthenticationEntryPoint</span> <span class="keyword">implements</span> <span class="title">ServerAuthenticationEntryPoint</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">commence</span><span class="params">(ServerWebExchange exchange, AuthenticationException e)</span> </span>&#123;</span><br><span class="line">        ServerHttpResponse response = exchange.getResponse();</span><br><span class="line">        response.setStatusCode(HttpStatus.OK);</span><br><span class="line">        response.getHeaders().add(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE);</span><br><span class="line">        String body = JSONUtil.toJsonStr(<span class="keyword">new</span> ApiResult&lt;&gt;(GlobalBusinessCodeEnum.TOKEN_INVALID.getCode(), GlobalBusinessCodeEnum.TOKEN_INVALID.getDesc()));</span><br><span class="line">        DataBuffer buffer = response.bufferFactory().wrap(body.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        <span class="keyword">return</span> response.writeWith(Mono.just(buffer));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="无权限时自定义返回结果"><a href="#无权限时自定义返回结果" class="headerlink" title="无权限时自定义返回结果"></a>无权限时自定义返回结果</h3><p>在第4步鉴权的过程中，如果无该权限，也是会直接返回，这里也需要定制提示信息</p>
<p>新建一个<strong>RequestAccessDeniedHandler</strong>，实现<strong>ServerAccessDeniedHandler</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 自定义返回结果：没有权限访问时</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestAccessDeniedHandler</span> <span class="keyword">implements</span> <span class="title">ServerAccessDeniedHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">handle</span><span class="params">(ServerWebExchange exchange, AccessDeniedException denied)</span> </span>&#123;</span><br><span class="line">        ServerHttpResponse response = exchange.getResponse();</span><br><span class="line">        response.setStatusCode(HttpStatus.OK);</span><br><span class="line">        response.getHeaders().add(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_JSON_VALUE);</span><br><span class="line">        String body= JSONUtil.toJsonStr(<span class="keyword">new</span> ApiResult&lt;&gt;(GlobalBusinessCodeEnum.NO_PERMISSION.getCode(),GlobalBusinessCodeEnum.NO_PERMISSION.getDesc()));</span><br><span class="line">        DataBuffer buffer =  response.bufferFactory().wrap(body.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">        <span class="keyword">return</span> response.writeWith(Mono.just(buffer));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="OAuth2相关配置"><a href="#OAuth2相关配置" class="headerlink" title="OAuth2相关配置"></a>OAuth2相关配置</h3><p>经过上述6个步骤，相关组件已经准备就绪，现在直接配置到OAuth2.0中。</p>
<p>新建SecurityConfig这个配置类，标注注解 <strong>@EnableWebFluxSecurity</strong>，注意不是 <strong>@EnableWebSecurity</strong>，因为Spring Cloud Gateway是基于Flux实现的。详细代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 网关的OAuth2.0资源的配置类</span></span><br><span class="line"><span class="comment"> * 由于spring cloud gateway使用的Flux，因此需要使用<span class="doctag">@EnableWebFluxSecurity</span>注解开启，而不是平常的web应用了</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebFluxSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * JWT的鉴权管理器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtAccessManager accessManager;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * token过期的异常处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RequestAuthenticationEntryPoint requestAuthenticationEntryPoint;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 权限不足的异常处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RequestAccessDeniedHandler requestAccessDeniedHandler;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 系统参数配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysParameterConfig sysConfig;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * token校验管理器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ReactiveAuthenticationManager tokenAuthenticationManager;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 跨域过滤器</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CorsFilter corsFilter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function">SecurityWebFilterChain <span class="title">webFluxSecurityFilterChain</span><span class="params">(ServerHttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 认证过滤器，放入认证管理器tokenAuthenticationManager</span></span><br><span class="line">        AuthenticationWebFilter authenticationWebFilter = <span class="keyword">new</span> AuthenticationWebFilter(tokenAuthenticationManager);</span><br><span class="line">        authenticationWebFilter.setServerAuthenticationConverter(<span class="keyword">new</span> ServerBearerTokenAuthenticationConverter());</span><br><span class="line"></span><br><span class="line">        http</span><br><span class="line">                .httpBasic().disable()</span><br><span class="line">                .csrf().disable()</span><br><span class="line">                .authorizeExchange()</span><br><span class="line">                <span class="comment">// 白名单直接放行</span></span><br><span class="line">                .pathMatchers(ArrayUtil.toArray(sysConfig.getIgnoreUrls(), String<span class="class">.<span class="keyword">class</span>)).<span class="title">permitAll</span>()</span></span><br><span class="line"><span class="class">                // 其他的请求必须鉴权，使用鉴权管理器</span></span><br><span class="line"><span class="class">                .<span class="title">anyExchange</span>().<span class="title">access</span>(<span class="title">accessManager</span>)</span></span><br><span class="line"><span class="class">                // 鉴权的异常处理，权限不足，<span class="title">token</span>失效</span></span><br><span class="line"><span class="class">                .<span class="title">and</span>().<span class="title">exceptionHandling</span>()</span></span><br><span class="line"><span class="class">                .<span class="title">authenticationEntryPoint</span>(<span class="title">requestAuthenticationEntryPoint</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">accessDeniedHandler</span>(<span class="title">requestAccessDeniedHandler</span>)</span></span><br><span class="line"><span class="class">                .<span class="title">and</span>()</span></span><br><span class="line"><span class="class">                // 跨域过滤器</span></span><br><span class="line"><span class="class">                .<span class="title">addFilterAt</span>(<span class="title">corsFilter</span>, <span class="title">SecurityWebFiltersOrder</span>.<span class="title">CORS</span>)</span></span><br><span class="line"><span class="class">                // <span class="title">token</span>的认证过滤器，用于校验<span class="title">token</span>和认证</span></span><br><span class="line"><span class="class">                .<span class="title">addFilterAt</span>(<span class="title">authenticationWebFilter</span>, <span class="title">SecurityWebFiltersOrder</span>.<span class="title">AUTHENTICATION</span>)</span>;</span><br><span class="line">        <span class="keyword">return</span> http.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要配置的内容如下：</p>
<ul>
<li>认证过滤器，其中利用了认证管理器对令牌的校验</li>
<li>鉴权管理器、令牌失效异常处理、无权限访问异常处理</li>
<li>白名单配置</li>
<li>跨域过滤器的配置</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">feat: 添加 认证鉴权成功后的全局过滤器，便于下游微服务获取用户信息</span><br></pre></td></tr></table></figure>

<h3 id="全局过滤器定制"><a href="#全局过滤器定制" class="headerlink" title="全局过滤器定制"></a>全局过滤器定制</h3><p>试想一下：<strong>网关层面认证鉴权成功后，下游微服务如何获取到当前用户的详细信息？</strong></p>
<p>这里是将令牌携带的用户信息解析出来，封装成<strong>JSON</strong>数据，然后通过<strong>Base64</strong>加密，放入到请求头中，转发给下游微服务。</p>
<p>这样一来，下游微服务只需要解密请求头中的JSON数据，即可获取用户的详细信息。</p>
<p>因此需要在网关中定义一个全局过滤器，用来拦截请求，解析令牌，关键代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全局过滤器，对token的拦截，解析token放入header中，便于下游微服务获取用户信息</span></span><br><span class="line"><span class="comment"> * 分为如下几步：</span></span><br><span class="line"><span class="comment"> * 1、白名单直接放行</span></span><br><span class="line"><span class="comment"> * 2、校验token</span></span><br><span class="line"><span class="comment"> * 3、读取token中存放的用户信息</span></span><br><span class="line"><span class="comment"> * 4、重新封装用户信息，加密成功json数据放入请求头中传递给下游微服务</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GlobalAuthenticationFilter</span> <span class="keyword">implements</span> <span class="title">GlobalFilter</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * JWT令牌的服务</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenStore tokenStore;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 系统参数配置</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SysParameterConfig sysConfig;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Mono&lt;Void&gt; <span class="title">filter</span><span class="params">(ServerWebExchange exchange, GatewayFilterChain chain)</span> </span>&#123;</span><br><span class="line">        String requestUrl = exchange.getRequest().getPath().value();</span><br><span class="line">        <span class="comment">// 1.白名单放行，比如授权服务、静态资源.....</span></span><br><span class="line">        <span class="keyword">if</span> (checkUrls(sysConfig.getIgnoreUrls(), requestUrl)) &#123;</span><br><span class="line">            <span class="keyword">return</span> chain.filter(exchange);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2.检查token是否存在</span></span><br><span class="line">        String token = getToken(exchange);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(token)) &#123;</span><br><span class="line">            <span class="keyword">return</span> invalidTokenMono(exchange);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3 判断是否是有效的token</span></span><br><span class="line">        OAuth2AccessToken oAuth2AccessToken;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 解析token，使用tokenStore</span></span><br><span class="line">            oAuth2AccessToken = tokenStore.readAccessToken(token);</span><br><span class="line">            Map&lt;String, Object&gt; additionalInformation = oAuth2AccessToken.getAdditionalInformation();</span><br><span class="line">            <span class="comment">// 取出用户身份信息</span></span><br><span class="line">            String user_name = additionalInformation.get(<span class="string">"user_name"</span>).toString();</span><br><span class="line">            <span class="comment">// 获取用户权限</span></span><br><span class="line">            List&lt;String&gt; authorities = (List&lt;String&gt;) additionalInformation.get(<span class="string">"authorities"</span>);</span><br><span class="line">            JSONObject jsonObject = <span class="keyword">new</span> JSONObject();</span><br><span class="line">            jsonObject.put(TokenConstant.PRINCIPAL_NAME, user_name);</span><br><span class="line">            jsonObject.put(TokenConstant.AUTHORITIES_NAME, authorities);</span><br><span class="line">            <span class="comment">// 将解析后的token加密放入请求头中，方便下游微服务解析获取用户信息</span></span><br><span class="line">            String base64 = Base64.encode(jsonObject.toJSONString());</span><br><span class="line">            <span class="comment">// 放入请求头中</span></span><br><span class="line">            ServerHttpRequest tokenRequest = exchange.getRequest().mutate().header(TokenConstant.TOKEN_NAME, base64).build();</span><br><span class="line">            ServerWebExchange build = exchange.mutate().request(tokenRequest).build();</span><br><span class="line">            <span class="keyword">return</span> chain.filter(build);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InvalidTokenException e) &#123;</span><br><span class="line">            <span class="comment">// 解析token异常，直接返回token无效</span></span><br><span class="line">            <span class="keyword">return</span> invalidTokenMono(exchange);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getOrder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 对url进行校验匹配</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkUrls</span><span class="params">(List&lt;String&gt; urls, String path)</span> </span>&#123;</span><br><span class="line">        AntPathMatcher pathMatcher = <span class="keyword">new</span> AntPathMatcher();</span><br><span class="line">        <span class="keyword">for</span> (String url : urls) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pathMatcher.match(url, path)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从请求头中获取Token</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> String <span class="title">getToken</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line">        String tokenStr = exchange.getRequest().getHeaders().getFirst(<span class="string">"Authorization"</span>);</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(tokenStr)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        String token = tokenStr.split(<span class="string">" "</span>)[<span class="number">1</span>];</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isBlank(token)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 无效的token</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Mono&lt;Void&gt; <span class="title">invalidTokenMono</span><span class="params">(ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line">        ApiResult&lt;Object&gt; apiResult = <span class="keyword">new</span> ApiResult&lt;&gt;(GlobalBusinessCodeEnum.TOKEN_INVALID.getCode(), GlobalBusinessCodeEnum.TOKEN_INVALID.getDesc());</span><br><span class="line">        <span class="keyword">return</span> buildReturnMono(apiResult, exchange);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Mono&lt;Void&gt; <span class="title">buildReturnMono</span><span class="params">(ApiResult apiResult, ServerWebExchange exchange)</span> </span>&#123;</span><br><span class="line">        ServerHttpResponse response = exchange.getResponse();</span><br><span class="line">        <span class="keyword">byte</span>[] bits = JSON.toJSONString(apiResult).getBytes(StandardCharsets.UTF_8);</span><br><span class="line">        DataBuffer buffer = response.bufferFactory().wrap(bits);</span><br><span class="line">        response.setStatusCode(HttpStatus.UNAUTHORIZED);</span><br><span class="line">        response.getHeaders().add(<span class="string">"Content-Type"</span>, <span class="string">"application/json;charset:utf-8"</span>);</span><br><span class="line">        <span class="keyword">return</span> response.writeWith(Mono.just(buffer));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码逻辑如下：</p>
<ul>
<li>检查是否是白名单，白名单直接放行</li>
<li>检验令牌是否存在</li>
<li>解析令牌中的用户信息</li>
<li>封装用户信息到JSON数据中</li>
<li>加密JSON数据</li>
<li>将加密后的JSON数据放入到请求头中</li>
</ul>
<p>好了，经过上述8个步骤，完整的网关已经搭建成功了。</p>
<h3 id="测试微服务搭建"><a href="#测试微服务搭建" class="headerlink" title="测试微服务搭建"></a>测试微服务搭建</h3><p>由于在网关层面已经做了鉴权了（细化到每个URI），因此微服务就不用集成Spring Security单独做权限控制了。</p>
<p>因此这里的微服务也是相对比较简单了，只需要将网关层传递的加密用户信息解密出来，放入到Request中，这样微服务就能随时获取到用户的信息了。</p>
<p>在公共模块中新建一个过滤器<strong>AuthenticationFilter</strong>，用于解密网关传递的用户数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 微服务过滤器，解密网关传递的用户信息，将其放入request中，便于后期业务方法直接获取用户信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthenticationFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 具体方法主要分为两步</span></span><br><span class="line"><span class="comment">     * 1. 解密网关传递的信息</span></span><br><span class="line"><span class="comment">     * 2. 将解密之后的信息封装放入到request中</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 获取请求头中的加密的用户信息</span></span><br><span class="line">        String token = request.getHeader(TokenConstant.TOKEN_NAME);</span><br><span class="line">        <span class="keyword">if</span> (StrUtil.isNotBlank(token))&#123;</span><br><span class="line">            <span class="comment">// 解密</span></span><br><span class="line">            String json = Base64.decodeStr(token);</span><br><span class="line">            JSONObject jsonObject = JSON.parseObject(json);</span><br><span class="line">            <span class="comment">// 获取用户身份信息、权限信息</span></span><br><span class="line">            String principal = jsonObject.getString(TokenConstant.PRINCIPAL_NAME);</span><br><span class="line">            JSONArray tempJsonArray = jsonObject.getJSONArray(TokenConstant.AUTHORITIES_NAME);</span><br><span class="line">            <span class="comment">// 权限</span></span><br><span class="line">            String[] authorities =  tempJsonArray.toArray(<span class="keyword">new</span> String[<span class="number">0</span>]);</span><br><span class="line">            <span class="comment">// 放入LoginVal</span></span><br><span class="line">            LoginVal loginVal = <span class="keyword">new</span> LoginVal();</span><br><span class="line">            loginVal.setUsername(principal);</span><br><span class="line">            loginVal.setAuthorities(authorities);</span><br><span class="line">            <span class="comment">// 放入request的attribute中</span></span><br><span class="line">            request.setAttribute(RequestConstant.LOGIN_VAL_ATTRIBUTE,loginVal);</span><br><span class="line">        &#125;</span><br><span class="line">        filterChain.doFilter(request,response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在测试微服务中新建两个接口，返回当前登录的用户信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/login/info"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> LoginVal <span class="title">info</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> OauthUtils.getCurrentUser();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/login/admin"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> LoginVal <span class="title">admin</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> OauthUtils.getCurrentUser();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：以上两个接口所需要的权限已经放入到了Redis中，权限如下：</p>
<ul>
<li><strong>/order/login/info</strong>：ROLE_admin和ROLE_user都能访问</li>
<li><strong>/order/login/admin</strong>：ROLE_admin权限才能访问</li>
</ul>
<h3 id="为什么要将URI和权限放入Redis"><a href="#为什么要将URI和权限放入Redis" class="headerlink" title="为什么要将URI和权限放入Redis"></a>为什么要将URI和权限放入Redis</h3><p>在网关的<strong>鉴权管理器</strong>那里是直接从Redis中获取URI对应的权限，然后和令牌中的权限比较，为什么要这样做？</p>
<p>这也是目前企业中比较常用的一种方式，将鉴权完全放在了网关层面，也实现了<strong>动态权限</strong>校验。<strong>当然有些是直接将接口的权限控制在每个微服务中。</strong></p>
<blockquote>
<p>目前采用这种方案需要另外维护URI和权限的对应关系，当然这种难度很低，便于实现。</p>
</blockquote>
<p>只是一种方案，具体是否选用还要考虑到架构层面。</p>
<h3 id="测试即可"><a href="#测试即可" class="headerlink" title="测试即可"></a>测试即可</h3><h2 id="JWT增强"><a href="#JWT增强" class="headerlink" title="JWT增强"></a>JWT增强</h2><h3 id="网关层如何获取令牌中的信息？"><a href="#网关层如何获取令牌中的信息？" class="headerlink" title="网关层如何获取令牌中的信息？"></a>网关层如何获取令牌中的信息？</h3><p><strong>网关集成OAuth2.0</strong>中定义了一个全局过滤器<strong>GlobalAuthenticationFilter</strong>用来解析令牌并且封装用户信息传递给下游微服务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">OAuth2AccessToken oAuth2AccessToken;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 解析token，使用tokenStore</span></span><br><span class="line">    oAuth2AccessToken = tokenStore.readAccessToken(token);</span><br><span class="line">    <span class="comment">// 令牌的关键信息都在additionalInformation中</span></span><br><span class="line">    Map&lt;String, Object&gt; additionalInformation = oAuth2AccessToken.getAdditionalInformation();</span><br><span class="line">    <span class="comment">// 取出用户身份信息</span></span><br><span class="line">    String user_name = additionalInformation.get(<span class="string">"user_name"</span>).toString();</span><br><span class="line">    <span class="comment">// 获取用户权限</span></span><br><span class="line">    List&lt;String&gt; authorities = (List&lt;String&gt;) additionalInformation.get(<span class="string">"authorities"</span>);</span><br><span class="line">    JSONObject jsonObject = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    jsonObject.put(TokenConstant.PRINCIPAL_NAME, user_name);</span><br><span class="line">    jsonObject.put(TokenConstant.AUTHORITIES_NAME, authorities);</span><br><span class="line">    <span class="comment">// 将解析后的token加密放入请求头中，方便下游微服务解析获取用户信息</span></span><br><span class="line">    String base64 = Base64.encode(jsonObject.toJSONString());</span><br><span class="line">    <span class="comment">// 放入请求头中</span></span><br><span class="line">    ServerHttpRequest tokenRequest = exchange.getRequest().mutate().header(TokenConstant.TOKEN_NAME, base64).build();</span><br><span class="line">    ServerWebExchange build = exchange.mutate().request(tokenRequest).build();</span><br><span class="line">    <span class="keyword">return</span> chain.filter(build);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InvalidTokenException e) &#123;</span><br><span class="line">    <span class="comment">// 解析token异常，直接返回token无效</span></span><br><span class="line">    <span class="keyword">return</span> invalidTokenMono(exchange);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中令牌的关键信息都存放在<strong>additionalInformation</strong>中，默认自带的有三个，分别是用户名、权限、jti，如下：</p>
<img src="https://oauth2images.oss-cn-guangzhou.aliyuncs.com/oauth2/additionalInformation.png" alt="additionalInformation" style="zoom:67%;">



<p>很显然这三个信息实际开发中并不够用，因此必须要对<strong>additionalInformation</strong>进行扩展。</p>
<h3 id="令牌增强"><a href="#令牌增强" class="headerlink" title="令牌增强"></a>令牌增强</h3><blockquote>
<p>JWT负载信息默认是固定的，如果想自定义添加一些额外信息，需要实现TokenEnhancer的enhance方法将附加信息添加到access_token中。</p>
</blockquote>
<p>现在下游微服务需要<strong>userId</strong></p>
<p>因此必须在<strong>认证过程中</strong>就需要将用户的userId存放到令牌中，这样在网关层才能从令牌中获取这部分信息，然后解析传递给下游微服务。</p>
<h4 id="改造-JwtAccessTokenConverter"><a href="#改造-JwtAccessTokenConverter" class="headerlink" title="改造 JwtAccessTokenConverter"></a>改造 JwtAccessTokenConverter</h4><p>新建一个内部类 <strong>JwtAccessTokenEnhancer</strong>，继承<strong>JwtAccessTokenConverter</strong>，重写其中的 <strong>enhance()</strong> 方法，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * JWT令牌增强，继承JwtAccessTokenConverter</span></span><br><span class="line"><span class="comment"> * 将业务所需的额外信息放入令牌中，这样下游微服务就能解析令牌获取</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtAccessTokenEnhancer</span> <span class="keyword">extends</span> <span class="title">JwtAccessTokenConverter</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重写enhance方法，在其中扩展</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> OAuth2AccessToken <span class="title">enhance</span><span class="params">(OAuth2AccessToken accessToken, OAuth2Authentication authentication)</span> </span>&#123;</span><br><span class="line">        Object principal = authentication.getUserAuthentication().getPrincipal();</span><br><span class="line">        <span class="keyword">if</span> (principal <span class="keyword">instanceof</span> UserDetailsDTO) &#123;</span><br><span class="line">            <span class="comment">// 获取userDetailService中查询到用户信息</span></span><br><span class="line">            UserDetailsDTO user = (UserDetailsDTO) principal;</span><br><span class="line">            <span class="comment">// 将额外的信息放入到LinkedHashMap中</span></span><br><span class="line">            LinkedHashMap&lt;String, Object&gt; extendInformation = <span class="keyword">new</span> LinkedHashMap&lt;&gt;();</span><br><span class="line">            <span class="comment">// 设置用户的userId</span></span><br><span class="line">            extendInformation.put(TokenConstant.USER_ID, user.getUserDO().getId());</span><br><span class="line">            <span class="comment">// 添加到additionalInformation</span></span><br><span class="line">            ((DefaultOAuth2AccessToken) accessToken).setAdditionalInformation(extendInformation);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.enhance(accessToken, authentication);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>逻辑很简单，分为四步：</p>
<ul>
<li>从<strong>OAuth2Authentication</strong>中获取认证成功的用户信息<strong>SecurityUser</strong></li>
<li>新建一个<strong>LinkedHashMap</strong>存放额外的信息。</li>
<li>将额外信息添加到<strong>additionalInformation</strong>中</li>
<li>调用父类的 <strong>enhance()</strong> 方法</li>
</ul>
<h4 id="注入JwtAccessTokenConverter"><a href="#注入JwtAccessTokenConverter" class="headerlink" title="注入JwtAccessTokenConverter"></a>注入JwtAccessTokenConverter</h4><p>此时在<strong>AccessTokenConfig</strong>中注入的<strong>JwtAccessTokenConverter</strong>就直接使用<strong>JwtAccessTokenEnhancer</strong>即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JwtAccessTokenConverter <span class="title">jwtAccessTokenConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    JwtAccessTokenConverter converter = <span class="keyword">new</span> JwtAccessTokenEnhancer();</span><br><span class="line">    <span class="comment">// 设置密钥</span></span><br><span class="line">    converter.setSigningKey(TokenConstant.SIGN_KEY);</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * 设置自定义得的令牌转换器，从map中转换身份信息</span></span><br><span class="line"><span class="comment">     * 如果不设置刷新令牌无法获取用户详细信息的问题</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    converter.setAccessTokenConverter(<span class="keyword">new</span> JwtEnhanceAccessTokenConverter());</span><br><span class="line">    <span class="keyword">return</span> converter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="令牌转换器"><a href="#令牌转换器" class="headerlink" title="令牌转换器"></a>令牌转换器</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 令牌转换器，将身份认证信息转换后存储在令牌内</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtEnhanceAccessTokenConverter</span> <span class="keyword">extends</span> <span class="title">DefaultAccessTokenConverter</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">JwtEnhanceAccessTokenConverter</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.setUserTokenConverter(<span class="keyword">new</span> JwtEnhanceUserAuthenticationConverter());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从map中提提取用户信息</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JwtEnhanceUserAuthenticationConverter</span> <span class="keyword">extends</span> <span class="title">DefaultUserAuthenticationConverter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重写抽取用户数据方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">extractAuthentication</span><span class="params">(Map&lt;String, ?&gt; map)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (map.containsKey(USERNAME)) &#123;</span><br><span class="line">            Collection&lt;? extends GrantedAuthority&gt; authorities = getAuthorities(map);</span><br><span class="line">            String username = (String) map.get(USERNAME);</span><br><span class="line">            String userId = map.get(TokenConstant.USER_ID).toString();</span><br><span class="line">            UserDO userDO = <span class="keyword">new</span> UserDO();</span><br><span class="line">            userDO.setId(userId);</span><br><span class="line">            userDO.setUsername(username);</span><br><span class="line">            UserDetailsDTO user =<span class="keyword">new</span> UserDetailsDTO(userDO, authorities);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> UsernamePasswordAuthenticationToken(user, <span class="string">""</span>, authorities);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 提取权限</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Collection&lt;? extends GrantedAuthority&gt; getAuthorities(Map&lt;String, ?&gt; map) &#123;</span><br><span class="line">        Object authorities = map.get(AUTHORITIES);</span><br><span class="line">        <span class="keyword">if</span> (authorities <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">            <span class="keyword">return</span> AuthorityUtils.commaSeparatedStringToAuthorityList((String) authorities);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (authorities <span class="keyword">instanceof</span> Collection) &#123;</span><br><span class="line">            <span class="keyword">return</span> AuthorityUtils.commaSeparatedStringToAuthorityList(StringUtils</span><br><span class="line">                    .collectionToCommaDelimitedString((Collection&lt;?&gt;) authorities));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Authorities must be either a String or a Collection"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最重要就是重写<strong>JwtAccessTokenConverter</strong>中的 <strong>enhance()</strong> 方法，在其中添加额外信息。</p>
<h4 id="过滤器改造"><a href="#过滤器改造" class="headerlink" title="过滤器改造"></a>过滤器改造</h4><p>这里需要改造两个过滤器，分别如下：</p>
<ul>
<li><strong>网关层的全局过滤器</strong>：将添加的额外信息解析放入到请求头中</li>
<li><strong>微服务的过滤器</strong>：从请求头取出信息。</li>
</ul>
<h5 id="网关层的全局过滤器"><a href="#网关层的全局过滤器" class="headerlink" title="网关层的全局过滤器"></a>网关层的全局过滤器</h5><p>在网关的全局过滤器<strong>GlobalAuthenticationFilter</strong>中的添加两行代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// 解析token，使用tokenStore</span></span><br><span class="line">    oAuth2AccessToken = tokenStore.readAccessToken(token);</span><br><span class="line">    Map&lt;String, Object&gt; additionalInformation = oAuth2AccessToken.getAdditionalInformation();</span><br><span class="line">    <span class="comment">// 取出用户身份信息</span></span><br><span class="line">    String user_name = additionalInformation.get(<span class="string">"user_name"</span>).toString();</span><br><span class="line">    <span class="comment">// 获取用户权限</span></span><br><span class="line">    List&lt;String&gt; authorities = (List&lt;String&gt;) additionalInformation.get(<span class="string">"authorities"</span>);</span><br><span class="line">    <span class="comment">// 从additionalInformation取出userId</span></span><br><span class="line">    String userId = additionalInformation.get(TokenConstant.USER_ID).toString();</span><br><span class="line">    JSONObject jsonObject = <span class="keyword">new</span> JSONObject();</span><br><span class="line">    jsonObject.put(TokenConstant.PRINCIPAL_NAME, user_name);</span><br><span class="line">    jsonObject.put(TokenConstant.AUTHORITIES_NAME, authorities);</span><br><span class="line">    <span class="comment">//封装到JSON数据中</span></span><br><span class="line">    jsonObject.put(TokenConstant.USER_ID, userId);</span><br><span class="line">    <span class="comment">// 将解析后的token加密放入请求头中，方便下游微服务解析获取用户信息</span></span><br><span class="line">    String base64 = Base64.encode(jsonObject.toJSONString());</span><br><span class="line">    <span class="comment">// 放入请求头中</span></span><br><span class="line">    ServerHttpRequest tokenRequest = exchange.getRequest().mutate().header(TokenConstant.TOKEN_NAME, base64).build();</span><br><span class="line">    ServerWebExchange build = exchange.mutate().request(tokenRequest).build();</span><br><span class="line">    <span class="keyword">return</span> chain.filter(build);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InvalidTokenException e) &#123;</span><br><span class="line">    <span class="comment">// 解析token异常，直接返回token无效</span></span><br><span class="line">    <span class="keyword">return</span> invalidTokenMono(exchange);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>很简单，就是从令牌的additionalInformation中取出然后放入到JSON数据中。</p>
<h5 id="微服务过滤器改造"><a href="#微服务过滤器改造" class="headerlink" title="微服务过滤器改造"></a>微服务过滤器改造</h5><p>在微服务的过滤器<strong>AuthenticationFilter</strong>中添加两行代码</p>
<h5 id="测试即可-1"><a href="#测试即可-1" class="headerlink" title="测试即可"></a>测试即可</h5><h2 id="自定义返回token格式"><a href="#自定义返回token格式" class="headerlink" title="自定义返回token格式"></a>自定义返回token格式</h2><h3 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h3><p>Spring Security OAuth的token返回格式都是默认的，但是往往这个格式是不适配系统，<code>/oauth/token</code>返回的格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"access_token"</span>: token</span><br><span class="line">    <span class="string">"token_type"</span>: <span class="string">"bearer"</span>,</span><br><span class="line">    <span class="attr">"refresh_token"</span>: xxxx</span><br><span class="line">    <span class="string">"expires_in"</span>: xxx,</span><br><span class="line">    <span class="attr">"scope"</span>: <span class="string">"xxx"</span>,</span><br><span class="line">    <span class="attr">"jti"</span>: xxxx</span><br><span class="line">    ....................</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然而此时系统中的统一返回格式为：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">"code"</span>:xxx</span><br><span class="line">    <span class="string">"data"</span>:xxx</span><br><span class="line">    <span class="string">"msg"</span>:xxx</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么如何去对默认的格式进行修改呢？</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>其实解决方案还是很多的，据陈某了解有如下两种解决方案：</p>
<ol>
<li>使用AOP的方式对<code>/oauth/token</code>这个接口的结果拦截修改</li>
<li>重定义接口覆盖默认的</li>
</ol>
<p>第一种方案呢可以实现，但是对于我们来说不够优雅，实现比较简单，不显逼格</p>
<p>于是今天介绍第二种方案，一种比较优雅的方式；想要理解第二种方式必须对Spring Security的底层源码有一些了解。</p>
<p><code>/oauth/token</code>这个接口定义在哪里呢？通过源码我们知道定义在<code>org.springframework.security.oauth2.provider.endpoint.TokenEndpoint</code>中，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/oauth/token"</span>, method=RequestMethod.GET)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity&lt;OAuth2AccessToken&gt; <span class="title">getAccessToken</span><span class="params">(Principal principal, @RequestParam</span></span></span><br><span class="line"><span class="function"><span class="params">Map&lt;String, String&gt; parameters)</span> <span class="keyword">throws</span> HttpRequestMethodNotSupportedException </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/oauth/token"</span>, method=RequestMethod.POST)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity&lt;OAuth2AccessToken&gt; <span class="title">postAccessToken</span><span class="params">(Principal principal, @RequestParam</span></span></span><br><span class="line"><span class="function"><span class="params">Map&lt;String, String&gt; parameters)</span> <span class="keyword">throws</span> HttpRequestMethodNotSupportedException </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到针对这个接口定义了两个，一个是GET请求、一个是POST请求</p>
<p><code>TokenEndpoint</code>其实就是一个接口，使用注解<code>@FrameworkEndpoint</code>标注，这个注解和<code>@Controller</code>的作用一样，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FrameworkEndpoint</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TokenEndpoint</span> <span class="keyword">extends</span> <span class="title">AbstractEndpoint</span> </span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>那么知道在哪里定义的就好办了，模仿着它这个接口自己重新定义一个覆盖掉不就好了，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/oauth"</span>)</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//令牌请求的端点</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> TokenEndpoint tokenEndpoint;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重写/oauth/token这个默认接口，返回的数据格式统一</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"/token"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ApiResult&lt;OAuth2AccessToken&gt; <span class="title">postAccessToken</span><span class="params">(Principal principal, @RequestParam</span></span></span><br><span class="line"><span class="function"><span class="params">            Map&lt;String, String&gt; parameters)</span> <span class="keyword">throws</span> HttpRequestMethodNotSupportedException </span>&#123;</span><br><span class="line">        OAuth2AccessToken accessToken = tokenEndpoint.postAccessToken(principal, parameters).getBody();</span><br><span class="line">        <span class="keyword">return</span> ApiResult.ok(accessToken);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到接口内部不需要自己重写逻辑，只需要调用<code>TokenEndpoint</code>中的方法</p>
<blockquote>
<p>注意：由于对TokenEndpoint中的端点重写了，因此前面定义的对用户名、密码之类的异常捕获的翻译类（<strong>OAuthServerWebResponseExceptionTranslator</strong>）将会失效，需要在全局异常中进行捕获</p>
</blockquote>
<p>上面是<code>/oauth/token</code>的接口，<code>/oauth/check_token</code>这个校验token的接口如需自定义也是可以的，对应的类是<code>org.springframework.security.oauth2.provider.endpoint.CheckTokenEndpoint</code></p>
<p>重写后的代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Api</span>(value = <span class="string">"OAuth接口"</span>)</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/oauth"</span>)</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthController</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CheckTokenEndpoint checkTokenEndpoint;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//自定义异常翻译器，针对用户名、密码异常，授权类型不支持的异常进行处理</span></span><br><span class="line">    <span class="keyword">private</span> OAuthServerWebResponseExceptionTranslator translate;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 重写/oauth/check_token这个默认接口，用于校验令牌，返回的数据格式统一</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"/check_token"</span>)</span><br><span class="line">    <span class="keyword">public</span> ResultMsg&lt;Map&lt;String,?&gt;&gt; checkToken(<span class="meta">@RequestParam</span>(<span class="string">"token"</span>) String value)  &#123;</span><br><span class="line">        Map&lt;String, ?&gt; map = checkTokenEndpoint.checkToken(value);</span><br><span class="line">        <span class="keyword">return</span> ResultMsg.resultSuccess(map);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这种方式是不是很优雅？也很符合Spring Security的设计思想，AOP的方式还要对参数解析，重新包装</p>
<h2 id="JWT非对称加密"><a href="#JWT非对称加密" class="headerlink" title="JWT非对称加密"></a>JWT非对称加密</h2><h3 id="JWT签名"><a href="#JWT签名" class="headerlink" title="JWT签名"></a>JWT签名</h3><p>签名实际上是生成一段标识(JWT的Signature部分)作为接收方验证信息是否被篡改的依据原理部分请参考这篇的文章：<a href="https://www.cnblogs.com/pcheng/p/9629621.html" target="_blank" rel="noopener">RSA加密、解密、签名、验签的原理及方法</a></p>
<p>其中对JWT签名有对称和非对称两种方式：</p>
<blockquote>
<p>对称方式：认证服务器和资源服务器使用同一个密钥进行加签和验签，默认算法HMAC</p>
</blockquote>
<blockquote>
<p>非对称方式：认证服务器使用私钥加签，资源服务器使用公钥验签，默认算法RSA</p>
</blockquote>
<p>非对称方式相较于对称方式更为安全，因为私钥只有认证服务器知道。</p>
<p>项目中使用RSA非对称签名方式，具体实现步骤如下：</p>
<ol>
<li>从密钥库获取密钥对（公钥+私钥）</li>
<li>认证服务器私钥对token签名</li>
<li>提供获取的公钥接口供资源服务器验签使用 或者 生成一个公钥文件放在资源服务器resource目录下使用</li>
</ol>
<h3 id="JWT转化器"><a href="#JWT转化器" class="headerlink" title="JWT转化器"></a>JWT转化器</h3><p>前面都是在认证授权服务 和 资源服务配置类中都配置了一个相同的 jwt 转换器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * JwtAccessTokenConverter 生成token的令牌转换器，可以实现指定token的生成方式(JWT)和对JWT进行签名</span></span><br><span class="line"><span class="comment"> * 在JWT编码的令牌值和OAuth身份验证信息之间进行转换(JWT保存着用户的身份信息)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JwtAccessTokenConverter <span class="title">jwtAccessTokenConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    JwtAccessTokenConverter converter = <span class="keyword">new</span> JwtAccessTokenConverter();</span><br><span class="line">    <span class="comment">// 这里的认证授权服务使用了简单的对称加密方式来加密jwt，同时资源服务中使用的也是相同密钥来配置jwt转换器</span></span><br><span class="line">    converter.setSigningKey(<span class="string">"secret"</span>);</span><br><span class="line">    <span class="keyword">return</span> converter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是生成环境中，还是会使用非对称方式来对jwt进行签名安全点</p>
<h3 id="生成公私钥"><a href="#生成公私钥" class="headerlink" title="生成公私钥"></a>生成公私钥</h3><p>使用 JDK 自带工具的 keytool 生成JKS密钥库(Java Key Store)，下面来了解一下命令参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -genkey -alias oauth2-template -keyalg RSA -keypass <span class="number">123456</span> -keystore auth.jks -storepass <span class="number">123456</span></span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\xxxx&gt;keytool -genkey -help</span><br><span class="line">keytool -genkeypair [OPTION]...</span><br><span class="line"></span><br><span class="line">生成密钥对</span><br><span class="line"></span><br><span class="line">选项:</span><br><span class="line"> -alias &lt;alias&gt;                  要处理的条目的别名</span><br><span class="line"> -keyalg &lt;keyalg&gt;                密钥算法名称</span><br><span class="line"> -keysize &lt;keysize&gt;              密钥位大小</span><br><span class="line"> -groupname &lt;name&gt;               Group name. For example, an Elliptic Curve name.</span><br><span class="line"> -sigalg &lt;sigalg&gt;                签名算法名称</span><br><span class="line"> -destalias &lt;destalias&gt;          目标别名</span><br><span class="line"> -dname &lt;dname&gt;                  唯一判别名</span><br><span class="line"> -startdate &lt;startdate&gt;          证书有效期开始日期/时间</span><br><span class="line"> -ext &lt;value&gt;                    X.509 扩展</span><br><span class="line"> -validity &lt;valDays&gt;             有效天数</span><br><span class="line"> -keypass &lt;arg&gt;                  密钥口令(至少要6个字符)</span><br><span class="line"> -keystore &lt;keystore&gt;            密钥库名称</span><br><span class="line"> -storepass &lt;arg&gt;                密钥库口令(至少要6个字符)</span><br><span class="line"> -storetype &lt;storetype&gt;          密钥库类型</span><br><span class="line"> -providername &lt;providername&gt;    提供方名称</span><br><span class="line"> -providerclass &lt;providerclass&gt;  提供方类名</span><br><span class="line"> -providerarg &lt;arg&gt;              提供方参数</span><br><span class="line"> -providerpath &lt;pathlist&gt;        提供方类路径</span><br><span class="line"> -v                              详细输出</span><br><span class="line"> -protected                      通过受保护的机制的口令</span><br></pre></td></tr></table></figure>

<p><img src="https://oauth2images.oss-cn-guangzhou.aliyuncs.com/oauth2/%E5%AF%86%E9%92%A5%E5%BA%93jks%E6%96%87%E4%BB%B6.png" alt="密钥库jks文件"></p>
<blockquote>
<p>将生成的 jks 密钥文件拷贝到 auth 认证授权模块下的resources目录下</p>
</blockquote>
<h3 id="修改认证授权服务配置类"><a href="#修改认证授权服务配置类" class="headerlink" title="修改认证授权服务配置类"></a>修改认证授权服务配置类</h3><p>只需要修改 jwt 转换器即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * JwtAccessTokenConverter 生成token的令牌转换器，可以实现指定token的生成方式(JWT)和对JWT进行签名</span></span><br><span class="line"><span class="comment"> * 在JWT编码的令牌值和OAuth身份验证信息之间进行转换(JWT保存着用户的身份信息)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JwtAccessTokenConverter <span class="title">jwtAccessTokenConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    JwtAccessTokenConverter converter = <span class="keyword">new</span> JwtAccessTokenConverter();</span><br><span class="line">    <span class="comment">// 其中 123456 对应 keypass； oauth2-template 对应 alias</span></span><br><span class="line">    KeyPair keyPair = <span class="keyword">new</span> KeyStoreKeyFactory(<span class="keyword">new</span> ClassPathResource(<span class="string">"auth.jks"</span>), <span class="string">"123456"</span>.toCharArray()).getKeyPair(<span class="string">"oauth2-template"</span>);</span><br><span class="line">    converter.setKeyPair(keyPair);</span><br><span class="line">    <span class="keyword">return</span> converter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="根据-jks-文件获取公钥"><a href="#根据-jks-文件获取公钥" class="headerlink" title="根据 jks 文件获取公钥"></a>根据 jks 文件获取公钥</h3><p>需要事先下载 openssl 软件包，windows环境需要添加 bin 目录的环境变量</p>
<p>命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -list -rfc --keystore auth.jks | openssl x509 -inform pem -pubkey</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">H:\code\oauth2-template&gt;keytool -list -rfc --keystore auth.jks | openssl x509 -inform pem -pubkey</span><br><span class="line">输入密钥库口令:  123456</span><br><span class="line">-----BEGIN PUBLIC KEY-----</span><br><span class="line">MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAj87HI9GDVT7c5U2RQ4x0</span><br><span class="line">0BYtOK7gbYfvFp7erxi+IR+TZXKoaz6aMjZL5T28mBmNanSWXL/204IpkW4ItDGg</span><br><span class="line">jIEO+iHBuQDlRHauxba8tRmTDWYQppAJSJz3coJbzUXHJwac3SKwROGegyRucmdb</span><br><span class="line">pu7znie6KbANwCQjeTvJiRQ+rz9H4pXtAkc5QximUzkLfRQ5PNqXEnfYI+lEenhR</span><br><span class="line">E7j5yhdYjSNPqVUjp/pAJoHrzzh/1RzBN91gOIXi6qG5+7VkgUlyXYC/w55dcY4S</span><br><span class="line">HQujFVsyEf1mSPusF8M2q7B6MN1/GpWTg8w8vgvhOLT8jQMkkd3P9ctyC5e720LN</span><br><span class="line">VwIDAQAB</span><br><span class="line">Warning:</span><br><span class="line"></span><br><span class="line">-----END JKS 密钥库使用专用格式。建议使用 &quot;keytool -importkeystore -srckeystore auth.jks -destkeystore auth.jks -deststoretype pkcs12&quot; 迁移到行业标准格式 PKCS12。PUBLIC KEY</span><br><span class="line">-----</span><br><span class="line">-----BEGIN CERTIFICATE-----</span><br><span class="line">MIIDdzCCAl+gAwIBAgIEK9x1+TANBgkqhkiG9w0BAQsFADBsMRAwDgYDVQQGEwdV</span><br><span class="line">bmtub3duMRAwDgYDVQQIEwdVbmtub3duMRAwDgYDVQQHEwdVbmtub3duMRAwDgYD</span><br><span class="line">VQQKEwdVbmtub3duMRAwDgYDVQQLEwdVbmtub3duMRAwDgYDVQQDEwdVbmtub3du</span><br><span class="line">MB4XDTIyMDcxODA3MzU1OVoXDTIyMTAxNjA3MzU1OVowbDEQMA4GA1UEBhMHVW5r</span><br><span class="line">bm93bjEQMA4GA1UECBMHVW5rbm93bjEQMA4GA1UEBxMHVW5rbm93bjEQMA4GA1UE</span><br><span class="line">ChMHVW5rbm93bjEQMA4GA1UECxMHVW5rbm93bjEQMA4GA1UEAxMHVW5rbm93bjCC</span><br><span class="line">ASIwDQYJKoZIhvcNAQEBBQADggEPADCCAQoCggEBAI/OxyPRg1U+3OVNkUOMdNAW</span><br><span class="line">LTiu4G2H7xae3q8YviEfk2VyqGs+mjI2S+U9vJgZjWp0lly/9tOCKZFuCLQxoIyB</span><br><span class="line">DvohwbkA5UR2rsW2vLUZkw1mEKaQCUic93KCW81FxycGnN0isEThnoMkbnJnW6bu</span><br><span class="line">854nuimwDcAkI3k7yYkUPq8/R+KV7QJHOUMYplM5C30UOTzalxJ32CPpRHp4URO4</span><br><span class="line">+coXWI0jT6lVI6f6QCaB6884f9UcwTfdYDiF4uqhufu1ZIFJcl2Av8OeXXGOEh0L</span><br><span class="line">oxVbMhH9Zkj7rBfDNquwejDdfxqVk4PMPL4L4Ti0/I0DJJHdz/XLcguXu9tCzVcC</span><br><span class="line">AwEAAaMhMB8wHQYDVR0OBBYEFM+NzPoQ09t83JrqNVSZS/E9tEsQMA0GCSqGSIb3</span><br><span class="line">DQEBCwUAA4IBAQBf6sfgvl6HnvhskwlFKly4g4XB+CLoavwZEARXwXMNqt49kyN0</span><br><span class="line">hnGt4gU3bT3JUGcqMVrOLtJy72ESCawW7Ge0fWsP+VMDEy3euhkABP8McDPWKP6a</span><br><span class="line">pV1qRlRXRgQSfh5CLbTppFmuVJi0WEepDxijuYD0/z9M56LPTmY0jydrq52Foc4b</span><br><span class="line">8zxYRAQdkWNkv/0ad6Kty5eFc1DoBRO5TztWGe0VZghlFHfcTSsAxwq8vuIYZGm+</span><br><span class="line">RXzK8NLfHujIonB0shFNib7z6viwovVJcS70C8g1+SKkg+trUBdP4xs7Tywo9Y77</span><br><span class="line">nl7qVLPjpdbxdPTJxonqkhDOyX2LVb3NY8Ri</span><br><span class="line">-----END CERTIFICATE-----</span><br></pre></td></tr></table></figure>

<p>在资源服务的resource文件下，新建一个 <code>public.txt</code> 文件，将公钥复制进去</p>
<blockquote>
<p>文件内容为：[—–BEGIN PUBLIC KEY—– 与 —–END PUBLIC KEY—– ]</p>
</blockquote>
<img src="https://oauth2images.oss-cn-guangzhou.aliyuncs.com/oauth2/%E5%85%AC%E9%92%A5%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95.png" alt="公钥文件目录" style="zoom:67%;">



<h3 id="修改资源服务配置类"><a href="#修改资源服务配置类" class="headerlink" title="修改资源服务配置类"></a>修改资源服务配置类</h3><p>资源服务配置类也只需要修改jwt转换器配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * JwtAccessTokenConverter令牌增强类</span></span><br><span class="line"><span class="comment"> * TokenEnhancer的子类，在JWT编码的令牌值和OAuth身份验证信息之间进行转换(JWT保存着用户的身份信息)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> JwtAccessTokenConverter <span class="title">jwtAccessTokenConverter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 加载公钥文件</span></span><br><span class="line">    Resource resource = <span class="keyword">new</span> ClassPathResource(<span class="string">"public.txt"</span>);</span><br><span class="line">    JwtAccessTokenConverter converter = <span class="keyword">new</span> JwtAccessTokenConverter();</span><br><span class="line">    String publicKey;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        publicKey = <span class="keyword">new</span> String(FileCopyUtils.copyToByteArray(resource.getInputStream()));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        log.error(<span class="string">"读取公钥文件失败"</span>, e);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BusinessException(<span class="string">"读取公钥文件失败"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    converter.setVerifierKey(publicKey);</span><br><span class="line">    <span class="keyword">return</span> converter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3>
      <blockquote class="mdui-m-t-5">
        
          <strong>本文遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">CC BY-NC-SA 4.0</a> 许可协议，转载请附上原文出处链接和本声明。</strong><br>
        
        <strong>本文链接：</strong><a href="https://yellowbp.github.io/2022/07/07/网关集成OAuth2/">https://yellowbp.github.io/2022/07/07/网关集成OAuth2/</a>
      </blockquote>
      
    </div>
    <footer class="mdui-card-actions">
      
        <a class="mdui-ripple article_categories-link" href="/categories/OAuth2/">OAuth2</a>
      
      
        <a class="mdui-ripple article_tags-link" href="/tags/redis/">redis</a>
      
    </footer>
    
  </article>
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script>$("#main article .mdui-card-content img.fancybox").on("click",function(e){$.fancybox.open({src:$(this).attr("src")});});</script>


  <nav id="paginator">
    
      <a rel="prev" class="extend prev" href="/2022/07/10/JWT令牌注销失效/">
        <button aria-label="prev" class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_back</i></button>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上一篇
      </a>
    
    <div class="spacer"></div>
    
      <a rel="next" class="extend next" href="/2022/07/06/OAuth2自定义异常/">
        下一篇&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <button aria-label="next" class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_forward</i></button>
      </a>
    
  </nav>


  <div id="comment" class="mdui-m-t-5">
    <style>#pop_ad,#feedAv{display:none!important;position:absolute!important;z-index:-9999;left:-1000px;opacity:0!important}</style>
<div id="SOHUCS" sid="cl74qc0gm00afjctwfoc0opxx"></div>
<script type="text/javascript">
(function(){
var appid = 'cyubhC2Dq';
var conf = 'prod_e4cce65003c5bed049fefcb8a6f09e12';
var width = window.innerWidth || document.documentElement.clientWidth;
if (width < 960) {
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="http://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("http://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>
  </div>



  <div style="position: fixed !important; right: 16px; top: 30%;">
    <button class="mdui-fab mdui-fab-mini mdui-ripple" mdui-menu="{target: '#toc'}"><i class="mdui-icon material-icons">format_list_numbered</i></button>
    <ul class="mdui-menu" id="toc">
      <li class="mdui-menu-item" disabled><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#网关集成OAuth2"><span class="toc-number">1.</span> <span class="toc-text">网关集成OAuth2</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#案例架构"><span class="toc-number">1.1.</span> <span class="toc-text">案例架构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#认证授权服务搭建"><span class="toc-number">1.2.</span> <span class="toc-text">认证授权服务搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#认证服务配置类"><span class="toc-number">1.2.1.</span> <span class="toc-text">认证服务配置类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#客户端信息配置"><span class="toc-number">1.2.2.</span> <span class="toc-text">客户端信息配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Security安全配置类"><span class="toc-number">1.2.3.</span> <span class="toc-text">Security安全配置类</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#网关服务搭建"><span class="toc-number">1.3.</span> <span class="toc-text">网关服务搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#案列架构"><span class="toc-number">1.3.1.</span> <span class="toc-text">案列架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#添加依赖"><span class="toc-number">1.3.2.</span> <span class="toc-text">添加依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JWT令牌服务配置"><span class="toc-number">1.3.3.</span> <span class="toc-text">JWT令牌服务配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#认证管理器自定义"><span class="toc-number">1.3.4.</span> <span class="toc-text">认证管理器自定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#鉴权管理器自定义"><span class="toc-number">1.3.5.</span> <span class="toc-text">鉴权管理器自定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#令牌无效或过期时自定义返回结果"><span class="toc-number">1.3.6.</span> <span class="toc-text">令牌无效或过期时自定义返回结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#无权限时自定义返回结果"><span class="toc-number">1.3.7.</span> <span class="toc-text">无权限时自定义返回结果</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#OAuth2相关配置"><span class="toc-number">1.3.8.</span> <span class="toc-text">OAuth2相关配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#全局过滤器定制"><span class="toc-number">1.3.9.</span> <span class="toc-text">全局过滤器定制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试微服务搭建"><span class="toc-number">1.3.10.</span> <span class="toc-text">测试微服务搭建</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#为什么要将URI和权限放入Redis"><span class="toc-number">1.3.11.</span> <span class="toc-text">为什么要将URI和权限放入Redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试即可"><span class="toc-number">1.3.12.</span> <span class="toc-text">测试即可</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JWT增强"><span class="toc-number">1.4.</span> <span class="toc-text">JWT增强</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#网关层如何获取令牌中的信息？"><span class="toc-number">1.4.1.</span> <span class="toc-text">网关层如何获取令牌中的信息？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#令牌增强"><span class="toc-number">1.4.2.</span> <span class="toc-text">令牌增强</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#改造-JwtAccessTokenConverter"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">改造 JwtAccessTokenConverter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#注入JwtAccessTokenConverter"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">注入JwtAccessTokenConverter</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#令牌转换器"><span class="toc-number">1.4.2.3.</span> <span class="toc-text">令牌转换器</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#过滤器改造"><span class="toc-number">1.4.2.4.</span> <span class="toc-text">过滤器改造</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#网关层的全局过滤器"><span class="toc-number">1.4.2.4.1.</span> <span class="toc-text">网关层的全局过滤器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#微服务过滤器改造"><span class="toc-number">1.4.2.4.2.</span> <span class="toc-text">微服务过滤器改造</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#测试即可-1"><span class="toc-number">1.4.2.4.3.</span> <span class="toc-text">测试即可</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#自定义返回token格式"><span class="toc-number">1.5.</span> <span class="toc-text">自定义返回token格式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#问题描述"><span class="toc-number">1.5.1.</span> <span class="toc-text">问题描述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#解决方案"><span class="toc-number">1.5.2.</span> <span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JWT非对称加密"><span class="toc-number">1.6.</span> <span class="toc-text">JWT非对称加密</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#JWT签名"><span class="toc-number">1.6.1.</span> <span class="toc-text">JWT签名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JWT转化器"><span class="toc-number">1.6.2.</span> <span class="toc-text">JWT转化器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#生成公私钥"><span class="toc-number">1.6.3.</span> <span class="toc-text">生成公私钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改认证授权服务配置类"><span class="toc-number">1.6.4.</span> <span class="toc-text">修改认证授权服务配置类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#根据-jks-文件获取公钥"><span class="toc-number">1.6.5.</span> <span class="toc-text">根据 jks 文件获取公钥</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#修改资源服务配置类"><span class="toc-number">1.6.6.</span> <span class="toc-text">修改资源服务配置类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#测试"><span class="toc-number">1.6.7.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li></ol></li>
    </ul>
  </div>
</main>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<footer id="footer" class="mdui-m-t-5 mdui-p-y-3 mdui-color-theme">
  <div class="mdui-p-y-0 mdui-text-center">
    
    
    
    
    
    
    
      <a href="https://github.com/yellowbp" target="_blank"><i class="mdui-p-a-1 mdui-icon iconfont mdui-text-color-theme-a100">&#xe7ab;</i></a>
    
    
    
    
    
      <a href="tencent://message/?uin=1432440963&Menu=yes" target="_blank"><i class="mdui-p-a-1 mdui-icon iconfont mdui-text-color-theme-a100">&#xe651;</i></a>
    
    
  </div>
  <div class="mdui-p-y-1 mdui-text-center">
    Copyright &copy; 2019 - 2022 hbp<br>
    Powered by <a href="https://hexo.io/" target="_blank" class="mdui-text-color-theme-accent">Hexo</a>hbp All rights reserved.
    
    <br>
    <span id="busuanzi_container_site_uv">
    本网站总访问量<span id="busuanzi_value_site_uv"></span>次
    </span>
  </div>
</footer>
  <button id="gotop" class="mdui-fab mdui-fab-fixed mdui-fab-hide mdui-ripple mdui-color-theme-accent"><i class="mdui-icon material-icons">arrow_upward</i></button>
  <script async src="http://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <script src="/js/mdui.js"></script>
<script src="/js/script.js"></script>
</body>
</html>