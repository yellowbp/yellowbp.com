<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="renderer" content="webkit">

  
  <title>SpringSecurity | bp的Blog</title>

  <link rel="shortcut icon" href="/images/favicon.png">
  
  <meta name="description" content="SpringSecurity简介基本概念  什么是安全框架？  解决系统安全问题的框架。如果没有安全框架，我们需要手动处理每个资源的访问控制，非常麻烦。使用安全框架，我们可以通过配置的方式实现对资源的访问限制。一般来说，安全框架主要有用户认证，用户授权，加密，会话管理等主要功能。  什么是用户认证？  用户认证就是判断一个用户的身份是否合法的过程，用户去访问系统资源时系统要求验证用户的身份信息，身">
<meta name="keywords" content="Spring">
<meta property="og:type" content="article">
<meta property="og:title" content="SpringSecurity">
<meta property="og:url" content="https://yellowbp.github.io/2021/06/01/SpringSecurity/index.html">
<meta property="og:site_name" content="bp的Blog">
<meta property="og:description" content="SpringSecurity简介基本概念  什么是安全框架？  解决系统安全问题的框架。如果没有安全框架，我们需要手动处理每个资源的访问控制，非常麻烦。使用安全框架，我们可以通过配置的方式实现对资源的访问限制。一般来说，安全框架主要有用户认证，用户授权，加密，会话管理等主要功能。  什么是用户认证？  用户认证就是判断一个用户的身份是否合法的过程，用户去访问系统资源时系统要求验证用户的身份信息，身">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E6%8E%88%E6%9D%83%E4%B8%89%E5%AE%9E%E4%BD%93%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B.jpg">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E6%8E%88%E6%9D%835%E5%BC%A0%E8%A1%A8%E6%A8%A1%E5%9E%8B.jpg">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E6%8E%88%E6%9D%83%E7%A4%BA%E4%BE%8B.jpg">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E5%9F%BA%E4%BA%8E%E8%A7%92%E8%89%B2%E7%9A%84%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E5%9F%BA%E4%BA%8E%E8%B5%84%E6%BA%90%E7%9A%84%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%89%A9%E7%90%86%E6%A8%A1%E5%9E%8B.jpg">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84.jpg">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E6%9D%83%E9%99%90%E8%A1%A8.jpg">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E5%86%85%E7%BD%AE%E7%99%BB%E5%BD%95%E9%A1%B5.jpg">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE.jpg">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E8%BF%87%E6%BB%A4%E9%93%BE%E8%AF%A6%E7%BB%86.jpg">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B.jpg">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E8%AE%A4%E8%AF%81%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6.jpg">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B.jpg">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E6%9C%AA%E7%99%BB%E5%BD%95%E6%BC%94%E7%A4%BA.jpg">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E7%99%BB%E5%BD%95.jpg">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E7%AE%A1%E7%90%86%E5%91%98%E8%AE%BF%E9%97%AE%E6%8E%A5%E5%8F%A3%E6%88%90%E5%8A%9F.jpg">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E6%B2%A1%E6%9C%89%E6%9D%83%E9%99%90%E8%AE%BF%E9%97%AE.jpg">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E8%B4%A6%E5%8F%B7%E4%B8%8D%E5%AD%98%E5%9C%A8.jpg">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E5%AF%86%E7%A0%81%E9%94%99%E8%AF%AF.jpg">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95.jpg">
<meta property="og:updated_time" content="2021-06-01T14:38:52.150Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="SpringSecurity">
<meta name="twitter:description" content="SpringSecurity简介基本概念  什么是安全框架？  解决系统安全问题的框架。如果没有安全框架，我们需要手动处理每个资源的访问控制，非常麻烦。使用安全框架，我们可以通过配置的方式实现对资源的访问限制。一般来说，安全框架主要有用户认证，用户授权，加密，会话管理等主要功能。  什么是用户认证？  用户认证就是判断一个用户的身份是否合法的过程，用户去访问系统资源时系统要求验证用户的身份信息，身">
<meta name="twitter:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E6%8E%88%E6%9D%83%E4%B8%89%E5%AE%9E%E4%BD%93%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B.jpg">

  <meta name="format-detection" content="telephone=no,email=no">
  <meta name="theme-color" content="#9C27B0">
  <meta name="description" content>
  <meta name="keywords" content=",Spring">

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="bp的Blog">
  <meta name="msapplication-starturl" content="https://yellowbp.github.io/2021/06/01/SpringSecurity/">
  <meta name="msapplication-navbutton-color" content="#9C27B0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="bp的Blog">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/images/favicon.png">

  
    <meta property="article:published_time" content="Tue Jun 01 2021 21:47:04 GMT+0800">
    <meta property="article:modified_time" content="Tue Jun 01 2021 22:38:52 GMT+0800">
  

  
    <link rel="canonical" href="https://yellowbp.github.io/2021/06/01/SpringSecurity/">
  

  <meta name="google-site-verification" content="fXjtlIfaDc_X-0P11rO3bEp1Nk4IKXphoJv0GqGZCco">
  <meta name="baidu-site-verification" content="I3t1wfwZvd">

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create','UA-139531378-1','auto');ga('send','pageview');
</script>
  <script>
  var _hmt = _hmt || [];
  (function() {var hm = document.createElement('script');
  hm.src = 'https://hm.baidu.com/hm.js?1054d51c0b66f1d168829173682c8159';
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script>
  

  <link rel="stylesheet" href="/css/mdui.css">
<link rel="stylesheet" href="/css/style.css">
</head>
<body class="mdui-appbar-with-toolbar mdui-drawer-body-left mdui-theme-primary-brown mdui-theme-accent-blue">
  <script>var a=localStorage.getItem("mdui-theme-layout-dark");if(a){document.getElementsByTagName("body")[0].className+=" mdui-theme-layout-dark"};</script>
  <header id="header" class="mdui-appbar mdui-appbar-fixed mdui-appbar-scroll-hide mdui-appbar-inset">
  <div class="mdui-toolbar mdui-color-theme">
    <a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-drawer="{target: '#sidebar', swipe: true}"><i class="mdui-icon material-icons">menu</i></a>
    <a href="/" class="mdui-typo-headline">bp的Blog</a>
    <div class="mdui-toolbar-spacer"></div>
    <a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-dialog="{target: '#search'}" mdui-tooltip="{content: '搜索'}"><i class="mdui-icon material-icons">search</i></a>
    
  </div>
</header>
<div class="mdui-dialog" id="search">
  
    <div class="search-form">
      <input type="search" class="search-form-input" placeholder="请输入关键字">
    </div>
    <div class="search-result" data-resource="/search.xml"></div>
  
</div>
  <aside id="sidebar" class="mdui-drawer mdui-drawer-full-height">
  <div class="mdui-grid-tile">
    <img src="/images/Gradient1.jpg" style="height: 160px;">
    <img src="/images/headPic.jpg" class="avatar-animation" style="position: absolute; top: 10%; left: 24px; width: 64px; height: 64px; border: 2px solid #fff; border-radius: 50%;">
    <div class="mdui-grid-tile-actions">
      <div class="mdui-grid-tile-text">
        <div class="mdui-grid-tile-title">hbp
        </div>
        <div class="mdui-grid-tile-subtitle"><i class="mdui-icon material-icons">art_track</i>要想快，先会慢</div>
      </div>
      
        <div class="mdui-grid-tile-buttons">
          <a href="mailto:347070556@qq.com" class="mdui-btn mdui-btn-icon" mdui-tooltip="{content: '347070556@qq.com'}"><i class="mdui-icon material-icons">email</i></a>
        </div>
      
    </div>
  </div>

  <div class="mdui-list" mdui-collapse="{accordion: true}">
    <a href="/" class="mdui-list-item mdui-ripple">
      <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-blue">home</i>
      <div class="mdui-list-item-content">主页</div>
    </a>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-deep-orange">inbox</i>
        <div class="mdui-list-item-content">归档</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/archives/2021/07/">七月 2021<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/06/">六月 2021<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/05/">五月 2021<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/04/">四月 2021<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/03/">三月 2021<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/02/">二月 2021<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/01/">一月 2021<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2020/03/">三月 2020<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/12/">十二月 2019<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/11/">十一月 2019<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/10/">十月 2019<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/09/">九月 2019<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/08/">八月 2019<span class="mdui-ripple sidebar_archives-count">6</span></a>
        
      </div>
    </div>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-green">chrome_reader_mode</i>
        <div class="mdui-list-item-content">分类</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/categories/Spring-Cloud-Alibaba/">Spring Cloud Alibaba<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/基础/">基础<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/安全框架/">安全框架<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/工具类/">工具类<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/技术/">技术<span class="mdui-ripple sidebar_archives-count">29</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/搭建/">搭建<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/数据库/">数据库<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/服务器/">服务器<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/电脑硬件/">电脑硬件<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/规范/">规范<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/重装/">重装<span class="mdui-ripple sidebar_archives-count">1</span></a>
        
      </div>
    </div>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-brown">bookmark</i>
        <div class="mdui-list-item-content">标签</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/tags/Spring/">Spring<span class="mdui-ripple sidebar_archives-count">6</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/algorithm/">algorithm<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/excel/">excel<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/git/">git<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/hexo/">hexo<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/javaWeb/">javaWeb<span class="mdui-ripple sidebar_archives-count">8</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/java基础/">java基础<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/linux/">linux<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/mysql/">mysql<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/nginx/">nginx<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/redis/">redis<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/spring/">spring<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/win7/">win7<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/其他/">其他<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/分布式/">分布式<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/接口文档/">接口文档<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/笔记本选购/">笔记本选购<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/自动化构建工具/">自动化构建工具<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/设计模式/">设计模式<span class="mdui-ripple sidebar_archives-count">1</span></a>
        
      </div>
    </div>
    <a href="/about" class="mdui-list-item mdui-ripple">
      <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-purple">person</i>
      <div class="mdui-list-item-content">关于</div>
    </a>
  </div>

  <div class="mdui-divider"></div>

  <div class="mdui-list" mdui-collapse="{accordion: true}">
    
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <div class="mdui-list-item-content">友情链接</div>
        <i class="mdui-list-item-icon mdui-icon material-icons">link</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        
          <a href="javascript:;" class="mdui-list-item mdui-ripple mdui-p-l-2 mdui-text-color-theme" style="justify-content: center;">链接为空</a>
        
      </div>
    </div>
  </div>
</aside>
  <main id="main" class="mdui-m-t-5 fadeIn animated">
  <link rel="stylesheet" href="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.css">
  <style>#main article .mdui-card-content .center-block{display:block!important;margin-right:auto!important;margin-left:auto!important}</style>
  <article class="mdui-card mdui-m-b-5">
    <header class="mdui-card-media">
      <img src="/images/random/material-14.png" style="max-height: 240px;">
      <div class="mdui-card-media-covered">
        <div class="mdui-card-primary">
          <div class="mdui-card-primary-title">SpringSecurity</div>
          <div class="mdui-card-primary-subtitle"><i class="iconfont">&#xe697;</i> 2021-06-01 / 
          <i class="iconfont">&#xe601;</i> hbp
          <span id="busuanzi_container_page_pv">
            本文总阅读量<span id="busuanzi_value_page_pv"></span>次
          </span>
          </div>
        </div>
      </div>
      <div class="mdui-card-menu">
        
        
      </div>
    </header>
    <div class="mdui-card-content mdui-typo">
      <h2 id="SpringSecurity简介"><a href="#SpringSecurity简介" class="headerlink" title="SpringSecurity简介"></a>SpringSecurity简介</h2><h3 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h3><blockquote>
<p> 什么是安全框架？</p>
</blockquote>
<p>解决系统安全问题的框架。如果没有安全框架，我们需要手动处理每个资源的访问控制，非常麻烦。使用安全框架，我们可以通过配置的方式实现对资源的访问限制。一般来说，安全框架主要有用户认证，用户授权，加密，会话管理等主要功能。</p>
<blockquote>
<p>什么是用户认证？</p>
</blockquote>
<p>用户认证就是判断一个用户的身份是否合法的过程，用户去访问系统资源时系统要求验证用户的身份信息，身份合法方可继续访问，不合法则拒绝访问。常见的用户身份认证方式有：用户名密码登录，二维码登录，手机短信登录，指纹认证等方式。</p>
<p><strong>简单来说，就是用户登录。</strong></p>
<blockquote>
<p>什么是用户授权</p>
</blockquote>
<p>授权是用户认证通过后，根据用户的权限来控制用户访问资源的过程，拥有资源的访问权限则正常访问，没有权限则拒绝访问。</p>
<p><strong>简单来说，就是系统判断用户是否有权限去做某些事情。</strong></p>
<blockquote>
<p>什么是会话管理</p>
</blockquote>
<p>用户认证通过后，为了避免用户的每次操作都进行认证可将用户的信息保证在会话中。会话就是系统为了保持当前用户的登录状态所提供的机制，常见的有：</p>
<ul>
<li><p>基于session方式</p>
<p>它的交互流程是：用户认证成功后，在服务端生成用户相关的数据保存在session对象(当前会话)中，并生成session_id发给客户端，客户端把 session_id 存放到 cookie 中，之后客户端请求时带上 session_id 就可以验证服务器端是否存在 session 数据，以此完成用户的合法校验，当用户退出系统或session过期销毁时,客户端的session_id也就无效了。</p>
</li>
<li><p>基于token方式(令牌)</p>
<p>用户认证成功后，服务端生成一个token字符串发给客户端（token里面可以存放用户的信息），客户端可以把token放到 cookie 或 localStorage 等存储中，每次请求时在请求头带上 token，服务端收到token后，进行解析校验令牌，通过验证后即可确认用户身份。</p>
</li>
</ul>
<p>【对比】</p>
<p>基于session的认证方式由Servlet规范定制，服务端要存储session信息需要占用内存资源，且客户端需要支持 cookie；基于token的方式则一般不需要服务端存储token，并且不限制客户端的存储方式。如今移动互联网时代更多类型的客户端需要接入系统，系统多是采用前后端分离的架构进行实现，所以基于token的方式更适合。</p>
<h3 id="常用安全框架"><a href="#常用安全框架" class="headerlink" title="常用安全框架"></a>常用安全框架</h3><ul>
<li>Spring Security：Spring家族的一员，是一个<strong>高度自定义</strong>（很好地支持自定义权限控制或认证逻辑等方面）的安全框架，能够为基于Spring的企业应用系统提供声明式的安全访问控制解决方案的安全框架。它提供了一组可以在Spring应用上下文中配置的Bean，充分利用了Spring IOC和AOP功能，为应用系统提供声明式的安全访问控制功能，减少了为企业系统安全控制编写大量重复代码的工作，“用户认证”和“用户授权”是两大核心功能。</li>
<li>Apache Shiro：一个功能强大且轻量级易于使用的Java安全框架，提供了认证，授权，加密和会话管理（但基于自己系统去实现一些自定义的权限或者认证方面的逻辑的时候，会显得特别麻烦 ，有时候甚至无法实现）。</li>
</ul>
<h3 id="授权的数据模型"><a href="#授权的数据模型" class="headerlink" title="授权的数据模型"></a>授权的数据模型</h3><p>如何进行授权即如何对用户访问资源进行控制，首先需要学习授权相关的数据模型。 </p>
<p>授权可简单理解为Who是否可以对What(which)进行How操作，Who、What、How构成了访问权限三元组，包括如下：</p>
<ul>
<li>Who，即主体（Subject），主体一般是指用户，也可以是程序，需要去访问系统中的资源。</li>
<li>What，即资源 （Resource），再继续细分下去又分为：<ul>
<li>系统功能资源，如系统菜单、页面、按钮、代码方法等。</li>
<li>实体资源（数据资源），如系统商品信息、系统订单信息</li>
</ul>
</li>
<li>How，权限/许可（Permission），规定了用户对资源的操作许可，权限离开资源没有意义， 如用户查询权限、用户添加权限、某个代码方法的调用权限、编号为001的用户的修改权限等，通过权限可知用户 对哪些资源都有哪些操作许可。</li>
</ul>
<p><strong>通常来说，企业开发中将资源和权限表合并为一张权限表</strong>，如下三张实体表：</p>
<ol>
<li>主体（用户id、账号、密码、…）</li>
<li>角色（角色id、角色名称、…）</li>
<li>权限（权限id、权限标识、权限名称、资源名称、资源访问地址、…）</li>
</ol>
<p>关系如下图：</p>
<p><img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E6%8E%88%E6%9D%83%E4%B8%89%E5%AE%9E%E4%BD%93%E6%95%B0%E6%8D%AE%E6%A8%A1%E5%9E%8B.jpg" alt></p>
<p>由于这三张表之间存在着多对多的关系，那么它们之间的交互，最好另外使用两张表来完成。而这两张表起着映射的作用，分别是“用户角色关系表” 和 “角色权限关系表”。即：</p>
<ol>
<li>主体（用户id、账号、密码、…）</li>
<li>主体和角色关系（用户id、角色id、…）</li>
<li>角色（角色id、角色名称、…）</li>
<li>角色和权限关系（角色id、权限id、…）</li>
<li>权限（权限id、权限标识、权限名称、资源名称、资源访问地址、…）</li>
</ol>
<p>因此它们的关系就变为：</p>
<p><img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E6%8E%88%E6%9D%835%E5%BC%A0%E8%A1%A8%E6%A8%A1%E5%9E%8B.jpg" alt></p>
<p>示例：</p>
<p><img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E6%8E%88%E6%9D%83%E7%A4%BA%E4%BE%8B.jpg" alt></p>
<h3 id="RBAC"><a href="#RBAC" class="headerlink" title="RBAC"></a>RBAC</h3><p>如何实现授权？业界通常基于RBAC实现授权。</p>
<h4 id="基于角色的访问控制"><a href="#基于角色的访问控制" class="headerlink" title="基于角色的访问控制"></a>基于角色的访问控制</h4><p>RBAC（Role-Based Access Control）基于角色的访问控制是按角色进行授权，比如：主体的角色为总经理查询员工工资信息等，访问控制流程如下：</p>
<p><img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E5%9F%BA%E4%BA%8E%E8%A7%92%E8%89%B2%E7%9A%84%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg" alt></p>
<p>根据上图中的判断逻辑，授权伪代码可表示如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(主体.hasRole(<span class="string">"总经理角色id"</span>)) &#123; </span><br><span class="line">    查询工资 </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果上图中查询工资所需要的角色变化为总经理和部门经理，此时就需要修改判断逻辑为“判断用户的角色是否是总经理或部门经理”，修改代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(主体.hasRole(<span class="string">"总经理角色id"</span>) || 主体.hasRole(<span class="string">"部门经理角色id"</span>))&#123; </span><br><span class="line">    查询工资 </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>根据上边的例子发现，当需要修改角色的权限时就需要修改授权的相关代码，<strong>系统可扩展性差</strong>。</p>
<h4 id="基于资源的访问控制（推荐）"><a href="#基于资源的访问控制（推荐）" class="headerlink" title="基于资源的访问控制（推荐）"></a>基于资源的访问控制（推荐）</h4><p>RBAC（Resource-Based Access Control）基于资源的访问控制是按资源（或权限）进行授权，比如：用户必须具有查询工资权限才可以查询员工工资信息等，访问控制流程如下：</p>
<p><img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E5%9F%BA%E4%BA%8E%E8%B5%84%E6%BA%90%E7%9A%84%E8%AE%BF%E9%97%AE%E6%8E%A7%E5%88%B6%E6%B5%81%E7%A8%8B%E5%9B%BE.jpg" alt></p>
<p>根据上图中的判断，授权伪代码可以表示为： </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(主体.hasPermission(<span class="string">"查询工资权限标识"</span>))&#123; </span><br><span class="line">    查询工资 </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>【<strong>优点</strong>】</p>
<ol>
<li><strong>系统可扩展性强</strong>，系统设计时定义好查询工资的权限标识，即使查询工资所需要的角色变化为总经理和部门经理也不需要修改授权代码。</li>
<li><strong>减少代码重构</strong>，将访问控制的关注点放在更细粒度的资源上，因为资源的变化频率比起角色要低得多，开发者在开发某一功能时可以直接检查用户是否具有对资源执行操作的能力，而不是去检查用户的角色。</li>
<li><strong>代码容易阅读</strong>，权限检查与代码当前执行的逻辑是对应的，而不像角色检查那样检查一个与当前操作间接相关的事物。</li>
<li><strong>灵活的安全模型</strong>，上面的代码示例并没有对用户、组或角色进行规定， 这意味着可以支持任何安全模型设计，比如，权限可以直接分配给用户，也可以将它们分配给一个角色，再由角色分配给用户， 也许还有组的概念，组与角色有关联，等等。 这些可能性是开放的，可以根据应用进行定制，而不管怎么对权限进行组织，最终代码里检查权限的地方都是相同的，只需要检查具体权限，无需关心上层概念。</li>
<li><strong>在运行时进行更改</strong>，由于权限检查代码直接与当前代码执行的操作相关，我们可以在应用程序运行时更改那些以权限为基础的上层安全模型中的关联关系，而不需要重构代码就可以使新的安全策略生效。</li>
</ol>
<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>本次的系统以员工管理系统为例，采用前后端分离的思想进行书写</p>
<h4 id="数据设计"><a href="#数据设计" class="headerlink" title="数据设计"></a>数据设计</h4><p>【说明】</p>
<p>这里我是把账户与员工信息独立出来了，因为员工记录，与帐号记录，无必然关系。一个场景举例，维护测试是需要某个帐号登录的。 这个帐号可能是不与员工挂钩的。 员工可能会离职，但是帐号不会离职，会交接。也就是说账户才有权限，而员工本身是没有的。</p>
<p><img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E6%95%B0%E6%8D%AE%E5%BA%93%E7%89%A9%E7%90%86%E6%A8%A1%E5%9E%8B.jpg" alt="数据库物理模型"></p>
<h4 id="Idea创建SpringBoot项目"><a href="#Idea创建SpringBoot项目" class="headerlink" title="Idea创建SpringBoot项目"></a>Idea创建SpringBoot项目</h4><p>可勾选web、lombok、spring security</p>
<p>【注意】lombok的使用得需要：注解 + 安装插件</p>
<h4 id="导入依赖"><a href="#导入依赖" class="headerlink" title="导入依赖"></a>导入依赖</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.projectlombok&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;lombok&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.18.16&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;io.springfox&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;springfox-swagger2&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.9.2&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;io.springfox&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;springfox-swagger-ui&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.9.2&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.alibaba&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;fastjson&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;1.2.28&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.baomidou&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.4.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;io.jsonwebtoken&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;jJWT&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;0.7.0&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;5.1.47&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    </span><br><span class="line">    	&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-starter-test&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<h4 id="搭建目录结构"><a href="#搭建目录结构" class="headerlink" title="搭建目录结构"></a>搭建目录结构</h4><p><img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E9%A1%B9%E7%9B%AE%E7%BB%93%E6%9E%84.jpg" alt="项目结构"></p>
<p>自己按照上面建包</p>
<h4 id="创建实体类"><a href="#创建实体类" class="headerlink" title="创建实体类"></a>创建实体类</h4><p>利用ORM思想，新建实体类，一共是5个实体类，下面贴主要的三个实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel</span>(value = <span class="string">"Account对象"</span>,description = <span class="string">"账号"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Account</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(<span class="string">"账户编号"</span>)</span><br><span class="line">    <span class="meta">@TableId</span>(value = <span class="string">"account_id"</span>,type = IdType.ID_WORKER)</span><br><span class="line">    <span class="keyword">private</span> Long accountId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(<span class="string">"员工编号"</span>)</span><br><span class="line">    <span class="keyword">private</span> Long EmployeeId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(<span class="string">"登录账号"</span>)</span><br><span class="line">    <span class="keyword">private</span> String account;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(<span class="string">"登录密码"</span>)</span><br><span class="line">    <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(<span class="string">"是否是测试号"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer isTest;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(<span class="string">"账号状态 1表示启用，0表示禁用"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer status;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(<span class="string">"逻辑删除 1表示已删除， 0表示未删除"</span>)</span><br><span class="line">    <span class="meta">@TableLogic</span></span><br><span class="line">    <span class="keyword">private</span> Integer isDeleted;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(<span class="string">"创建时间"</span>)</span><br><span class="line">    <span class="meta">@TableField</span>(fill = FieldFill.INSERT)</span><br><span class="line">    <span class="keyword">private</span> Date gmtCreate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(<span class="string">"更新时间"</span>)</span><br><span class="line">    <span class="meta">@TableField</span>(fill = FieldFill.INSERT_UPDATE)</span><br><span class="line">    <span class="keyword">private</span> Date gmtModified;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel</span>(value=<span class="string">"Permission对象"</span>, description=<span class="string">"权限"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Permission</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"权限编号"</span>)</span><br><span class="line">    <span class="meta">@TableId</span>(value = <span class="string">"permission_id"</span>,type = IdType.ID_WORKER)</span><br><span class="line">    <span class="keyword">private</span> Long permissionId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"父节点(所属上级)"</span>)</span><br><span class="line">    <span class="keyword">private</span> Long parentId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"权限标识符"</span>)</span><br><span class="line">    <span class="keyword">private</span> String permissionCode;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"权限名称"</span>)</span><br><span class="line">    <span class="keyword">private</span> String permissionName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"类型(1:菜单, 2:按钮)"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer permissionType;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"图标"</span>)</span><br><span class="line">    <span class="keyword">private</span> String permissionIcon;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"请求地址(访问路径)"</span>)</span><br><span class="line">    <span class="keyword">private</span> String permissionUrl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 以下两个属性，是数据库没有的，为了方便做递归操作而建的</span></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"层级"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer level;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"下级"</span>)</span><br><span class="line">    <span class="keyword">private</span> List&lt;Permission&gt; children;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"创建时间"</span>)</span><br><span class="line">    <span class="meta">@TableField</span>(fill = FieldFill.INSERT)</span><br><span class="line">    <span class="keyword">private</span> Date gmtCreate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"更新时间"</span>)</span><br><span class="line">    <span class="meta">@TableField</span>(fill = FieldFill.INSERT_UPDATE)</span><br><span class="line">    <span class="keyword">private</span> Date gmtModified;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@ApiModel</span>(value = <span class="string">"role对象"</span>,description = <span class="string">"角色"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Role</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"角色编号"</span>)</span><br><span class="line">    <span class="meta">@TableId</span>(value = <span class="string">"role_id"</span>,type = IdType.ID_WORKER)</span><br><span class="line">    <span class="keyword">private</span> Long roleId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"角色类型"</span>)</span><br><span class="line">    <span class="keyword">private</span> String roleType;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"角色描述"</span>)</span><br><span class="line">    <span class="keyword">private</span> String roleDescription;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"创建时间"</span>)</span><br><span class="line">    <span class="meta">@TableField</span>(fill = FieldFill.INSERT)</span><br><span class="line">    <span class="keyword">private</span> Date gmtCreate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"更新时间"</span>)</span><br><span class="line">    <span class="meta">@TableField</span>(fill = FieldFill.INSERT_UPDATE)</span><br><span class="line">    <span class="keyword">private</span> Date gmtModified;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="配置MyBatis-Plus的自动填充功能"><a href="#配置MyBatis-Plus的自动填充功能" class="headerlink" title="配置MyBatis Plus的自动填充功能"></a>配置MyBatis Plus的自动填充功能</h4><p>项目中经常会遇到一些数据，每次都使用相同的方式填充，例如记录的创建时间，更新时间等。上述实体类中被@TableField就是实现自动填充的步骤之一。我们可以使用MyBatis Plus的自动填充功能，完成这些字段的赋值工作，每次插入或更新操作，都会自动帮我们填充值。</p>
<ol>
<li><p>在实体类中的<code>gmtCreate</code>和<code>gmtModified</code>上添加注解(上面已经添加了)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@TableField</span>(fill = FieldFill.INSERT)</span><br><span class="line"><span class="keyword">private</span> Date gmtCreate;</span><br><span class="line"></span><br><span class="line"><span class="meta">@TableField</span>(fill = FieldFill.INSERT_UPDATE)</span><br><span class="line"><span class="keyword">private</span> Date gmtModified;</span><br></pre></td></tr></table></figure>
</li>
<li><p>实现元对象处理器接口，这样自动填充功能才能生效</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hbp.servicebase.handler;</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMetaObjectHandler</span> <span class="keyword">implements</span> <span class="title">MetaObjectHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertFill</span><span class="params">(MetaObject metaObject)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setFieldValByName(<span class="string">"gmtCreate"</span>,<span class="keyword">new</span> Date(),metaObject);</span><br><span class="line">        <span class="keyword">this</span>.setFieldValByName(<span class="string">"gmtModified"</span>,<span class="keyword">new</span> Date(),metaObject);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateFill</span><span class="params">(MetaObject metaObject)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setFieldValByName(<span class="string">"gmtModified"</span>,<span class="keyword">new</span> Date(),metaObject);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h4 id="配置yaml"><a href="#配置yaml" class="headerlink" title="配置yaml"></a>配置yaml</h4><p>resources目录下删除application.properties，新建 application.ymal</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 服务端口</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8000</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost/employee?useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">6666</span></span><br><span class="line">  <span class="comment"># 默认情况下json时间格式带有时区，并且是世界标准时间，和我们的时间差了八个小时</span></span><br><span class="line">  <span class="comment"># 定义返回json的全局时间格式</span></span><br><span class="line">  <span class="attr">jackson:</span></span><br><span class="line">    <span class="attr">date-format:</span> <span class="string">yyyy-MM-dd</span> <span class="string">HH:mm:ss</span></span><br><span class="line">    <span class="attr">time-zone:</span> <span class="string">GMT+8</span></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis-plus:</span></span><br><span class="line">  <span class="attr">configuration:</span></span><br><span class="line">    <span class="comment"># mybatis日志，打印sql信息</span></span><br><span class="line">    <span class="attr">log-impl:</span> <span class="string">org.apache.ibatis.logging.stdout.StdOutImpl</span></span><br><span class="line">    <span class="comment"># 驼峰命名开启</span></span><br><span class="line">    <span class="attr">map-underscore-to-camel-case:</span> <span class="literal">true</span></span><br><span class="line">  <span class="comment"># mapper接口与其.xml文件绑定，因为他们在不同的路径上，classpath是指编译生成的classes包下的</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:**/mapper/*.xml</span></span><br><span class="line">  <span class="comment"># 实体别名 这样在mapper.xml中resultType就不用写全限定名，可以直接使用实体类的类名</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.hbp.spring_security.entity</span></span><br></pre></td></tr></table></figure>

<h4 id="统一接口返回格式"><a href="#统一接口返回格式" class="headerlink" title="统一接口返回格式"></a>统一接口返回格式</h4><h5 id="新建接口定义返回状态码"><a href="#新建接口定义返回状态码" class="headerlink" title="新建接口定义返回状态码"></a>新建接口定义返回状态码</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hbp.spring_security.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResultCode</span> </span>&#123;</span><br><span class="line">	<span class="comment">//成功状态码</span></span><br><span class="line">    Integer SUCCESS = <span class="number">20000</span>;</span><br><span class="line">    <span class="comment">//失败状态码</span></span><br><span class="line">    Integer ERROR = <span class="number">20001</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="新建统一返回数据类"><a href="#新建统一返回数据类" class="headerlink" title="新建统一返回数据类"></a>新建统一返回数据类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Result</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"是否成功"</span>)</span><br><span class="line">    <span class="keyword">private</span> Boolean success;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"状态码"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer code;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"返回信息"</span>)</span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ApiModelProperty</span>(value = <span class="string">"返回数据"</span>)</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,Object&gt; data = <span class="keyword">new</span> HashMap&lt;String,Object&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 构造函数私有化</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">Result</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//成功的静态方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Result <span class="title">ok</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Result result = <span class="keyword">new</span> Result();</span><br><span class="line">        result.setCode(ResultCode.SUCCESS);</span><br><span class="line">        result.setSuccess(<span class="keyword">true</span>);</span><br><span class="line">        result.setMessage(<span class="string">"成功"</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//失败的静态方法</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Result <span class="title">error</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Result result = <span class="keyword">new</span> Result();</span><br><span class="line">        result.setCode(ResultCode.ERROR);</span><br><span class="line">        result.setSuccess(<span class="keyword">false</span>);</span><br><span class="line">        result.setMessage(<span class="string">"失败"</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">success</span><span class="params">(Boolean success)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setSuccess(success);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">code</span><span class="params">(Integer code)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setCode(code);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">message</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setMessage(message);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">data</span><span class="params">(Map&lt;String,Object&gt; map)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setData(map);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">data</span><span class="params">(String key, Object value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.data.put(key,value);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h4><p>测试以上搭建是否成功，且能否连接到数据库</p>
<h5 id="先把spring-security的依赖注释掉"><a href="#先把spring-security的依赖注释掉" class="headerlink" title="先把spring security的依赖注释掉"></a>先把spring security的依赖注释掉</h5><h5 id="插入数据到数据库"><a href="#插入数据到数据库" class="headerlink" title="插入数据到数据库"></a>插入数据到数据库</h5><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`account`</span> <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="literal">NULL</span>, <span class="string">'admin'</span>, <span class="string">'$2a$10$R.LqnppeElBgJk7AeAxmFu619FxQKjCsQhWgPfmQtZcUSlTH1oMom'</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="string">'2021-05-25 09:30:20'</span>, <span class="string">'2021-05-25 09:30:23'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`account`</span> <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="literal">NULL</span>, <span class="string">'1111'</span>, <span class="string">'$2a$10$nmCddNZgsAcGCGXPU0R1dunaLQa5tivxpwj8rg.72EPLhM96Vvh42'</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="string">'2021-05-28 14:40:58'</span>, <span class="string">'2021-05-28 14:41:01'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`role`</span> <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="string">'超级管理员'</span>, <span class="string">'拥有系统所有权限'</span>, <span class="string">'2021-05-27 14:07:11'</span>, <span class="string">'2021-05-27 14:07:14'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`role`</span> <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="string">'普通员工'</span>, <span class="string">'测试而已，啥权限也没有'</span>, <span class="string">'2021-05-28 14:41:36'</span>, <span class="string">'2021-05-28 14:41:39'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`account_role`</span> <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="string">'2021-05-27 14:11:09'</span>, <span class="string">'2021-05-27 14:11:11'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`account_role`</span> <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">2</span>, <span class="number">2</span>, <span class="string">'2021-05-28 14:42:42'</span>, <span class="string">'2021-05-28 14:42:46'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`permission`</span> <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">0</span>, <span class="string">'系统所有权限'</span>, <span class="number">1</span>, <span class="string">'all'</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="string">'2021-05-27 11:16:42'</span>, <span class="string">'2021-05-27 11:16:44'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`permission`</span> <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="string">'员工管理'</span>, <span class="number">1</span>, <span class="string">'employee:list'</span>, <span class="string">'api/employee'</span>, <span class="literal">NULL</span>, <span class="string">'2021-05-27 11:19:30'</span>, <span class="string">'2021-05-27 11:19:33'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`permission`</span> <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">2</span>, <span class="string">'员工添加'</span>, <span class="number">2</span>, <span class="string">'employee:add'</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="string">'2021-05-27 11:45:40'</span>, <span class="string">'2021-05-27 11:45:42'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`permission`</span> <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="number">2</span>, <span class="string">'员工编辑'</span>, <span class="number">2</span>, <span class="string">'employee:edit'</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="string">'2021-05-27 11:46:30'</span>, <span class="string">'2021-05-27 11:46:33'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`permission`</span> <span class="keyword">VALUES</span> (<span class="number">5</span>, <span class="number">2</span>, <span class="string">'员工删除'</span>, <span class="number">2</span>, <span class="string">'employee:delete'</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="string">'2021-05-27 11:46:56'</span>, <span class="string">'2021-05-27 11:46:58'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`permission`</span> <span class="keyword">VALUES</span> (<span class="number">6</span>, <span class="number">1</span>, <span class="string">'角色管理'</span>, <span class="number">1</span>, <span class="string">'role:list'</span>, <span class="string">'api/role'</span>, <span class="literal">NULL</span>, <span class="string">'2021-05-27 11:48:54'</span>, <span class="string">'2021-05-27 11:48:56'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`permission`</span> <span class="keyword">VALUES</span> (<span class="number">8</span>, <span class="number">6</span>, <span class="string">'角色新增'</span>, <span class="number">2</span>, <span class="string">'role:add'</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="string">'2021-05-27 11:50:07'</span>, <span class="string">'2021-05-27 11:50:09'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`permission`</span> <span class="keyword">VALUES</span> (<span class="number">9</span>, <span class="number">6</span>, <span class="string">'角色编辑'</span>, <span class="number">2</span>, <span class="string">'role:edit'</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="string">'2021-05-27 11:50:32'</span>, <span class="string">'2021-05-27 11:50:34'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`permission`</span> <span class="keyword">VALUES</span> (<span class="number">10</span>, <span class="number">6</span>, <span class="string">'角色删除'</span>, <span class="number">2</span>, <span class="string">'role:delete'</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="string">'2021-05-27 13:34:44'</span>, <span class="string">'2021-05-27 13:34:49'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`permission_role`</span> <span class="keyword">VALUES</span> (<span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="string">'2021-05-27 14:11:56'</span>, <span class="string">'2021-05-27 14:11:59'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`permission_role`</span> <span class="keyword">VALUES</span> (<span class="number">2</span>, <span class="number">1</span>, <span class="number">3</span>, <span class="string">'2021-05-28 09:21:46'</span>, <span class="string">'2021-05-28 09:21:49'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`permission_role`</span> <span class="keyword">VALUES</span> (<span class="number">3</span>, <span class="number">1</span>, <span class="number">4</span>, <span class="string">'2021-05-28 09:21:54'</span>, <span class="string">'2021-05-28 09:21:58'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`permission_role`</span> <span class="keyword">VALUES</span> (<span class="number">4</span>, <span class="number">2</span>, <span class="number">7</span>, <span class="string">'2021-05-28 14:43:08'</span>, <span class="string">'2021-05-28 14:43:11'</span>);</span><br></pre></td></tr></table></figure>

<p><img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E6%9D%83%E9%99%90%E8%A1%A8.jpg" alt="权限表"></p>
<h5 id="mapper层"><a href="#mapper层" class="headerlink" title="mapper层"></a>mapper层</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">Account</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="service层"><a href="#service层" class="headerlink" title="service层"></a>service层</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hbp.spring_security.service;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccountService</span> <span class="keyword">extends</span> <span class="title">IService</span>&lt;<span class="title">Account</span>&gt; </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hbp.spring_security.service.impl;</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">AccountMapper</span>, <span class="title">Account</span>&gt; <span class="keyword">implements</span> <span class="title">AccountService</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="controller层"><a href="#controller层" class="headerlink" title="controller层"></a>controller层</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/api"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountContrller</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok().message(<span class="string">"测试成功"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="启动类"><a href="#启动类" class="headerlink" title="启动类"></a>启动类</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="comment">// 该注解默认会扫描该类所在的包下所有的配置类</span></span><br><span class="line"><span class="meta">@ComponentScan</span>(basePackages = <span class="string">"com.hbp"</span>)</span><br><span class="line"><span class="meta">@MapperScan</span>(<span class="string">"com.hbp.spring_security.mapper"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServiceLoginAclApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ServiceLoginAclApplication<span class="class">.<span class="keyword">class</span>,<span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="运行项目"><a href="#运行项目" class="headerlink" title="运行项目"></a>运行项目</h5><p>访问地址：localhost:8000/api/test 可以看到成功后返回的json数据</p>
<h2 id="整合Spring-Security"><a href="#整合Spring-Security" class="headerlink" title="整合Spring Security"></a>整合Spring Security</h2><h3 id="添加启动器"><a href="#添加启动器" class="headerlink" title="添加启动器"></a>添加启动器</h3><p>在SpringBoot中想要使用SpringSecurity，只要添加SpringSecurity的启动器即可。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个依赖在最初给的pom中已经有了，不过给注释了，取消掉就可以，其余什么都不用做。</p>
<h3 id="启动项目"><a href="#启动项目" class="headerlink" title="启动项目"></a>启动项目</h3><p>启动完成后，我们访问<a href="http://localhost:8000或者其中的任何接口，都会重定向到spring" target="_blank" rel="noopener">http://localhost:8000或者其中的任何接口，都会重定向到spring</a> security内置的登录页面。</p>
<p><img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E5%86%85%E7%BD%AE%E7%99%BB%E5%BD%95%E9%A1%B5.jpg" alt="内置登录页"></p>
<p>SpringSecurity默认的用户名是user，密码则在启动项目时会打印在控制台上。登录成功后会跳转到404页面(因为我们没有写页面)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Using generated security password: <span class="number">4370239</span>d-<span class="number">1e54</span>-<span class="number">4231</span>-b0ff-cd6e3711fa9d</span><br></pre></td></tr></table></figure>

<p>每次启动都会分配不一样的密码。SpringSecurity同样支持自定义密码，只要在application.yml中简单配置一下即可。一旦自定义了密码，控制台就不会生成随机密码了（这一块了解即可，测试完后删除掉，以免影响后续代码，导致一些错误）</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">security:</span></span><br><span class="line">  <span class="attr">user:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123</span></span><br></pre></td></tr></table></figure>

<h3 id="讲解说明"><a href="#讲解说明" class="headerlink" title="讲解说明"></a>讲解说明</h3><p>以下方式采用先讲原理，再贴代码，分3个大功能去讲</p>
<ol>
<li>认证</li>
<li>授权</li>
<li>会话</li>
</ol>
<h3 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h3><h4 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h4><p>Spring Security所解决的问题就是<strong>安全访问控制</strong>，而安全访问控制功能其实就是对所有进入系统的请求进行拦截， 校验每个请求是否能够访问它所期望的资源。根据前边知识的学习，可以通过Filter或AOP等技术来实现，Spring Security对Web资源的保护是靠Filter实现的，所以从这个Filter来入手，逐步深入Spring Security原理。</p>
<p>当初始化Spring Security时，会创建一个名为 SpringSecurityFilterChain 的Servlet过滤器，类型为 <code>org.springframework.security.web.FilterChainProxy</code>，它实现了javax.servlet.Filter，因此外部的请求会经过此 类，下图是Spring Security过虑器链结构图：</p>
<p><img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE.jpg" alt="过滤器链"></p>
<p>为什么会有这么多Filter呢？因为它不光要检验用户认证，还有权限。FilterChainProxy是一个代理，真正起作用的是FilterChainProxy中SecurityFilterChain所包含的各个Filter，同时这些Filter作为Bean被Spring管理，它们是Spring Security核心，各有各的职责，但他们并不直接处理用户的<strong>认证</strong>，也不直接处理用户的<strong>授权</strong>，而是把它们交给了认证管理器（AuthenticationManager）和决策管理器 （AccessDecisionManager）进行处理。所以Spring security是基于过滤器链的方式来过滤用户的请求，但最终检验用户身份和权限的是认证管理器和决策管理器。</p>
<blockquote>
<p> spring Security功能的实现主要是由一系列过滤器链相互配合完成。</p>
</blockquote>
<p><img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E8%BF%87%E6%BB%A4%E9%93%BE%E8%AF%A6%E7%BB%86.jpg" alt="过滤链详细"></p>
<p>下面介绍过滤器链中主要的几个过滤器及其作用：</p>
<ul>
<li><strong>SecurityContextPersistenceFilter</strong> 这个Filter是整个拦截过程的入口和出口（也就是第一个和最后一个拦截 器），会在请求开始时从配置好的 SecurityContextRepository 中获取 SecurityContext，然后把它设置给 SecurityContextHolder。在请求完成后将 SecurityContextHolder 持有的 SecurityContext 再保存到配置好的 SecurityContextRepository，同时清除 securityContextHolder 所持有的 SecurityContext</li>
<li><strong>UsernamePasswordAuthenticationFilter</strong> 用于处理来自表单提交的认证，即登录。它是通过调用AuthenticationManager来进行用户认证的，该表单必须提供对应的用户名和密码，其内部还有登录成功或失败后进行处理的 AuthenticationSuccessHandler 和 AuthenticationFailureHandler，这些都可以根据需求做相关改变； </li>
<li><strong>FilterSecurityInterceptor</strong> 是用于保护web资源的，即授权，它是通过调用AccessDecisionManager对当前用户进行授权访问</li>
<li><strong>ExceptionTranslationFilter</strong> 能够捕获来自 FilterChain 所有的异常，并进行处理。但是它只会处理两类异常： AuthenticationException 和 AccessDeniedException，其它的异常它会继续抛出。 </li>
</ul>
<h4 id="用户认证流程"><a href="#用户认证流程" class="headerlink" title="用户认证流程"></a>用户认证流程</h4><p><img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B.jpg" alt="认证流程"></p>
<p>让我们仔细分析认证过程： </p>
<ol>
<li><p>用户提交用户名、密码被SecurityFilterChain中的 UsernamePasswordAuthenticationFilter 过滤器获取到， 封装为请求Authentication，通常情况下是UsernamePasswordAuthenticationToken这个实现类。 </p>
</li>
<li><p>然后过滤器将Authentication提交至认证管理器（AuthenticationManager）进行认证 </p>
</li>
<li><p>认证管理器又委托它的实现类为ProviderManager，ProviderManager维护着一个 List<authenticationprovider> 列表，存放多种认证方式，只要经过其中一个即可，最终实际的认证工作是由 ….AuthenticationProvider完成的。而web表单的对应的实现类为 DaoAuthenticationProvider，它的内部又维护着一个UserDetailsService负责UserDetails的获取。</authenticationprovider></p>
</li>
<li><p>如果成功拿到了UserDetails（从数据库查出的用户身份信息）就要进行密码校验，拿用户输入的密码与UserDetails里的密码通过PasswordEncoder密码编码器进行比对，认证通过后， AuthenticationProvider将UserDetails填充至Authentication。可以看出AuthenticationManager接口（认证管理器）是认证相关的核心接口，也是发起认证的出发点</p>
</li>
<li><p>认证成功后， AuthenticationManager 身份管理器返回一个被填充满了信息的（包括上面提到的权限信息，身份信息，细节信息，但密码通常会被移除） Authentication 实例。 </p>
</li>
<li><p>SecurityContextHolder 安全上下文容器将第4步填充了信息的 Authentication ，通过 SecurityContextHolder.getContext().setAuthentication(…)方法，设置到其中。 </p>
</li>
</ol>
<p><strong>认证核心组件的大体关系如下：</strong></p>
<p><img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E8%AE%A4%E8%AF%81%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6.jpg" alt="认证核心组件"></p>
<h5 id="AuthenticationProvider"><a href="#AuthenticationProvider" class="headerlink" title="AuthenticationProvider"></a><strong>AuthenticationProvider</strong></h5><p>通过前面的认证流程我们得知，认证管理器（AuthenticationManager）委托 AuthenticationProvider完成认证工作。 AuthenticationProvider是一个接口，定义如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AuthenticationProvider</span> </span>&#123; </span><br><span class="line">    <span class="function">Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span> <span class="keyword">throws</span> AuthenticationException</span>; </span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; var1)</span></span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>authenticate()</strong>方法定义了<strong>认证的实现过程</strong>，它的参数是一个Authentication，里面包含了登录用户所提交的用 户、密码等。而返回值也是一个Authentication，这个Authentication则是在认证成功后，将用户的权限及其他信息重新组装后生成。 </p>
<p>Spring Security中维护着一个 List<authenticationprovider> 列表，存放多种认证方式，不同的认证方式使用不同的AuthenticationProvider。如使用用户名密码登录时，使用AuthenticationProvider1，短信登录时使用 AuthenticationProvider2等等这样的例子很多。 </authenticationprovider></p>
<p>每个AuthenticationProvider需要实现 <strong>supports()</strong> 方法来表明自己支持的认证方式，如我们使用表单方式认证， 在提交请求时Spring Security会生成UsernamePasswordAuthenticationToken，它是一个Authentication，里面封装着用户提交的用户名、密码信息。而对应的，哪个AuthenticationProvider来处理它。</p>
<p>我们在<strong>DaoAuthenticationProvider</strong>的基类AbstractUserDetailsAuthenticationProvider发现以下代码：即他是通过账户密码的方式进行认证，当然还有别的，比如短信认证</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; authentication)</span> </span>&#123; </span><br><span class="line">    <span class="keyword">return</span> UsernamePasswordAuthenticationToken<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">authentication</span>)</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后，我们来看一下<strong>Authentication</strong>(认证信息)的结构，它是一个接口，我们之前提到的 UsernamePasswordAuthenticationToken就是它的实现之一：</p>
<p>Authentication是spring security包中的接口，直接继承自Principal类，而Principal是位于 java.security包中的。它是表示着一个抽象主体身份，任何主体都有一个名称，因此包含一个getName()方法。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Authentication</span> <span class="keyword">extends</span> <span class="title">Principal</span>, <span class="title">Serializable</span> </span>&#123; </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 权限信息列表，默认是GrantedAuthority接口的一些实现类，通常是代表权限信息的一系列字符串。</span></span><br><span class="line">    Collection&lt;? extends GrantedAuthority&gt; getAuthorities(); </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// // 凭证信息，用户输入的密码字符串，在认证过后通常会被移除，用于保障安全。</span></span><br><span class="line">    <span class="function">Object <span class="title">getCredentials</span><span class="params">()</span></span>; </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 细节信息，web应用中的实现接口通常为 WebAuthenticationDetails，它记录了访问者的ip地址和sessionId的值</span></span><br><span class="line">    <span class="function">Object <span class="title">getDetails</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 身份信息，大部分情况下返回的是UserDetails接口的实现类，UserDetails代表用户的详细信息，那从Authentication中取出来的UserDetails就是当前登录用户信息，它也是框架中的常用接口之一。 </span></span><br><span class="line">    <span class="function">Object <span class="title">getPrincipal</span><span class="params">()</span></span>; </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAuthenticated</span><span class="params">()</span></span>; </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setAuthenticated</span><span class="params">(<span class="keyword">boolean</span> var1)</span> <span class="keyword">throws</span> IllegalArgumentException</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="UserDetailsService（一般需要我们自定义实现）"><a href="#UserDetailsService（一般需要我们自定义实现）" class="headerlink" title="UserDetailsService（一般需要我们自定义实现）"></a>UserDetailsService（一般需要我们自定义实现）</h5><p>因为上面的认证流程中，我们可以看到<code>UsernamePasswordAuthenticationFilter</code>和<code>DaoAuthenticationProvider</code>是非常关键的，而他们内部的逻辑是完整且复杂的，所以我们一般不会对他们俩进行自定义，而它整个流程中，是再调用UserDetailsService里的方法：<code>loadUserByUsername</code>进行查询用户的信息，因此我们可以<strong>通过UserDetailsService来自定义登录逻辑</strong>，实现里面的方法进行我们的查询数据库信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetailsService</span> </span>&#123; </span><br><span class="line">    <span class="function">UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException</span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>【注意】这里再明确一下，别把DaoAuthenticationProvider和UserDetailsService的职责搞混淆，其实UserDetailsService只负责从特定的地方（通常是数据库）加载用户信息，仅此而已。而DaoAuthenticationProvider的职责更大，它完成完整的认证流程，同时会把UserDetails填充至Authentication。 </p>
<p>而UserDetailsService口中返回的<strong>UserDetails</strong>，它是用户的信息，它同样是一个接口，一般真实开发中，<strong>也是要去实现它</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetails</span> <span class="keyword">extends</span> <span class="title">Serializable</span> </span>&#123; </span><br><span class="line">    Collection&lt;? extends GrantedAuthority&gt; getAuthorities(); </span><br><span class="line">    </span><br><span class="line">    <span class="function">String <span class="title">getPassword</span><span class="params">()</span></span>; </span><br><span class="line">    <span class="function">String <span class="title">getUsername</span><span class="params">()</span></span>; </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAccountNonExpired</span><span class="params">()</span></span>; </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isAccountNonLocked</span><span class="params">()</span></span>; </span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isCredentialsNonExpired</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span></span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>它和Authentication接口很类似，比如它们都拥有username，authorities。要注意Authentication的getCredentials()与 UserDetails中的getPassword()需要被区分对待，前者是用户提交的密码凭证，后者是用户实际存储的密码，认证密码其实就是对这两者的比对。Authentication中的getAuthorities()实际是由UserDetails的getAuthorities()传递而形成的。还记得Authentication接口中的getDetails()方法吗？其中的UserDetails用户详细信息便是经过了 AuthenticationProvider认证之后被填充的。</p>
<p><strong>通过实现UserDetailsService和UserDetails，我们可以完成对用户信息获取方式以及用户信息字段的扩展。</strong> </p>
<p>Spring Security提供的InMemoryUserDetailsManager(内存认证)，JdbcUserDetailsManager(jdbc认证)就是 UserDetailsService的实现类，主要区别无非就是从内存还是从数据库加载用户。</p>
<h5 id="PasswordEncoder"><a href="#PasswordEncoder" class="headerlink" title="PasswordEncoder"></a><strong>PasswordEncoder</strong></h5><p>DaoAuthenticationProvider认证处理器通过UserDetailsService获取到UserDetails后，它是如何与请求Authentication中的密码做对比呢？ </p>
<p>在这里Spring Security为了适应多种多样的加密类型，又做了抽象，DaoAuthenticationProvider通过 PasswordEncoder接口的matches方法进行密码的对比，而具体的密码对比细节取决于实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PasswordEncoder</span> </span>&#123;</span><br><span class="line">   <span class="comment">// 把客户端的密码按照特定的编码规则进行加密。这里传入的参数是客户端的密码</span></span><br><span class="line">   <span class="function">String <span class="title">encode</span><span class="params">(CharSequence rawPassword)</span></span>;</span><br><span class="line">    </span><br><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment">    验证从数据库中获取的密码与编码(加密)后的密码是否匹配。如果密码匹配，</span></span><br><span class="line"><span class="comment">    则返回 true；如果不匹配，则返回 false。</span></span><br><span class="line"><span class="comment">    第一个参数表示需要被解析的密码（客户端密码）。第二个参数表示数据库存储的密码。</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(CharSequence rawPassword, String encodedPassword)</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 如果能够二次加密则返回 true，否则返回 false。默认返回 false。比较少用到 </span></span><br><span class="line">   <span class="function"><span class="keyword">default</span> <span class="keyword">boolean</span> <span class="title">upgradeEncoding</span><span class="params">(String encodedPassword)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h6 id="内置编码器介绍"><a href="#内置编码器介绍" class="headerlink" title="内置编码器介绍"></a>内置编码器介绍</h6><p>在 Spring Security 中内置了很多关于加密的编码器，即接口PasswordEncoder的实现类，官方推荐的编码器为BCryptPasswordEncoder，我们一般也是选用这个编码器。</p>
<p>BCryptPasswordEncoder 是对 bcrypt 强散列方法的具体实现。是基于Hash算法实现的单向加密。可以通过strength控制加密强度，默认10</p>
<p><strong>Spring Security 要求容器中必须有 PasswordEncoder 实例。所以当自定义登录逻辑(UserDetailsService)时要求必须给容器注入 PaswordEncoder 的bean对象</strong></p>
<p>在安全配置类SecurityConfig中注入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在测试类中进行测试一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">contextLoads</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    PasswordEncoder pw = <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    <span class="comment">//加密</span></span><br><span class="line">    String encode01 = pw.encode(<span class="string">"123"</span>);</span><br><span class="line">    System.out.println(encode01);</span><br><span class="line"></span><br><span class="line">    String encode02 = pw.encode(<span class="string">"123"</span>);</span><br><span class="line">    System.out.println(encode02);</span><br><span class="line">    <span class="comment">//判断原字符和加密后内容是否匹配</span></span><br><span class="line">    <span class="keyword">boolean</span> matches01 = pw.matches(<span class="string">"123"</span>, encode01);</span><br><span class="line">    <span class="keyword">boolean</span> matches02 = pw.matches(<span class="string">"123"</span>, encode02);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">"密码比较结果"</span>);</span><br><span class="line">    System.out.println(matches01);</span><br><span class="line">    System.out.println(matches02);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">控制台输出：</span><br><span class="line">$<span class="number">2</span>a$<span class="number">10</span>$UGxtrKWr6ikqo6TInFnD3uxZ2FsJ/dFoFEYSGsFfv2D1bK60RILPK</span><br><span class="line">$<span class="number">2</span>a$<span class="number">10</span>$nmCddNZgsAcGCGXPU0R1dunaLQa5tivxpwj8rg<span class="number">.72</span>EPLhM96Vvh42</span><br><span class="line">密码比较结果</span><br><span class="line"><span class="keyword">true</span></span><br><span class="line"><span class="keyword">true</span></span><br></pre></td></tr></table></figure>

<p>从这里我们可以看出来，每次加密后的值都是不一样的，但是解密出的结果却是一样的</p>
<h5 id="总结："><a href="#总结：" class="headerlink" title="总结："></a>总结：</h5><p>登录验证就是拿到客户端的用户名密码和我们查到的的用户名密码（即<code>UserDetails</code>的实现类）进行比对，拿到<strong>我们查找到的用户名密码是经过<code>UserDetailsService.loadUserByUsername(String userName)</code>实现的</strong>，框架实现的<code>UserDetailsService</code>通常无法知足项目要求，就须要本身手动实现了，同时若是框架自带的<code>UserDetails</code>的实现类无法知足要求咱们也能够本身实现UserDetails。<code>UserDetail</code>是<code>SpringSecurity</code>和应用之间的桥梁，无论你数据库怎么建，只要你最后将用户信息和权限的关系封装为<code>UserDetails</code>，<code>SpringSecurity</code>就能够按它本身的机制进行权限校验。</p>
<h4 id="用户认证整合"><a href="#用户认证整合" class="headerlink" title="用户认证整合"></a>用户认证整合</h4><p>这处是实操，非原理讲解</p>
<h5 id="自定义用户信息"><a href="#自定义用户信息" class="headerlink" title="自定义用户信息"></a>自定义用户信息</h5><p>前面我们登录都是用的指定的用户名和密码或者是springsecurity默认的用户名和打印出来的密码。我们要想连接上自定义数据库只需要实现一个自定义的UserDetailsService</p>
<p>【<strong>说明</strong>】UserDetailsService接口返回的是UserDetails，根据自己的需求来选择是否需要自定义实体类，并实现UserDetails，UserDetails封装的是从数据库中查出来的数据</p>
<p>我们这里就新建MyAccountDetails</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAccountDetails</span> <span class="keyword">implements</span> <span class="title">UserDetails</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自己定义的账户实体类，账户的信息</span></span><br><span class="line">    <span class="keyword">private</span> Account account;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用户权限的集合</span></span><br><span class="line">    <span class="meta">@JsonIgnore</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;GrantedAuthority&gt; authorities;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;String&gt; <span class="title">getRoles</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> authorities.stream().map(GrantedAuthority::getAuthority).collect(Collectors.toList());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 数据库里的密码</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPassword</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> account.getPassword();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 用户名 </span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> account.getAccount();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否过期</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccountNonExpired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 是否锁定</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isAccountNonLocked</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 凭证是否过期</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCredentialsNonExpired</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 是否可用</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="把该账户对应的权限查询出来"><a href="#把该账户对应的权限查询出来" class="headerlink" title="把该账户对应的权限查询出来"></a>把该账户对应的权限查询出来</h5><ol>
<li><p>mapper包新建PermissionMapper接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PermissionMapper</span> <span class="keyword">extends</span> <span class="title">BaseMapper</span>&lt;<span class="title">Permission</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">List&lt;Permission&gt; <span class="title">findPermissionsByAccountId</span><span class="params">(Long accountId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>resources/mapper新建xml文件对应mapper接口</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.hbp.spring_security.mapper.PermissionMapper"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--把字段提取出来--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sql</span> <span class="attr">id</span>=<span class="string">"columns"</span>&gt;</span>   	p.permission_id,p.parent_id,p.permission_name,p.permission_icon,p.permission_url,p.permission_type,p.permission_code</span><br><span class="line">    <span class="tag">&lt;/<span class="name">sql</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"findPermissionsByAccountId"</span> <span class="attr">resultType</span>=<span class="string">"permission"</span> <span class="attr">parameterType</span>=<span class="string">"long"</span>&gt;</span></span><br><span class="line">        select distinct</span><br><span class="line">        <span class="tag">&lt;<span class="name">include</span> <span class="attr">refid</span>=<span class="string">"columns"</span>/&gt;</span></span><br><span class="line">        from account_role ar</span><br><span class="line">        inner join permission_role pr on ar.role_id = pr.role_id</span><br><span class="line">        inner join permission p on pr.permission_id = p.permission_id</span><br><span class="line">        where ar.account_id = #&#123;accountId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>service包下新建PermissionService接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PermissionService</span> <span class="keyword">extends</span> <span class="title">IService</span>&lt;<span class="title">Permission</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;Permission&gt; <span class="title">findPermissionsByAccountId</span><span class="params">(Long accountId)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>service/impl/PermissionServiceImpl</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PermissionServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">PermissionMapper</span>, <span class="title">Permission</span>&gt; <span class="keyword">implements</span> <span class="title">PermissionService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Permission&gt; <span class="title">findPermissionsByAccountId</span><span class="params">(Long accountId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> baseMapper.findPermissionsByAccountId(accountId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<hr>
<p>自定义一个UserDetailsServiceImpl实现UserDetailsService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountDetailsServiceImpl</span> <span class="keyword">implements</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountService accountService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PermissionService permissionService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String account)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">// 根据账号获取账户信息</span></span><br><span class="line">        QueryWrapper&lt;Account&gt; wrapper = <span class="keyword">new</span> QueryWrapper&lt;&gt;();</span><br><span class="line">        wrapper.eq(<span class="string">"account"</span>,account);</span><br><span class="line">        Account accountInfo = accountService.getOne(wrapper);</span><br><span class="line">        <span class="keyword">if</span> (accountInfo == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UsernameNotFoundException(<span class="string">"账户不存在"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">"1"</span>.equals(accountInfo.getStatus())) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> LockedException(<span class="string">"账户被禁止，请联系管理员"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 获取账户权限</span></span><br><span class="line">        List&lt;GrantedAuthority&gt; grantedAuthorities = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        List&lt;Permission&gt; permissions = permissionService.findPermissionsByAccountId(accountInfo.getAccountId());</span><br><span class="line">        System.out.println(permissions);</span><br><span class="line">        List&lt;String&gt; collect = permissions.stream().map(Permission::getPermissionCode).collect(Collectors.toList());</span><br><span class="line">        <span class="keyword">for</span>(String permission : collect) &#123;</span><br><span class="line">            <span class="comment">// mybatis数据里的空值和null，在你从未对这个数据修改时，它就是null。如果修改了又删除掉了，它就会是空值</span></span><br><span class="line">            <span class="keyword">if</span> (!(<span class="string">""</span>).equals(permission) &amp;&amp; permission != <span class="keyword">null</span>) &#123;</span><br><span class="line">                SimpleGrantedAuthority grantedAuthority = <span class="keyword">new</span> SimpleGrantedAuthority(permission);</span><br><span class="line">                grantedAuthorities.add(grantedAuthority);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 把数据封装到UserDetails中</span></span><br><span class="line">        MyAccountDetails myAccountDetails = <span class="keyword">new</span> MyAccountDetails(accountInfo, grantedAuthorities);</span><br><span class="line">        <span class="comment">// 方便观察结果</span></span><br><span class="line">        System.out.println(myAccountDetails);</span><br><span class="line">        <span class="keyword">return</span> myAccountDetails;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="加密"><a href="#加密" class="headerlink" title="加密"></a>加密</h5><p>Spring Security 还内置了几种常用的 PasswordEncoder 接口，官方推荐使用的是BCryptPasswordEncoder</p>
<p>新建config包，在其包下新建SecurityConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hbp.spring_security.config;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里如果爆红不用管</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密码处理</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> auth</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        auth.userDetailsService(userDetailsService).passwordEncoder(passwordEncoder());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="生成加密密码"><a href="#生成加密密码" class="headerlink" title="生成加密密码"></a>生成加密密码</h5><p>因为我们前面测试项目时，用的是明文密码存储，引入了Spring Security后，因为配置了加密密码的校验，所以得生成一个加密密码存入数据库</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SpringSecurityApplicationTests</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">createPwd</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        PasswordEncoder pw = <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">        <span class="comment">//加密</span></span><br><span class="line">        String encode01 = pw.encode(<span class="string">"123"</span>);</span><br><span class="line">        System.out.println(encode01);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="测试-1"><a href="#测试-1" class="headerlink" title="测试"></a>测试</h5><p>我们再重启项目，这时候控制台就不再打印密码，现在需要输入数据库中的用户名密码才能登录。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">localhost:<span class="number">8000</span>/login</span><br></pre></td></tr></table></figure>

<p>这里如果输入正确的账号和密码，就会跳转404白页，如果其中有个错误，都不能跳转。</p>
<p>【注意】如果只要输入的账号是在数据库中存在的，那么无论密码正确与否，控制台都会有正确的用户信息返回</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">返回的数据：</span><br><span class="line">MyAccountDetails(account=Account(accountId=<span class="number">1</span>, EmployeeId=<span class="keyword">null</span>, account=admin, password=$<span class="number">2</span>a$<span class="number">10</span>$R.LqnppeElBgJk7AeAxmFu619FxQKjCsQhWgPfmQtZcUSlTH1oMom, isTest=<span class="number">0</span>, status=<span class="number">1</span>, isDeleted=<span class="number">0</span>, gmtCreate=Tue May <span class="number">25</span> <span class="number">09</span>:<span class="number">30</span>:<span class="number">20</span> CST <span class="number">2021</span>, gmtModified=Tue May <span class="number">25</span> <span class="number">09</span>:<span class="number">30</span>:<span class="number">23</span> CST <span class="number">2021</span>), authorities=[all, employee:list, employee:add])</span><br></pre></td></tr></table></figure>

<p><strong>到此，用户认证便已完成</strong></p>
<h5 id="加入授权控制示例，方便后续讲解"><a href="#加入授权控制示例，方便后续讲解" class="headerlink" title="加入授权控制示例，方便后续讲解"></a>加入授权控制示例，方便后续讲解</h5><p>授权管理有2中方式</p>
<ul>
<li><p>方式一：使用注解方式，当有’all’权限时，才能访问这个接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@ResponseBody</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/api"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AccountContrller</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/test"</span>)</span><br><span class="line">    <span class="comment">// 可以用逗号形式加入多个</span></span><br><span class="line">    <span class="meta">@PostAuthorize</span>(<span class="string">"hasAnyAuthority('all')"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Result <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Result.ok().message(<span class="string">"测试成功"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<p>访问：localhost:8000/api/test 此时会跳转到登录页，输入管理员账号密码，可以正确返回json格式数据。输入另一个没有’all’权限的账号，报403(无权限)</p>
</li>
<li><p>方式二：SecurityConfig类中配置拦截处理</p>
<p>通配符有三种：</p>
<ul>
<li>? ：匹配任何单字符</li>
<li>*：匹配0或者任意数量的字符</li>
<li>**：匹配0或者更多的目录</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    http.authorizeRequests()</span><br><span class="line">            .antMatchers(<span class="string">"/api/test"</span>).hasAnyAuthority(<span class="string">"p1"</span>)</span><br><span class="line">            .anyRequest().authenticated() <span class="comment">// 拦截所有请求</span></span><br><span class="line">            .and()</span><br><span class="line">            .formLogin(); <span class="comment">// 开启表单登录</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：与上述一致</p>
</li>
</ul>
<h3 id="授权"><a href="#授权" class="headerlink" title="授权"></a>授权</h3><h4 id="工作原理-1"><a href="#工作原理-1" class="headerlink" title="工作原理"></a>工作原理</h4><p>Spring Security可以通过 http.authorizeRequests() 对web请求进行授权保护。Spring Security使用标准Filter建立了对web请求的拦截，最终实现对资源的授权访问。 </p>
<h5 id="授权流程："><a href="#授权流程：" class="headerlink" title="授权流程："></a>授权流程：</h5><p><img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B.jpg" alt="授权流程"></p>
<p>分析授权流程： </p>
<ol>
<li><p><strong>拦截请求</strong>，已认证用户访问受保护的web资源将被SecurityFilterChain中的 FilterSecurityInterceptor 的子类拦截。 </p>
</li>
<li><p><strong>获取资源访问策略</strong>，FilterSecurityInterceptor会从 SecurityMetadataSource 的子类 DefaultFilterInvocationSecurityMetadataSource 获取要访问当前资源所需要的权限 Collection<configattribute> SecurityMetadataSource其实就是读取访问策略的抽象，而读取的内容，其实就是我们配置的访问规则， 读取访问策略如：</configattribute></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http.authorizeRequests() </span><br><span class="line">    .antMatchers(<span class="string">"/r/r1"</span>).hasAuthority(<span class="string">"p1"</span>) </span><br><span class="line">    .antMatchers(<span class="string">"/r/r2"</span>).hasAuthority(<span class="string">"p2"</span>) ...</span><br></pre></td></tr></table></figure>
</li>
<li><p>最后，FilterSecurityInterceptor会调用 AccessDecisionManager 进行授权决策，若决策通过，则允许访问资源，否则将禁止访问。</p>
</li>
</ol>
<p>AccessDecisionManager（访问决策管理器）的核心接口如下: </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccessDecisionManager</span> </span>&#123; </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 通过传递的参数来鉴定用户是否有访问对应受保护资源的权限</span></span><br><span class="line"><span class="comment">    * Authentication封装了用户的权限信息</span></span><br><span class="line"><span class="comment">    * configAttributes里面则是访问当前资源所需要的权限，即受保护资源的访问策略，通过SecurityMetadataSource获取。</span></span><br><span class="line"><span class="comment">    */</span> </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">decide</span><span class="params">(Authentication authentication , Object object, Collection&lt;ConfigAttribute&gt; configAttributes )</span> <span class="keyword">throws</span> AccessDeniedException, InsufficientAuthenticationException</span>; </span><br><span class="line">    <span class="comment">//略.. </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="授权决策"><a href="#授权决策" class="headerlink" title="授权决策"></a>授权决策</h5><p>AccessDecisionManager采用<strong>投票</strong>的方式来确定是否能够访问受保护资源。 </p>
<p>AccessDecisionManager中的抽象实现包含的一系列AccessDecisionVoter将会被用来对Authentication 是否有权访问受保护对象进行投票，AccessDecisionManager根据投票结果，做出最终决策。 AccessDecisionVoter是一个接口，其中定义有三个方法，具体结构如下所示。 </p>
<p>AccessDecisionVoter是一个接口，其中定义有三个方法，具体结构如下所示。 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccessDecisionVoter</span>&lt;<span class="title">S</span>&gt; </span>&#123; </span><br><span class="line">    <span class="keyword">int</span> ACCESS_GRANTED = <span class="number">1</span>; <span class="comment">// 赞同</span></span><br><span class="line">    <span class="keyword">int</span> ACCESS_ABSTAIN = <span class="number">0</span>; <span class="comment">// 弃权</span></span><br><span class="line">    <span class="keyword">int</span> ACCESS_DENIED = ‐<span class="number">1</span>; <span class="comment">// 拒绝</span></span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(ConfigAttribute var1)</span></span>; </span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; var1)</span></span>; </span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">vote</span><span class="params">(Authentication var1, S var2, Collection&lt;ConfigAttribute&gt; var3)</span></span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>vote()方法的返回结果会是AccessDecisionVoter中定义的三个常量之一。</p>
<p>ACCESS_GRANTED表示同意， ACCESS_DENIED表示拒绝，ACCESS_ABSTAIN表示弃权。如果一个AccessDecisionVoter不能判定当前Authentication是否拥有访问对应受保护对象的权限，则其vote()方法的返回值应当为弃权ACCESS_ABSTAIN。</p>
<p>Spring Security内置了三个基于投票的AccessDecisionManager实现类如下，它们分别是 </p>
<ul>
<li><strong>AffirmativeBased逻辑是：</strong><ul>
<li>只要有AccessDecisionVoter的投票为ACCESS_GRANTED则同意用户进行访问；</li>
<li>如果全部弃权也表示通过；</li>
<li>如果没有一个人投赞成票，但是有人投反对票，则将抛出AccessDeniedException。 Spring security默认使用的是AffirmativeBased。 </li>
</ul>
</li>
<li><strong>ConsensusBased逻辑是：</strong><ul>
<li>如果赞成票多于反对票则表示通过。</li>
<li>反过来，如果反对票多于赞成票则将抛出AccessDeniedException。 </li>
<li>如果赞成票与反对票相同且不等于0，并且属性allowIfEqualGrantedDeniedDecisions的值为true，则表 示通过，否则将抛出异常AccessDeniedException。参数allowIfEqualGrantedDeniedDecisions的值默认为true。</li>
<li>如果所有的AccessDecisionVoter都弃权了，则将视参数allowIfAllAbstainDecisions的值而定，如果该值为true则表示通过，否则将抛出异常AccessDeniedException。参数allowIfAllAbstainDecisions的值默认为false。</li>
</ul>
</li>
<li><strong>UnanimousBased逻辑是：</strong><ul>
<li>跟AffirmativeBased是返过来的</li>
<li>如果受保护对象配置的某一个ConfifigAttribute被任意的AccessDecisionVoter反对了，则将抛出AccessDeniedException。</li>
<li>如果没有反对票，但是有赞成票，则表示通过。</li>
<li>如果全部弃权了，则将视参数allowIfAllAbstainDecisions的值而定，true则通过，false则抛出 AccessDeniedException。 </li>
</ul>
</li>
</ul>
<p><strong>其实就是比对字符串，不能说是投票吧，方法名容易让人误解</strong></p>
<h5 id="总结：-1"><a href="#总结：-1" class="headerlink" title="总结："></a>总结：</h5><p><strong>其实这授权的过程了解即可，因为我们一般都是直接交给spring security自己处理，不会去自定义里面的方法。其实实质就是判断当前的用户所包含的权限列表中是否包含访问指定url所须要的权限，Collection<configattribute>里面的授权值是跟Authentication里的getAuthorities()里的权限进行比较的，而getAuthorities()的类型是GrantedAuthority，里面有个实现类是SimpleGrantedAuthority，这个玩意在我们自定义的UserDetailsService里有写到过，就是根据数据库的授权值生成的</configattribute></strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SimpleGrantedAuthority grantedAuthority = <span class="keyword">new</span> SimpleGrantedAuthority(permission);</span><br></pre></td></tr></table></figure>

<h4 id="用户授权整合"><a href="#用户授权整合" class="headerlink" title="用户授权整合"></a>用户授权整合</h4><p>SpringSecurity会自动帮我们进行权限控制。而我们要做的就是在需要进行权限控制的方法上添加上权限标识即可。</p>
<p>在相关的全部接口上加上@PreAuthorize(“hasAnyAuthority(‘user:list’)”)即可，当然也可以在配置类的设置，这样我们就实现了授权管理了。但是到这里还会存在一些问题，比如未授权时所访问的页面是如何的等等，后续会讲到。</p>
<h2 id="JWT"><a href="#JWT" class="headerlink" title="JWT"></a>JWT</h2><h3 id="常见的认证机制"><a href="#常见的认证机制" class="headerlink" title="常见的认证机制"></a>常见的认证机制</h3><p><strong>HTTP Basic Auth</strong></p>
<p>HTTP Basic Auth简单点说明就是每次请求API时都提供用户的username和password，简言之，Basic Auth是配合RESTful API 使用的最简单的认证方式，只需提供用户名密码即可，但由于有把用户名密码暴露给第三方客户端的风险，在生产环境下被使用的越来越少。因此，在开发对外开放的RESTful API时，尽量避免采用HTTP Basic Auth。</p>
<p><strong>Cookie Auth</strong></p>
<p>Cookie认证机制就是为一次请求认证在服务端创建一个Session对象，同时在客户端的浏览器端创建了一个Cookie对象；通过客户端带上来Cookie对象来与服务器端的session对象匹配来实现状态管理的。默认的，当我们关闭浏览器的时候，cookie会被删除。但可以通过修改cookie 的expire time使cookie在一定时间内有效。</p>
<p><strong>OAuth</strong></p>
<p>OAuth（开放授权,Open Authorization）是一个开放的授权标准，允许用户让第三方应用访问该用户在某一web服务上存储的私密的资源（如照片，视频，联系人列表），而无需将用户名和密码提供给第三方应用。如网站通过微信、微博登录等，主要用于第三方登录。OAuth允许用户提供一个令牌，而不是用户名和密码来访问他们存放在特定服务提供者的数据。每一个令牌授权一个特定的第三方系统（例如，视频编辑网站)在特定的时段（例如，接下来的2小时内）内访问特定的资源（例如仅仅是某一相册中的视频）。这样，OAuth让用户可以授权第三方网站访问他们存储在另外服务提供者的某些特定信息，而非所有内容。这种基于OAuth的认证机制适用于个人消费者类的互联网产品，如社交类APP等应用，但是不太适合拥有自有认证权限管理的企业应用。</p>
<p>缺点：过重。</p>
<p><strong>Token Auth</strong></p>
<p>使用基于 Token 的身份验证方法，在服务端不需要存储用户的登录记录。大概的流程是这样的：</p>
<ol>
<li><p>客户端使用用户名跟密码请求登录</p>
</li>
<li><p>服务端收到请求，去验证用户名与密码</p>
</li>
<li><p>验证成功后，服务端会签发一个 Token，再把这个 Token 发送给客户端</p>
</li>
<li><p>客户端收到 Token 以后可以把它存储起来，比如可以放在 Cookie 里</p>
</li>
<li><p>客户端每次向服务端请求资源的时候需要带着服务端签发的 Token</p>
</li>
<li><p>服务端收到请求，然后去验证客户端请求里面带着的 Token，如果验证成功，就向客户端返回请求的数据</p>
</li>
</ol>
<p><strong>这种方法比第一种方式更安全，比第二种方式更节约服务器资源，比第三种方式更加轻量。</strong></p>
<p>Token Auth的优点（Token机制相对于Cookie机制又有什么好处呢？）：</p>
<ol>
<li>支持跨域访问: Cookie是不允许垮域访问的，这一点对Token机制是不存在的，前提是传输的用户</li>
</ol>
<p>认证信息通过HTTP头传输.</p>
<ol start="2">
<li>无状态(也称：服务端可扩展行):Token机制在服务端不需要存储session信息，因为Token 自身包</li>
</ol>
<p>含了所有登录用户的信息，只需要在客户端的cookie或本地介质存储状态信息.</p>
<ol start="3">
<li>更适用CDN: 可以通过内容分发网络请求你服务端的所有资料（如：javascript，HTML,图片</li>
</ol>
<p>等），而你的服务端只要提供API即可.</p>
<ol start="4">
<li>去耦: 不需要绑定到一个特定的身份验证方案。Token可以在任何地方生成，只要在你的API被调用</li>
</ol>
<p>的时候，你可以进行Token生成调用即可.</p>
<ol start="5">
<li>更适用于移动应用: 当你的客户端是一个原生平台（iOS, Android，Windows 10等）时，Cookie</li>
</ol>
<p>是不被支持的（你需要通过Cookie容器进行处理），这时采用Token认证机制就会简单得多。</p>
<ol start="6">
<li><p>CSRF:因为不再依赖于Cookie，所以你就不需要考虑对CSRF（跨站请求伪造）的防范。</p>
</li>
<li><p>性能: 一次网络往返时间（通过数据库查询session信息）总比做一次HMACSHA256计算的Token</p>
</li>
</ol>
<p>验证和解析要费时得多.</p>
<ol start="8">
<li>不需要为登录页面做特殊处理: 如果你使用Protractor 做功能测试的时候，不再需要为登录页面做</li>
</ol>
<p>特殊处理.</p>
<ol start="9">
<li>基于标准化:你的API可以采用标准化的 JSON Web Token (JWT). 这个标准已经存在多个后端库</li>
</ol>
<p>（.NET, Ruby, Java,Python, PHP）和多家公司的支持（如：Firebase,Google, Microsoft）.</p>
<h3 id="JWT简介"><a href="#JWT简介" class="headerlink" title="JWT简介"></a>JWT简介</h3><h4 id="什么是JWT"><a href="#什么是JWT" class="headerlink" title="什么是JWT"></a>什么是JWT</h4><p>JSON Web Token（JWT）是一个开放的行业<strong>标准</strong>(即没有具体的实现)，它定义了一种简介的、自包含的协议格式，用于在通信双方传递json对象，传递的信息经过数字签名可以被验证和信任。JWT可以使用HMAC算法或使用RSA的公钥/私钥对来签名，防止被篡改。</p>
<p>JWT令牌的优点：</p>
<ol>
<li><p>JWT基于json，非常方便解析。</p>
</li>
<li><p>可以在令牌中自定义丰富的内容，易扩展。</p>
</li>
<li><p>通过非对称加密算法及数字签名技术，JWT防止篡改，安全性高。</p>
</li>
<li><p>资源服务使用JWT可不依赖认证服务即可完成授权。</p>
</li>
</ol>
<p>缺点：</p>
<ol>
<li>JWT令牌较长，占存储空间比较大。</li>
</ol>
<h4 id="JWT组成"><a href="#JWT组成" class="headerlink" title="JWT组成"></a><strong>JWT</strong>组成</h4><p>一个JWT实际上就是一个字符串，它由三部分组成：头部、载荷(负载)与签名</p>
<p><strong>头部(Header)</strong></p>
<p>头部用于描述关于该JWT的最基本的信息，例如其类型（即JWT）以及签名所用的算法（如HMACS、HA256或RSA）等。这也可以被表示成一个JSON对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"alg"</span>: <span class="string">"HS256"</span>,</span><br><span class="line">  <span class="string">"typ"</span>: <span class="string">"JWT"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>alg ：签名的算法，这里使用的算法是HS256算法</p>
<p>typ ：是类型。</p>
<p>我们对头部的json字符串进行BASE64编码（网上有很多在线编码的网站），编码后的字符串如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9</span><br></pre></td></tr></table></figure>

<p>Base64 是一种基于64个可打印字符来表示二进制数据的表示方法。由于2的6次方等于64，所以每6个比特为一个单元，对应某个可打印字符。三个字节有24个比特，对应于4个Base64单元，即3个字节需要用4个可打印字符来表示。JDK 中提供了非常方便的 BASE64Encoder 和 BASE64Decoder ，用它们可以非常方便的完成基于 BASE64 的编码和解码，<strong>即它是可以解密的</strong>。</p>
<p><strong>负载、载荷(Payload)</strong></p>
<p>第二部分是负载，就是存放有效信息的地方。</p>
<p>这些有效信息包含三个部分：</p>
<ol>
<li>标准中注册的声明（建议但不强制使用）</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">iss: JWT签发者</span><br><span class="line">sub: JWT所面向的用户</span><br><span class="line">aud: 接收JWT的一方</span><br><span class="line">exp: JWT的过期时间，这个过期时间必须要大于签发时间</span><br><span class="line">nbf: 定义在什么时间之前，该JWT都是不可用的.</span><br><span class="line">iat: JWT的签发时间</span><br><span class="line">jti: JWT的唯一身份标识，主要用来作为一次性token,从而回避重放攻击。</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>公共的声明</li>
</ol>
<p>公共的声明可以添加任何的信息，一般添加用户的相关信息或其他业务需要的必要信息.但不建议添加敏感信息，因为该部分在客户端可解密.</p>
<ol start="3">
<li>私有的声明</li>
</ol>
<p>私有声明是提供者和消费者所共同定义的声明，一般不建议存放敏感信息，因为base64是对称解密的，意味着该部分信息可以归类为明文信息。这个指的就是<strong>自定义的claim</strong>。比如下面那个举例中的name都属于自定的claim。这些private claim跟JWT标准规定的claim区别在于：JWT规定的claim，JWT的接收方在拿到JWT之后，是知道怎么对这些标准的claim进行验证(还不知道是否能够验证)；而private claims不会验证，除非明确告诉接收方要对这些claim进行验证以及规则才行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">"sub"</span>: <span class="string">"1234567890"</span>,</span><br><span class="line">  <span class="string">"name"</span>: <span class="string">"John Doe"</span>,</span><br><span class="line">  <span class="string">"iat"</span>: <span class="number">1516239022</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 sub 是标准的声明， name 是自定义的声明（公共的或私有的）然后将其进行base64编码，得到JWT的第二部分：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkphbWVzIiwiYWRtaW4iOnRydWV9</span><br></pre></td></tr></table></figure>

<p>【注意】：声明中不要放一些敏感信息。</p>
<p><strong>签证、签名（signature）</strong></p>
<p>JWT的第三部分是一个签证信息，此部分用于防止JWT内容被篡改，    这个签证信息由三部分组成：</p>
<ol>
<li><p>header (base64后的)</p>
</li>
<li><p>payload (base64后的)</p>
</li>
<li><p>secret（盐或者说私钥，一定要<strong>保密</strong>）</p>
</li>
</ol>
<p>这个部分需要base64加密后的header和base64加密后的payload使用<code>.</code>连接组成的字符串，然后通过header中声明的加密方式进行加盐secret组合加密，然后就构成了JWT的第三部分：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">8</span>HI-Lod0ncfVDnbKIPJJqLH998duF9DSDGkx3gRPNVI</span><br></pre></td></tr></table></figure>

<p>将这三部分用.连接成一个完整的字符串,构成了最终的JWT:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiaWF0IjoxNTE2MjM5MDIyfQ<span class="number">.8</span>HI-Lod0ncfVDnbKIPJJqLH998duF9DSDGkx3gRPNVI</span><br></pre></td></tr></table></figure>

<p>注意： secret 是保存在服务器端的， JWT 的签发生成也是在服务器端的， secret 就只是用来进行 JWT的签发和 JWT 的验证，所以，它就是你服务端的私钥，在任何场景都不应该流露出去。一旦客户端得知这个 secret , 那就意味着客户端是可以自我签发 JWT 了。</p>
<h3 id="JJWT简介"><a href="#JJWT简介" class="headerlink" title="JJWT简介"></a>JJWT简介</h3><h4 id="什么是JJWT"><a href="#什么是JJWT" class="headerlink" title="什么是JJWT"></a>什么是JJWT</h4><p>因为JWT只是一个标准，而针对java来说，有它对应的一套实现，叫JJWT，JJWT是一个提供端到端的 JWT 创建和验证的Java库。，JJW很容易使用和理解。它被设计成一个以建筑为中心的流畅界面，隐藏了它的大部分复杂性。</p>
<h4 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a><strong>快速入门</strong></h4><h5 id="token的创建"><a href="#token的创建" class="headerlink" title="token的创建"></a>token的创建</h5><p>创建SpringBoot工程，引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--JJWT依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jJWT<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>创建测试类JWTTest，用于生成token：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JWTdemoApplicationTests</span> </span>&#123;</span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 创建token</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Test</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreatToken</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">//创建一个JWTBuilder对象</span></span><br><span class="line">      JWTBuilder JWTBuilder = JWTs.builder()</span><br><span class="line">            <span class="comment">//声明的标识&#123;"jti":"888"&#125;</span></span><br><span class="line">           .setId(<span class="string">"888"</span>)</span><br><span class="line">            <span class="comment">//主体，用户&#123;"sub":"Rose"&#125;</span></span><br><span class="line">           .setSubject(<span class="string">"Rose"</span>)</span><br><span class="line">            <span class="comment">//创建日期&#123;"ita":"xxxxxx"&#125;</span></span><br><span class="line">           .setIssuedAt(<span class="keyword">new</span> Date())</span><br><span class="line">            <span class="comment">//签名手段，参数1：算法，参数2：盐</span></span><br><span class="line">           .signWith(SignatureAlgorithm.HS256,<span class="string">"xxxx"</span>);</span><br><span class="line">      <span class="comment">//生成JWT的token</span></span><br><span class="line">      String token = JWTBuilder.compact();</span><br><span class="line">      System.out.println(token);</span><br><span class="line">      <span class="comment">//三部分的base64解密</span></span><br><span class="line">      System.out.println(<span class="string">"--------------------"</span>);</span><br><span class="line">      String[] split = token.split(<span class="string">"\\."</span>);</span><br><span class="line">      System.out.println(Base64Codec.BASE64.decodeToString(split[<span class="number">0</span>]));</span><br><span class="line">      System.out.println(Base64Codec.BASE64.decodeToString(split[<span class="number">1</span>]));</span><br><span class="line">      <span class="comment">//无法解密，会出现乱码</span></span><br><span class="line">      System.out.println(Base64Codec.BASE64.decodeToString(split[<span class="number">2</span>]));</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="token的验证解析"><a href="#token的验证解析" class="headerlink" title="token的验证解析"></a>token的验证解析</h5><p>我们刚才已经创建了token ，在web应用中这个操作是由服务端进行然后发给客户端，客户端在下次向服务端发送请求时需要携带这个token（这就好像是拿着一张门票一样），那服务端接到这个token应该解析出token中的信息（例如用户id）,根据这些信息查询数据库返回相应的结果。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testParseToken</span><span class="params">()</span></span>&#123;</span><br><span class="line">   <span class="comment">//token</span></span><br><span class="line">   String token =</span><br><span class="line">		 <span class="string">"eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI4ODgiLCJzdWIiOiJSb3NlIiwiaWF0IjoxNTc4ODE0MjUyfQ"</span> +</span><br><span class="line">         <span class="string">".-FYFMHyfTcGzq900f_Drfdsges0ge2UjaWvPW9gCDto"</span>;</span><br><span class="line">   <span class="comment">//解析token获取,获取Claims，JWT负载中的声明对象</span></span><br><span class="line">   Claims claims = JWTs.parser()</span><br><span class="line">         <span class="comment">//私钥，即secret，也可以说是盐</span></span><br><span class="line">         .setSigningKey(<span class="string">"xxxx"</span>)</span><br><span class="line">         .parseClaimsJws(token)</span><br><span class="line">         .getBody();</span><br><span class="line">   <span class="comment">//打印声明的属性</span></span><br><span class="line">   System.out.println(<span class="string">"id:"</span>+claims.getId());</span><br><span class="line">   System.out.println(<span class="string">"subject:"</span>+claims.getSubject());</span><br><span class="line">   System.out.println(<span class="string">"issuedAt:"</span>+claims.getIssuedAt());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>试着将token或签名秘钥篡改一下，会发现运行时就会报错，所以解析token也就是验证token</p>
<h5 id="token过期校验"><a href="#token过期校验" class="headerlink" title="token过期校验"></a>token过期校验</h5><p>有很多时候，我们并不希望签发的token是永久生效的（上节的token是永久的），所以我们可以为token添加一个过期时间。原因：从服务器发出的token，服务器自己并不做记录，就存在一个弊端就是，服务端无法主动控制某token的立刻失效。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreatTokenHasExp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">//当前系统时间的长整型</span></span><br><span class="line">   <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">   <span class="comment">//过期时间，这里是1分钟后的时间长整型</span></span><br><span class="line">   <span class="keyword">long</span> exp = now + <span class="number">60</span> * <span class="number">1000</span>;</span><br><span class="line">   <span class="comment">//创建一个JWTBuilder对象</span></span><br><span class="line">   JWTBuilder JWTBuilder = JWTs.builder()</span><br><span class="line">         <span class="comment">//声明的标识&#123;"jti":"888"&#125;</span></span><br><span class="line">         .setId(<span class="string">"888"</span>)</span><br><span class="line">         <span class="comment">//主体，用户&#123;"sub":"Rose"&#125;</span></span><br><span class="line">         .setSubject(<span class="string">"Rose"</span>)</span><br><span class="line">         <span class="comment">//创建日期&#123;"ita":"xxxxxx"&#125;</span></span><br><span class="line">         .setIssuedAt(<span class="keyword">new</span> Date())</span><br><span class="line">         <span class="comment">//签名手段，参数1：算法，参数2：盐</span></span><br><span class="line">         .signWith(SignatureAlgorithm.HS256, <span class="string">"xxxx"</span>)</span><br><span class="line">         <span class="comment">//设置过期时间</span></span><br><span class="line">         .setExpiration(<span class="keyword">new</span> Date(exp));</span><br><span class="line">   <span class="comment">//生成JWT的token</span></span><br><span class="line">   String token = JWTBuilder.compact();</span><br><span class="line">   System.out.println(token);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testParseTokenHasExp</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">//token</span></span><br><span class="line">   String token = <span class="string">"eyJhbGciOiJIUzI1NiJ9"</span> +</span><br><span class="line"><span class="string">".eyJqdGkiOiI4ODgiLCJzdWIiOiJSb3NlIiwiaWF0IjoxNTc4ODE1MDYyLCJleHAiOjE1Nzg4MTUxMj"</span> +</span><br><span class="line"><span class="string">"IsInJvbGVzIjoiYWRtaW4iLCJsb2dvIjoic2hzeHQuanBnIn0.hKog0RsZ9_6II_R8kUCp0HLAouUAYX"</span> +</span><br><span class="line"><span class="string">"AJVbz3xtLTUh4"</span>;</span><br><span class="line">   <span class="comment">//解析token获取负载中的声明对象</span></span><br><span class="line">   Claims claims = JWTs.parser()</span><br><span class="line">         .setSigningKey(<span class="string">"xxxx"</span>)</span><br><span class="line">         .parseClaimsJws(token)</span><br><span class="line">         .getBody();</span><br><span class="line">   <span class="comment">//打印声明的属性</span></span><br><span class="line">   System.out.println(<span class="string">"id:"</span> + claims.getId());</span><br><span class="line">   System.out.println(<span class="string">"subject:"</span> + claims.getSubject());</span><br><span class="line">   System.out.println(<span class="string">"issuedAt:"</span> + claims.getIssuedAt());</span><br><span class="line">   DateFormat sf =<span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">   System.out.println(<span class="string">"签发时间:"</span>+sf.format(claims.getIssuedAt()));</span><br><span class="line">   System.out.println(<span class="string">"过期时间:"</span>+sf.format(claims.getExpiration()));</span><br><span class="line">   System.out.println(<span class="string">"当前时间:"</span>+sf.format(<span class="keyword">new</span> Date()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：当未过期时可以正常读取，当过期时会引发io.jsonwebtoken.ExpiredJWTException异常。</p>
<h5 id="自定义claims"><a href="#自定义claims" class="headerlink" title="自定义claims"></a>自定义claims</h5><p>我们刚才的例子只是存储了id和subject两个信息，如果你想存储更多的信息（例如角色、权限等）可以自定义claims</p>
<p>测试用例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testCreatTokenByClaims</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">//当前系统时间的长整型</span></span><br><span class="line">   <span class="keyword">long</span> now = System.currentTimeMillis();</span><br><span class="line">   <span class="comment">//过期时间，这里是1分钟后的时间长整型</span></span><br><span class="line">   <span class="keyword">long</span> exp = now + <span class="number">60</span> * <span class="number">1000</span>;</span><br><span class="line">   <span class="comment">//创建一个JWTBuilder对象</span></span><br><span class="line">   JWTBuilder JWTBuilder = JWTs.builder()</span><br><span class="line">         <span class="comment">//声明的标识&#123;"jti":"888"&#125;</span></span><br><span class="line">         .setId(<span class="string">"888"</span>)</span><br><span class="line">         <span class="comment">//主体，用户&#123;"sub":"Rose"&#125;</span></span><br><span class="line">        .setSubject(<span class="string">"Rose"</span>)</span><br><span class="line">         <span class="comment">//创建日期&#123;"ita":"xxxxxx"&#125;</span></span><br><span class="line">         .setIssuedAt(<span class="keyword">new</span> Date())</span><br><span class="line">         <span class="comment">//签名手段，参数1：算法，参数2：盐</span></span><br><span class="line">         .signWith(SignatureAlgorithm.HS256, <span class="string">"xxxx"</span>)</span><br><span class="line">         <span class="comment">//设置过期时间</span></span><br><span class="line">         .setExpiration(<span class="keyword">new</span> Date(exp))</span><br><span class="line">         <span class="comment">//直接传入map</span></span><br><span class="line">         <span class="comment">// .addClaims(map)</span></span><br><span class="line">         .claim(<span class="string">"roles"</span>,<span class="string">"admin"</span>)</span><br><span class="line">         .claim(<span class="string">"logo"</span>,<span class="string">"shsxt.jpg"</span>);</span><br><span class="line">   <span class="comment">//生成JWT的token</span></span><br><span class="line">   String token = JWTBuilder.compact();</span><br><span class="line">   System.out.println(token);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testParseTokenByClaims</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="comment">//token</span></span><br><span class="line">   String token = <span class="string">"eyJhbGciOiJIUzI1NiJ9"</span> +</span><br><span class="line"><span class="string">".eyJqdGkiOiI4ODgiLCJzdWIiOiJSb3NlIiwiaWF0IjoxNTc4ODE1MDYyLCJleHAiOjE1Nzg4MTUxMj"</span> +</span><br><span class="line"><span class="string">"IsInJvbGVzIjoiYWRtaW4iLCJsb2dvIjoic2hzeHQuanBnIn0.hKog0RsZ9_6II_R8kUCp0HLAouUAYX"</span> +</span><br><span class="line"><span class="string">"AJVbz3xtLTUh4"</span>;</span><br><span class="line">   <span class="comment">//解析token获取负载中的声明对象</span></span><br><span class="line">   Claims claims = JWTs.parser()</span><br><span class="line">         .setSigningKey(<span class="string">"xxxx"</span>)</span><br><span class="line">         .parseClaimsJws(token)</span><br><span class="line">         .getBody();</span><br><span class="line">   <span class="comment">//打印声明的属性</span></span><br><span class="line">   System.out.println(<span class="string">"id:"</span> + claims.getId());</span><br><span class="line">   System.out.println(<span class="string">"subject:"</span> + claims.getSubject());</span><br><span class="line">   System.out.println(<span class="string">"issuedAt:"</span> + claims.getIssuedAt());</span><br><span class="line">   DateFormat sf =<span class="keyword">new</span> SimpleDateFormat(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>);</span><br><span class="line">   System.out.println(<span class="string">"签发时间:"</span>+sf.format(claims.getIssuedAt()));</span><br><span class="line">   System.out.println(<span class="string">"过期时间:"</span>+sf.format(claims.getExpiration()));</span><br><span class="line">   System.out.println(<span class="string">"当前时间:"</span>+sf.format(<span class="keyword">new</span> Date()));</span><br><span class="line">   System.out.println(<span class="string">"roles:"</span>+claims.get(<span class="string">"roles"</span>));</span><br><span class="line">   System.out.println(<span class="string">"logo:"</span>+claims.get(<span class="string">"logo"</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="Java中解析JWT中的内容"><a href="#Java中解析JWT中的内容" class="headerlink" title="Java中解析JWT中的内容"></a>Java中解析JWT中的内容</h5><p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--JWT依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.jsonwebtoken<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jJWT<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.9.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>修改UserController类，使用jJWT工具类来解析请求头中<code>Authorization</code>中存储的JWT内容</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">   <span class="meta">@GetMapping</span>(<span class="string">"/getCurrentUser"</span>)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">getCurrentUser</span><span class="params">(Authentication authentication, HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">      String header = request.getHeader(<span class="string">"Authorization"</span>);</span><br><span class="line">      String token = header.substring(header.indexOf(<span class="string">"bearer"</span>) + <span class="number">7</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">return</span> JWTs.parser()</span><br><span class="line">           .setSigningKey(<span class="string">"test_key"</span>.getBytes(StandardCharsets.UTF_8))</span><br><span class="line">           .parseClaimsJws(token)</span><br><span class="line">           .getBody();</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将令牌放入Authorization头中</p>
<h3 id="整合JWT"><a href="#整合JWT" class="headerlink" title="整合JWT"></a>整合JWT</h3><h4 id="新建JWT工具类"><a href="#新建JWT工具类" class="headerlink" title="新建JWT工具类"></a>新建JWT工具类</h4><p>用于生成和解析JWT</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hbp.spring_security.util;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JWTUtil</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * token过期时间为：1个星期</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> EXPIRE = <span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">7</span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 密钥 secret</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String SECRET = <span class="string">"6666"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">generateJWTToken</span><span class="params">(String account, Long accountId, Long employeeId, List&lt;String&gt; permissions)</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        String JWTToken = JWTs.builder()</span><br><span class="line">                .setHeaderParam(<span class="string">"typ"</span>, <span class="string">"JWT"</span>)</span><br><span class="line">                .setHeaderParam(<span class="string">"alg"</span>, <span class="string">"HS256"</span>)</span><br><span class="line"></span><br><span class="line">                .setSubject(<span class="string">"employee"</span>)</span><br><span class="line"></span><br><span class="line">                .setIssuedAt(<span class="keyword">new</span> Date())</span><br><span class="line">                .setExpiration(<span class="keyword">new</span> Date(System.currentTimeMillis() + EXPIRE))</span><br><span class="line"></span><br><span class="line">                .claim(<span class="string">"account"</span>, account)</span><br><span class="line">                .claim(<span class="string">"accountId"</span>, accountId)</span><br><span class="line">                .claim(<span class="string">"employeeId"</span>, employeeId)</span><br><span class="line">                .claim(<span class="string">"permissions"</span>,permissions)</span><br><span class="line"></span><br><span class="line">                .signWith(SignatureAlgorithm.HS256, SECRET)</span><br><span class="line">                .compact();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> JWTToken;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断token是否存在与有效</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> JWTToken</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">checkToken</span><span class="params">(String JWTToken)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (ObjectUtils.isEmpty(JWTToken)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            JWTs.parser().setSigningKey(SECRET).parseClaimsJws(JWTToken);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断token是否已过期</span></span><br><span class="line">        <span class="keyword">return</span> JWTs.parser().setSigningKey(SECRET).parseClaimsJws(JWTToken).getBody().getExpiration().before(<span class="keyword">new</span> Date());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断token是否存在与有效</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> request</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">checkToken</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            String JWTToken = request.getHeader(<span class="string">"authorization"</span>);</span><br><span class="line">            <span class="keyword">if</span> (ObjectUtils.isEmpty(JWTToken)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            JWTs.parser().setSigningKey(SECRET).parseClaimsJws(JWTToken);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 根据token字符串获取：账户ID、员工ID、权限列表</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> token</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Map&lt;String,Object&gt; <span class="title">getAccountIdByJWTToken</span><span class="params">(String token)</span> </span>&#123;</span><br><span class="line">        HashMap&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (ObjectUtils.isEmpty(token)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Jws&lt;Claims&gt; claimsJws = JWTs.parser().setSigningKey(SECRET).parseClaimsJws(token);</span><br><span class="line">        Claims claims = claimsJws.getBody();</span><br><span class="line">        map.put(<span class="string">"account"</span>,claims.get(<span class="string">"account"</span>));</span><br><span class="line">        map.put(<span class="string">"accountId"</span>,claims.get(<span class="string">"accountId"</span>));</span><br><span class="line">        map.put(<span class="string">"employeeId"</span>,claims.get(<span class="string">"employeeId"</span>));</span><br><span class="line">        map.put(<span class="string">"permissions"</span>,claims.get(<span class="string">"permissions"</span>));</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//return (String)claims.get("employeeId");</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="照着JWT的工作流程来："><a href="#照着JWT的工作流程来：" class="headerlink" title="照着JWT的工作流程来："></a><strong>照着JWT的工作流程来</strong>：</h4><h5 id="自定义登录成功后的处理器"><a href="#自定义登录成功后的处理器" class="headerlink" title="自定义登录成功后的处理器"></a>自定义登录成功后的处理器</h5><p>首先是登录成功后会给客户端会返回一个JWT token，所以我们首先自定义一个MyAuthenticationSuccessHandler实现AuthenticationSuccessHandler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hbp.spring_security.handler;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyAuthenticationSuccessHandler</span> <span class="keyword">implements</span> <span class="title">AuthenticationSuccessHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthenticationSuccess</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        <span class="comment">// 拿到登录用户信息</span></span><br><span class="line">        MyAccountDetails accountDetails = (MyAccountDetails) authentication.getPrincipal();</span><br><span class="line">        <span class="comment">// 获取需要生成token的值</span></span><br><span class="line">        Long accountId = accountDetails.getAccount().getAccountId();</span><br><span class="line">        String account = accountDetails.getAccount().getAccount();</span><br><span class="line">        Long employeeId = accountDetails.getAccount().getEmployeeId();</span><br><span class="line">        List&lt;GrantedAuthority&gt; authorities = accountDetails.getAuthorities();</span><br><span class="line">        List&lt;String&gt; permissions = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// 权限的类型转换</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; authorities.size(); i++) &#123;</span><br><span class="line">            permissions.add(String.valueOf(authorities.get(i)));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 生成token</span></span><br><span class="line">        String token = JWTUtil.generateJWTToken(account, accountId, employeeId, permissions);</span><br><span class="line">        Result result = Result.ok().message(<span class="string">"登录成功"</span>).data(<span class="string">"token"</span>,token);</span><br><span class="line">        <span class="comment">// 以json格式，把返回值输出到页面</span></span><br><span class="line">        httpServletResponse.setCharacterEncoding(<span class="string">"utf-8"</span>);</span><br><span class="line">        httpServletResponse.setContentType(<span class="string">"application/json"</span>);</span><br><span class="line">        httpServletResponse.getWriter().write(JSON.toJSONString(result));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="JWT的拦截器"><a href="#JWT的拦截器" class="headerlink" title="JWT的拦截器"></a>JWT的拦截器</h5><p>让每个请求都需要验证JWT token</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hbp.spring_security.filter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JWTAuthenticationTokenFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AccountDetailsServiceImpl accountDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 拿到requset中的请求头</span></span><br><span class="line">        String authorizationHeader = request.getHeader(<span class="string">"Authorization"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (authorizationHeader != <span class="keyword">null</span> &amp;&amp; authorizationHeader.startsWith(<span class="string">"Bearer "</span>)) &#123;</span><br><span class="line">            <span class="comment">// 截取Authorization中Bearer后面的部分   注意Bearer后面是有一个空格的 别漏了！！！</span></span><br><span class="line">            String token = authorizationHeader.substring(<span class="string">"Bearer "</span>.length());</span><br><span class="line">            <span class="comment">// 解析token获取账号</span></span><br><span class="line">            Map&lt;String, Object&gt; map = JWTUtil.getAccountIdByJWTToken(token);</span><br><span class="line">            String account = (String) map.get(<span class="string">"account"</span>);</span><br><span class="line">            <span class="comment">// 如果token没过期且SpringSecurity中不存在存在用户的信息</span></span><br><span class="line">            <span class="keyword">if</span> (account != <span class="keyword">null</span> &amp;&amp; SecurityContextHolder.getContext().getAuthentication() == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// 重新认证授权</span></span><br><span class="line">                MyAccountDetails accountDetails = (MyAccountDetails)accountDetailsService.loadUserByUsername(account);</span><br><span class="line">                <span class="comment">// //判断是否存在这个用户</span></span><br><span class="line">                <span class="keyword">if</span> (accountDetails != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    UsernamePasswordAuthenticationToken authentication = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(accountDetails, <span class="keyword">null</span>, accountDetails.getAuthorities());</span><br><span class="line">                    authentication.setDetails(<span class="keyword">new</span> WebAuthenticationDetailsSource().buildDetails(request));</span><br><span class="line">                    SecurityContextHolder.getContext().setAuthentication(authentication);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 放行</span></span><br><span class="line">        filterChain.doFilter(request,response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="屏蔽重定向的登录页面，自定义未登录或者token失效的统一处理"><a href="#屏蔽重定向的登录页面，自定义未登录或者token失效的统一处理" class="headerlink" title="屏蔽重定向的登录页面，自定义未登录或者token失效的统一处理"></a>屏蔽重定向的登录页面，自定义未登录或者token失效的统一处理</h5><p>自定义实现AuthenticationEntryPoint，用于在未登录是访问接口返回json</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hbp.spring_security.handler;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomizeAuthenticationEntryPoint</span> <span class="keyword">implements</span> <span class="title">AuthenticationEntryPoint</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commence</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException e)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        response.setCharacterEncoding(<span class="string">"utf-8"</span>);</span><br><span class="line">        response.setContentType(<span class="string">"application/json"</span>);</span><br><span class="line">        response.getWriter().write(JSON.toJSONString(Result.error().message(<span class="string">"尚未登录，或者登录过期"</span> + e.getMessage())));</span><br><span class="line">        response.getWriter().flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="自定义退出登录"><a href="#自定义退出登录" class="headerlink" title="自定义退出登录"></a>自定义退出登录</h5><p>自定义实现LogoutSuccessHandler，用于在退出登录返回json</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomizeLogoutSuccessHandler</span> <span class="keyword">implements</span> <span class="title">LogoutSuccessHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onLogoutSuccess</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Authentication authentication)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        response.setCharacterEncoding(<span class="string">"utf-8"</span>);</span><br><span class="line">        response.setContentType(<span class="string">"application/json"</span>);</span><br><span class="line">        response.getWriter().write(JSON.toJSONString(Result.error().message(<span class="string">"退出成功"</span>)));</span><br><span class="line">        response.getWriter().flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="自定义异常处理"><a href="#自定义异常处理" class="headerlink" title="自定义异常处理"></a>自定义异常处理</h4><p>用户虽说不能访问没有权限的功能了，但是异常没有处理。如果点击，如果前端也没有做错误的拦截的话，用户会看到一串的报错信息，这很不友好，并且也会对服务器造成压力。我们只需要捕获权限的异常即可。</p>
<p>这里分2大块的异常处理，一是关于认证的异常处理。二是关于权限的异常处理</p>
<h5 id="认证的异常处理"><a href="#认证的异常处理" class="headerlink" title="认证的异常处理"></a>认证的异常处理</h5><p>handler包下，新建CustomizeAuthenticationFailureHandler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomizeAuthenticationFailureHandler</span> <span class="keyword">implements</span> <span class="title">AuthenticationFailureHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onAuthenticationFailure</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException e)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        Result result = Result.error();</span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> UsernameNotFoundException) &#123;</span><br><span class="line">            result.message(<span class="string">"账号不存在"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> BadCredentialsException ) &#123;</span><br><span class="line">            result.message(<span class="string">"密码错误"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> InternalAuthenticationServiceException) &#123;</span><br><span class="line">            result.message(<span class="string">"账号被禁用，请联系管理员"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> CredentialsExpiredException) &#123;</span><br><span class="line">            result.message(<span class="string">"密码过期，请联系管理员!"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> AccountExpiredException) &#123;</span><br><span class="line">            result.message(<span class="string">"账户过期，请联系管理员!"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            result.message(<span class="string">"登录失败!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        response.setCharacterEncoding(<span class="string">"utf-8"</span>);</span><br><span class="line">        response.setContentType(<span class="string">"application/json"</span>);</span><br><span class="line">        response.getWriter().write(JSON.toJSONString(result));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="权限的异常处理"><a href="#权限的异常处理" class="headerlink" title="权限的异常处理"></a>权限的异常处理</h5><p>handler包下，新建CustomizeAccessDeniedHandler</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomizeAccessDeniedHandler</span> <span class="keyword">implements</span> <span class="title">AccessDeniedHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AccessDeniedException e)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        response.setCharacterEncoding(<span class="string">"utf-8"</span>);</span><br><span class="line">        response.setContentType(<span class="string">"application/json"</span>);</span><br><span class="line">        response.getWriter().write(JSON.toJSONString(Result.error().message(<span class="string">"没有权限，请联系管理员授权"</span>)));</span><br><span class="line">        response.getWriter().flush();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="将上述方法加入到SecurityConfig中的配置方法里"><a href="#将上述方法加入到SecurityConfig中的配置方法里" class="headerlink" title="将上述方法加入到SecurityConfig中的配置方法里"></a>将上述方法加入到SecurityConfig中的配置方法里</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="meta">@EnableGlobalMethodSecurity</span>(prePostEnabled = <span class="keyword">true</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 这里如果爆红不用管</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserDetailsService userDetailsService;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomizeAuthenticationSuccessHandler authenticationSuccessHandler;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JWTAuthenticationTokenFilter JWTAuthenticationTokenFilter;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomizeAuthenticationEntryPoint customizeAuthenticationEntryPoint;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomizeAccessDeniedHandler accessDeniedHandler;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomizeAuthenticationFailureHandler customizeAuthenticationFailureHandler;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> CustomizeLogoutSuccessHandler customizeLogoutSuccessHandler;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthenticationProvider <span class="title">daoAuthenticationProvider</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        DaoAuthenticationProvider daoAuthenticationProvider = <span class="keyword">new</span> DaoAuthenticationProvider();</span><br><span class="line">        daoAuthenticationProvider.setUserDetailsService(userDetailsService);</span><br><span class="line">        <span class="comment">// 密码处理</span></span><br><span class="line">        daoAuthenticationProvider.setPasswordEncoder(passwordEncoder());</span><br><span class="line">        <span class="comment">// 要想抛出UsernameNotFoundException这个异常，就要设置成false，因为在源码里会把这个异常转为BadCredentialsException</span></span><br><span class="line">        daoAuthenticationProvider.setHideUserNotFoundExceptions(<span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">return</span> daoAuthenticationProvider;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 配置设置</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> http</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        http.csrf().disable()</span><br><span class="line">                .sessionManagement()</span><br><span class="line">                .sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line">                .and()</span><br><span class="line">                .httpBasic().authenticationEntryPoint(customizeAuthenticationEntryPoint)</span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .anyRequest().authenticated() <span class="comment">// 拦截所有请求,登陆后能够访问</span></span><br><span class="line">                .and()</span><br><span class="line">                .formLogin()</span><br><span class="line">                .failureHandler(customizeAuthenticationFailureHandler)</span><br><span class="line">                .successHandler(authenticationSuccessHandler).permitAll()</span><br><span class="line">            	.and()</span><br><span class="line">                .logout().logoutSuccessHandler(customizeLogoutSuccessHandler).permitAll();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//添加JWT拦截器</span></span><br><span class="line">        http.addFilterBefore(JWTAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        <span class="comment">// 用户无权限异常处理</span></span><br><span class="line">        http.exceptionHandling().accessDeniedHandler(accessDeniedHandler);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 使用自定义的认证提供器</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> auth</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> Exception</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        auth.authenticationProvider(daoAuthenticationProvider());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="测试-2"><a href="#测试-2" class="headerlink" title="测试"></a>测试</h5><p>这里使用借助postman来测试</p>
<ol>
<li><p>在我们未携带JWT token信息时，访问localhost:8080/api/test接口</p>
<p><img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E6%9C%AA%E7%99%BB%E5%BD%95%E6%BC%94%E7%A4%BA.jpg" alt="未登录演示"></p>
</li>
<li><p>进行登录测试，登录管理员账号，并复制其token</p>
<p><img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E7%99%BB%E5%BD%95.jpg" alt="登录"></p>
</li>
<li><p>用管理员的token访问接口，发现已经可以正常访问了</p>
<p><img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E7%AE%A1%E7%90%86%E5%91%98%E8%AE%BF%E9%97%AE%E6%8E%A5%E5%8F%A3%E6%88%90%E5%8A%9F.jpg" alt="管理员访问接口成功"></p>
</li>
<li><p>我们再次尝试另一个用户登录后获取到token访问该接口</p>
<p><img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E6%B2%A1%E6%9C%89%E6%9D%83%E9%99%90%E8%AE%BF%E9%97%AE.jpg" alt="没有权限访问"></p>
</li>
<li><p>当我们输入的账号不存在时</p>
<p><img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E8%B4%A6%E5%8F%B7%E4%B8%8D%E5%AD%98%E5%9C%A8.jpg" alt="账号不存在"></p>
</li>
<li><p>密码错误</p>
<p><img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E5%AF%86%E7%A0%81%E9%94%99%E8%AF%AF.jpg" alt="密码错误"></p>
</li>
<li><p>退出登录</p>
<p><img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springSecurityimages/%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95.jpg" alt></p>
</li>
</ol>

      <blockquote class="mdui-m-t-5">
        
          <strong>本文遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">CC BY-NC-SA 4.0</a> 许可协议，转载请附上原文出处链接和本声明。</strong><br>
        
        <strong>本文链接：</strong><a href="https://yellowbp.github.io/2021/06/01/SpringSecurity/">https://yellowbp.github.io/2021/06/01/SpringSecurity/</a>
      </blockquote>
      
    </div>
    <footer class="mdui-card-actions">
      
        <a class="mdui-ripple article_categories-link" href="/categories/安全框架/">安全框架</a>
      
      
        <a class="mdui-ripple article_tags-link" href="/tags/Spring/">Spring</a>
      
    </footer>
    
  </article>
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script>$("#main article .mdui-card-content img.fancybox").on("click",function(e){$.fancybox.open({src:$(this).attr("src")});});</script>


  <nav id="paginator">
    
      <a rel="prev" class="extend prev" href="/2021/06/17/获取容器中的Bean对象/">
        <button aria-label="prev" class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_back</i></button>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上一篇
      </a>
    
    <div class="spacer"></div>
    
      <a rel="next" class="extend next" href="/2021/05/29/POI和easyExcel/">
        下一篇&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <button aria-label="next" class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_forward</i></button>
      </a>
    
  </nav>


  <div id="comment" class="mdui-m-t-5">
    <style>#pop_ad,#feedAv{display:none!important;position:absolute!important;z-index:-9999;left:-1000px;opacity:0!important}</style>
<div id="SOHUCS" sid="ckqv2z2vj00525gtwmz14nj38"></div>
<script type="text/javascript">
(function(){
var appid = 'cyubhC2Dq';
var conf = 'prod_e4cce65003c5bed049fefcb8a6f09e12';
var width = window.innerWidth || document.documentElement.clientWidth;
if (width < 960) {
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="http://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("http://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>
  </div>



  <div style="position: fixed !important; right: 16px; top: 30%;">
    <button class="mdui-fab mdui-fab-mini mdui-ripple" mdui-menu="{target: '#toc'}"><i class="mdui-icon material-icons">format_list_numbered</i></button>
    <ul class="mdui-menu" id="toc">
      <li class="mdui-menu-item" disabled><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#SpringSecurity简介"><span class="toc-number">1.</span> <span class="toc-text">SpringSecurity简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#基本概念"><span class="toc-number">1.1.</span> <span class="toc-text">基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#常用安全框架"><span class="toc-number">1.2.</span> <span class="toc-text">常用安全框架</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#授权的数据模型"><span class="toc-number">1.3.</span> <span class="toc-text">授权的数据模型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RBAC"><span class="toc-number">1.4.</span> <span class="toc-text">RBAC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#基于角色的访问控制"><span class="toc-number">1.4.1.</span> <span class="toc-text">基于角色的访问控制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#基于资源的访问控制（推荐）"><span class="toc-number">1.4.2.</span> <span class="toc-text">基于资源的访问控制（推荐）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#环境搭建"><span class="toc-number">1.5.</span> <span class="toc-text">环境搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#数据设计"><span class="toc-number">1.5.1.</span> <span class="toc-text">数据设计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Idea创建SpringBoot项目"><span class="toc-number">1.5.2.</span> <span class="toc-text">Idea创建SpringBoot项目</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#导入依赖"><span class="toc-number">1.5.3.</span> <span class="toc-text">导入依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#搭建目录结构"><span class="toc-number">1.5.4.</span> <span class="toc-text">搭建目录结构</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#创建实体类"><span class="toc-number">1.5.5.</span> <span class="toc-text">创建实体类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置MyBatis-Plus的自动填充功能"><span class="toc-number">1.5.6.</span> <span class="toc-text">配置MyBatis Plus的自动填充功能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置yaml"><span class="toc-number">1.5.7.</span> <span class="toc-text">配置yaml</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#统一接口返回格式"><span class="toc-number">1.5.8.</span> <span class="toc-text">统一接口返回格式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#新建接口定义返回状态码"><span class="toc-number">1.5.8.1.</span> <span class="toc-text">新建接口定义返回状态码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#新建统一返回数据类"><span class="toc-number">1.5.8.2.</span> <span class="toc-text">新建统一返回数据类</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#测试"><span class="toc-number">1.5.9.</span> <span class="toc-text">测试</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#先把spring-security的依赖注释掉"><span class="toc-number">1.5.9.1.</span> <span class="toc-text">先把spring security的依赖注释掉</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#插入数据到数据库"><span class="toc-number">1.5.9.2.</span> <span class="toc-text">插入数据到数据库</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#mapper层"><span class="toc-number">1.5.9.3.</span> <span class="toc-text">mapper层</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#service层"><span class="toc-number">1.5.9.4.</span> <span class="toc-text">service层</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#controller层"><span class="toc-number">1.5.9.5.</span> <span class="toc-text">controller层</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#启动类"><span class="toc-number">1.5.9.6.</span> <span class="toc-text">启动类</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#运行项目"><span class="toc-number">1.5.9.7.</span> <span class="toc-text">运行项目</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#整合Spring-Security"><span class="toc-number">2.</span> <span class="toc-text">整合Spring Security</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#添加启动器"><span class="toc-number">2.1.</span> <span class="toc-text">添加启动器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#启动项目"><span class="toc-number">2.2.</span> <span class="toc-text">启动项目</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#讲解说明"><span class="toc-number">2.3.</span> <span class="toc-text">讲解说明</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#认证"><span class="toc-number">2.4.</span> <span class="toc-text">认证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#工作原理"><span class="toc-number">2.4.1.</span> <span class="toc-text">工作原理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#用户认证流程"><span class="toc-number">2.4.2.</span> <span class="toc-text">用户认证流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#AuthenticationProvider"><span class="toc-number">2.4.2.1.</span> <span class="toc-text">AuthenticationProvider</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#UserDetailsService（一般需要我们自定义实现）"><span class="toc-number">2.4.2.2.</span> <span class="toc-text">UserDetailsService（一般需要我们自定义实现）</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#PasswordEncoder"><span class="toc-number">2.4.2.3.</span> <span class="toc-text">PasswordEncoder</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#内置编码器介绍"><span class="toc-number">2.4.2.3.1.</span> <span class="toc-text">内置编码器介绍</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#总结："><span class="toc-number">2.4.2.4.</span> <span class="toc-text">总结：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#用户认证整合"><span class="toc-number">2.4.3.</span> <span class="toc-text">用户认证整合</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#自定义用户信息"><span class="toc-number">2.4.3.1.</span> <span class="toc-text">自定义用户信息</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#把该账户对应的权限查询出来"><span class="toc-number">2.4.3.2.</span> <span class="toc-text">把该账户对应的权限查询出来</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#加密"><span class="toc-number">2.4.3.3.</span> <span class="toc-text">加密</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#生成加密密码"><span class="toc-number">2.4.3.4.</span> <span class="toc-text">生成加密密码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#测试-1"><span class="toc-number">2.4.3.5.</span> <span class="toc-text">测试</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#加入授权控制示例，方便后续讲解"><span class="toc-number">2.4.3.6.</span> <span class="toc-text">加入授权控制示例，方便后续讲解</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#授权"><span class="toc-number">2.5.</span> <span class="toc-text">授权</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#工作原理-1"><span class="toc-number">2.5.1.</span> <span class="toc-text">工作原理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#授权流程："><span class="toc-number">2.5.1.1.</span> <span class="toc-text">授权流程：</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#授权决策"><span class="toc-number">2.5.1.2.</span> <span class="toc-text">授权决策</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#总结：-1"><span class="toc-number">2.5.1.3.</span> <span class="toc-text">总结：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#用户授权整合"><span class="toc-number">2.5.2.</span> <span class="toc-text">用户授权整合</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JWT"><span class="toc-number">3.</span> <span class="toc-text">JWT</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#常见的认证机制"><span class="toc-number">3.1.</span> <span class="toc-text">常见的认证机制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JWT简介"><span class="toc-number">3.2.</span> <span class="toc-text">JWT简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#什么是JWT"><span class="toc-number">3.2.1.</span> <span class="toc-text">什么是JWT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JWT组成"><span class="toc-number">3.2.2.</span> <span class="toc-text">JWT组成</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JJWT简介"><span class="toc-number">3.3.</span> <span class="toc-text">JJWT简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#什么是JJWT"><span class="toc-number">3.3.1.</span> <span class="toc-text">什么是JJWT</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#快速入门"><span class="toc-number">3.3.2.</span> <span class="toc-text">快速入门</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#token的创建"><span class="toc-number">3.3.2.1.</span> <span class="toc-text">token的创建</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#token的验证解析"><span class="toc-number">3.3.2.2.</span> <span class="toc-text">token的验证解析</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#token过期校验"><span class="toc-number">3.3.2.3.</span> <span class="toc-text">token过期校验</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#自定义claims"><span class="toc-number">3.3.2.4.</span> <span class="toc-text">自定义claims</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#Java中解析JWT中的内容"><span class="toc-number">3.3.2.5.</span> <span class="toc-text">Java中解析JWT中的内容</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#整合JWT"><span class="toc-number">3.4.</span> <span class="toc-text">整合JWT</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#新建JWT工具类"><span class="toc-number">3.4.1.</span> <span class="toc-text">新建JWT工具类</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#照着JWT的工作流程来："><span class="toc-number">3.4.2.</span> <span class="toc-text">照着JWT的工作流程来：</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#自定义登录成功后的处理器"><span class="toc-number">3.4.2.1.</span> <span class="toc-text">自定义登录成功后的处理器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#JWT的拦截器"><span class="toc-number">3.4.2.2.</span> <span class="toc-text">JWT的拦截器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#屏蔽重定向的登录页面，自定义未登录或者token失效的统一处理"><span class="toc-number">3.4.2.3.</span> <span class="toc-text">屏蔽重定向的登录页面，自定义未登录或者token失效的统一处理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#自定义退出登录"><span class="toc-number">3.4.2.4.</span> <span class="toc-text">自定义退出登录</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#自定义异常处理"><span class="toc-number">3.4.3.</span> <span class="toc-text">自定义异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#认证的异常处理"><span class="toc-number">3.4.3.1.</span> <span class="toc-text">认证的异常处理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#权限的异常处理"><span class="toc-number">3.4.3.2.</span> <span class="toc-text">权限的异常处理</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#将上述方法加入到SecurityConfig中的配置方法里"><span class="toc-number">3.4.3.3.</span> <span class="toc-text">将上述方法加入到SecurityConfig中的配置方法里</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#测试-2"><span class="toc-number">3.4.3.4.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></li></ol></li></ol></li>
    </ul>
  </div>
</main>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<footer id="footer" class="mdui-m-t-5 mdui-p-y-3 mdui-color-theme">
  <div class="mdui-p-y-0 mdui-text-center">
    
    
    
    
    
    
    
      <a href="https://github.com/yellowbp" target="_blank"><i class="mdui-p-a-1 mdui-icon iconfont mdui-text-color-theme-a100">&#xe7ab;</i></a>
    
    
    
    
    
      <a href="tencent://message/?uin=1432440963&Menu=yes" target="_blank"><i class="mdui-p-a-1 mdui-icon iconfont mdui-text-color-theme-a100">&#xe651;</i></a>
    
    
  </div>
  <div class="mdui-p-y-1 mdui-text-center">
    Copyright &copy; 2019 - 2021 hbp<br>
    Powered by <a href="https://hexo.io/" target="_blank" class="mdui-text-color-theme-accent">Hexo</a>Peyton Wong All rights reserved.
    
    <br>
    <span id="busuanzi_container_site_uv">
    本网站总访问量<span id="busuanzi_value_site_uv"></span>次
    </span>
  </div>
</footer>
  <button id="gotop" class="mdui-fab mdui-fab-fixed mdui-fab-hide mdui-ripple mdui-color-theme-accent"><i class="mdui-icon material-icons">arrow_upward</i></button>
  <script async src="http://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <script src="/js/mdui.js"></script>
<script src="/js/script.js"></script>
</body>
</html>