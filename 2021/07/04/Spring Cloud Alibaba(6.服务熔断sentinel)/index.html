<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="renderer" content="webkit">

  
  <title>Spring Cloud Alibaba(6.服务熔断sentinel) | bp的Blog</title>

  <link rel="shortcut icon" href="/images/favicon.png">
  
  <meta name="description" content="Spring Cloud Alibaba(6.服务熔断sentinel)分布式遇到的问题服务的可用性，造成一个服务挂掉有很多的原因：  硬件的原因：内存不够，磁盘空间不足等 软件层面上：运行时的OOM异常，或者说第三方的服务、DB 挂掉或迟迟没有响应，从而导致所有请求系统的线程堆积，造成线程池爆满  原因总结来说就是：  激增流量 被其他服务拖垮 异常没处理（出现异常，造成代码中断，本该正常释放的">
<meta name="keywords" content="git">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Cloud Alibaba(6.服务熔断sentinel)">
<meta property="og:url" content="https://yellowbp.github.io/2021/07/04/Spring Cloud Alibaba(6.服务熔断sentinel)/index.html">
<meta property="og:site_name" content="bp的Blog">
<meta property="og:description" content="Spring Cloud Alibaba(6.服务熔断sentinel)分布式遇到的问题服务的可用性，造成一个服务挂掉有很多的原因：  硬件的原因：内存不够，磁盘空间不足等 软件层面上：运行时的OOM异常，或者说第三方的服务、DB 挂掉或迟迟没有响应，从而导致所有请求系统的线程堆积，造成线程池爆满  原因总结来说就是：  激增流量 被其他服务拖垮 异常没处理（出现异常，造成代码中断，本该正常释放的">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://springcloudalibaba.oss-cn-guangzhou.aliyuncs.com/%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99%E8%AE%BE%E7%BD%AE.jpg">
<meta property="og:image" content="https://springcloudalibaba.oss-cn-guangzhou.aliyuncs.com/qps.png">
<meta property="og:image" content="https://springcloudalibaba.oss-cn-guangzhou.aliyuncs.com/%E7%BA%BF%E7%A8%8B.png">
<meta property="og:image" content="https://springcloudalibaba.oss-cn-guangzhou.aliyuncs.com/%E5%85%B3%E8%81%94.jpg">
<meta property="og:image" content="https://springcloudalibaba.oss-cn-guangzhou.aliyuncs.com/%E9%93%BE%E8%B7%AF.jpg">
<meta property="og:image" content="https://springcloudalibaba.oss-cn-guangzhou.aliyuncs.com/openFeign%E6%95%B4%E5%90%88sentinel.jpg">
<meta property="og:updated_time" content="2021-08-01T15:20:36.141Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spring Cloud Alibaba(6.服务熔断sentinel)">
<meta name="twitter:description" content="Spring Cloud Alibaba(6.服务熔断sentinel)分布式遇到的问题服务的可用性，造成一个服务挂掉有很多的原因：  硬件的原因：内存不够，磁盘空间不足等 软件层面上：运行时的OOM异常，或者说第三方的服务、DB 挂掉或迟迟没有响应，从而导致所有请求系统的线程堆积，造成线程池爆满  原因总结来说就是：  激增流量 被其他服务拖垮 异常没处理（出现异常，造成代码中断，本该正常释放的">
<meta name="twitter:image" content="https://springcloudalibaba.oss-cn-guangzhou.aliyuncs.com/%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99%E8%AE%BE%E7%BD%AE.jpg">

  <meta name="format-detection" content="telephone=no,email=no">
  <meta name="theme-color" content="#9C27B0">
  <meta name="description" content>
  <meta name="keywords" content=",git">

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="bp的Blog">
  <meta name="msapplication-starturl" content="https://yellowbp.github.io/2021/07/04/Spring Cloud Alibaba(6.服务熔断sentinel)/">
  <meta name="msapplication-navbutton-color" content="#9C27B0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="bp的Blog">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/images/favicon.png">

  
    <meta property="article:published_time" content="Sun Jul 04 2021 10:10:48 GMT+0800">
    <meta property="article:modified_time" content="Sun Aug 01 2021 23:20:36 GMT+0800">
  

  
    <link rel="canonical" href="https://yellowbp.github.io/2021/07/04/Spring Cloud Alibaba(6.服务熔断sentinel)/">
  

  <meta name="google-site-verification" content="fXjtlIfaDc_X-0P11rO3bEp1Nk4IKXphoJv0GqGZCco">
  <meta name="baidu-site-verification" content="I3t1wfwZvd">

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create','UA-139531378-1','auto');ga('send','pageview');
</script>
  <script>
  var _hmt = _hmt || [];
  (function() {var hm = document.createElement('script');
  hm.src = 'https://hm.baidu.com/hm.js?1054d51c0b66f1d168829173682c8159';
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script>
  

  <link rel="stylesheet" href="/css/mdui.css">
<link rel="stylesheet" href="/css/style.css">
</head>
<body class="mdui-appbar-with-toolbar mdui-drawer-body-left mdui-theme-primary-brown mdui-theme-accent-blue">
  <script>var a=localStorage.getItem("mdui-theme-layout-dark");if(a){document.getElementsByTagName("body")[0].className+=" mdui-theme-layout-dark"};</script>
  <header id="header" class="mdui-appbar mdui-appbar-fixed mdui-appbar-scroll-hide mdui-appbar-inset">
  <div class="mdui-toolbar mdui-color-theme">
    <a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-drawer="{target: '#sidebar', swipe: true}"><i class="mdui-icon material-icons">menu</i></a>
    <a href="/" class="mdui-typo-headline">bp的Blog</a>
    <div class="mdui-toolbar-spacer"></div>
    <a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-dialog="{target: '#search'}" mdui-tooltip="{content: '搜索'}"><i class="mdui-icon material-icons">search</i></a>
    
  </div>
</header>
<div class="mdui-dialog" id="search">
  
    <div class="search-form">
      <input type="search" class="search-form-input" placeholder="请输入关键字">
    </div>
    <div class="search-result" data-resource="/search.xml"></div>
  
</div>
  <aside id="sidebar" class="mdui-drawer mdui-drawer-full-height">
  <div class="mdui-grid-tile">
    <img src="/images/Gradient1.jpg" style="height: 160px;">
    <img src="/images/headPic.jpg" class="avatar-animation" style="position: absolute; top: 10%; left: 24px; width: 64px; height: 64px; border: 2px solid #fff; border-radius: 50%;">
    <div class="mdui-grid-tile-actions">
      <div class="mdui-grid-tile-text">
        <div class="mdui-grid-tile-title">hbp
        </div>
        <div class="mdui-grid-tile-subtitle"><i class="mdui-icon material-icons">art_track</i>要想快，先会慢</div>
      </div>
      
        <div class="mdui-grid-tile-buttons">
          <a href="mailto:347070556@qq.com" class="mdui-btn mdui-btn-icon" mdui-tooltip="{content: '347070556@qq.com'}"><i class="mdui-icon material-icons">email</i></a>
        </div>
      
    </div>
  </div>

  <div class="mdui-list" mdui-collapse="{accordion: true}">
    <a href="/" class="mdui-list-item mdui-ripple">
      <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-blue">home</i>
      <div class="mdui-list-item-content">主页</div>
    </a>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-deep-orange">inbox</i>
        <div class="mdui-list-item-content">归档</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/archives/2022/03/">三月 2022<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2022/02/">二月 2022<span class="mdui-ripple sidebar_archives-count">12</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/10/">十月 2021<span class="mdui-ripple sidebar_archives-count">9</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/09/">九月 2021<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/08/">八月 2021<span class="mdui-ripple sidebar_archives-count">6</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/07/">七月 2021<span class="mdui-ripple sidebar_archives-count">12</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/06/">六月 2021<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/05/">五月 2021<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/04/">四月 2021<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/03/">三月 2021<span class="mdui-ripple sidebar_archives-count">6</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/02/">二月 2021<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/01/">一月 2021<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2020/03/">三月 2020<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/12/">十二月 2019<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/11/">十一月 2019<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/10/">十月 2019<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/09/">九月 2019<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/08/">八月 2019<span class="mdui-ripple sidebar_archives-count">6</span></a>
        
      </div>
    </div>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-green">chrome_reader_mode</i>
        <div class="mdui-list-item-content">分类</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/categories/ElasticSearch/">ElasticSearch<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/Spring/">Spring<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/SpringBoot/">SpringBoot<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/SpringCloud-Alibaba/">SpringCloud Alibaba<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/SpringMVC/">SpringMVC<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/docker/">docker<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/excel/">excel<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/git/">git<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/java8/">java8<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/java基础/">java基础<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/jenkins/">jenkins<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/jenkins/docker/">docker<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/jwt/">jwt<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/k8s/">k8s<span class="mdui-ripple sidebar_archives-count">10</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/linux/">linux<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/linux搭建/">linux搭建<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/maven/">maven<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/mybatis/">mybatis<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/mysql/">mysql<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/redis/">redis<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/servlet/">servlet<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/ssm/">ssm<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/yaml/">yaml<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/上传下载文件/">上传下载文件<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/乱码/">乱码<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/参数校验/">参数校验<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/发短信/">发短信<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/小程序/">小程序<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/工具类/">工具类<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/开发软件/">开发软件<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/技术/">技术<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/搭建博客/">搭建博客<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/源码分析/">源码分析<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/电脑硬件/">电脑硬件<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/算法/">算法<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/缓存/">缓存<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/虚拟机/">虚拟机<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/规范/">规范<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/认证授权/">认证授权<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/设计模式/">设计模式<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/负载均衡/">负载均衡<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/通用工具类/">通用工具类<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/部署/">部署<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/重装/">重装<span class="mdui-ripple sidebar_archives-count">1</span></a>
        
      </div>
    </div>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-brown">bookmark</i>
        <div class="mdui-list-item-content">标签</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/tags/Spring/">Spring<span class="mdui-ripple sidebar_archives-count">22</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/algorithm/">algorithm<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/excel/">excel<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/git/">git<span class="mdui-ripple sidebar_archives-count">13</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/hexo/">hexo<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/javaWeb/">javaWeb<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/java基础/">java基础<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/jwt/">jwt<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/linux/">linux<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/mysql/">mysql<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/nginx/">nginx<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/redis/">redis<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/servlet/">servlet<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/spring/">spring<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/win7/">win7<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/其他/">其他<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/分布式/">分布式<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/接口文档/">接口文档<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/笔记本选购/">笔记本选购<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/自动化构建工具/">自动化构建工具<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/设计模式/">设计模式<span class="mdui-ripple sidebar_archives-count">1</span></a>
        
      </div>
    </div>
    <a href="/about" class="mdui-list-item mdui-ripple">
      <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-purple">person</i>
      <div class="mdui-list-item-content">关于</div>
    </a>
  </div>

  <div class="mdui-divider"></div>

  <div class="mdui-list" mdui-collapse="{accordion: true}">
    
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <div class="mdui-list-item-content">友情链接</div>
        <i class="mdui-list-item-icon mdui-icon material-icons">link</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        
          <a href="javascript:;" class="mdui-list-item mdui-ripple mdui-p-l-2 mdui-text-color-theme" style="justify-content: center;">链接为空</a>
        
      </div>
    </div>
  </div>
</aside>
  <main id="main" class="mdui-m-t-5 fadeIn animated">
  <link rel="stylesheet" href="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.css">
  <style>#main article .mdui-card-content .center-block{display:block!important;margin-right:auto!important;margin-left:auto!important}</style>
  <article class="mdui-card mdui-m-b-5">
    <header class="mdui-card-media">
      <img src="/images/random/material-9.png" style="max-height: 240px;">
      <div class="mdui-card-media-covered">
        <div class="mdui-card-primary">
          <div class="mdui-card-primary-title">Spring Cloud Alibaba(6.服务熔断sentinel)</div>
          <div class="mdui-card-primary-subtitle"><i class="iconfont">&#xe697;</i> 2021-07-04 / 
          <i class="iconfont">&#xe601;</i> hbp
          <span id="busuanzi_container_page_pv">
            本文总阅读量<span id="busuanzi_value_page_pv"></span>次
          </span>
          </div>
        </div>
      </div>
      <div class="mdui-card-menu">
        
        
      </div>
    </header>
    <div class="mdui-card-content mdui-typo">
      <h1 id="Spring-Cloud-Alibaba-6-服务熔断sentinel"><a href="#Spring-Cloud-Alibaba-6-服务熔断sentinel" class="headerlink" title="Spring Cloud Alibaba(6.服务熔断sentinel)"></a>Spring Cloud Alibaba(6.服务熔断sentinel)</h1><h2 id="分布式遇到的问题"><a href="#分布式遇到的问题" class="headerlink" title="分布式遇到的问题"></a>分布式遇到的问题</h2><p>服务的可用性，造成一个服务挂掉有很多的原因：</p>
<ul>
<li>硬件的原因：内存不够，磁盘空间不足等</li>
<li>软件层面上：运行时的OOM异常，或者说第三方的服务、DB 挂掉或迟迟没有响应，从而导致所有请求系统的线程堆积，造成线程池爆满</li>
</ul>
<p>原因总结来说就是：</p>
<ol>
<li>激增流量</li>
<li>被其他服务拖垮</li>
<li>异常没处理（出现异常，造成代码中断，本该正常释放的资源没释放到，比如内存释放，清空对象等）</li>
</ol>
<p>说白了就是系统缺乏高可用防护/容错机制，尤其是针对流量的防护</p>
<h2 id="服务的可用性场景"><a href="#服务的可用性场景" class="headerlink" title="服务的可用性场景"></a>服务的可用性场景</h2><p>在一个高度服务化的系统中,我们实现的一个业务逻辑通常会依赖多个服务，并且常常也会调用同一个服务。</p>
<p>假如说秒杀商品服务链路下，积分服务因为并发大、流量激增等而导致挂掉了。当请求过来，在商品请求积分的时候，所有的请求都会挤压在商品到积分的链路上，得不到响应，在服务提供者不可用的时候，会出现大量重试的情况：用户重试、代码逻辑重试，这些重试最终导致：进一步加大请求流量。所以归根结底导致雪崩效应的最根本原因是：大量请求线程同步等待造成的资源耗尽。当服务调用者使用同步调用时, 会产生大量的等待线程占用系统资源。一旦线程资源被耗尽,服务调用者提供的服务也将处于不可用状态, 于是服务雪崩效应产生了。，从而加剧流量的增加，请求停留在商品服务中，商品服务也挂掉了，以此类推。而商品服务作为一个共享的服务，从而导致其他服务链路不可用。这就是服务雪崩。</p>
<p><strong>服务雪崩效应</strong>：因服务提供者的不可用导致服务调用者的不可用,并将不可用逐渐放大的过程，就叫服务雪崩效应。</p>
<h3 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h3><p>常见的容错机制：</p>
<ul>
<li><p><strong>超时机制</strong></p>
<p>在不做任何处理的情况下，服务提供者不可用会导致消费者请求线程强制等待，而造成系统资源耗尽。加入超时机制，一旦超时，就释放资源。由于释放资源速度较快，一定程度上可以抑制资源耗尽的问题。这种机制是很基本，也挺常用的防护机制。比如设置服务与服务之间的连接超时时间。如果在规定时间内没有得到响应的话，给用户返回请求超时等，当然如果在这个规定时间内，并发量还是很大的话，还是会挤爆线程池。</p>
</li>
<li><p><strong>服务限流(针对流量进行限制)</strong></p>
<p>当某个服务访问量达到了它所能承受的临界值后，肯定要为它设置限流：比如说，会提前为这个服务进行一个压测，得到一个QPS(每秒访问量)的临界值为500，然后为它进行限流，一旦QPS为800的时候，有300会进行限流，只有500才能访问服务，针对300的请求我们可以进行降级，比如返回请求服务过多，或者直接拒绝等。</p>
</li>
<li><p><strong>隔离(根据线程或信号)</strong></p>
<p>原理：用户的请求将不再直接访问服务，而是通过线程池中的空闲线程来访问服务，如果线程池已满，则会进行降级处理，用户的请求不会被阻塞，至少可以看到一个执行结果（例如返回友好的提示信息），而不是无休止的等待或者看到系统崩溃。</p>
</li>
<li><p><strong>服务熔断</strong></p>
<p>远程服务不稳定或网络抖动时暂时关闭，就叫服务熔断。</p>
<p>现实世界的断路器大家肯定都很了解，断路器实时监控电路的情况，如果发现电路电流异常，就会跳闸，从而防止电路被烧毁。</p>
<p>软件世界的断路器可以这样理解：实时监测应用，如果发现在一定时间内失败次数/失败率达到一定阈值，就“跳闸”，断路器打开——此时，请求直接返回，而不去调用原本调用的逻辑。跳闸一段时间后（例如10秒），断路器会进入半开状态，这是一个瞬间态，此时允许一次请求调用该调的逻辑，如果成功，则断路器关闭，应用正常调用；如果调用依然不成功，断路器继续回到打开状态，过段时间再进入半开状态尝试——通过”跳闸“，应用可以保护自己，而且避免浪费资源；而通过半开的设计，可实现应用的“自我修复“。所以，同样的道理，当依赖的服务有大量超时时，在让新的请求去访问根本没有意义，只会无畏的消耗现有资源。比如我们设置了超时时间为1s,如果短时间内有大量请求在1s内都得不到响应，就意味着这个服务出现了异常，此时就没有必要再让其他的请求去访问这个依赖了，这个时候就应该使用断路器避免资源浪费。</p>
</li>
<li><p><strong>服务降级</strong></p>
<p>有服务熔断，必然要有服务降级。</p>
<p>通过来说，服务还会区分强依赖(订单服务就是强依赖，它一挂掉，秒杀商品就不能用了)还是弱依赖(比如积分服务，它挂掉之后，它不影响秒杀商品的下单，此时就应该给它一个降级，比如说给它记录一个日志，哪个商品哪个订单，后续再根据调度对它进行补偿，把积分恢复起来)，在弱依赖上实现降级</p>
<p>所谓降级，就是当某个服务熔断之后，服务将不再被调用，此时客户端可以自己准备一个本地的fallback（回退）回调，返回一个缺省值。 例如：(备用接口/缓存/mock数据) 。这样做，虽然服务水平下降，但好歹可用，比直接挂掉要强，当然这也要看适合的业务场景。</p>
</li>
</ul>
<h2 id="Sentinel是什么"><a href="#Sentinel是什么" class="headerlink" title="Sentinel是什么"></a>Sentinel是什么</h2><p>Sentinel是阿里巴巴开源的，面向分布式服务架构的高可用防护组件</p>
<p>随着微服务的流行，服务和服务之间的稳定性变得越来越重要。Sentinel 是面向分布式服务架构的流量控制组件，主要以流量为切入点，从限流、流量整形、熔断降级、系统负载保护、热点防护等多个维度来帮助开发者保障微服务的稳定性。</p>
<p>官方文档：<a href="https://github.com/alibaba/Sentinel/wiki" target="_blank" rel="noopener">https://github.com/alibaba/Sentinel/wiki</a></p>
<p><strong>Sentinel和Hystrix对比</strong></p>
<h2 id="Sentinel代码使用"><a href="#Sentinel代码使用" class="headerlink" title="Sentinel代码使用"></a>Sentinel代码使用</h2><p>Sentinel 可以简单的分为 Sentinel 核心库(需要在代码中进行依赖的)和 Dashboard(Sentinel的控制台，界面化操作)。核心库不依赖 Dashboard，但是结合 Dashboard 可以取得最好的效果（也就是说核心库的东西可以通过java代码来实现）。</p>
<p>定义的Sentinel进行资源保护的几个步骤（我们说的资源，可以是任何东西，服务，服务里的方法，甚至是一段代码）：</p>
<ol>
<li><p>定义资源</p>
</li>
<li><p>定义规则</p>
</li>
<li><p>检验规则是否生效</p>
</li>
</ol>
<p>先把可能需要保护的资源定义好（埋点），之后再配置规则。也可以理解为，只要有了资源，我们就可以在任何时候灵活地定义各种流量控制规则。在编码的时候，只需要考虑这个代码是否需要保护，如果需要保护，就将之定义为一个资源。</p>
<p>下面先使用 Java 代码来实现流控的操作(有利于对源码的理解)：</p>
<ol>
<li><p>创建一个sentinel_demo模块，这里pom文件中的parent没有继承springcloud父项目(因为单纯的使用sentinel核心库的时候，不需要一定得在spring cloud alibaba上使用的，它可以在分布式架构中使用，并不一定说是微服务，即我们可以单纯地使用这个核心库)</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.3.2.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel_demo<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--针对rest接口进行设置的--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--sentinel核心库--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.16<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--如果要使用@SentinelResource--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-annotation-aspectj<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>创建一个接口，用来定义资源(通常资源名与接口名一致)，然后为资源进行规则的设置(这里是流控规则)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hbp.controller;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String RESOURCE_NAME = <span class="string">"hello"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 1.定义资源</span></span><br><span class="line"><span class="comment">     * 进行sentinel流控</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">        Entry entry = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 1.sentinel针对资源进行限制的(通常资源的名称会跟接口的名称一致)</span></span><br><span class="line">            entry = SphU.entry(RESOURCE_NAME);</span><br><span class="line">            String str = <span class="string">"hello Sentinel"</span>;</span><br><span class="line">            log.info(<span class="string">"====="</span> + str + <span class="string">"====="</span>);</span><br><span class="line">            <span class="keyword">return</span> str;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (BlockException e) &#123;</span><br><span class="line">            <span class="comment">// 资源访问阻止，被限流或被降级</span></span><br><span class="line">            <span class="comment">// 进行相应的处理操作</span></span><br><span class="line">            log.info(<span class="string">"block!"</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">"被流控了!!"</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">            <span class="comment">// 若需要配置降级规则，需要通过这种方式记录业务异常</span></span><br><span class="line">            Tracer.traceEntry(ex,entry);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (entry != <span class="keyword">null</span>) &#123;</span><br><span class="line">                entry.exit();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 2.为资源进行定义规则</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@PostConstruct</span>： Spring的初始化注解。</span></span><br><span class="line"><span class="comment">     * 当前HelloController这个Bean创建的时候，它会自动调用被<span class="doctag">@PostConstruct</span>标注的初始化操作</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initFlowRules</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 流控规则集合</span></span><br><span class="line">        ArrayList&lt;FlowRule&gt; rules = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// 一个流控规则</span></span><br><span class="line">        FlowRule rule = <span class="keyword">new</span> FlowRule();</span><br><span class="line">        <span class="comment">// 设置受保护的资源(为哪个资源进行流控)</span></span><br><span class="line">        rule.setResource(RESOURCE_NAME);</span><br><span class="line">        <span class="comment">// 设置流控规则 QPS(每秒的访问数)</span></span><br><span class="line">        rule.setGrade(RuleConstant.FLOW_GRADE_QPS);</span><br><span class="line">        <span class="comment">// 设置受保护的资源阈值</span></span><br><span class="line">        <span class="comment">// 结合上行的QPS，这里的意思就是：每秒只能访问1次，如果超过1次，就会对其进行流控(出发BlockException异常)</span></span><br><span class="line">        rule.setCount(<span class="number">1</span>);</span><br><span class="line">        rules.add(rule);</span><br><span class="line">        <span class="comment">// 加载配置好的规则</span></span><br><span class="line">        FlowRuleManager.loadRules(rules);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试。测试结果：每秒访问接口1次是可以正常访问的，而如果每秒多次访问，则会显示”被流控了!!”。</p>
</li>
</ol>
<p>缺点：</p>
<ol>
<li>业务侵入性很强，需要在controller中写入非业务代码，定义资源和处理被控流的处理代码都得耦合到这个接口当中。</li>
<li>配置不灵活 若需要添加新的受保护资源 需要手动添加 init方法来添加流控规则 </li>
</ol>
<p>因此，可以通过@SentinelResource可以改善上面的方式</p>
<h3 id="注解-SentinelResource"><a href="#注解-SentinelResource" class="headerlink" title="注解@SentinelResource"></a>注解@SentinelResource</h3><ol>
<li><p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--如果要使用@SentinelResource--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-annotation-aspectj<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.8.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>配置Bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SentinelApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SentinelApplication<span class="class">.<span class="keyword">class</span>,<span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SentinelResourceAspect <span class="title">sentinelResourceAspect</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> SentinelResourceAspect();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>定义资源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String USER_RESOURCE_NAME = <span class="string">"user"</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@SentinelResource</span>：改善接口中资源定义和被流控降级后的处理方法(也就是hello接口中的try和第一个catch)</span></span><br><span class="line"><span class="comment"> * 【使用】：</span></span><br><span class="line"><span class="comment"> * value：定义资源</span></span><br><span class="line"><span class="comment"> * blockHandler：设置流控降级后的处理方法(默认该方法必须声明在同一个类中)</span></span><br><span class="line"><span class="comment"> *      如果不想在同一个类中，则可以使用 blockHandlerClass，并且该方法一定得使用static</span></span><br><span class="line"><span class="comment"> * fallback：当接口出现了异常，就可以交给fallback指定得方法进行处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="meta">@SentinelResource</span>(value = USER_RESOURCE_NAME, blockHandler = <span class="string">"blockHandlerForGetUser"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> User(<span class="string">"hbp"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>降级后(不符合规则)的处理方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 【注意】：</span></span><br><span class="line"><span class="comment"> * 1.一定要public</span></span><br><span class="line"><span class="comment"> * 2.返回值一定要和定义资源的方法的返回值保持一致，并要包含源方法参数，顺序也要一样(即被<span class="doctag">@SentinelResource</span>，设置了blockHandler对应的方法，称为源方法)</span></span><br><span class="line"><span class="comment"> *     因为A服务调用B服务的时候，一旦被流控，不可能直接返回一个异常给用户，假如B服务是一个无关紧要的服务(弱依赖)，完全可以返回一个正常的结果；如果是强依赖，则返回“当前请求过多=”</span></span><br><span class="line"><span class="comment"> * 3.可以在参数后添加 BlockException 可以区分是什么规则的处理方法</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">blockHandlerForGetUser</span><span class="params">(String id,BlockException ex)</span> </span>&#123;</span><br><span class="line">    ex.printStackTrace();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> User(<span class="string">"流控了！！！"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>为资源定义降级规则</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 2.为资源进行定义规则</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@PostConstruct</span>： Spring的初始化注解。</span></span><br><span class="line"><span class="comment"> * 当前HelloController这个Bean创建的时候，它会自动调用被<span class="doctag">@PostConstruct</span>标注的初始化操作</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initFlowRules</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 流控规则集合</span></span><br><span class="line">    ArrayList&lt;FlowRule&gt; rules = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    <span class="comment">// 一个流控规则</span></span><br><span class="line">    FlowRule rule = <span class="keyword">new</span> FlowRule();</span><br><span class="line">    <span class="comment">// 设置受保护的资源(为哪个资源进行流控)</span></span><br><span class="line">    rule.setResource(RESOURCE_NAME);</span><br><span class="line">    <span class="comment">// 设置流控规则 QPS(每秒的访问数)</span></span><br><span class="line">    rule.setGrade(RuleConstant.FLOW_GRADE_QPS);</span><br><span class="line">    <span class="comment">// 设置受保护的资源阈值</span></span><br><span class="line">    <span class="comment">// 结合上行的QPS，这里的意思就是：每秒只能访问1次，如果超过1次，就会对其进行流控(出发BlockException异常)</span></span><br><span class="line">    rule.setCount(<span class="number">1</span>);</span><br><span class="line">    rules.add(rule);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过@SentinelResource来定义资源并配置降级和流控的处理方法</span></span><br><span class="line">    FlowRule rule2 = <span class="keyword">new</span> FlowRule();</span><br><span class="line">    rule2.setRefResource(USER_RESOURCE_NAME);</span><br><span class="line">    rule2.setGrade(RuleConstant.FLOW_GRADE_QPS);</span><br><span class="line">    rule2.setCount(<span class="number">1</span>);</span><br><span class="line">    rules.add(rule2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 加载配置好的规则</span></span><br><span class="line">    FlowRuleManager.loadRules(rules);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试。</p>
</li>
<li><p>异常处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/user"</span>)</span><br><span class="line"><span class="meta">@SentinelResource</span>(value = USER_RESOURCE_NAME,</span><br><span class="line">        fallback = <span class="string">"fallbackhandleForGetUser"</span>,</span><br><span class="line">        blockHandler = <span class="string">"blockHandlerForGetUser"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">getUser</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> User(<span class="string">"hbp"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">fallbackhandleForGetUser</span><span class="params">(String id,Throwable e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> User(<span class="string">"有异常"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>若 blockHandler 和 fallback 都进行了配置，流控降级的优先级要更高。</strong></p>
</li>
<li><p>具体@SentinelResouce 用法，看<a href="https://github.com/alibaba/Sentinel/wiki/%E6%B3%A8%E8%A7%A3%E6%94%AF%E6%8C%81" target="_blank" rel="noopener">官方文档</a></p>
</li>
</ol>
<h3 id="熔断降级"><a href="#熔断降级" class="headerlink" title="熔断降级"></a>熔断降级</h3><ol>
<li><p>定义资源</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/degrade"</span>)</span><br><span class="line"><span class="meta">@SentinelResource</span>(value = DEGRADE_RESOURCE_NAME,entryType = EntryType.IN,blockHandler = <span class="string">"blockHandlerForFb"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">degrade</span><span class="params">(String id)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="keyword">throw</span>  <span class="keyword">new</span> RuntimeException(<span class="string">"异常"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>为资源设置降级处理操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">blockHandlerForFb</span><span class="params">(String id,BlockException ex)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> User(<span class="string">"hbbbbp"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置熔断降级规则</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 降级规则</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@PostConstruct</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initDegradeRule</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ArrayList&lt;DegradeRule&gt; degradeRules = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">    DegradeRule degradeRule = <span class="keyword">new</span> DegradeRule();</span><br><span class="line">    degradeRule.setResource(DEGRADE_RESOURCE_NAME);</span><br><span class="line">    <span class="comment">// 设置降级规则：异常数</span></span><br><span class="line">    degradeRule.setGrade(RuleConstant.DEGRADE_GRADE_EXCEPTION_COUNT);</span><br><span class="line">    <span class="comment">// 触发熔断异常数:2</span></span><br><span class="line">    degradeRule.setCount(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 触发熔断最小请求数:3</span></span><br><span class="line">    degradeRule.setMinRequestAmount(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 统计时长，单位ms 。这里如果时间太短不好测试</span></span><br><span class="line">    degradeRule.setStatIntervalMs(<span class="number">60</span>*<span class="number">1000</span>*<span class="number">60</span>);</span><br><span class="line">    <span class="comment">// 上面4行代码意思：1分钟内，请求3次，如果出现了2次异常就会触发熔断</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 熔断持续时长，单位是秒，根据上述规则，一旦触发了熔断，就会有一个熔断期，</span></span><br><span class="line"><span class="comment">     * 在这熔断期内，如果还有请求，就会调用我们的降级处理方法，而不是调用我们接口的代码，</span></span><br><span class="line"><span class="comment">     * 如果熔断期完了之后，它会恢复接口请求调用，但是如果在恢复后的第一次请求异常，</span></span><br><span class="line"><span class="comment">     * 就会直接再次熔断，而不会设置的规则进行判定了。</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    degradeRule.setTimeWindow(<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line">    degradeRules.add(degradeRule);</span><br><span class="line">    <span class="comment">// 加载熔断规则</span></span><br><span class="line">    DegradeRuleManager.loadRules(degradeRules);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>自行测试</p>
</li>
</ol>
<p>流控规则一般设置在服务提供方，而降级规则一般设置在调用方</p>
<p>其他降级规则代码如上的套路。</p>
<h2 id="启动-Sentinel-控制台"><a href="#启动-Sentinel-控制台" class="headerlink" title="启动 Sentinel 控制台"></a><strong>启动</strong> <strong>Sentinel</strong> 控制台</h2><p>下载控制台 jar 包并在本地启动：<a href="https://github.com/alibaba/Sentinel/releases" target="_blank" rel="noopener">https://github.com/alibaba/Sentinel/releases</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动控制台命名</span></span><br><span class="line">java -jar sentinel-dashboard-1.8.0.jar</span><br></pre></td></tr></table></figure>

<p>访问：localhost:8080  默认账号密码都是 sentinel</p>
<blockquote>
<p>用户可以通过如下参数进行配置：</p>
<p>-Dsentinel.dashboard.auth.username=sentinel -Dsentinel.dashboard.auth.password 用于指定控制台的登录用户名和密码</p>
<p>-Dserver.port=8858 启动端口号</p>
</blockquote>
<p>更多配置参考：</p>
<p><strong>为了方便快捷启动可以在桌面创建.bat批处理文件</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">java ‐Dserver.port=8858 ‐Dsentinel.dashboard.auth.username=hbp ‐Dsentinel.dashboard.auth.password=123456 ‐jar D:\server\sentinel‐dashboard‐1.8.0.jar</span><br><span class="line">pause</span><br></pre></td></tr></table></figure>

<p>保存，双击运行即可快速启动Sentinel服务了(如果运行时，cmd出现乱码，请把命令删除，重新手动输入)</p>
<h2 id="Spring-Cloud-Alibaba整合Sentinel"><a href="#Spring-Cloud-Alibaba整合Sentinel" class="headerlink" title="Spring Cloud Alibaba整合Sentinel"></a>Spring Cloud Alibaba整合Sentinel</h2><p>自行创建模块测试</p>
<ol>
<li><p>引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>添加yml配置，为微服务设置sentinel控制台地址</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8061</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">order-sentinel</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8858</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>添加测试接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/flow"</span>)</span><br><span class="line"><span class="meta">@SentinelResource</span>(value = <span class="string">"flow"</span>,blockHandler = <span class="string">"flowBlockHandler"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">flow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"正常访问"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">flowBlockHandler</span><span class="params">(BlockException e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"流控flow了"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在sentinel控制台中设置流控规则</p>
<p>流量控制(flow control)，其原理是监控应用流量的QPS (每秒访问量)或 并发线程数 等指标，当达到指定的阈值时对流量进行控制，以避免被瞬时的流量高峰冲垮，从而保障应用的高可用性</p>
<p>应用场景：</p>
<ul>
<li>应对洪峰流量：秒杀，大促，下单，订单回流处理</li>
<li>消息型场景：削峰填谷，冷热启动</li>
<li>付费系统：根据使用流量付费</li>
<li>API Gateway：精准控制API流量</li>
<li>任何应用：探测应用中运行的满程序块，进行限制</li>
</ul>
<p>最普适的场景：</p>
<ol>
<li>Provider端（提供端是被访问的，所以是在提供端进行流控）控制脉冲流量（忽然的高峰流量）</li>
<li>针对不同调用来源进行流控(H5端，App端=)</li>
<li>Web接口流控</li>
</ol>
<p>如何配置流控规则：</p>
<ol>
<li>梳理核心接口</li>
<li>通过事前压测评估核心接口的容量</li>
<li>配置QPS</li>
</ol>
</li>
</ol>
<h3 id="QPS"><a href="#QPS" class="headerlink" title="QPS"></a>QPS</h3><p><strong>这里是对@SentinelResource中的value资源进行流控，即是使用自定义的</strong>，设置单机阈值为2</p>
<p><img src="https://springcloudalibaba.oss-cn-guangzhou.aliyuncs.com/%E6%B5%81%E6%8E%A7%E8%A7%84%E5%88%99%E8%AE%BE%E7%BD%AE.jpg" alt></p>
<ol>
<li>测试结果。</li>
</ol>
<p>【<strong>注意</strong>】：每次重启服务，就要重新在控制台里设置规则。下面会讲如何持久化</p>
<h3 id="并发线程数"><a href="#并发线程数" class="headerlink" title="并发线程数"></a><strong>并发线程数</strong></h3><p>并发数控制用于保护业务线程池不被慢调用耗尽。Sentinel 并发控制不负责创建和管理线程池，而是简单统计当前请求上下文的线程数目（正在执行的调用数目），如果超出阈值，新的请求会被立即拒绝，效果类似于信号量隔离。并发数控制通常在调用端进行配置。</p>
<p>QPS和并发线程数区别：</p>
<p>QPS是每次只允许一个请求访问。</p>
<p><img src="https://springcloudalibaba.oss-cn-guangzhou.aliyuncs.com/qps.png" alt></p>
<p>线程是当一个请求进来，服务器还在处理中，还没有响应给客户端，则其他线程必须等待。</p>
<p><img src="https://springcloudalibaba.oss-cn-guangzhou.aliyuncs.com/%E7%BA%BF%E7%A8%8B.png" alt></p>
<h3 id="BlockException异常统一处理"><a href="#BlockException异常统一处理" class="headerlink" title="BlockException异常统一处理"></a>BlockException异常统一处理</h3><p>如果接口声明了@SentinelResource的话，就不用走全局异常的方法</p>
<ol>
<li><p>处理类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.hbp.exception;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyBlockExceptionHandler</span> <span class="keyword">implements</span> <span class="title">BlockExceptionHandler</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    Logger log = LoggerFactory.getLogger(<span class="keyword">this</span>.getClass());</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse response, BlockException e)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// getRule() 资源 规则的详细信息</span></span><br><span class="line">        log.info(e.getRule());</span><br><span class="line">        </span><br><span class="line">        Result r = <span class="keyword">new</span> Result();</span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> FlowException) &#123;</span><br><span class="line">            r = Result.error(<span class="number">100</span>, <span class="string">"接口限流了"</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> DegradeException) &#123;</span><br><span class="line">            r = Result.error(<span class="number">101</span>, <span class="string">"服务降级了"</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> ParamFlowException) &#123;</span><br><span class="line">            r = Result.error(<span class="number">102</span>, <span class="string">"热点参数限流了"</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> SystemBlockException) &#123;</span><br><span class="line">            r = Result.error(<span class="number">103</span>, <span class="string">"触发系统保护规则了"</span>);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e <span class="keyword">instanceof</span> AuthorityException) &#123;</span><br><span class="line">            r = Result.error(<span class="number">104</span>, <span class="string">"授权规则不通过"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//返回json数据</span></span><br><span class="line">        response.setStatus(<span class="number">500</span>);</span><br><span class="line">        response.setCharacterEncoding(<span class="string">"utf-8"</span>);</span><br><span class="line">        response.setContentType(MediaType.APPLICATION_JSON_VALUE);</span><br><span class="line">        <span class="keyword">new</span> ObjectMapper().writeValue(response.getWriter(), r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>把controller要测试接口中的@SentinelResource去掉，并且在dashboard控制台对’order/flow’配置流控。</p>
</li>
<li><p>测试是否使用了全局异常处理</p>
</li>
</ol>
<h3 id="流控的高级模式-提供端"><a href="#流控的高级模式-提供端" class="headerlink" title="流控的高级模式(提供端)"></a>流控的高级模式(提供端)</h3><p><strong>直接(默认)</strong></p>
<p>资源调用达到设置的阈值后直接被流控抛出异常</p>
<p><strong>关联</strong></p>
<p>当两个资源之间具有资源争抢或者依赖关系的时候，这两个资源便具有了关联。比如要下单，要进行商品进行秒杀的时候，需要保证插入数据库的操作，而此时如果查询量也同样大的时候，这时候对数据库造成读操作和写操作的资源争抢，读的速度过高会影响写得速度，从而影响系统的吞吐量，写的速度过高会影响读的速度。如果放任读写操作争抢资源，这样当写库操作过于频繁时，读数据的请求会被限流。因此我们可以通过对插入限制流控，进而影响查询。当插入频繁的时候，读数据的请求会被限流。即由生成订单来触发查询项目的流线。</p>
<p><img src="https://springcloudalibaba.oss-cn-guangzhou.aliyuncs.com/%E5%85%B3%E8%81%94.jpg" alt></p>
<p><strong>链路</strong></p>
<p>根据调用链路入口限流。</p>
<p>sentinel同样支持对方法进行流控</p>
<p> 下面中记录了资源之间的调用链路，这些资源通过调用关系，相互之间构成一棵调用树。这棵树的根节点是一个名字为getUser 的虚拟节点，调用链的入口都是这个虚节点的子节点。</p>
<p>一棵典型的调用树如下图所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">/order/test1  /order/test2</span><br><span class="line">    \             /     </span><br><span class="line">     \           /     </span><br><span class="line">      \         /</span><br><span class="line">        getUser</span><br></pre></td></tr></table></figure>

<p>上图中来自入口 /order/test1 和 /order/test2的请求都调用到了方法(资源) getUser（即在/order/test1 &amp; /order/test2的业务方法中都调用了getUser这个方法(需要标注@SentinelResource注解)）</p>
<p><img src="https://springcloudalibaba.oss-cn-guangzhou.aliyuncs.com/%E9%93%BE%E8%B7%AF.jpg" alt></p>
<p>测试，发现链路规则不生效。</p>
<p>这时候需要在配置文件中配置下列参数即可：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">spring.cloud.sentinel.web‐context‐unify:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<h3 id="流控效果"><a href="#流控效果" class="headerlink" title="流控效果"></a>流控效果</h3><h4 id="快速失败"><a href="#快速失败" class="headerlink" title="快速失败"></a>快速失败</h4><p>（RuleConstant.CONTROL_BEHAVIOR_DEFAULT）方式是默认的流量控制方式，当QPS超过任意规则的阈值后，新的请求就会被立即拒绝，拒绝方式为抛出FlowException。这种方式适用于对系统处理能力确切已知的情况下，比如通过压测确定了系统的准确水位时。</p>
<h4 id="Warm-Up（激增流量）"><a href="#Warm-Up（激增流量）" class="headerlink" title="Warm Up（激增流量）"></a>Warm Up（激增流量）</h4><p>Warm Up（RuleConstant.CONTROL_BEHAVIOR_WARM_UP）方式，即预热/冷启动方式。当系统长期处于低水位的情况下，当流量突然增加时，直接把系统拉升到高水位可能瞬间把系统压垮。通过”冷启动”，让通过的流量缓慢增加，在一定时间内逐渐增加到阈值上限，给冷系统一个预热的时间，避免冷系统被压垮。比如以电商举例，平时有无人问津的商品，一搞大促，流量激增，正常来说应该先去找Cache，但这时Cache不存在或已过时，这时候大量的请求就会瞬间达到DB层。压垮系统。而Warm up则是会慢慢地访问，那么在此期间，缓存就上来了，到后面查询就很快了。</p>
<p>冷加载因子: codeFactor 默认是3，即请求 QPS 从 threshold / 3 开始，经预热时长逐渐升至设定的 QPS 阈值。</p>
<h4 id="排队等待（脉冲流量）"><a href="#排队等待（脉冲流量）" class="headerlink" title="排队等待（脉冲流量）"></a><strong>排队等待（脉冲流量）</strong></h4><p>匀速排队（<code>RuleConstant.CONTROL_BEHAVIOR_RATE_LIMITER</code>）方式会严格控制请求通过的间隔时间，也即是让请求以均匀的速度通过，对应的是漏桶算法</p>
<p>这种方式主要用于处理间隔性突发的流量，例如消息队列。想象一下这样的场景，在某一秒有大量的请求到来，而接下来的几秒则处于空闲状态，我们希望系统能够在接下来的空闲期间逐渐处理这些请求，而不是在第一秒直接拒绝多余的请求。</p>
<p>注意：匀速排队模式暂时不支持 QPS &gt; 1000 的场景</p>
<p>以上可以用 jemeter 进行压测</p>
<h3 id="降级规则"><a href="#降级规则" class="headerlink" title="降级规则"></a><strong>降级规则</strong></h3><p>除了流量控制以外，对调用链路中不稳定的资源进行熔断降级也是保障高可用的重要措施之一。我们需要对不稳定的<strong>弱依赖服务调用</strong>进行熔断降级，暂时切断不稳定调用，避免局部不稳定因素导致整体的雪崩。熔断降级作为保护自身的手段，通常在客户端<strong>（调用端）</strong>进行配置。</p>
<h4 id="熔断降级与隔离-通常在消费端组合配置"><a href="#熔断降级与隔离-通常在消费端组合配置" class="headerlink" title="熔断降级与隔离(通常在消费端组合配置)"></a>熔断降级与隔离(通常在消费端组合配置)</h4><ul>
<li>并发控制(信号量隔离)</li>
<li>基于慢调用比例熔断</li>
<li>基于异常比例熔断</li>
</ul>
<h4 id="触发熔断后的处理逻辑示例"><a href="#触发熔断后的处理逻辑示例" class="headerlink" title="触发熔断后的处理逻辑示例"></a>触发熔断后的处理逻辑示例</h4><ul>
<li>提供 fallback 或 blockhandler 实现(服务降级)</li>
<li>返回错误result</li>
<li>读缓存(DB访问降级)</li>
</ul>
<h5 id="慢调用比例"><a href="#慢调用比例" class="headerlink" title="慢调用比例"></a><strong>慢调用比例</strong></h5><p>慢调用比例 (SLOW_REQUEST_RATIO)：选择以慢调用比例作为阈值，需要设置允许的慢调用 RT（即最大的响应时间），请求的响应时间大于该值则统计为慢调用。当单位统计时长（statIntervalMs）内请求数目大于设置的最小请求数目，并且慢调用的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF­OPEN 状态），若接下来的一个请求响应时间小于设置的慢调用 RT 则结束熔断，若大于设置的慢调用 RT 则会再次被熔断。</p>
<h5 id="异常比例"><a href="#异常比例" class="headerlink" title="异常比例"></a><strong>异常比例</strong></h5><p>异常比例 (ERROR_RATIO)：当单位统计时长（statIntervalMs）内请求数目大于设置的最小请求数目，并且异常的比例大于阈值，则接下来的熔断时长内请求会自动被熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF­OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。异常比率的阈值范围是 [0.0, 1.0]，代表 0% ­ 100%。</p>
<h5 id="异常数"><a href="#异常数" class="headerlink" title="异常数"></a><strong>异常数</strong></h5><p>异常数 (ERROR_COUNT)：当单位统计时长内的异常数目超过阈值之后会自动进行熔断。经过熔断时长后熔断器会进入探测恢复状态（HALF­OPEN 状态），若接下来的一个请求成功完成（没有错误）则结束熔断，否则会再次被熔断。注意：异常降级仅针对业务异常，对 Sentinel 限流降级本身的异常（BlockException）不生效。</p>
<h3 id="整合openfeign进行降级"><a href="#整合openfeign进行降级" class="headerlink" title="整合openfeign进行降级"></a>整合openfeign进行降级</h3><p><img src="https://springcloudalibaba.oss-cn-guangzhou.aliyuncs.com/openFeign%E6%95%B4%E5%90%88sentinel.jpg" alt></p>
<ol>
<li><p>自行创建模块，并引入依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--nacos服务注册发现，这里不需要写版本，因为父Maven的springCloudAlibaba管理器已经帮我们管理好版本了--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.6.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.5.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>库存服务中controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/reduce2"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">reduce2</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">1</span> / <span class="number">0</span>;</span><br><span class="line">    System.out.println(<span class="string">"扣减库存"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"扣减库存:"</span> + port;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>调用者的OpenFeign接口：StockFeignService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"stock-server"</span>,path = <span class="string">"/stock"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">StockFeignService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/reduce2"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">reduce2</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>调用者的controller</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/order"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    StockFeignService stockFeignService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/add"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">add</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"下单成功"</span>);</span><br><span class="line">        String msg = stockFeignService.reduce2();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"hello feign"</span> + msg ;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>先测试一下是否报500(正常来说是会报的)</p>
</li>
<li><p>openfegin的fallback实现类(得继承上面得OpenFeign接口)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StockFeignServiceFallback</span> <span class="keyword">implements</span> <span class="title">StockFeignService</span></span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">reduce2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"被降级啦！！"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>openfeign接口添加fallback参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"stock-server"</span>,path = <span class="string">"/stock"</span>,fallback = StockFeignServiceFallback<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">interface</span> <span class="title">StockFeignService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/reduce2"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">reduce2</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置文件中启动openfeign整合sentinel</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">sentinel:</span></span><br><span class="line">    <span class="comment"># openfeign整合sentinel</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<h3 id="热点参数限流"><a href="#热点参数限流" class="headerlink" title="热点参数限流"></a>热点参数限流</h3><p>热点识别流控</p>
<p>何为热点？热点即经常访问的数据。很多时候我们希望统计某个热点数据中访问频次最高的数据，并对其访问进行限制。（某些商品是电商系统经常访问的）</p>
<p>热点参数限流会统计传入参数中的热点参数，并根据配置的限流阈值与模式，对包含热点参数的资源调用进行限流。热点参数限流可以看做是一种特殊的流量控制，仅对包含热点参数的资源调用生效。</p>
<p>【<strong>注意】：</strong></p>
<ol>
<li><p>热点规则需要使用@SentinelResource(“resourceName”)注解，否则不生效</p>
</li>
<li><p>参数必须是7种基本数据类型才会生效</p>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/info/&#123;id&#125;"</span>) </span><br><span class="line"><span class="meta">@SentinelResource</span>(value = <span class="string">"userinfo"</span>, </span><br><span class="line">                 blockHandler = <span class="string">"handleException2"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> R <span class="title">info</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Integer id)</span>&#123;</span><br><span class="line">  UserEntity user = userService.getById(id);</span><br><span class="line">  <span class="keyword">return</span> R.ok().put(<span class="string">"user"</span>, user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p> 单机阈值： 针对所有参数的值进行设置的一个公共的阈值</p>
<ol>
<li><p>假设当前 参数 大部分的值都是热点流量， 单机阈值就是针对热点流量进行设置，  额外针对普通流量进行参数值流控</p>
</li>
<li><p>假设当前 参数 大部分的值都是普通流量， 单机阈值就是针对普通流量进行设置，  额外针对热点流量进行参数值流控</p>
</li>
</ol>
<h3 id="系统规则"><a href="#系统规则" class="headerlink" title="系统规则"></a><strong>系统规则</strong></h3><p>就算是有上述的所有防控规则，也不能一定能保证系统的稳定性</p>
<p>比如：</p>
<ol>
<li>容量评估不到位，某个大流量接口没有配置，导致系统崩溃</li>
<li>突然发现机器的Load和CPU使用率过高，但却没有办法很快的确认到底是哪里出现了问题，也来不及处理</li>
<li>规则难配，依赖难梳理等</li>
</ol>
<p>希望有个全局的兜底防护，即便因为种种原因导致系统崩了，也希望有个一定的保护机制</p>
<p>Sentinel 系统自适应限流从整体维度对应用入口流量进行控制，结合应用的 Load、CPU 使用率、总体平均 RT、入口 QPS 和并发线程数等几个维度的监控指标，通过自适应的流控策略，让系统的入口流量和系统的负载达到一个平衡，让系统尽可能跑在最大吞吐量的同时保证系统整体的稳定性。</p>
<ul>
<li><strong>Load</strong> <strong>自适应</strong>（仅对 Linux/Unix­like 机器生效）：系统的 load1 作为启发指标，进行自适应系统保护。当系统load1 超过设定的启发值，且系统当前的并发线程数超过估算的系统容量时才会触发系统保护（BBR 阶段）。系统容量由系统的 maxQps * minRt 估算得出。设定参考值一般是 CPU cores * 2.5。<a href="https://www.cnblogs.com/gentlemanhai/p/8484839.html" target="_blank" rel="noopener">https://www.cnblogs.com/gentlemanhai/p/8484839.html</a></li>
<li><strong>CPU usage</strong>（1.5.0+ 版本）：当系统 CPU 使用率超过阈值即触发系统保护（取值范围 0.0­1.0），比较灵敏。</li>
<li><strong>平均</strong> <strong>RT</strong>：当单台机器上所有入口流量的<strong>平均</strong> RT 达到阈值即触发系统保护，单位是毫秒。</li>
<li><strong>并发线程数</strong>：当单台机器上所有入口流量的平均并发线程数达到阈值即触发系统保护。</li>
<li><strong>入口</strong> <strong>QPS</strong>：当单台机器上所有入口流量的<strong>平均</strong> QPS 达到阈值即触发系统保护。</li>
</ul>
<h2 id="规则持久化"><a href="#规则持久化" class="headerlink" title="规则持久化"></a>规则持久化</h2><p>目前来说，在控制台设置的信息，一旦重复服务后，配置将失效，因为它默认保存在内存中。这给我们带来非常大的不便</p>
<h3 id="Sentinel持久化模式"><a href="#Sentinel持久化模式" class="headerlink" title="Sentinel持久化模式"></a>Sentinel持久化模式</h3><h4 id="原始模式-默认模式"><a href="#原始模式-默认模式" class="headerlink" title="原始模式(默认模式)"></a>原始模式(默认模式)</h4><p>如果不做任何修改，Dashboard 的推送规则方式是通过 API 将规则推送至客户端并直接更新到内存中：这种做法的好处是简单，无依赖；坏处是应用重启规则就会消失，仅用于简单测试，不能用于生产环境。</p>
<h4 id="拉模式"><a href="#拉模式" class="headerlink" title="拉模式"></a><strong>拉模式</strong></h4><p>pull 模式的数据源（如本地文件、RDBMS 等）一般是可写入的。使用时需要在客户端注册数据源：将对应的读数据源注册至对应的 RuleManager，将写数据源注册至 transport 的WritableDataSourceRegistry 中。</p>
<h4 id="推模式-常用"><a href="#推模式-常用" class="headerlink" title="推模式(常用)"></a><strong>推模式(常用)</strong></h4><p>生产环境下一般更常用的是 push 模式的数据源。对于 push 模式的数据源,如远程配置中心（ZooKeeper, Nacos, Apollo等等），推送的操作不应由 Sentinel 客户端进行，而应该经控制台统一进行管理，直接进行推送，数据源仅负责获取配置中心推送的配置并更新到本地。因此推送规则正确做法应该是 <strong>配置中心控制台**</strong>/Sentinel** <strong>控制台</strong> <strong>→</strong> <strong>配置中心</strong> <strong>→</strong> <strong>Sentinel</strong> <strong>数据源</strong> <strong>→ Sentinel</strong>，而不是经 Sentinel 数据源推送至配置中心。这样的流程就非常清晰了：</p>
<h5 id="基于Nacos配置中心控制台实现推送"><a href="#基于Nacos配置中心控制台实现推送" class="headerlink" title="基于Nacos配置中心控制台实现推送"></a>基于Nacos配置中心控制台实现推送</h5><ol>
<li><p>添加依赖</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>Nacos配置中心中配置DataId等(下面这些参数可以在官网看是什么意思)</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[ </span><br><span class="line">    &#123; </span><br><span class="line">        <span class="attr">"resource"</span>: <span class="string">"order/test"</span>, </span><br><span class="line">        "controlBehavior": 0, #QPS</span><br><span class="line">        "count": 10.0,  #阈值</span><br><span class="line">        "grade": 1, </span><br><span class="line">        "limitApp": "default", </span><br><span class="line">        "strategy": 0 </span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
</li>
<li><p>yaml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">datasource:</span></span><br><span class="line">  <span class="attr">flow-rule:</span> <span class="comment"># 名字可以自定义</span></span><br><span class="line">  <span class="attr">nacos:</span></span><br><span class="line">   <span class="string">server‐addr:</span> <span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span><span class="string">:8848</span></span><br><span class="line">   <span class="string">dataId:</span> <span class="string">$&#123;spring.application.name&#125;</span></span><br><span class="line">   <span class="attr">groupId:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line">   <span class="string">data‐type:</span> <span class="string">json</span></span><br><span class="line">   <span class="string">rule‐type:</span> <span class="string">flow</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>测试。此时，直接可以在Sentinel控制台中可以看到重启服务也有配置了</p>
</li>
</ol>

      <blockquote class="mdui-m-t-5">
        
          <strong>本文遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">CC BY-NC-SA 4.0</a> 许可协议，转载请附上原文出处链接和本声明。</strong><br>
        
        <strong>本文链接：</strong><a href="https://yellowbp.github.io/2021/07/04/Spring Cloud Alibaba(6.服务熔断sentinel)/">https://yellowbp.github.io/2021/07/04/Spring Cloud Alibaba(6.服务熔断sentinel)/</a>
      </blockquote>
      
    </div>
    <footer class="mdui-card-actions">
      
        <a class="mdui-ripple article_categories-link" href="/categories/SpringCloud-Alibaba/">SpringCloud Alibaba</a>
      
      
        <a class="mdui-ripple article_tags-link" href="/tags/git/">git</a>
      
    </footer>
    
  </article>
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script>$("#main article .mdui-card-content img.fancybox").on("click",function(e){$.fancybox.open({src:$(this).attr("src")});});</script>


  <nav id="paginator">
    
      <a rel="prev" class="extend prev" href="/2021/07/04/Spring Could Alibaba(1.基本开发框架搭建)/">
        <button aria-label="prev" class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_back</i></button>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上一篇
      </a>
    
    <div class="spacer"></div>
    
      <a rel="next" class="extend next" href="/2021/06/29/linux部署jar包/">
        下一篇&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <button aria-label="next" class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_forward</i></button>
      </a>
    
  </nav>


  <div id="comment" class="mdui-m-t-5">
    <style>#pop_ad,#feedAv{display:none!important;position:absolute!important;z-index:-9999;left:-1000px;opacity:0!important}</style>
<div id="SOHUCS" sid="cl0fhnfol007vkktwalz20zly"></div>
<script type="text/javascript">
(function(){
var appid = 'cyubhC2Dq';
var conf = 'prod_e4cce65003c5bed049fefcb8a6f09e12';
var width = window.innerWidth || document.documentElement.clientWidth;
if (width < 960) {
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="http://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("http://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>
  </div>



  <div style="position: fixed !important; right: 16px; top: 30%;">
    <button class="mdui-fab mdui-fab-mini mdui-ripple" mdui-menu="{target: '#toc'}"><i class="mdui-icon material-icons">format_list_numbered</i></button>
    <ul class="mdui-menu" id="toc">
      <li class="mdui-menu-item" disabled><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Spring-Cloud-Alibaba-6-服务熔断sentinel"><span class="toc-number">1.</span> <span class="toc-text">Spring Cloud Alibaba(6.服务熔断sentinel)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#分布式遇到的问题"><span class="toc-number">1.1.</span> <span class="toc-text">分布式遇到的问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#服务的可用性场景"><span class="toc-number">1.2.</span> <span class="toc-text">服务的可用性场景</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#解决方案"><span class="toc-number">1.2.1.</span> <span class="toc-text">解决方案</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sentinel是什么"><span class="toc-number">1.3.</span> <span class="toc-text">Sentinel是什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Sentinel代码使用"><span class="toc-number">1.4.</span> <span class="toc-text">Sentinel代码使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#注解-SentinelResource"><span class="toc-number">1.4.1.</span> <span class="toc-text">注解@SentinelResource</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#熔断降级"><span class="toc-number">1.4.2.</span> <span class="toc-text">熔断降级</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#启动-Sentinel-控制台"><span class="toc-number">1.5.</span> <span class="toc-text">启动 Sentinel 控制台</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Cloud-Alibaba整合Sentinel"><span class="toc-number">1.6.</span> <span class="toc-text">Spring Cloud Alibaba整合Sentinel</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#QPS"><span class="toc-number">1.6.1.</span> <span class="toc-text">QPS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#并发线程数"><span class="toc-number">1.6.2.</span> <span class="toc-text">并发线程数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#BlockException异常统一处理"><span class="toc-number">1.6.3.</span> <span class="toc-text">BlockException异常统一处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#流控的高级模式-提供端"><span class="toc-number">1.6.4.</span> <span class="toc-text">流控的高级模式(提供端)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#流控效果"><span class="toc-number">1.6.5.</span> <span class="toc-text">流控效果</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#快速失败"><span class="toc-number">1.6.5.1.</span> <span class="toc-text">快速失败</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Warm-Up（激增流量）"><span class="toc-number">1.6.5.2.</span> <span class="toc-text">Warm Up（激增流量）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#排队等待（脉冲流量）"><span class="toc-number">1.6.5.3.</span> <span class="toc-text">排队等待（脉冲流量）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#降级规则"><span class="toc-number">1.6.6.</span> <span class="toc-text">降级规则</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#熔断降级与隔离-通常在消费端组合配置"><span class="toc-number">1.6.6.1.</span> <span class="toc-text">熔断降级与隔离(通常在消费端组合配置)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#触发熔断后的处理逻辑示例"><span class="toc-number">1.6.6.2.</span> <span class="toc-text">触发熔断后的处理逻辑示例</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#慢调用比例"><span class="toc-number">1.6.6.2.1.</span> <span class="toc-text">慢调用比例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#异常比例"><span class="toc-number">1.6.6.2.2.</span> <span class="toc-text">异常比例</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#异常数"><span class="toc-number">1.6.6.2.3.</span> <span class="toc-text">异常数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#整合openfeign进行降级"><span class="toc-number">1.6.7.</span> <span class="toc-text">整合openfeign进行降级</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#热点参数限流"><span class="toc-number">1.6.8.</span> <span class="toc-text">热点参数限流</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#系统规则"><span class="toc-number">1.6.9.</span> <span class="toc-text">系统规则</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#规则持久化"><span class="toc-number">1.7.</span> <span class="toc-text">规则持久化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Sentinel持久化模式"><span class="toc-number">1.7.1.</span> <span class="toc-text">Sentinel持久化模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#原始模式-默认模式"><span class="toc-number">1.7.1.1.</span> <span class="toc-text">原始模式(默认模式)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#拉模式"><span class="toc-number">1.7.1.2.</span> <span class="toc-text">拉模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#推模式-常用"><span class="toc-number">1.7.1.3.</span> <span class="toc-text">推模式(常用)</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#基于Nacos配置中心控制台实现推送"><span class="toc-number">1.7.1.3.1.</span> <span class="toc-text">基于Nacos配置中心控制台实现推送</span></a></li></ol></li></ol></li></ol></li></ol></li></ol></li>
    </ul>
  </div>
</main>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<footer id="footer" class="mdui-m-t-5 mdui-p-y-3 mdui-color-theme">
  <div class="mdui-p-y-0 mdui-text-center">
    
    
    
    
    
    
    
      <a href="https://github.com/yellowbp" target="_blank"><i class="mdui-p-a-1 mdui-icon iconfont mdui-text-color-theme-a100">&#xe7ab;</i></a>
    
    
    
    
    
      <a href="tencent://message/?uin=1432440963&Menu=yes" target="_blank"><i class="mdui-p-a-1 mdui-icon iconfont mdui-text-color-theme-a100">&#xe651;</i></a>
    
    
  </div>
  <div class="mdui-p-y-1 mdui-text-center">
    Copyright &copy; 2019 - 2022 hbp<br>
    Powered by <a href="https://hexo.io/" target="_blank" class="mdui-text-color-theme-accent">Hexo</a>hbp All rights reserved.
    
    <br>
    <span id="busuanzi_container_site_uv">
    本网站总访问量<span id="busuanzi_value_site_uv"></span>次
    </span>
  </div>
</footer>
  <button id="gotop" class="mdui-fab mdui-fab-fixed mdui-fab-hide mdui-ripple mdui-color-theme-accent"><i class="mdui-icon material-icons">arrow_upward</i></button>
  <script async src="http://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <script src="/js/mdui.js"></script>
<script src="/js/script.js"></script>
</body>
</html>