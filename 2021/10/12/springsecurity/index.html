<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="renderer" content="webkit">

  
  <title>bp的Blog</title>

  <link rel="shortcut icon" href="/images/favicon.png">
  
  <meta name="description" content="SpringSecurity只要掌握了认证和授权功能的核心原理，无论什么安全框架使用起来都会非常容易！那么本文就讲解如何使用主流的安全框架Spring Security来实现认证和授权功能，并且顺带剖析Spring Security的源码。 提纲挈领Web系统中登录认证（Authentication）的核心就是凭证机制，无论是session还是token，都是在用户成功登录时返回给用户一个凭证，后">
<meta name="keywords" content="Spring">
<meta property="og:type" content="article">
<meta property="og:title" content="bp的Blog">
<meta property="og:url" content="https://yellowbp.github.io/2021/10/12/springsecurity/index.html">
<meta property="og:site_name" content="bp的Blog">
<meta property="og:description" content="SpringSecurity只要掌握了认证和授权功能的核心原理，无论什么安全框架使用起来都会非常容易！那么本文就讲解如何使用主流的安全框架Spring Security来实现认证和授权功能，并且顺带剖析Spring Security的源码。 提纲挈领Web系统中登录认证（Authentication）的核心就是凭证机制，无论是session还是token，都是在用户成功登录时返回给用户一个凭证，后">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81%E7%AE%80%E7%95%A5%E5%9B%BE.png">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E6%8E%88%E6%9D%83%E6%9D%83%E9%99%90%E7%AE%80%E7%95%A5%E5%9B%BE.png">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE.png">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/springsecurity%E5%8A%A0%E8%BD%BD%E7%9A%84%E6%89%80%E6%9C%89%E8%BF%87%E6%BB%A4%E5%99%A8.png">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E4%B8%89%E4%B8%AA%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6%E7%9A%84%E5%85%B3%E7%B3%BB.png">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E6%B3%A8%E5%86%8C%E7%94%A8%E6%88%B7.png">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E6%B5%8B%E8%AF%95%E8%AE%A4%E8%AF%81%E9%94%99%E8%AF%AF.png">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81%E6%88%90%E5%8A%9F%E6%B5%8B%E8%AF%95.png">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E5%86%8D%E6%AC%A1%E8%AF%B7%E6%B1%82%E6%8E%A5%E5%8F%A3.png">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E5%9B%BE.png">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/token%E7%99%BB%E5%BD%95%E6%93%8D%E4%BD%9C.png">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E6%9B%BF%E6%8D%A2%E8%BF%87%E6%BB%A4%E5%99%A8%E5%90%8E%E7%9A%84%E8%BF%87%E6%BB%A4%E9%93%BE.png">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E6%90%BA%E5%B8%A6token%E5%90%8E%E8%AF%B7%E6%B1%82%E6%8E%A5%E5%8F%A3.png">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E6%9D%83%E9%99%90%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B%E5%9B%BE.png">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E6%8E%A5%E5%8F%A3%E8%B5%84%E6%BA%90%E5%9C%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E4%BD%93%E7%8E%B0.png">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E6%B2%A1%E6%9C%89%E6%9D%83%E9%99%90%E6%B5%8B%E8%AF%95.png">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E6%9C%89%E6%9D%83%E9%99%90%E6%B5%8B%E8%AF%95.png">
<meta property="og:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/springsecurity%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE.png">
<meta property="og:updated_time" content="2022-01-17T09:30:27.286Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="bp的Blog">
<meta name="twitter:description" content="SpringSecurity只要掌握了认证和授权功能的核心原理，无论什么安全框架使用起来都会非常容易！那么本文就讲解如何使用主流的安全框架Spring Security来实现认证和授权功能，并且顺带剖析Spring Security的源码。 提纲挈领Web系统中登录认证（Authentication）的核心就是凭证机制，无论是session还是token，都是在用户成功登录时返回给用户一个凭证，后">
<meta name="twitter:image" content="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81%E7%AE%80%E7%95%A5%E5%9B%BE.png">

  <meta name="format-detection" content="telephone=no,email=no">
  <meta name="theme-color" content="#9C27B0">
  <meta name="description" content>
  <meta name="keywords" content=",Spring">

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="bp的Blog">
  <meta name="msapplication-starturl" content="https://yellowbp.github.io/2021/10/12/springsecurity/">
  <meta name="msapplication-navbutton-color" content="#9C27B0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="bp的Blog">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/images/favicon.png">

  
    <meta property="article:published_time" content="Tue Oct 12 2021 23:35:39 GMT+0800">
    <meta property="article:modified_time" content="Mon Jan 17 2022 17:30:27 GMT+0800">
  

  
    <link rel="canonical" href="https://yellowbp.github.io/2021/10/12/springsecurity/">
  

  <meta name="google-site-verification" content="fXjtlIfaDc_X-0P11rO3bEp1Nk4IKXphoJv0GqGZCco">
  <meta name="baidu-site-verification" content="I3t1wfwZvd">

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create','UA-139531378-1','auto');ga('send','pageview');
</script>
  <script>
  var _hmt = _hmt || [];
  (function() {var hm = document.createElement('script');
  hm.src = 'https://hm.baidu.com/hm.js?1054d51c0b66f1d168829173682c8159';
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script>
  

  <link rel="stylesheet" href="/css/mdui.css">
<link rel="stylesheet" href="/css/style.css">
</head>
<body class="mdui-appbar-with-toolbar mdui-drawer-body-left mdui-theme-primary-brown mdui-theme-accent-blue">
  <script>var a=localStorage.getItem("mdui-theme-layout-dark");if(a){document.getElementsByTagName("body")[0].className+=" mdui-theme-layout-dark"};</script>
  <header id="header" class="mdui-appbar mdui-appbar-fixed mdui-appbar-scroll-hide mdui-appbar-inset">
  <div class="mdui-toolbar mdui-color-theme">
    <a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-drawer="{target: '#sidebar', swipe: true}"><i class="mdui-icon material-icons">menu</i></a>
    <a href="/" class="mdui-typo-headline">bp的Blog</a>
    <div class="mdui-toolbar-spacer"></div>
    <a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-dialog="{target: '#search'}" mdui-tooltip="{content: '搜索'}"><i class="mdui-icon material-icons">search</i></a>
    
  </div>
</header>
<div class="mdui-dialog" id="search">
  
    <div class="search-form">
      <input type="search" class="search-form-input" placeholder="请输入关键字">
    </div>
    <div class="search-result" data-resource="/search.xml"></div>
  
</div>
  <aside id="sidebar" class="mdui-drawer mdui-drawer-full-height">
  <div class="mdui-grid-tile">
    <img src="/images/Gradient1.jpg" style="height: 160px;">
    <img src="/images/headPic.jpg" class="avatar-animation" style="position: absolute; top: 10%; left: 24px; width: 64px; height: 64px; border: 2px solid #fff; border-radius: 50%;">
    <div class="mdui-grid-tile-actions">
      <div class="mdui-grid-tile-text">
        <div class="mdui-grid-tile-title">hbp
        </div>
        <div class="mdui-grid-tile-subtitle"><i class="mdui-icon material-icons">art_track</i>要想快，先会慢</div>
      </div>
      
        <div class="mdui-grid-tile-buttons">
          <a href="mailto:347070556@qq.com" class="mdui-btn mdui-btn-icon" mdui-tooltip="{content: '347070556@qq.com'}"><i class="mdui-icon material-icons">email</i></a>
        </div>
      
    </div>
  </div>

  <div class="mdui-list" mdui-collapse="{accordion: true}">
    <a href="/" class="mdui-list-item mdui-ripple">
      <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-blue">home</i>
      <div class="mdui-list-item-content">主页</div>
    </a>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-deep-orange">inbox</i>
        <div class="mdui-list-item-content">归档</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/archives/2022/03/">三月 2022<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2022/02/">二月 2022<span class="mdui-ripple sidebar_archives-count">12</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/10/">十月 2021<span class="mdui-ripple sidebar_archives-count">9</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/09/">九月 2021<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/08/">八月 2021<span class="mdui-ripple sidebar_archives-count">6</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/07/">七月 2021<span class="mdui-ripple sidebar_archives-count">12</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/06/">六月 2021<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/05/">五月 2021<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/04/">四月 2021<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/03/">三月 2021<span class="mdui-ripple sidebar_archives-count">9</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/02/">二月 2021<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/01/">一月 2021<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2020/03/">三月 2020<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/12/">十二月 2019<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/11/">十一月 2019<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/10/">十月 2019<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/09/">九月 2019<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/08/">八月 2019<span class="mdui-ripple sidebar_archives-count">6</span></a>
        
      </div>
    </div>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-green">chrome_reader_mode</i>
        <div class="mdui-list-item-content">分类</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/categories/ElasticSearch/">ElasticSearch<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/Spring/">Spring<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/SpringBoot/">SpringBoot<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/SpringCloud-Alibaba/">SpringCloud Alibaba<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/SpringMVC/">SpringMVC<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/docker/">docker<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/excel/">excel<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/git/">git<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/java8/">java8<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/java基础/">java基础<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/jenkins/">jenkins<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/jenkins/docker/">docker<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/jwt/">jwt<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/k8s/">k8s<span class="mdui-ripple sidebar_archives-count">10</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/linux/">linux<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/linux搭建/">linux搭建<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/maven/">maven<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/mybatis/">mybatis<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/mysql/">mysql<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/redis/">redis<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/servlet/">servlet<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/ssm/">ssm<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/yaml/">yaml<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/上传下载文件/">上传下载文件<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/乱码/">乱码<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/参数校验/">参数校验<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/发短信/">发短信<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/小程序/">小程序<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/工具类/">工具类<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/开发软件/">开发软件<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/技术/">技术<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/搭建博客/">搭建博客<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/源码分析/">源码分析<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/电脑硬件/">电脑硬件<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/算法/">算法<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/缓存/">缓存<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/虚拟机/">虚拟机<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/规范/">规范<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/认证授权/">认证授权<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/设计模式/">设计模式<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/负载均衡/">负载均衡<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/通用工具类/">通用工具类<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/部署/">部署<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/重装/">重装<span class="mdui-ripple sidebar_archives-count">1</span></a>
        
      </div>
    </div>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-brown">bookmark</i>
        <div class="mdui-list-item-content">标签</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/tags/Spring/">Spring<span class="mdui-ripple sidebar_archives-count">22</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/algorithm/">algorithm<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/excel/">excel<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/git/">git<span class="mdui-ripple sidebar_archives-count">13</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/hexo/">hexo<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/javaWeb/">javaWeb<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/java基础/">java基础<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/jwt/">jwt<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/linux/">linux<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/mysql/">mysql<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/nginx/">nginx<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/redis/">redis<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/servlet/">servlet<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/spring/">spring<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/win7/">win7<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/其他/">其他<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/分布式/">分布式<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/接口文档/">接口文档<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/笔记本选购/">笔记本选购<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/自动化构建工具/">自动化构建工具<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/设计模式/">设计模式<span class="mdui-ripple sidebar_archives-count">4</span></a>
        
      </div>
    </div>
    <a href="/about" class="mdui-list-item mdui-ripple">
      <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-purple">person</i>
      <div class="mdui-list-item-content">关于</div>
    </a>
  </div>

  <div class="mdui-divider"></div>

  <div class="mdui-list" mdui-collapse="{accordion: true}">
    
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <div class="mdui-list-item-content">友情链接</div>
        <i class="mdui-list-item-icon mdui-icon material-icons">link</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        
          <a href="javascript:;" class="mdui-list-item mdui-ripple mdui-p-l-2 mdui-text-color-theme" style="justify-content: center;">链接为空</a>
        
      </div>
    </div>
  </div>
</aside>
  <main id="main" class="mdui-m-t-5 fadeIn animated">
  <link rel="stylesheet" href="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.css">
  <style>#main article .mdui-card-content .center-block{display:block!important;margin-right:auto!important;margin-left:auto!important}</style>
  <article class="mdui-card mdui-m-b-5">
    <header class="mdui-card-media">
      <img src="/images/random/material-15.png" style="max-height: 240px;">
      <div class="mdui-card-media-covered">
        <div class="mdui-card-primary">
          <div class="mdui-card-primary-title"></div>
          <div class="mdui-card-primary-subtitle"><i class="iconfont">&#xe697;</i> 2021-10-12 / 
          <i class="iconfont">&#xe601;</i> hbp
          <span id="busuanzi_container_page_pv">
            本文总阅读量<span id="busuanzi_value_page_pv"></span>次
          </span>
          </div>
        </div>
      </div>
      <div class="mdui-card-menu">
        
        
      </div>
    </header>
    <div class="mdui-card-content mdui-typo">
      <h1 id="SpringSecurity"><a href="#SpringSecurity" class="headerlink" title="SpringSecurity"></a>SpringSecurity</h1><p>只要掌握了认证和授权功能的核心原理，无论什么安全框架使用起来都会非常容易！那么本文就讲解如何使用主流的安全框架Spring Security来实现认证和授权功能，并且顺带剖析Spring Security的源码。</p>
<h2 id="提纲挈领"><a href="#提纲挈领" class="headerlink" title="提纲挈领"></a>提纲挈领</h2><p>Web系统中登录认证（Authentication）的核心就是<strong>凭证</strong>机制，无论是<code>session</code>还是<code>token</code>，都是在用户成功登录时返回给用户一个凭证，后续用户访问接口需携带凭证来表明自己的身份。后端会对需要进行认证的接口进行安全判断，若凭证没问题则代表已登录就放行接口，若凭证有问题则直接拒绝请求。这个安全判断<strong>都是放在过滤器里统一处理的</strong>：</p>
<img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81%E7%AE%80%E7%95%A5%E5%9B%BE.png" alt="登录认证简略图" style="zoom:75%;">

<p>登录认证是对<strong>用户的身份</strong>进行确认，权限授权（Authorization）是对<strong>用户能否访问某个资源</strong>进行确认，授权发生都认证之后。与认证一样，这种通用逻辑都是放在过滤器里进行的统一操作：</p>
<img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E6%8E%88%E6%9D%83%E6%9D%83%E9%99%90%E7%AE%80%E7%95%A5%E5%9B%BE.png" alt="授权权限简略图" style="zoom:75%;">

<p><code>LoginFilter</code>先进行登录认证判断，认证通过后再由<code>AuthFilter</code>进行权限授权判断，一层一层没问题后才会执行我们真正的业务逻辑。</p>
<p>Spring Security对Web系统的支持<strong>就是基于这一个个过滤器组成的过滤器链</strong></p>
<img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E8%BF%87%E6%BB%A4%E5%99%A8%E9%93%BE.png" alt="过滤器链" style="zoom:80%;">

<p>当初始化 Spring Security 时，在<code>Servlet</code>过滤器链中，会创建一个名为 FilterChainProxy 过滤器 ，这个代理过滤器会创建一套Spring Security自定义的过滤器链，然后执行一系列过滤器。我们可以大概看一下<code>FilterChainProxy</code>的大致源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">      FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">    </span><br><span class="line">    ...省略其他代码	</span><br><span class="line">        </span><br><span class="line">    doFilterInternal(request, response, chain);</span><br><span class="line">    </span><br><span class="line">    ...省略其他代码</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(ServletRequest request, ServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">			FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line"></span><br><span class="line">    ...省略其他代码</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取Spring Security的一套过滤器</span></span><br><span class="line">    List&lt;Filter&gt; filters = getFilters(fwRequest);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将这一套过滤器组成Spring Security自己的过滤器链，并开始执行</span></span><br><span class="line">    VirtualFilterChain vfc = <span class="keyword">new</span> VirtualFilterChain(fwRequest, chain, filters);</span><br><span class="line">    vfc.doFilter(fwRequest, fwResponse);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>doFilterInternal是OncePerRequestFilter 中的一个抽象方法</p>
<p>OncePerRequestFilter.doFilter方法中通过request.getAttribute判断当前过滤器是否已执行，若未执行过，则调用doFilterInternal方法，交由其子类实现</p>
<p>OncePerRequestFilter是由Spring提供的抽象类，它能够确保在一次请求中只通过一次filter，而不会重复执行</p>
</blockquote>
<img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/springsecurity%E5%8A%A0%E8%BD%BD%E7%9A%84%E6%89%80%E6%9C%89%E8%BF%87%E6%BB%A4%E5%99%A8.png" alt="springsecurity加载的所有过滤器" style="zoom:80%;">

<p>这里面我们只需要重点关注两个过滤器即可：<code>UsernamePasswordAuthenticationFilter</code>负责登录认证，<code>FilterSecurityInterceptor</code>负责权限授权。</p>
<blockquote>
<p>Spring Security的核心逻辑全在这一套过滤器中，这些Filter作为Bean被Spring管理，过滤器里会调用各种组件完成功能，掌握了这些过滤器和组件你就掌握了Spring Security！这个框架的使用方式就是对这些过滤器和组件进行扩展。</p>
</blockquote>
<h2 id="代码编写"><a href="#代码编写" class="headerlink" title="代码编写"></a>代码编写</h2><h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><p>只需要引入Spring Security依赖包即可</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>依赖包导入后，Spring Security就默认提供了许多功能将整个应用给保护了起来：</p>
<ul>
<li>创建好了spring security默认的登录页面及提交的表单</li>
<li>要求经过身份验证的用户才能与应用程序进行交互</li>
<li>默认生成用户名为<code>user</code>的随机密码并打印在控制台上</li>
<li><code>CSRF</code>攻击防护、<code>Session Fixation</code>攻击防护</li>
<li>==</li>
</ul>
<p>在实际开发中，有些<strong>默认配置好的功能往往不符合我们的实际需求，所以我们一般会自定义一些配置</strong>。配置方式很简单，新建一个配置类即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里不需要加 @Configuration，因为@EnableWebSecurity中已经加了</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在该类中重写<code>WebSecurityConfigurerAdapter</code>中的方法就能对Spring Security进行自定义配置。</p>
<h3 id="登录认证"><a href="#登录认证" class="headerlink" title="登录认证"></a>登录认证</h3><p>依赖包和配置类准备好后，接下来我们要完成的第一个功能那自然是登录认证，毕竟用户要使用我们系统第一步就是登录。之前文章介绍了<code>Session</code>和<code>token</code>两种认证方式，这里我们来用Spring Security实现这两种认证。</p>
<h4 id="最简单的认证方式"><a href="#最简单的认证方式" class="headerlink" title="最简单的认证方式"></a>最简单的认证方式</h4><p>不管哪种认证方式和框架，有些核心概念是不会变的，这些核心概念在安全框架中会以各种组件来体现，了解各个组件的同时功能也就跟着实现了功能。</p>
<p>我们系统中会有许多用户，确认当前是哪个用户正在使用我们系统就是登录认证的最终目的。这里我们就提取出了一个核心概念：<strong>当前登录用户/当前认证用户</strong>。整个系统安全都是围绕当前登录用户展开的！这个不难理解，要是当前登录用户都不能确认了，那A下了一个订单，下到了B的账户上这不就乱套了。这一概念在Spring Security中的体现就是 <strong><code>Authentication</code></strong>，它存储了认证信息，代表当前登录用户。</p>
<p>我们在程序中如何获取并使用它呢？我们就需要通过上下文对象 <strong><code>SecurityContext</code></strong> 来获取<code>Authentication</code></p>
<blockquote>
<p>这种在一个线程中横跨若干方法调用，需要传递的对象，我们通常称之为上下文（Context）。上下文对象是非常有必要的，否则你每个方法都得额外增加一个参数接收对象，实在太麻烦了。</p>
</blockquote>
<p>这个上下文对象则是交由 <strong><code>SecurityContextHolder</code></strong> 进行管理，你可以在程序<strong>任何地方</strong>使用它：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Authentication authentication = SecurityContextHolder.getContext().getAuthentication();</span><br></pre></td></tr></table></figure>

<p><code>SecurityContextHolder</code>原理非常简单，就是和我们之前实现的上下文对象一样，使用<code>ThreadLocal</code>来保证一个线程中传递同一个对象！</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadLocalSecurityContextHolderStrategy</span> <span class="keyword">implements</span> <span class="title">SecurityContextHolderStrategy</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 保证线程中传递得是同一个对象</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ThreadLocal&lt;SecurityContext&gt; contextHolder = <span class="keyword">new</span> ThreadLocal();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SecurityContext <span class="title">getContext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        SecurityContext ctx = (SecurityContext)contextHolder.get();</span><br><span class="line">        <span class="keyword">if</span> (ctx == <span class="keyword">null</span>) &#123;</span><br><span class="line">            ctx = <span class="keyword">this</span>.createEmptyContext();</span><br><span class="line">            contextHolder.set(ctx);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> ctx;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们已经知道了Spring Security中三个核心组件：</p>
<ul>
<li>Authentication：存储了认证信息，代表当前登录用户</li>
<li>SeucirtyContext：上下文对象，用来获取<code>Authentication</code></li>
<li>SecurityContextHolder：上下文管理对象，用来在程序任何地方获取<code>SecurityContext</code></li>
</ul>
<p>他们关系如下：</p>
<img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E4%B8%89%E4%B8%AA%E6%A0%B8%E5%BF%83%E7%BB%84%E4%BB%B6%E7%9A%84%E5%85%B3%E7%B3%BB.png" alt="三个核心组件的关系" style="zoom:80%;">

<p><code>Authentication</code>中那三个玩意就是认证信息：</p>
<p><code>Principal</code>：用户信息，没有认证时一般是用户名，认证后一般是用户对象，即 UserDetails</p>
<p><code>Credentials</code>：用户凭证，一般是密码</p>
<p><code>Authorities</code>：用户权限</p>
<p>现在我们知道如何获取并使用当前登录用户了，那这个用户是怎么进行认证的呢？总不能我随便new一个就代表用户认证完毕了吧。所以我们还缺一个生成<code>Authentication</code>对象的认证过程！</p>
<p>认证过程就是登录过程，不使用安全框架时咱们的认证过程是这样的：</p>
<blockquote>
<p>查询用户数据 –&gt; 判断账号密码是否正确 –&gt; 正确则将用户信息存储到上下文中 –&gt; 上下文中有了这个对象则代表该用户登录了</p>
</blockquote>
<p>Spring Security的认证流程也是如此：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Authentication authentication = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(用户名, 用户密码, 用户的权限集合);</span><br><span class="line">SecurityContextHolder.getContext().setAuthentication(authentication);</span><br></pre></td></tr></table></figure>

<p>和不使用安全框架一样，将认证对象放到上下文中就代表用户已登录。上面代码演示的就是Spring Security最简单的认证方式，直接将<code>Authentication</code>放置到<code>SecurityContext</code>中就完成认证了！</p>
<p>这个流程和之前获取当前登录用户的流程自然是相反的：</p>
<blockquote>
<p>Authentication –&gt; SecurityContext –&gt; SecurityContextHolder</p>
</blockquote>
<p>是不是觉得，就这？这就完成认证啦？这也太简单了吧。对于Spring Security来说，这样确实就完成了认证，但对于我们来说还少了一步，那就是判断用户的账号密码是否正确。用户进行登录操作时会传递过来账号密码，我们肯定是要查询用户数据然后判断传递过来的账号密码是否正确，只有正确了咱们才会将认证信息放到上下文对象中，不正确就直接提示错误：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 调用service层执行判断业务逻辑</span></span><br><span class="line"><span class="keyword">if</span> (!userService.login(用户名, 用户密码)) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"账号密码错误"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 账号密码正确了才将认证信息放到上下文中（用户权限需要再从数据库中获取，后面再说，这里省略）</span></span><br><span class="line">Authentication authentication = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(用户名, 用户密码, 用户的权限集合);</span><br><span class="line">SecurityContextHolder.getContext().setAuthentication(authentication);</span><br></pre></td></tr></table></figure>

<p>这样才算是一个完整的认证过程，和不使用安全框架时的流程是一样的哦，只是一些组件之前是我们自己实现的。</p>
<p>这里查询用户信息并校验账号密码是完全由我们自己在业务层编写所有逻辑，其实这一块Spring Security也有组件供我们使用：</p>
<h4 id="AuthenticationManager认证方式"><a href="#AuthenticationManager认证方式" class="headerlink" title="AuthenticationManager认证方式"></a>AuthenticationManager认证方式</h4><p><strong><code>AuthenticationManager</code></strong> 就是Spring Security用于执行身份验证的认证管理器组件，只需要调用它的<code>authenticate</code>方法即可完成认证，它将一个未认证的<code>Authentication</code>传入，返回一个已认证的<code>Authentication</code>，默认使用的实现类为：ProviderManager。Spring Security默认的认证方式就是在<code>UsernamePasswordAuthenticationFilter</code>这个过滤器中调用这个认证管理器组件，该管理器负责认证逻辑。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Authentication <span class="title">attemptAuthentication</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">      HttpServletResponse response)</span> <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line">    </span><br><span class="line">   ...省略其他代码</span><br><span class="line">    </span><br><span class="line">   String username = obtainUsername(request);</span><br><span class="line">   String password = obtainPassword(request);</span><br><span class="line"></span><br><span class="line">   UsernamePasswordAuthenticationToken authRequest = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(</span><br><span class="line">         username, password);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">return</span> <span class="keyword">this</span>.getAuthenticationManager().authenticate(authRequest);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> AuthenticationManager <span class="title">getAuthenticationManager</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> authenticationManager;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们要按照自己的方式使用这个组件，先在之前配置类配置一下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里不需要加 @Configuration，因为@EnableWebSecurity中已经加了</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationManager <span class="title">authenticationManager</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.authenticationManager();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里我们写上完整的登录接口代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"/api"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"/login"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">login</span><span class="params">(@RequestBody LoginParam param)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 生成一个包含账号密码的认证信息</span></span><br><span class="line">        UsernamePasswordAuthenticationToken authenticationToken = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(param.getUserName(), param.getPassword());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// AuthenticationManager来校验这个认证信息，返回一个已认证的Authentication</span></span><br><span class="line">        Authentication authentication = authenticationManager.authenticate(authenticationToken);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将返回的Authentication存到上下文中</span></span><br><span class="line">        SecurityContextHolder.getContext().setAuthentication(authentication);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"登录成功"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意，这里流程和之前说的流程是完全一样的，只是用户身份验证改成了使用<code>AuthenticationManager</code>来进行。</p>
</blockquote>
<p><code>AuthenticationManager</code>的校验逻辑非常简单：</p>
<p>根据用户名先查询出用户对象(没有查到则抛出异常) – &gt; 将查到的用户对象的密码和传递过来的密码进行校验，密码不匹配则抛出异常</p>
<p>这个逻辑没啥好说的，再简单不过了。重点是这里每一个步骤Spring Security都提供了组件：</p>
<p>是谁执行 <strong>根据用户名查询出用户对象</strong> 逻辑的呢？用户对象数据可以存在内存中、文件中、数据库中，你得确定好怎么查才行。这一部分就是交由<strong><code>UserDetialsService</code></strong> 接口处理的，该接口只有一个方法<code>loadUserByUsername(String username)</code>，通过用户名查询用户对象，默认实现是在内存中查询。</p>
<p>那查询出来的 <strong>用户对象</strong> 又是什么呢？每个系统中的用户对象数据都不尽相同，咱们需要确认我们的用户数据是啥样的才行。Spring Security中的用户数据则是由<strong><code>UserDetails</code></strong> 来体现，该接口中提供了账号、密码等通用属性。</p>
<p><strong>对密码进行校验</strong>大家可能会觉得比较简单，<code>if、else</code>搞定，就没必要用什么组件了吧？但框架毕竟是框架考虑的比较周全，除了<code>if、else</code>外还解决了密码加密的问题，这个组件就是<strong><code>PasswordEncoder</code></strong>，负责密码加密与校验。</p>
<p>我们可以看下<code>AuthenticationManager</code>校验逻辑的大概源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProviderManager</span> <span class="keyword">implements</span> <span class="title">AuthenticationManager</span>, <span class="title">MessageSourceAware</span>,<span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 只展示核心代码</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Authentication <span class="title">authenticate</span><span class="params">(Authentication authentication)</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> AuthenticationException </span>&#123;</span><br><span class="line"></span><br><span class="line">        ...省略其他代码</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 传递过来的用户名</span></span><br><span class="line">        String username = authentication.getName();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用UserDetailService的方法，用用户名查询出用户对象UserDetails(查询不出来UserDetailService则会抛出异常)</span></span><br><span class="line">        UserDetails loadedUser = <span class="keyword">this</span>.getUserDetailsService().loadUserByUsername(username);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 传递过来的密码</span></span><br><span class="line">        String presentedPassword = authentication.getCredentials().toString();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用密码解析器passwordEncoder传递过来的密码是否和真实的用户密码匹配</span></span><br><span class="line">        <span class="keyword">if</span> (!passwordEncoder.matches(presentedPassword, userDetails.getPassword())) &#123;</span><br><span class="line">            <span class="comment">// 密码错误则抛出异常</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BadCredentialsException(messages.getMessage(<span class="string">"Bad credentials"</span>));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这里返回的是已认证的Authentication，是将整个UserDetils放进去充当principal</span></span><br><span class="line">        UsernamePasswordAuthenticationToken result = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(</span><br><span class="line">            principal, authentication.getCredentials(),</span><br><span class="line">            authoritiesMapper.mapAuthorities(user.getAuthorities()));</span><br><span class="line">        result.setDetails(authentication.getDetails());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">        ...省略其他代码</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>UserDetialsService</code>–&gt; <code>UserDetails</code> –&gt; <code>PasswordEncoder</code>，这三个组件Spring Security都有默认实现，这一般是满足不了我们的实际需求的，所以这里我们自己来实现这些组件！</p>
<h5 id="加密器PasswordEncoder"><a href="#加密器PasswordEncoder" class="headerlink" title="加密器PasswordEncoder"></a>加密器PasswordEncoder</h5><p>首先是<code>PasswordEncoder</code>，这个接口很简单就两个重要方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PasswordEncoder</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 加密，对一同一个密码每次加密后的值都是不一样的，但是解密出的结果却是一样的</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">encode</span><span class="params">(CharSequence rawPassword)</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将未加密的字符串（前端传递过来的密码）和已加密的字符串（数据库中存储的密码）进行校验</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(CharSequence rawPassword, String encodedPassword)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>你可以实现此接口定义自己的加密规则和校验规则，不过Spring Security提供了很多加密器实现，我们这里选定一个就好。可以在之前所说的<strong>配置类</strong>里进行如下配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 这里我们使用官方推荐的bcrypt加密算法，安全性比较高</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因为密码加密是我前面文章少数没有介绍的功能，所以这里额外提一嘴。往数据库中添加用户数据时就要将密码进行加密，否则后续进行密码校验时从数据库拿出来的还是明文密码，是无法通过校验的。比如我们有一个用户注册的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/register"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">register</span><span class="params">(@RequestBody @Validated RegisterParam param)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    UserDO userDO = <span class="keyword">new</span> UserDO();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用加密器将前端传递过来的密码进行加密</span></span><br><span class="line">    userDO.setUserName(param.getUserName());</span><br><span class="line">    userDO.setPassword(passwordEncoder.encode(param.getPassword()));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将用户实体对象添加到数据库</span></span><br><span class="line">    userService.save(userDO);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"注册成功"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样数据库中存储的密码都是已加密的了：</p>
<img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E6%B3%A8%E5%86%8C%E7%94%A8%E6%88%B7.png" alt="注册用户" style="zoom:80%;">

<h4 id="用户对象UserDetails"><a href="#用户对象UserDetails" class="headerlink" title="用户对象UserDetails"></a>用户对象UserDetails</h4><p>该接口就是我们所说的用户对象，它提供了用户的一些通用属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetails</span> <span class="keyword">extends</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 用户权限集合（现在暂时不用管，后续处理）</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   Collection&lt;? extends GrantedAuthority&gt; getAuthorities();</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 用户密码</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">String <span class="title">getPassword</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 用户名</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function">String <span class="title">getUsername</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 用户没过期返回true，反之则false</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">isAccountNonExpired</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 用户没锁定返回true，反之则为false</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">isAccountNonLocked</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 用户凭证(通常为密码)没过期返回true，反之则为false</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">isCredentialsNonExpired</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 用户是启用状态返回true，反之则为false</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">boolean</span> <span class="title">isEnabled</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际开发中我们的用户属性各种各样，这些默认属性必然是满足不了，所以我们一般会自己实现该接口，然后设置好我们实际的用户实体对象。实现此接口要重写很多方法比较麻烦，我们可以继承Spring Security提供的<code>org.springframework.security.core.userdetails.User</code>类，该类实现了<code>UserDetails</code>接口帮我们省去了重写方法的工作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDetail</span> <span class="keyword">extends</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 我们自己的用户实体对象，这里省略掉getter、setter方法</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> UserDO userDO;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">UserDetail</span><span class="params">(UserDO userDO, Collection&lt;? extends GrantedAuthority&gt; authorities)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 必须调用父类的构造方法，初始化用户名、密码、权限</span></span><br><span class="line">        <span class="keyword">super</span>(userDO.getUserName(), userDO.getPassword(), authorities);</span><br><span class="line">        <span class="keyword">this</span>.userDO = userDO;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="业务对象UserDetailsService"><a href="#业务对象UserDetailsService" class="headerlink" title="业务对象UserDetailsService"></a>业务对象UserDetailsService</h5><p>该接口很简单只有一个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 根据用户名获取用户对象（获取不到直接抛异常）</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function">UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>咱们自己的用户业务类实现该接口即可完成自己的逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">UserMapper</span>, <span class="title">UserDO</span>&gt; <span class="keyword">implements</span> <span class="title">UserService</span>, <span class="title">UserDetailsService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> <span class="keyword">throws</span> UsernameNotFoundException </span>&#123;</span><br><span class="line">        <span class="comment">// 从数据库中查询用户实体对象</span></span><br><span class="line">        UserDO userDO = userMapper.selectByUserName(username);</span><br><span class="line">        <span class="keyword">if</span> (userDO == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UsernameNotFoundException(<span class="string">"没有该用户"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 走到这代表查询到了实体对象，那就返回我们自定义的UserDetail对象（这里的权限暂时放个空集合，后面会另外讲解）</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> UserDetail(userDO, Collections.emptyList());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>AuthenticationManager</code>校验所调用的三个组件我们就已经做好实现了！</p>
<p>不知道大家注意到没有，当我们查询用户失败时或者校验密码失败时都会抛出Spring Security的自定义异常。这些异常不可能放任不管，Spring Security对于这些异常都是在<code>ExceptionTranslationFilter</code>过滤器中进行处理（可以回顾一下前面的过滤器截图），而<strong><code>AuthenticationEntryPoint</code></strong> 则专门处理认证异常！</p>
<h5 id="认证异常处理器AuthenticationEntryPoint"><a href="#认证异常处理器AuthenticationEntryPoint" class="headerlink" title="认证异常处理器AuthenticationEntryPoint"></a>认证异常处理器AuthenticationEntryPoint</h5><p>该接口也只有一个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AuthenticationEntryPoint</span> </span>&#123;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 接收异常并处理</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">commence</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们来自定义一个类实现我们自己的错误处理逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyEntryPoint</span> <span class="keyword">implements</span> <span class="title">AuthenticationEntryPoint</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commence</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AuthenticationException authException)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        response.setContentType(<span class="string">"application/json;charset=utf-8"</span>);</span><br><span class="line">        PrintWriter out = response.getWriter();</span><br><span class="line">        <span class="comment">// 直接提示前端认证错误</span></span><br><span class="line">        out.write(<span class="string">"认证错误"</span>);</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>用户传递过来账号密码 –&gt;  认证校验  –&gt;  异常处理，这一整套流程的组件我们就都给定义完了！现在只差最后一步，就是在Spring Security配置类里面进行一些配置，才能让这些生效。</p>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>Spring Security对哪些接口进行保护、什么组件生效、某些功能是否启用等等都需要在配置类中进行配置，注意看代码注释：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这里不需要加 @Configuration，因为@EnableWebSecurity中已经加了</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SecurityConfig</span> <span class="keyword">extends</span> <span class="title">WebSecurityConfigurerAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserServiceImpl userDetailsService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(AuthenticationManagerBuilder auth)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 指定UserDetailService和加密器</span></span><br><span class="line">        auth.userDetailsService(userDetailsService)</span><br><span class="line">                .passwordEncoder(passwordEncoder());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 关闭csrf和frameOptions，如果不关闭会影响前端请求接口</span></span><br><span class="line">        http.csrf().disable();</span><br><span class="line">        http.headers().frameOptions().disable();</span><br><span class="line">        <span class="comment">// 开启跨域以便前端调用接口</span></span><br><span class="line">        http.cors();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 这个是配置的关键，决定哪些接口开启防护，哪些接口绕过防护</span></span><br><span class="line">        http.authorizeRequests()</span><br><span class="line">                <span class="comment">// 注意这里，是允许前端跨域联调的一个必要配置</span></span><br><span class="line">                .requestMatchers(CorsUtils::isPreFlightRequest).permitAll()</span><br><span class="line">                <span class="comment">// 指定某些接口不需要通过验证即可访问。登录、注册接口肯定是不需要认证的</span></span><br><span class="line">                .antMatchers(<span class="string">"/api/login"</span>, <span class="string">"/api/user/register"</span>).permitAll()</span><br><span class="line">                <span class="comment">// 除了放行上面的接口之外，其他接口都需要认证才能访问</span></span><br><span class="line">                .anyRequest().authenticated()</span><br><span class="line">                .and()</span><br><span class="line">                <span class="comment">// 指定认证错误处理器</span></span><br><span class="line">                .exceptionHandling().authenticationEntryPoint(<span class="keyword">new</span> CustomizeAuthenticationEntryPoint());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> AuthenticationManager <span class="title">authenticationManager</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.authenticationManager();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> PasswordEncoder <span class="title">passwordEncoder</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 这里我们使用bcrypt加密算法，安全性比较高</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> BCryptPasswordEncoder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中用的最多的就是<code>configure(HttpSecurity http)</code>方法，可以通过<code>HttpSecurity</code>进行许多配置。当我们重写这个方法时，就已经关闭了默认的表单登录方式，然后我们再配置好启用哪些组件、指定哪些接口需要认证，就搞定了！</p>
<p>假设现在我们有一个<code>/API/test</code>接口，在没有登录的时候调用该接口看下效果：</p>
<img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E6%B5%8B%E8%AF%95%E8%AE%A4%E8%AF%81%E9%94%99%E8%AF%AF.png" alt="测试认证错误" style="zoom:67%;">

<p>我们登录一下：</p>
<img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E7%99%BB%E5%BD%95%E8%AE%A4%E8%AF%81%E6%88%90%E5%8A%9F%E6%B5%8B%E8%AF%95.png" alt="登录认证成功测试" style="zoom:67%;">

<p>然后再调用测试接口：</p>
<img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E5%86%8D%E6%AC%A1%E8%AF%B7%E6%B1%82%E6%8E%A5%E5%8F%A3.png" alt="再次请求接口" style="zoom:67%;">

<p>可以看到未登录时测试接口是无法正常访问的，会按照我们在<code>EntryPoint</code>中的逻辑返回错误提示。</p>
<h4 id="总结和补充"><a href="#总结和补充" class="headerlink" title="总结和补充"></a>总结和补充</h4><p>流程图：</p>
<img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E8%AE%A4%E8%AF%81%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="认证流程" style="zoom:110%;">

<ol>
<li>用户进行登录操作，传递账号密码过来 –&gt; 过滤器UsernamePasswordAuthenticationFilter将用户信息(此时只有账号密码)封装为Authencation –&gt; 登录接口调用<code>AuthenticationManager</code> </li>
<li>根据用户名查询出数据库中对应的用户信息 –&gt; <code>UserDetailService</code> 查询出 <code>UserDetails</code>(真实的用户用户)</li>
<li>将传递过来的密码(在Authencation中) 和 数据库中的密码(在UserDetails中)进行对比校验 –&gt; <code>PasswordEncoder</code></li>
<li>校验通过则将认证信息存入到上下文中 –&gt; 将<code>UserDetails</code>存入到<code>Authentication</code>(密码通常会被移除)，将<code>Authentication</code>存入到<code>SecurityContext</code></li>
<li>如果认证失败则抛出异常 –&gt; 由<code>AuthenticationEntryPoint</code>处理</li>
</ol>
<p>刚才我们讲的认证方式都是基于<code>session</code>机制（默认方式），认证后Spring Security会将<code>Authentication</code>存入到<code>session</code>中，Key为<code>HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY</code>。也就是说，你完全可以通过如下方式获取<code>Authentication</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Authentication = (Authentication)session.getAttribute(HttpSessionSecurityContextRepository.SPRING_SECURITY_CONTEXT_KEY)</span><br></pre></td></tr></table></figure>

<p>当然，官方还是不推荐这样直接操作的，因为统一通过<code>SecurityContextHolder</code>操作更利于管理！使用<code>SecurityContextHolder</code>除了获取当前用户外，退出登录的操作也是很方便的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/logout"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">logout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    SecurityContextHolder.clearContext();</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"退出成功"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>session</code>认证咱们就讲解到此，接下来咱们讲解<code>token</code>的认证。</p>
<h3 id="JWT集成"><a href="#JWT集成" class="headerlink" title="JWT集成"></a>JWT集成</h3><p>关于<code>JWT</code>的介绍和工具类等自行查阅，直接带大家实现代码。</p>
<p>采用<code>JWT</code>的方式进行认证首先做的第一步就是在配置类里禁用掉<code>session</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 禁用session</span></span><br><span class="line">http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>注意，这里的禁用是指Spring Security不采用<code>session</code>机制了，不代表你禁用掉了整个系统的<code>session</code>功能。</p>
</blockquote>
<p>然后我们再修改一下登录接口，当用户登录成功的同时，我们需要生成<code>token</code>并返回给前端，这样前端才能访问其他接口时携带<code>token</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/login"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> UserVO <span class="title">login</span><span class="params">(@RequestBody @Validated LoginParam param)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 调用业务层执行登录操作</span></span><br><span class="line">    <span class="keyword">return</span> userService.login(param);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>业务层方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserVO <span class="title">login</span><span class="params">(LoginParam param)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 根据用户名查询出用户实体对象</span></span><br><span class="line">    UserDO userDO = baseMapper.selectByUserName(param.getUserName());</span><br><span class="line">    <span class="comment">// 若没有查到用户 或者 密码校验失败则抛出自定义异常</span></span><br><span class="line">    <span class="keyword">if</span> (userDO == <span class="keyword">null</span> || !passwordEncoder.matches(param.getPassword(), userDO.getPassword())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ApiException(<span class="string">"账号密码错误"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 需要返回给前端VO对象</span></span><br><span class="line">    UserVO userVO = <span class="keyword">new</span> UserVO();</span><br><span class="line">    userVO.setId(userDO.getId());</span><br><span class="line">    userVO.setUserName(userVO.getUserName());</span><br><span class="line">    <span class="comment">// 生成JWT，将用户名数据存入其中</span></span><br><span class="line">    userVO.setToken(jwtManager.generate(userVO.getUserName()));</span><br><span class="line">    <span class="keyword">return</span> userVO;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们执行一下登录操作：</p>
<img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/token%E7%99%BB%E5%BD%95%E6%93%8D%E4%BD%9C.png" alt="token登录操作" style="zoom:80%;">

<p>我们可以看到登录成功时接口会返回<code>token</code>，后续我们再访问其它接口时需要将<code>token</code>放到请求头中。这里我们需要自定义一个认证过滤器，来对<code>token</code>进行校验：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtManager jwtManager;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserServiceImpl userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">        <span class="comment">// 从请求头中获取token字符串并解析</span></span><br><span class="line">        Claims claims = jwtManager.parse(request.getHeader(<span class="string">"Authorization"</span>));</span><br><span class="line">        <span class="keyword">if</span> (claims != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// 从JWT中提取之前存储好的用户名</span></span><br><span class="line">            String userName = claims.getSubject();</span><br><span class="line">            <span class="comment">// 查询出用户对象</span></span><br><span class="line">            UserDetails userDetails = userService.loadUserByUsername(userName);</span><br><span class="line">            <span class="comment">// 手动组装一个认证对象</span></span><br><span class="line">            UsernamePasswordAuthenticationToken authentication = <span class="keyword">new</span> UsernamePasswordAuthenticationToken(userDetails, userDetails.getPassword(), userDetails.getAuthorities());</span><br><span class="line">            <span class="comment">// 将认证对象放到上下文中</span></span><br><span class="line">            SecurityContextHolder.getContext().setAuthentication(authentication);</span><br><span class="line">        &#125;</span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>过滤器中的逻辑和之前介绍的<strong>最简单的认证方式</strong>逻辑是一致的，每当一个请求来时我们都会校验<code>JWT</code>进行认证，上下文对象中有了<code>Authentication</code>后续过滤器就会知道该请求已经认证过了。</p>
<p>咱们这个自定义的过滤器需要替换掉Spring Security默认的认证过滤器，这样我们的过滤器才能生效，所以我们需要进行如下配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 将我们自定义的认证过滤器替换掉默认的认证过滤器</span></span><br><span class="line">http.addFilterBefore(loginFilter, UsernamePasswordAuthenticationFilter<span class="class">.<span class="keyword">class</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>我们可以断点调试看一下现在的过滤器是怎样的：</p>
<img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E6%9B%BF%E6%8D%A2%E8%BF%87%E6%BB%A4%E5%99%A8%E5%90%8E%E7%9A%84%E8%BF%87%E6%BB%A4%E9%93%BE.png" alt="替换过滤器后的过滤链" style="zoom:80%;">

<p>可以看到我们自定义的过滤器已经替换掉了<code>UsernamePasswordAuthenticationFilter</code>默认过滤器了！当我们携带<code>token</code>访问接口时可以发现已经生效：</p>
<img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E6%90%BA%E5%B8%A6token%E5%90%8E%E8%AF%B7%E6%B1%82%E6%8E%A5%E5%8F%A3.png" alt="携带token后请求接口" style="zoom:80%;">

<p>登录认证到此就讲解完毕了，接下来我们一鼓作气来实现权限授权！</p>
<h3 id="权限授权"><a href="#权限授权" class="headerlink" title="权限授权"></a>权限授权</h3><p>菜单权限主要是通过前端渲染，数据权限主要靠<code>SQL</code>拦截，和Spring Security没太大耦合，就不多展开了。我们来梳理一下<strong>接口权限</strong>的授权的流程：</p>
<ol>
<li>当一个请求过来，我们先得知道这个请求的规则，即需要怎样的权限才能访问</li>
<li>然后获取当前登录用户所拥有的权限</li>
<li>再校验当前用户是否拥有该请求的权限</li>
<li>用户拥有这个权限则正常返回数据，没有权限则拒绝请求</li>
</ol>
<p>流程如下：</p>
<img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E6%9D%83%E9%99%90%E6%8E%88%E6%9D%83%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="授权流程" style="zoom:70%;">

<p>完成了登录认证功能后，想必大家已经有点感觉：Spring Security将流程功能分得很细，每一个小功能都会有一个组件专门去做，我们要做的就是去自定义这些组件！Spring Security针对上述流程也提供了许多组件。</p>
<p>Spring Security的授权发生在<code>FilterSecurityInterceptor</code>过滤器中：</p>
<ol>
<li>首先调用的是<strong><code>SecurityMetadataSource</code></strong>，来获取当前请求的鉴权规则</li>
<li>然后通过<code>Authentication</code>获取当前登录用户所有权限数据：<strong><code>GrantedAuthority</code></strong>，这个我们前面提过，认证对象里存放这个权限数据</li>
<li>再调用<strong><code>AccessDecisionManager</code></strong> 授权管理器来校验当前用户是否拥有该权限</li>
<li>如果有就放行接口，没有则抛出异常，该异常会被<strong><code>AccessDeniedHandler</code></strong> 处理</li>
</ol>
<p>我们可以来看一下过滤器里大概的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">    ...省略其它代码</span><br><span class="line">        </span><br><span class="line">    <span class="comment">// 这是Spring Security封装的对象，该对象里包含了request等信息</span></span><br><span class="line">    FilterInvocation fi = <span class="keyword">new</span> FilterInvocation(request, response, chain);</span><br><span class="line">    <span class="comment">// 这里调用了父类的AbstractSecurityInterceptor的方法,认证核心逻辑基本全在父类里</span></span><br><span class="line">    InterceptorStatusToken token = <span class="keyword">super</span>.beforeInvocation(fi);</span><br><span class="line"></span><br><span class="line">    ...省略其它代码</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>父类的<code>beforeInvocation</code>大概源码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> InterceptorStatusToken <span class="title">beforeInvocation</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">    ...省略其它代码</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 调用SecurityMetadataSource来获取当前请求的鉴权规则，这个ConfigAttribue就是规则，后面会讲</span></span><br><span class="line">    Collection&lt;ConfigAttribute&gt; attributes = <span class="keyword">this</span>.obtainSecurityMetadataSource().getAttributes(object);</span><br><span class="line">    <span class="comment">// 如果当前请求啥规则也没有，就代表该请求无需授权即可访问，直接结束方法</span></span><br><span class="line">    <span class="keyword">if</span> (CollectionUtils.isEmpty(attributes)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 获取当前登录用户</span></span><br><span class="line">    Authentication authenticated = authenticateIfRequired();</span><br><span class="line">    <span class="comment">// 调用AccessDecisionManager来校验当前用户是否拥有该权限，没有权限则抛出异常</span></span><br><span class="line">    <span class="keyword">this</span>.accessDecisionManager.decide(authenticated, object, attributes);</span><br><span class="line">    </span><br><span class="line">    ...省略其它代码</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>老生常谈，核心流程都是一样的。我们接下来自定义这些组件，以完成我们自己的鉴权逻辑。</p>
<h4 id="鉴权规则源SecurityMetadataSource"><a href="#鉴权规则源SecurityMetadataSource" class="headerlink" title="鉴权规则源SecurityMetadataSource"></a><strong>鉴权规则源SecurityMetadataSource</strong></h4><p>该接口我们只需要关注一个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SecurityMetadataSource</span> </span>&#123;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 获取当前请求的鉴权规则</span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> object 该参数就是Spring Security封装的FilterInvocation对象，包含了很多request信息</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@return</span> 鉴权规则对象</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function">Collection&lt;ConfigAttribute&gt; <span class="title">getAttributes</span><span class="params">(Object object)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ConfigAttribute</code>就是我们所说的鉴权规则，该接口只有一个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConfigAttribute</span> </span>&#123;</span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 这个字符串就是规则，它可以是角色名、权限名、表达式等等。</span></span><br><span class="line"><span class="comment">  * 你完全可以按照自己想法来定义，后面AccessDecisionManager会用这个字符串</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function">String <span class="title">getAttribute</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在之前文章中我们授权的实现全是靠着资源<code>id</code>，用户<code>id</code>关联角色<code>id</code>，角色<code>id</code>关联资源<code>id</code>，这样用户就相当于关联了资源，而我们接口资源在数据库中的体现是这样的：</p>
<img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E6%8E%A5%E5%8F%A3%E8%B5%84%E6%BA%90%E5%9C%A8%E6%95%B0%E6%8D%AE%E5%BA%93%E4%B8%AD%E7%9A%84%E4%BD%93%E7%8E%B0.png" alt="接口资源在数据库中的体现" style="zoom:80%;">

<p>这里还是一样，我们照样以资源<code>id</code>作为权限的标记。接下咱们就来自定义<code>SecurityMetadataSource</code>组件：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySecurityMetadataSource</span> <span class="keyword">implements</span> <span class="title">SecurityMetadataSource</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 当前系统所有接口资源对象，放在这里相当于一个缓存的功能。</span></span><br><span class="line"><span class="comment">     * 你可以在应用启动时将该缓存给初始化，也可以在使用过程中加载数据，这里我就不多展开说明了</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;Resource&gt; RESOURCES = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;ConfigAttribute&gt; <span class="title">getAttributes</span><span class="params">(Object object)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 该对象是Spring Security帮我们封装好的，可以通过该对象获取request等信息</span></span><br><span class="line">        FilterInvocation filterInvocation = (FilterInvocation) object;</span><br><span class="line">        HttpServletRequest request = filterInvocation.getRequest();</span><br><span class="line">        <span class="comment">// 遍历所有权限资源，以和当前请求进行匹配</span></span><br><span class="line">        <span class="keyword">for</span> (Resource resource : RESOURCES) &#123;</span><br><span class="line">            <span class="comment">// 因为我们url资源是这种格式：GET:/API/user/test/&#123;id&#125;，冒号前面是请求方法，冒号后面是请求路径，所以要字符串拆分</span></span><br><span class="line">            String[] split = resource.getPath().split(<span class="string">":"</span>);</span><br><span class="line">            <span class="comment">// 因为/API/user/test/&#123;id&#125;这种路径参数不能直接equals来判断请求路径是否匹配，所以需要用Ant类来匹配</span></span><br><span class="line">            AntPathRequestMatcher ant = <span class="keyword">new</span> AntPathRequestMatcher(split[<span class="number">1</span>]);</span><br><span class="line">            <span class="comment">// 如果请求方法和请求路径都匹配上了，则代表找到了这个请求所需的权限资源</span></span><br><span class="line">            <span class="keyword">if</span> (request.getMethod().equals(split[<span class="number">0</span>]) &amp;&amp; ant.matches(request)) &#123;</span><br><span class="line">                <span class="comment">// 将我们权限资源id返回，这个SecurityConfig就是ConfigAttribute一个简单实现</span></span><br><span class="line">                <span class="keyword">return</span> Collections.singletonList(<span class="keyword">new</span> SecurityConfig(resource.getId().toString()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 走到这里就代表该请求无需授权即可访问，返回空</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;ConfigAttribute&gt; <span class="title">getAllConfigAttributes</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 不用管，这么写就行</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 不用管，这么写就行</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，我们这里返回的<code>ConfigAttribute</code>鉴权规则，就是我们的资源<code>id</code></p>
<h4 id="用户权限GrantedAuthority"><a href="#用户权限GrantedAuthority" class="headerlink" title="用户权限GrantedAuthority"></a><strong>用户权限GrantedAuthority</strong></h4><p>该组件代表用户所拥有的权限，和<code>ConfigAttribute</code>一样也只有一个方法，该方法返回的字符串就是代表着权限</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GrantedAuthority</span> <span class="keyword">extends</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">  <span class="function">String <span class="title">getAuthority</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>将<code>GrantedAuthority</code>和<code>ConfigAttribute</code>一对比，就知道用户是否拥有某个权限了。</strong></p>
<p>Spring Security对<code>GrantedAuthority</code>有一个简单实现<code>SimpleGrantedAuthority</code>，对咱们来说够用了，所以我们额外再新建一个实现。我们要做的就是在<code>UserDetialsService</code>中，获取用户对象的同时也将权限数据查询出来：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> UserDetails <span class="title">loadUserByUsername</span><span class="params">(String username)</span> </span>&#123;</span><br><span class="line">    UserEntity user = userMapper.selectByUsername(username);</span><br><span class="line">    <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UsernameNotFoundException(<span class="string">"没有找到该用户"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 先将该用户所拥有的资源id全部查询出来，再转换成 SimpleGrantedAuthority 权限对象</span></span><br><span class="line">    Set&lt;SimpleGrantedAuthority&gt; authorities = resourceService.getIdsByUserId(user.getId())</span><br><span class="line">        .stream()</span><br><span class="line">        .map(String::valueOf)</span><br><span class="line">        .map(SimpleGrantedAuthority::<span class="keyword">new</span>)</span><br><span class="line">        .collect(Collectors.toSet());</span><br><span class="line">    <span class="comment">// 将用户实体和权限集合都放到UserDetail中，</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> UserDetail(user, authorities);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样当认证完毕时，<code>Authentication</code>就会拥有用户信息和权限数据了。</p>
<h4 id="授权管理AccessDecisionManager"><a href="#授权管理AccessDecisionManager" class="headerlink" title="授权管理AccessDecisionManager"></a><strong>授权管理AccessDecisionManager</strong></h4><p>终于要来到我们真正的授权组件了，这个组件才最终决定了你有没有某个权限，该接口我们只需关注一个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">AccessDecisionManager</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"> <span class="comment">/**</span></span><br><span class="line"><span class="comment">  * 授权操作，如果没有权限则抛出异常 </span></span><br><span class="line"><span class="comment">  *</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> authentication 当前登录用户，以获取当前用户权限信息</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> object FilterInvocation对象，以获取request信息</span></span><br><span class="line"><span class="comment">  * <span class="doctag">@param</span> configAttributes 访问当前资源所需要的权限，即受保护资源的访问策略，通过SecurityMetadataSource获取。</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"> <span class="function"><span class="keyword">void</span> <span class="title">decide</span><span class="params">(Authentication authentication, Object object, Collection&lt;ConfigAttribute&gt; configAttributes)</span></span></span><br><span class="line"><span class="function">   <span class="keyword">throws</span> AccessDeniedException, InsufficientAuthenticationException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法接受了这几个参数后完全能做到权限校验了，我们来实现自己的逻辑：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyDecisionManager</span> <span class="keyword">implements</span> <span class="title">AccessDecisionManager</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decide</span><span class="params">(Authentication authentication, Object object, Collection&lt;ConfigAttribute&gt; configAttributes)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 如果授权规则为空则代表此URL无需授权就能访问</span></span><br><span class="line">        <span class="keyword">if</span> (Collections.isEmpty(configAttributes)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 判断授权规则和当前用户所属权限是否匹配</span></span><br><span class="line">        <span class="keyword">for</span> (ConfigAttribute ca : configAttributes) &#123;</span><br><span class="line">            <span class="keyword">for</span> (GrantedAuthority authority : authentication.getAuthorities()) &#123;</span><br><span class="line">                <span class="comment">// 如果匹配上了，代表当前登录用户是有该权限的，直接结束方法</span></span><br><span class="line">                <span class="keyword">if</span> (Objects.equals(authority.getAuthority(), ca.getAttribute())) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 走到这里就代表没有权限，必须要抛出异常，否则错误处理器捕捉不到</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> AccessDeniedException(<span class="string">"没有相关权限"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(ConfigAttribute attribute)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 不用管，这么写就行</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(Class&lt;?&gt; clazz)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 不用管，这么写就行</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="授权错误处理器AccessDeniedHandler"><a href="#授权错误处理器AccessDeniedHandler" class="headerlink" title="授权错误处理器AccessDeniedHandler"></a><strong>授权错误处理器AccessDeniedHandler</strong></h4><p>该组件和之前的认证异常处理器一样，只有一个方法用来处理异常，只不过这个是用来处理授权异常的。我们直接来实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyDeniedHandler</span> <span class="keyword">implements</span> <span class="title">AccessDeniedHandler</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, AccessDeniedException accessDeniedException)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        response.setContentType(<span class="string">"application/json;charset=utf-8"</span>);</span><br><span class="line">        out.write(<span class="string">"没有相关权限"</span>);</span><br><span class="line">        out.flush();</span><br><span class="line">        out.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="配置-1"><a href="#配置-1" class="headerlink" title="配置"></a>配置</h3><p>组件都定义好了，那我们接下来就是最后一步咯，就是让这些组件生效。我们的鉴权规则源组件<code>SecurityMetadataSource</code>和授权管理组件<code>AccessDecisionManager</code>必须通过授权过滤器<code>FilterSecurityInterceptor</code>来配置生效，所以我们得自己先写一个过滤器，这个过滤器的核心代码基本按照父类的写就行，主要就是属性的配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthFilter</span> <span class="keyword">extends</span> <span class="title">AbstractSecurityInterceptor</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> SecurityMetadataSource securityMetadataSource;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> SecurityMetadataSource <span class="title">obtainSecurityMetadataSource</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 将我们自定义的SecurityMetadataSource给返回</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.securityMetadataSource;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAccessDecisionManager</span><span class="params">(AccessDecisionManager accessDecisionManager)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 将我们自定义的AccessDecisionManager给注入</span></span><br><span class="line">        <span class="keyword">super</span>.setAccessDecisionManager(accessDecisionManager);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span><br><span class="line">        <span class="comment">// 下面的就是按照父类写法写的</span></span><br><span class="line">        FilterInvocation fi = <span class="keyword">new</span> FilterInvocation(request, response, chain);</span><br><span class="line">        InterceptorStatusToken token = <span class="keyword">super</span>.beforeInvocation(fi);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 执行下一个拦截器</span></span><br><span class="line">            fi.getChain().doFilter(fi.getRequest(), fi.getResponse());</span><br><span class="line">        &#125;  <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// 请求之后的处理</span></span><br><span class="line">            <span class="keyword">super</span>.afterInvocation(token, <span class="keyword">null</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Class&lt;?&gt; getSecureObjectClass() &#123;</span><br><span class="line">        <span class="keyword">return</span> FilterInvocation<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>过滤器定义好了，我们回到Spring Security配置类让这个过滤器替换掉原有的过滤器就一切都搞定啦：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http.addFilterBefore(authFilter, FilterSecurityInterceptor<span class="class">.<span class="keyword">class</span>)</span>;</span><br></pre></td></tr></table></figure>

<p>我们可以来看下效果，没有权限的情况下访问接口：</p>
<img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E6%B2%A1%E6%9C%89%E6%9D%83%E9%99%90%E6%B5%8B%E8%AF%95.png" alt="没有权限测试" style="zoom:80%;">

<p>有权限的情况下访问接口：</p>
<img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/%E6%9C%89%E6%9D%83%E9%99%90%E6%B5%8B%E8%AF%95.png" alt="有权限测试" style="zoom:80%;">

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>整个Spring Security就讲解完毕了，我们对两个过滤器、N多个组件进行了自定义实现，从而达到了我们的功能。这里做了一个思维导图方便大家理解：</p>
<p><img src="https://springsecurityimages.oss-cn-guangzhou.aliyuncs.com/springsecurityimages/springsecurity%E6%80%9D%E7%BB%B4%E5%AF%BC%E5%9B%BE.png" alt="springsecurity思维导图"></p>
<p>别看组件这么多，认证授权的核心流程和一些概念是不会变的，什么安全框架都万变不离其宗。比如<code>Shiro</code>，其中最基本的概念<code>Subject</code>就代表当前用户，<code>SubjectManager</code>就是用户管理器……</p>
<blockquote>
<p>文章主要来源：</p>
<p>作者：RudeCrab</p>
<p><a href="https://mp.weixin.qq.com/s/ue35vPCR20wIDkdJ82EVeg" target="_blank" rel="noopener">https://mp.weixin.qq.com/s/ue35vPCR20wIDkdJ82EVeg</a></p>
</blockquote>

      <blockquote class="mdui-m-t-5">
        
          <strong>本文遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">CC BY-NC-SA 4.0</a> 许可协议，转载请附上原文出处链接和本声明。</strong><br>
        
        <strong>本文链接：</strong><a href="https://yellowbp.github.io/2021/10/12/springsecurity/">https://yellowbp.github.io/2021/10/12/springsecurity/</a>
      </blockquote>
      
    </div>
    <footer class="mdui-card-actions">
      
        <a class="mdui-ripple article_categories-link" href="/categories/认证授权/">认证授权</a>
      
      
        <a class="mdui-ripple article_tags-link" href="/tags/Spring/">Spring</a>
      
    </footer>
    
  </article>
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script>$("#main article .mdui-card-content img.fancybox").on("click",function(e){$.fancybox.open({src:$(this).attr("src")});});</script>


  <nav id="paginator">
    
      <a rel="prev" class="extend prev" href="/2021/10/16/spring-Validator校验/">
        <button aria-label="prev" class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_back</i></button>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上一篇
      </a>
    
    <div class="spacer"></div>
    
      <a rel="next" class="extend next" href="/2021/10/07/java代码优化小技巧/">
        下一篇&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <button aria-label="next" class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_forward</i></button>
      </a>
    
  </nav>


  <div id="comment" class="mdui-m-t-5">
    <style>#pop_ad,#feedAv{display:none!important;position:absolute!important;z-index:-9999;left:-1000px;opacity:0!important}</style>
<div id="SOHUCS" sid="cl0ic7mxd008vwwtwvtq9tsgl"></div>
<script type="text/javascript">
(function(){
var appid = 'cyubhC2Dq';
var conf = 'prod_e4cce65003c5bed049fefcb8a6f09e12';
var width = window.innerWidth || document.documentElement.clientWidth;
if (width < 960) {
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="http://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("http://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>
  </div>



  <div style="position: fixed !important; right: 16px; top: 30%;">
    <button class="mdui-fab mdui-fab-mini mdui-ripple" mdui-menu="{target: '#toc'}"><i class="mdui-icon material-icons">format_list_numbered</i></button>
    <ul class="mdui-menu" id="toc">
      <li class="mdui-menu-item" disabled><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#SpringSecurity"><span class="toc-number">1.</span> <span class="toc-text">SpringSecurity</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#提纲挈领"><span class="toc-number">1.1.</span> <span class="toc-text">提纲挈领</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#代码编写"><span class="toc-number">1.2.</span> <span class="toc-text">代码编写</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#依赖"><span class="toc-number">1.2.1.</span> <span class="toc-text">依赖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#登录认证"><span class="toc-number">1.2.2.</span> <span class="toc-text">登录认证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#最简单的认证方式"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">最简单的认证方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#AuthenticationManager认证方式"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">AuthenticationManager认证方式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#加密器PasswordEncoder"><span class="toc-number">1.2.2.2.1.</span> <span class="toc-text">加密器PasswordEncoder</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#用户对象UserDetails"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">用户对象UserDetails</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#业务对象UserDetailsService"><span class="toc-number">1.2.2.3.1.</span> <span class="toc-text">业务对象UserDetailsService</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#认证异常处理器AuthenticationEntryPoint"><span class="toc-number">1.2.2.3.2.</span> <span class="toc-text">认证异常处理器AuthenticationEntryPoint</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#配置"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#总结和补充"><span class="toc-number">1.2.2.5.</span> <span class="toc-text">总结和补充</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JWT集成"><span class="toc-number">1.2.3.</span> <span class="toc-text">JWT集成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#权限授权"><span class="toc-number">1.2.4.</span> <span class="toc-text">权限授权</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#鉴权规则源SecurityMetadataSource"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">鉴权规则源SecurityMetadataSource</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#用户权限GrantedAuthority"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">用户权限GrantedAuthority</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#授权管理AccessDecisionManager"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">授权管理AccessDecisionManager</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#授权错误处理器AccessDeniedHandler"><span class="toc-number">1.2.4.4.</span> <span class="toc-text">授权错误处理器AccessDeniedHandler</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#配置-1"><span class="toc-number">1.2.5.</span> <span class="toc-text">配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">1.3.</span> <span class="toc-text">总结</span></a></li></ol></li></ol></li>
    </ul>
  </div>
</main>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<footer id="footer" class="mdui-m-t-5 mdui-p-y-3 mdui-color-theme">
  <div class="mdui-p-y-0 mdui-text-center">
    
    
    
    
    
    
    
      <a href="https://github.com/yellowbp" target="_blank"><i class="mdui-p-a-1 mdui-icon iconfont mdui-text-color-theme-a100">&#xe7ab;</i></a>
    
    
    
    
    
      <a href="tencent://message/?uin=1432440963&Menu=yes" target="_blank"><i class="mdui-p-a-1 mdui-icon iconfont mdui-text-color-theme-a100">&#xe651;</i></a>
    
    
  </div>
  <div class="mdui-p-y-1 mdui-text-center">
    Copyright &copy; 2019 - 2022 hbp<br>
    Powered by <a href="https://hexo.io/" target="_blank" class="mdui-text-color-theme-accent">Hexo</a>hbp All rights reserved.
    
    <br>
    <span id="busuanzi_container_site_uv">
    本网站总访问量<span id="busuanzi_value_site_uv"></span>次
    </span>
  </div>
</footer>
  <button id="gotop" class="mdui-fab mdui-fab-fixed mdui-fab-hide mdui-ripple mdui-color-theme-accent"><i class="mdui-icon material-icons">arrow_upward</i></button>
  <script async src="http://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <script src="/js/mdui.js"></script>
<script src="/js/script.js"></script>
</body>
</html>