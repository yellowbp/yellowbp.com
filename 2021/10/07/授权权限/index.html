<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="renderer" content="webkit">

  
  <title>权限授权 | bp的Blog</title>

  <link rel="shortcut icon" href="/images/favicon.png">
  
  <meta name="description" content="权限授权前言每个系统的权限功能都不尽相同，各有其自身的业务特点，对权限管理的设计也都各有特色。 不过不管是怎样的权限设计，大致可归为三种：  页面权限（菜单级） 操作权限（按钮级） 数据权限  按维度划分的话就是：  粗颗粒权限 细颗粒权限  本文的目的是带大家了解权限授权（Authorization）的核心，所以直接带你手撸权限授权，不会用上安全框架。核心搞清楚后，什么安全框架理解使用起来都会非">
<meta name="keywords" content="Spring">
<meta property="og:type" content="article">
<meta property="og:title" content="权限授权">
<meta property="og:url" content="https://yellowbp.github.io/2021/10/07/授权权限/index.html">
<meta property="og:site_name" content="bp的Blog">
<meta property="og:description" content="权限授权前言每个系统的权限功能都不尽相同，各有其自身的业务特点，对权限管理的设计也都各有特色。 不过不管是怎样的权限设计，大致可归为三种：  页面权限（菜单级） 操作权限（按钮级） 数据权限  按维度划分的话就是：  粗颗粒权限 细颗粒权限  本文的目的是带大家了解权限授权（Authorization）的核心，所以直接带你手撸权限授权，不会用上安全框架。核心搞清楚后，什么安全框架理解使用起来都会非">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/user%E8%A1%A8.png">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E8%8F%9C%E5%8D%95%E6%98%BE%E7%A4%BA.png">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/resource%E8%A1%A8.png">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/resource%E6%95%B0%E6%8D%AE.png">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E5%89%8D%E5%90%8E%E7%AB%AF%E4%B8%8D%E5%88%86%E7%A6%BB%E6%97%B6%E7%9A%84%E9%89%B4%E6%9D%83%E9%93%BE%E8%B7%AF.png">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E6%97%B6%E7%9A%84%E9%89%B4%E6%9D%83%E9%93%BE%E8%B7%AF.png">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E7%99%BB%E5%BD%95%E5%90%8E%E8%BF%94%E5%9B%9E%E9%A1%B5%E9%9D%A2URI.png">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E6%B7%BB%E5%8A%A0%E6%9D%83%E9%99%90%E6%95%B0%E6%8D%AE.png">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E4%BF%AE%E6%94%B9%E8%8F%9C%E5%8D%95%E9%A1%B5%E9%9D%A2%E6%9D%83%E9%99%90.png">
<meta property="og:image" content="h:/images/authorityimages/菜单权限权限修改后.png">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E8%B5%84%E6%BA%90%E8%A1%A8%E6%94%B9%E8%BF%9B.png">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E8%B5%84%E6%BA%90%E8%A1%A8%E7%9A%84%E5%86%85%E5%AE%B9.png">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E4%B8%AD%E9%97%B4%E8%A1%A8.png">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E7%94%A8%E6%88%B7%E8%B5%84%E6%BA%90%E8%A1%A8%E6%95%B0%E6%8D%AE.png">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E7%94%A8%E6%88%B7%E8%B5%84%E6%BA%90%E8%A1%A8%28%E5%A4%9A%E5%AF%B9%E5%A4%9A%29.png">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E8%A7%92%E8%89%B2%E8%A1%A8%E5%8F%8A%E6%95%B0%E6%8D%AE.png">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E4%B8%AD%E9%97%B4%E8%A1%A8%E5%8F%8A%E6%95%B0%E6%8D%AE.png">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/rbac%E6%A8%A1%E5%9E%8B.png">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E5%88%A0%E9%99%A4%E6%8C%89%E9%92%AE.png">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E6%94%B9%E8%BF%9B%E8%B5%84%E6%BA%90%E8%A1%A8.png">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E8%B5%84%E6%BA%90%E8%A1%A8%E6%95%B0%E6%8D%AE%E6%94%B9%E8%BF%9B.png">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/postman%E8%AF%B7%E6%B1%82.png">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E6%8E%A5%E5%8F%A3%E6%B3%A8%E8%A7%A3%E7%BB%93%E6%9E%9C.png">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E5%85%AC%E5%8F%B8%E8%A1%A8.png">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E7%94%A8%E6%88%B7%E5%85%AC%E5%8F%B8%E8%A1%A8%E6%95%B0%E6%8D%AE.png">
<meta property="og:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E6%8B%A6%E6%88%AA%E5%90%8E%E7%9A%84sql.png">
<meta property="og:updated_time" content="2021-12-07T06:22:49.595Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="权限授权">
<meta name="twitter:description" content="权限授权前言每个系统的权限功能都不尽相同，各有其自身的业务特点，对权限管理的设计也都各有特色。 不过不管是怎样的权限设计，大致可归为三种：  页面权限（菜单级） 操作权限（按钮级） 数据权限  按维度划分的话就是：  粗颗粒权限 细颗粒权限  本文的目的是带大家了解权限授权（Authorization）的核心，所以直接带你手撸权限授权，不会用上安全框架。核心搞清楚后，什么安全框架理解使用起来都会非">
<meta name="twitter:image" content="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/user%E8%A1%A8.png">

  <meta name="format-detection" content="telephone=no,email=no">
  <meta name="theme-color" content="#9C27B0">
  <meta name="description" content>
  <meta name="keywords" content=",Spring">

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="bp的Blog">
  <meta name="msapplication-starturl" content="https://yellowbp.github.io/2021/10/07/授权权限/">
  <meta name="msapplication-navbutton-color" content="#9C27B0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="bp的Blog">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/images/favicon.png">

  
    <meta property="article:published_time" content="Thu Oct 07 2021 15:11:17 GMT+0800">
    <meta property="article:modified_time" content="Tue Dec 07 2021 14:22:49 GMT+0800">
  

  
    <link rel="canonical" href="https://yellowbp.github.io/2021/10/07/授权权限/">
  

  <meta name="google-site-verification" content="fXjtlIfaDc_X-0P11rO3bEp1Nk4IKXphoJv0GqGZCco">
  <meta name="baidu-site-verification" content="I3t1wfwZvd">

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create','UA-139531378-1','auto');ga('send','pageview');
</script>
  <script>
  var _hmt = _hmt || [];
  (function() {var hm = document.createElement('script');
  hm.src = 'https://hm.baidu.com/hm.js?1054d51c0b66f1d168829173682c8159';
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script>
  

  <link rel="stylesheet" href="/css/mdui.css">
<link rel="stylesheet" href="/css/style.css">
</head>
<body class="mdui-appbar-with-toolbar mdui-drawer-body-left mdui-theme-primary-brown mdui-theme-accent-blue">
  <script>var a=localStorage.getItem("mdui-theme-layout-dark");if(a){document.getElementsByTagName("body")[0].className+=" mdui-theme-layout-dark"};</script>
  <header id="header" class="mdui-appbar mdui-appbar-fixed mdui-appbar-scroll-hide mdui-appbar-inset">
  <div class="mdui-toolbar mdui-color-theme">
    <a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-drawer="{target: '#sidebar', swipe: true}"><i class="mdui-icon material-icons">menu</i></a>
    <a href="/" class="mdui-typo-headline">bp的Blog</a>
    <div class="mdui-toolbar-spacer"></div>
    <a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-dialog="{target: '#search'}" mdui-tooltip="{content: '搜索'}"><i class="mdui-icon material-icons">search</i></a>
    
  </div>
</header>
<div class="mdui-dialog" id="search">
  
    <div class="search-form">
      <input type="search" class="search-form-input" placeholder="请输入关键字">
    </div>
    <div class="search-result" data-resource="/search.xml"></div>
  
</div>
  <aside id="sidebar" class="mdui-drawer mdui-drawer-full-height">
  <div class="mdui-grid-tile">
    <img src="/images/Gradient1.jpg" style="height: 160px;">
    <img src="/images/headPic.jpg" class="avatar-animation" style="position: absolute; top: 10%; left: 24px; width: 64px; height: 64px; border: 2px solid #fff; border-radius: 50%;">
    <div class="mdui-grid-tile-actions">
      <div class="mdui-grid-tile-text">
        <div class="mdui-grid-tile-title">hbp
        </div>
        <div class="mdui-grid-tile-subtitle"><i class="mdui-icon material-icons">art_track</i>要想快，先会慢</div>
      </div>
      
        <div class="mdui-grid-tile-buttons">
          <a href="mailto:347070556@qq.com" class="mdui-btn mdui-btn-icon" mdui-tooltip="{content: '347070556@qq.com'}"><i class="mdui-icon material-icons">email</i></a>
        </div>
      
    </div>
  </div>

  <div class="mdui-list" mdui-collapse="{accordion: true}">
    <a href="/" class="mdui-list-item mdui-ripple">
      <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-blue">home</i>
      <div class="mdui-list-item-content">主页</div>
    </a>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-deep-orange">inbox</i>
        <div class="mdui-list-item-content">归档</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/archives/2022/02/">二月 2022<span class="mdui-ripple sidebar_archives-count">11</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/10/">十月 2021<span class="mdui-ripple sidebar_archives-count">9</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/09/">九月 2021<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/08/">八月 2021<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/07/">七月 2021<span class="mdui-ripple sidebar_archives-count">12</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/06/">六月 2021<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/05/">五月 2021<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/04/">四月 2021<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/03/">三月 2021<span class="mdui-ripple sidebar_archives-count">6</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/02/">二月 2021<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/01/">一月 2021<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2020/03/">三月 2020<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/12/">十二月 2019<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/11/">十一月 2019<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/10/">十月 2019<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/09/">九月 2019<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/08/">八月 2019<span class="mdui-ripple sidebar_archives-count">6</span></a>
        
      </div>
    </div>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-green">chrome_reader_mode</i>
        <div class="mdui-list-item-content">分类</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/categories/ElasticSearch/">ElasticSearch<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/Spring/">Spring<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/SpringBoot/">SpringBoot<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/SpringCloud-Alibaba/">SpringCloud Alibaba<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/SpringMVC/">SpringMVC<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/docker/">docker<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/excel/">excel<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/git/">git<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/java8/">java8<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/java基础/">java基础<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/jenkins/">jenkins<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/jenkins/docker/">docker<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/jwt/">jwt<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/k8s/">k8s<span class="mdui-ripple sidebar_archives-count">10</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/linux/">linux<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/linux搭建/">linux搭建<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/maven/">maven<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/mybatis/">mybatis<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/mysql/">mysql<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/redis/">redis<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/servlet/">servlet<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/ssm/">ssm<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/yaml/">yaml<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/上传下载文件/">上传下载文件<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/乱码/">乱码<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/参数校验/">参数校验<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/发短信/">发短信<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/小程序/">小程序<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/开发软件/">开发软件<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/技术/">技术<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/搭建博客/">搭建博客<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/源码分析/">源码分析<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/电脑硬件/">电脑硬件<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/算法/">算法<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/缓存/">缓存<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/虚拟机/">虚拟机<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/规范/">规范<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/认证授权/">认证授权<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/设计模式/">设计模式<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/负载均衡/">负载均衡<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/通用工具类/">通用工具类<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/部署/">部署<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/重装/">重装<span class="mdui-ripple sidebar_archives-count">1</span></a>
        
      </div>
    </div>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-brown">bookmark</i>
        <div class="mdui-list-item-content">标签</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/tags/Spring/">Spring<span class="mdui-ripple sidebar_archives-count">21</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/algorithm/">algorithm<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/excel/">excel<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/git/">git<span class="mdui-ripple sidebar_archives-count">12</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/hexo/">hexo<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/javaWeb/">javaWeb<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/java基础/">java基础<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/jwt/">jwt<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/linux/">linux<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/mysql/">mysql<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/nginx/">nginx<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/redis/">redis<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/servlet/">servlet<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/spring/">spring<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/win7/">win7<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/其他/">其他<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/分布式/">分布式<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/接口文档/">接口文档<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/笔记本选购/">笔记本选购<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/自动化构建工具/">自动化构建工具<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/设计模式/">设计模式<span class="mdui-ripple sidebar_archives-count">1</span></a>
        
      </div>
    </div>
    <a href="/about" class="mdui-list-item mdui-ripple">
      <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-purple">person</i>
      <div class="mdui-list-item-content">关于</div>
    </a>
  </div>

  <div class="mdui-divider"></div>

  <div class="mdui-list" mdui-collapse="{accordion: true}">
    
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <div class="mdui-list-item-content">友情链接</div>
        <i class="mdui-list-item-icon mdui-icon material-icons">link</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        
          <a href="javascript:;" class="mdui-list-item mdui-ripple mdui-p-l-2 mdui-text-color-theme" style="justify-content: center;">链接为空</a>
        
      </div>
    </div>
  </div>
</aside>
  <main id="main" class="mdui-m-t-5 fadeIn animated">
  <link rel="stylesheet" href="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.css">
  <style>#main article .mdui-card-content .center-block{display:block!important;margin-right:auto!important;margin-left:auto!important}</style>
  <article class="mdui-card mdui-m-b-5">
    <header class="mdui-card-media">
      <img src="/images/random/material-13.png" style="max-height: 240px;">
      <div class="mdui-card-media-covered">
        <div class="mdui-card-primary">
          <div class="mdui-card-primary-title">权限授权</div>
          <div class="mdui-card-primary-subtitle"><i class="iconfont">&#xe697;</i> 2021-10-07 / 
          <i class="iconfont">&#xe601;</i> hbp
          <span id="busuanzi_container_page_pv">
            本文总阅读量<span id="busuanzi_value_page_pv"></span>次
          </span>
          </div>
        </div>
      </div>
      <div class="mdui-card-menu">
        
        
      </div>
    </header>
    <div class="mdui-card-content mdui-typo">
      <h1 id="权限授权"><a href="#权限授权" class="headerlink" title="权限授权"></a>权限授权</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>每个系统的权限功能都不尽相同，各有其自身的业务特点，对权限管理的设计也都各有特色。</p>
<p>不过不管是怎样的权限设计，大致可归为三种：</p>
<ul>
<li>页面权限（菜单级）</li>
<li>操作权限（按钮级）</li>
<li>数据权限</li>
</ul>
<p>按维度划分的话就是：</p>
<ul>
<li>粗颗粒权限</li>
<li>细颗粒权限</li>
</ul>
<p>本文的目的是带大家了解权限授权（<strong>Authorization</strong>）的核心，所以直接带你手撸权限授权，不会用上安全框架。核心搞清楚后，什么安全框架理解使用起来都会非常容易。</p>
<p>读完文章你能收获：</p>
<ul>
<li>权限授权的核心概念</li>
<li>页面权限、操作权限、数据权限的设计与实现</li>
<li>权限模型（RBAC）的演进与使用</li>
<li>接口扫描与<code>SQL</code>拦截</li>
</ul>
<h2 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h2><p>登录认证（Authentication）是对<strong>用户的身份</strong>进行确认，权限授权（Authorization）是对<strong>用户能否访问某个资源</strong>进行确认。比如你输入账号密码登录到某个论坛，这就是认证。你这个账号是管理员所以想进哪个板块就进哪个板块，这就是授权。权限授权通常发生在登录认证成功之后，即先得确认你是谁，然后再确认你能访问什么。现在其实已经说清楚权限的本质是什么了，就是<strong>保护资源</strong>。无论是怎样的功能要求，权限其核心都是围绕在<strong>资源</strong>二字上。不能访问论坛版块，此时版块是资源；不能进入某些区域，此时区域是资源……</p>
<p><strong>本文重点：进行权限系统的设计，第一步就是考虑要保护什么资源，再接着思考如何保护这个资源</strong></p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>我们使用<code>SpringBoot</code>搭建Web项目，<code>MySQL</code>和<code>Mybatis-plus</code>来进行数据存储与操作。下面是我们要用的必备依赖包：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- web依赖包, web应用必备 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- MySQL，连接MySQL必备 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- MyBatis-plus，ORM框架，访问并操作数据库 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>在设计权限相关的表之前，肯定是先得有一个最基础的用户表，这里字段就简单点，就三个 ：主键、用户名、密码：</p>
<img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/user%E8%A1%A8.png" alt="user表" style="zoom:67%;">

<p>对应的实体类和SQL建表语句我就不写了，大家一看表结构都知道该咋写</p>
<p>接下来我们就先实现一种非常简单的权限控制！</p>
<h3 id="页面权限（菜单级）"><a href="#页面权限（菜单级）" class="headerlink" title="页面权限（菜单级）"></a>页面权限（菜单级）</h3><p>页面权限非常容易理解，就是有这个权限的用户才能访问这个页面，没这个权限的用户就无法访问，它是以整个页面为维度，对权限的控制并没有那么细，所以是一种<strong>粗颗粒权限</strong>。</p>
<p>最直观的一个例子就是，有权限的用户就会显示所有菜单，无权限的用户就只会显示部分菜单：</p>
<img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E8%8F%9C%E5%8D%95%E6%98%BE%E7%A4%BA.png" alt="菜单显示" style="zoom:60%;">

<p>这些菜单都对应着一个页面，控制了导航菜单就相当于控制住了页面入口，所以页面权限通常也可称为<strong>菜单权限</strong></p>
<h4 id="权限核心"><a href="#权限核心" class="headerlink" title="权限核心"></a>权限核心</h4><p>就像之前所说，要设计一个权限系统第一步就是要考虑 保护什么资源，页面权限这种要保护的资源那必然是页面嘛。一个页面（菜单）对应一个<code>URI</code>地址，当用户登录的时候判断这个用户拥有哪些页面权限，自然而然就知道要渲染出什么导航菜单了！这些理清楚后，表的设计自然浮现眼前：</p>
<img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/resource%E8%A1%A8.png" alt="resource表" style="zoom:67%;">

<p>这个资源表非常简单但目前足够用了，我们要设置用户的权限话，只要将用户id和<code>URI</code>对应起来即可：</p>
<img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/resource%E6%95%B0%E6%8D%AE.png" alt="resource数据" style="zoom:80%;">

<p>上面的数据就表明，<code>user_id</code>为<code>1</code>的用户拥有3个页面的权限，<code>user_id</code>为<code>2</code>的用户只拥有数据管理 和 角色管理权限（首页我们就让所有用户都能进，毕竟一个用户你至少还是得让他能看到一些最基本的东西嘛）。至此，我们就完成了页面权限的数据库表设计！</p>
<p>数据干巴巴放在那毫无作用，所以接下来我们就要进行代码的编写来使用这些数据。代码实现分为后端和前端。</p>
<p>在前后端没有分离的时候，逻辑的处理和页面的渲染都是在后端进行，所以整体的逻辑链路是这样的：</p>
<img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E5%89%8D%E5%90%8E%E7%AB%AF%E4%B8%8D%E5%88%86%E7%A6%BB%E6%97%B6%E7%9A%84%E9%89%B4%E6%9D%83%E9%93%BE%E8%B7%AF.png" style="zoom:67%;">

<p>在前后端分离模式下，后端只负责提供<code>JSON</code>数据，页面渲染是前端的事，此时整体的逻辑链路就发生了变化：</p>
<img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E5%89%8D%E5%90%8E%E7%AB%AF%E5%88%86%E7%A6%BB%E6%97%B6%E7%9A%84%E9%89%B4%E6%9D%83%E9%93%BE%E8%B7%AF.png" alt="前后端分离时的鉴权链路" style="zoom:67%;">

<p>那么用户登录成功的同时，后端要将用户的权限数据返回给前端，这是我们登录接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserService userService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(value = <span class="string">"/login"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">login</span><span class="params">(@RequestBody LoginDTO loginDTO)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 这里简单点就只返回一个权限集合路径集合</span></span><br><span class="line">        <span class="keyword">return</span> userService.login(loginDTO);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>具体的业务方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">UserMapper</span>, <span class="title">User</span>&gt; <span class="keyword">implements</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ResourceMapper resourceMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Set&lt;String&gt; <span class="title">login</span><span class="params">(LoginDTO loginDTO)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 根据前端传递过来的账号密码从数据库中查询用户数据</span></span><br><span class="line">        <span class="comment">// 该方法SQL语句：select * from user where user_name = #&#123;userName&#125; and password = #&#123;password&#125;</span></span><br><span class="line">        User user = userMapper.selectByLogin(loginDTO.getUserName(), loginDTO.getPassword());</span><br><span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ApiException(<span class="string">"账号或密码错误"</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 返回该用户的权限路径集合</span></span><br><span class="line">        <span class="comment">// 该方法的SQL语句：select path from resource where user_id = #&#123;userId&#125;</span></span><br><span class="line">        <span class="keyword">return</span> resourceMapper.getPathsByUserId(user.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>后端的接口咱们就编写完毕了，前端在登录成功后会收到后端传递过来的<code>JSON</code>数据：</p>
<img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E7%99%BB%E5%BD%95%E5%90%8E%E8%BF%94%E5%9B%9E%E9%A1%B5%E9%9D%A2URI.png" alt="登录后返回页面URI" style="zoom:80%;">

<p>这时候后端不需要像之前那样将菜单名映射也传递给前端，<strong>前端自己会存储一个映射字典</strong>。前端将这个权限存储在本地（比如<code>LocalStorage</code>），然后根据权限数据渲染菜单，前后端分离模式下的权限功能就这样完成了。</p>
<p>到目前为止，页面权限的基本逻辑链路就介绍完毕了，是不是非常简单？基本的逻辑弄清楚之后，剩下的不过就是非常普通的增删改查：当我想要让一个用户的权限变大时就对这个用户的权限数据进行增加，想让一个用户的权限变小时就对这个用户的权限数据进行删除……接下来我们就完成这一步，让系统的用户能够对权限进行管理，否则干什么都要直接操作数据库那肯定是不行的。</p>
<p>首先，肯定是得先让用户能够看到一个数据列表然后才能进行操作，我新增了一些数据来方便展示效果：</p>
<img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E6%B7%BB%E5%8A%A0%E6%9D%83%E9%99%90%E6%95%B0%E6%8D%AE.png" alt="添加权限数据" style="zoom:80%;">

<p>这里分页、新增账户、删除账户的代码怎么写我就不讲解了，就讲一下对权限进行编辑的接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginController</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ResourceService resourceService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping</span>(value = <span class="string">"/menus"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">updateMenus</span><span class="params">(@RequestBody UserMenusDTO userMenusDTO)</span> </span>&#123;</span><br><span class="line">        resourceService.updateMenus(userMenusDTO);</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"操作成功"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接受前端传递过来的参数非常简单，就一个用户id和将要设置的菜单路径集合：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserMenusDTO</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> Set&lt;String&gt; menus;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>业务类的代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResourceServiceImpl</span> <span class="keyword">extends</span> <span class="title">ServiceImpl</span>&lt;<span class="title">ResourceMapper</span>, <span class="title">Resource</span>&gt; <span class="keyword">implements</span> <span class="title">ResourceService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ResourceMapper resourceMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateMenus</span><span class="params">(UserMenusDTO userMenusDTO)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 先根据用户id删除原有的该用户权限数据</span></span><br><span class="line">        resourceMapper.removeByUserId(userMenusDTO.getId());</span><br><span class="line">        <span class="comment">// 如果权限集合为空，就代表只用删除所有权限，不用走后面的更新流程了</span></span><br><span class="line">        <span class="keyword">if</span> (Collections.isEmpty(userMenusDTO.getMenus())) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 根据用户id新增权限数据</span></span><br><span class="line">        resourceMapper.saveMenusByUserId(userMenusDTO.getId(), userMenusDTO.getMenus());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>删除权限数据和新增权限数据的SQL语句如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.hbp.authority.mapper.ResourceMapper"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--根据角色id删除该角色下所有权限--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"removeByUserId"</span>&gt;</span></span><br><span class="line">        delete from resource where user_id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--根据用户id增加菜单权限，这里resource表的id自增需要 (@TableId设置与数据库的id要设置成自动增长)才能生效--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"saveMenusByUserId"</span>&gt;</span></span><br><span class="line">        insert into resource(user_id, path) values</span><br><span class="line">        <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">"menus"</span> <span class="attr">separator</span>=<span class="string">","</span> <span class="attr">item</span>=<span class="string">"menu"</span>&gt;</span></span><br><span class="line">            (#&#123;id&#125;, #&#123;menu&#125;)</span><br><span class="line">        <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>如此就完成了权限数据编辑的功能：</p>
<img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E4%BF%AE%E6%94%B9%E8%8F%9C%E5%8D%95%E9%A1%B5%E9%9D%A2%E6%9D%83%E9%99%90.png" alt="修改菜单页面权限" style="zoom:80%;">

<img src="H:\images\authorityimages\菜单权限权限修改后.png" alt="菜单权限权限修改后" style="zoom:80%;">

<p>可以看到<code>user_id</code>为4的用户之前是只能访问<code>数据管理</code>，对其进行权限编辑后，他就也能访问账户管理 和 角色管理了，现在我们的页面权限管理功能才算完成。</p>
<p>是不是感觉非常简单，我们仅仅用了两张表就完成了一个权限管理功能。</p>
<h4 id="ACL模型"><a href="#ACL模型" class="headerlink" title="ACL模型"></a>ACL模型</h4><p>两张表十分方便且容易理解，系统小数据量小这样玩没啥，如果数据量大就有其弊端所在：</p>
<ol>
<li>数据重复极大<ul>
<li>消耗存储资源。比如<code>/user/account</code>，我有多少用户有这权限我就得存储多少个这样的字符串。要知道这还是最简单的资源信息呢，只有一个路径，有些资源的信息可有很多哟：资源名称、类型、等级、介绍等等</li>
<li>更改资源成本过大。比如<code>/data</code>我要改成<code>/info</code>，那现有的那些权限数据都要跟着改</li>
</ul>
</li>
<li>设计不合理<ul>
<li>无法直观描述资源。刚才我们只弄了三个资源，如果我系统中想添加第四、五…种资源是没有办法的，因为现在的资源都是依赖于用户而存在，根本不能独立存储起来</li>
<li>表的释义不清。现在我们的<code>resource</code>表与其说是在描述资源，倒不如说是在描述用户和资源的关系</li>
</ul>
</li>
</ol>
<blockquote>
<p>为了解决上述问题，我们应当对当前表设计进行改良，要将<strong>资源</strong>和<strong>用户和资源的关系</strong>拎清。用户和资源的关系是多对多的，一个用户可以有多个权限，一个权限下可以有多个用户，我们一般都用中间表来描述这种多对多关系。然后资源表就不用来描述关系了，只用来描述资源。 这样我们新的表设计就出来了：建立中间表，改进资源表！</p>
</blockquote>
<p>我们先来对资源表进行改造，<code>id</code>、<code>user_id</code>、<code>path</code>这是之前的三个字段，<code>user_id</code>并不是用来描述资源的，所以我们将它删除。然后我们再额外加一个<code>name</code>字段用来描述资源名称（非必须），改造后此时资源表如下：</p>
<img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E8%B5%84%E6%BA%90%E8%A1%A8%E6%94%B9%E8%BF%9B.png" alt="资源表改进" style="zoom:80%;">

<p>表里的内容就专门用来放资源：</p>
<img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E8%B5%84%E6%BA%90%E8%A1%A8%E7%9A%84%E5%86%85%E5%AE%B9.png" alt="资源表的内容" style="zoom:80%;">

<p>资源表搞定了咱们建立一个中间表用来描述用户和权限的关系，中间表很简单就只存用户id和资源id（组成联合主键，就不需要额外设置自身的 主键id 了）：</p>
<p><img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E4%B8%AD%E9%97%B4%E8%A1%A8.png" alt="用户资源表数据"></p>
<p>之前的权限关系在中间表里就是这样存储的了：</p>
<img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E7%94%A8%E6%88%B7%E8%B5%84%E6%BA%90%E8%A1%A8%E6%95%B0%E6%8D%AE.png" alt="用户资源表数据" style="zoom:80%;">



<p>现在的数据表明，id为<code>1</code>的用户拥有id为<code>1、2、3</code>的权限，即用户1拥有<code>账户管理、角色管理、数据管理</code>权限。id为<code>2</code>的用户只拥有id为<code>3</code>的资源权限，即用户2拥有<code>数据管理</code>权限！</p>
<p>整个表设计就如此升级完毕了，现在我们的表关系如下：</p>
<img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E7%94%A8%E6%88%B7%E8%B5%84%E6%BA%90%E8%A1%A8%28%E5%A4%9A%E5%AF%B9%E5%A4%9A%29.png" alt="用户资源表(多对多)" style="zoom:80%;">

<p>由于表发生了变化，那么之前我们的代码也要进行相应的调整，调整也很简单，就是之前所有关于权限的操作都是操作<code>resource</code>表，我们改成操作<code>user_resource</code>表即可：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.hbp.authority.mapper.ResourceMapper"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--根据用户id获取该用户下所有权限路径--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"getPathsByUserId"</span> <span class="attr">resultType</span>=<span class="string">"java.lang.String"</span>&gt;</span></span><br><span class="line">        select id</span><br><span class="line">        from resource r</span><br><span class="line">        inner user_resource ur join on r.id = ur.resource_id</span><br><span class="line">        where ur.user_id = #&#123;userId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--根据用户id删除该角色下所有权限--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"removeByUserId"</span>&gt;</span></span><br><span class="line">        delete from user_resource where user_id = #&#123;id&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--根据用户id增加菜单权限--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"saveMenusByUserId"</span>&gt;</span></span><br><span class="line">        insert into user_resource(user_id, resource_id) values</span><br><span class="line">        <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">"menus"</span> <span class="attr">separator</span>=<span class="string">","</span> <span class="attr">item</span>=<span class="string">"menu"</span>&gt;</span></span><br><span class="line">            (#&#123;id&#125;, #&#123;menu&#125;)</span><br><span class="line">        <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>其中重点就是之前我们都是操作资源表的<code>path</code>字符串，前后端之间传递权限信息也是传递的<code>path</code>字符串，现在都改为操作资源表的<code>id</code></strong>（Java代码中记得也改过来，这里我就只演示SQL）</p>
<p>这里要单独解释一下，前后端只传递资源id的话，前端是咋根据这个id渲染页面呢？又是怎样根据这个id显示资源名称的呢？这是因为前端本地有存储一个映射字典，字典里有资源的信息，比如id对应哪个路径、名称等等，前端拿到了用户的id后根据字典进行判断就可以做到相应的功能了。</p>
<p>这个映射字典在实际开发中有两种管理模式，一种是前后端采取约定的形式，前端自己就在代码里造好了字典，如果后续资源有什么变化，前后端人员沟通一下就好了，这种方式只适合权限资源特别简单的情况。还一种就是后端提供一个接口，接口返回所有的资源数据，每当用户登录或进入系统首页的时候前端调用接口同步一下资源字典就好了！我们现在就用这种方式，所以还得写一个接口出来才行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 返回所有资源数据</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/resource/list"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Resource&gt; <span class="title">getList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// SQL语句非常简单：select * from resource</span></span><br><span class="line">    <span class="keyword">return</span> resourceService.list();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在，我们的权限设计才像点样子。这种用户和权限资源绑定关系的模式就是<strong>ACL模型</strong>，即Access Control List访问控制列表，其特点是方便、易于理解，适合权限功能简单的系统。</p>
<p>继续将整个设计再升级一下！</p>
<h4 id="RBAC模型"><a href="#RBAC模型" class="headerlink" title="RBAC模型"></a>RBAC模型</h4><p>我这里为了方便演示所以没有设置过多的权限资源（就是导航菜单），所以整个权限系统用起来好像也挺方便的，不过一旦权限资源多了起来目前的设计有点捉襟见肘了。假设我们有100个权限资源，A用户要设置50个权限，BCD三个用户也要设置这同样的50个权限，那么我必须为每个用户都重复操作50下才行！这种需求还特别特别常见，比如销售部门的员工都拥有同样的权限，每新来一个员工我就得给其一步一步重复地去设置权限，并且我要是更改这个销售部门的权限，那么旗下所有员工的权限都得一一更改，极其繁琐</p>
<blockquote>
<p>计算机科学领域的任何问题都可以通过增加一个间接的中间层来解决</p>
</blockquote>
<p>现在我们的权限关系是和用户绑定的，所以每有一个新用户我们就得为其设置一套专属的权限。既然很多用户的权限都是相同的，那么我再封装一层出来，屏蔽用户和权限之间的关系不就搞定了</p>
<p>这样有新的用户时只需要将其和这个封装层绑定关系，即可拥有一整套权限，将来就算权限更改也很方便。这个封装层我们将它称为<strong>角色</strong>！角色非常容易理解，销售人员是一种角色、后勤是一种角色，角色和权限绑定，用户和角色绑定</p>
<p>既然加了一层角色，我们的表设计也要跟着改变。毋庸置疑，肯定得有一个角色表来专门描述角色信息，简单点就两个字段<code>主键id</code>、<code>角色名称</code>，这里添加两个角色数据以作演示：</p>
<img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E8%A7%92%E8%89%B2%E8%A1%A8%E5%8F%8A%E6%95%B0%E6%8D%AE.png" alt="角色表及数据" style="zoom:80%;">

<p>刚才说的权限是和角色挂钩的，那么之前的<code>user_resource</code>表就要改成<code>role_resource</code>，然后用户又和角色挂钩，所以还得来一个<code>user_role</code>表：</p>
<img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E4%B8%AD%E9%97%B4%E8%A1%A8%E5%8F%8A%E6%95%B0%E6%8D%AE.png" alt="中间表及数据" style="zoom:80%;">

<p>上面的数据表明，id为<code>1</code>的角色（超级管理员）拥有三个权限资源，id为<code>2</code>的角色（数据管理员）只有一个权限资源。 然后用户<code>1</code>拥有超级管理员角色，用户<code>2</code>拥有数据管理员角色。</p>
<p>如果还有一个用户想拥有超级管理员的所有权限，只需要将该用户和超级管理员角色绑定即可！这样我们就完成了表的设计，现在我们数据库表如下（可以不用外键相连）：</p>
<img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/rbac%E6%A8%A1%E5%9E%8B.png" alt="rbac模型" style="zoom:80%;">

<p>这就是非常著名且非常流行的RBAC模型，即Role-Based Access Controller基于角色访问控制模型！它能满足绝大多数的权限要求，是业界最常用的权限模型之一。光说不练假把式，现在表也设计好了，咱们接下来改进我们的代码并且和前端联调起来，完成一个基于角色的权限管理系统！</p>
<p>之前咱们的用户页面是直接操作权限的，现在我们要改成操作角色，所以SQL语句要按如下编写：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.hbp.authority.mapper.RoleMapper"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--根据用户id批量新增角色--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertRolesByUserId"</span>&gt;</span></span><br><span class="line">        insert into user_role(user_id, role_id) values</span><br><span class="line">        <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">"roleIds"</span> <span class="attr">separator</span>=<span class="string">","</span> <span class="attr">item</span>=<span class="string">"roleId"</span>&gt;</span></span><br><span class="line">            (#&#123;userId&#125;, #&#123;roleId&#125;)</span><br><span class="line">        <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--根据用户id删除该用户所有角色--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteByUserId"</span>&gt;</span></span><br><span class="line">        delete from user_role where user_id = #&#123;userId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--根据用户id查询角色id集合--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectIdsByUserId"</span> <span class="attr">resultType</span>=<span class="string">"java.lang.Long"</span>&gt;</span></span><br><span class="line">        select role_id from user_role where user_id = #&#123;userId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>除了用户对角色的操作，我们还得有一个接口是拿用户id直接获取该用户的所有权限，这样前端才好根据当前用户的权限进行页面渲染。之前我们是将<code>resource</code>和<code>user_resource</code>连表查询出用户的所有权限，现在我们将<code>user_role</code>和<code>role_resource</code>连表拿到权限id ：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--根据用户id获取权限id--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectIdsByUserId"</span> <span class="attr">resultType</span>=<span class="string">"java.lang.Long"</span>&gt;</span></span><br><span class="line">    SELECT</span><br><span class="line">    	rr.resource_id</span><br><span class="line">    FROM</span><br><span class="line">    	user_role ur</span><br><span class="line">    	INNER JOIN role_resource rr ON ur.role_id = rr.role_id</span><br><span class="line">    WHERE</span><br><span class="line">    	ur.user_id = #&#123;userId&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>关于用户这一块的操作到此就完成了，我们接着来处理角色相关的操作。角色这里的思路和之前是一样的，之前用户是怎样直接操作权限的，这里角色就怎样操作权限：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.rudecrab.rbac.mapper.ResourceMapper"</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--根据角色id批量增加权限--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"insertResourcesByRoleId"</span>&gt;</span></span><br><span class="line">        insert into role_resource(role_id, resource_id) values</span><br><span class="line">        <span class="tag">&lt;<span class="name">foreach</span> <span class="attr">collection</span>=<span class="string">"resourceIds"</span> <span class="attr">separator</span>=<span class="string">","</span> <span class="attr">item</span>=<span class="string">"resourceId"</span>&gt;</span></span><br><span class="line">            (#&#123;roleId&#125;, #&#123;resourceId&#125;)</span><br><span class="line">        <span class="tag">&lt;/<span class="name">foreach</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--根据角色id删除该角色下所有权限--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">delete</span> <span class="attr">id</span>=<span class="string">"deleteByRoleId"</span>&gt;</span></span><br><span class="line">        delete from role_resource where role_id = #&#123;roleId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">delete</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">&lt;!--根据角色id获取权限id--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">"selectIdsByRoleId"</span> <span class="attr">resultType</span>=<span class="string">"java.lang.Long"</span>&gt;</span></span><br><span class="line">        select resource_id from role_resource where role_id = #&#123;roleId&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注意哦，这里前后端传递的也都是<code>id</code>，既然是<code>id</code>那么前端就得有映射字典才好渲染，所以我们这两个接口是必不可少的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 返回所有资源数据</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/resource/list"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Resource&gt; <span class="title">getList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// SQL语句非常简单：select * from resource</span></span><br><span class="line">    <span class="keyword">return</span> resourceService.list();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 返回所有角色数据</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/role/list"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;Role&gt; <span class="title">getList</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// SQL语句非常简单：select * from role</span></span><br><span class="line">    <span class="keyword">return</span> roleService.list();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>字典有了，操作角色的方法有了，操作权限的方法也有了，至此我们就完成了基于RBAC模型的页面权限功能。</p>
<p><strong>无论几张表，权限的核心还是我之前展示的那流程图，思路掌握了怎样的模型都是OK的</strong></p>
<p>不知道大家发现没有，在前后端分离的模式下，后端在登录的时候将权限数据甩给前端后就再也不管了，如果此时用户的权限发生变化是无法通知前端的，并且数据存储在前端也容易被用户直接篡改，所以很不安全。前后端分离不像未分离一样，页面请求都得走后端，后端可以很轻松的就对每个页面请求其进行安全判断：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Controller</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ViewController</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ResourceService resourceService;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 这些逻辑都可以放在过滤器统一做，这里只是为了方便演示</span></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/user/account"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">userAccount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 先从缓存或数据库中取出当前登录用户的权限数据</span></span><br><span class="line">  List&lt;String&gt; menus = resourceService.getCurrentUserMenus();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 判断有没有权限</span></span><br><span class="line">        <span class="keyword">if</span> (list.contains(<span class="string">"/user/account"</span>)) &#123;</span><br><span class="line">             <span class="comment">// 有权限就返回正常页面</span></span><br><span class="line">         <span class="keyword">return</span> <span class="string">"user-account"</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 没有权限就返回404页面</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"404"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码，首先权限数据存储在后端，被用户直接篡改的可能就被屏蔽了。并且每当用户访问页面的时候后端都要实时查询数据，当用户权限数据发生变更时也能即时同步。</p>
<p>这么一说难道前后端分离模式下就得认栽了？当然不是，其实有一个骚操作就是前端发起每一次后端请求时，后端都将最新的权限数据返回给前端，这样就能避免上述问题了。不过这个方法会给网络传输带来极大的压力，既不优雅也不明智，所以一般都不这么干。折中的办法就是当用户进入某个页面时重新获取一次权限数据，比如首页。不过这也不太安全，毕竟只要用户不进入首页那还是没用。</p>
<p>那么又优雅又明智又安全的方式是什么呢，就是我们接下来要讲的操作权限了！</p>
<h3 id="操作权限"><a href="#操作权限" class="headerlink" title="操作权限"></a><strong>操作权限</strong></h3><p>操作权限就是将<strong>操作</strong>视为资源，比如删除操作，有些人可以有些人不行。于后端来说，操作就是一个接口。于前端来说，操作往往是一个按钮，所以操作权限也被称为<strong>按钮权限</strong>，是一种<strong>细颗粒权限</strong>。</p>
<p>在页面上比较直观的体现就是没有这个删除权限的人就不会显示该按钮，或者该按钮被禁用：</p>
<img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E5%88%A0%E9%99%A4%E6%8C%89%E9%92%AE.png" alt="删除按钮" style="zoom:60%;">

<p><strong>前端实现按钮权限还是和之前导航菜单渲染一样的，拿当前用户的权限资源id和权限资源字典对比，有权限就渲染出来，无权限就不渲染</strong></p>
<p>前端关于权限的逻辑和之前一样，那操作权限怎么就比页面权限安全了呢？这个安全主要体现在后端上，页面渲染不走后端，但接口可必须得走后端，那只要走后端那就好办了，我们只需要对每个接口进行一个权限判断就OK了嘛！</p>
<h4 id="基本实现"><a href="#基本实现" class="headerlink" title="基本实现"></a>基本实现</h4><p>咱们之前都是针对页面权限进行的设计，现在扩展操作权限的话我们要对现有的<code>resource</code>资源表进行一个小小的扩展，加一个<code>type</code>字段来区分页面权限和操作权限</p>
<img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E6%94%B9%E8%BF%9B%E8%B5%84%E6%BA%90%E8%A1%A8.png" alt="改进资源表" style="zoom:80%;">

<p>这里我们用<code>0</code>来表示页面权限，用<code>1</code>来表示操作权限。</p>
<p>表扩展完毕，我们接下来就要添加操作权限类型的数据。刚才也说了，于后端而言操作就是一个接口，那么我们就要<strong>将 接口路径 作为我们的权限资源</strong>，大家一看就都明白了：</p>
<img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E8%B5%84%E6%BA%90%E8%A1%A8%E6%95%B0%E6%8D%AE%E6%94%B9%E8%BF%9B.png" alt="资源表数据改进" style="zoom:80%;">

<p><code>DELETE:/API/user</code>分为两个部分组成，<code>DELETE:</code>表示该接口的请求方式，比如<code>GET</code>、<code>POST</code>等，<code>/API/user</code>则是接口路径了，两者组合起来就能确定一个接口请求！</p>
<p>数据有了，我们接着在代码中进行权限安全判断，注意看注释：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/API/user"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">    ...省略自动注入的service代码</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DeleteMapping</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">deleteUser</span><span class="params">(Long[] ids)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 拿到所有权限路径 和 当前用户拥有的权限路径</span></span><br><span class="line">        Set&lt;String&gt; allPaths = resourceService.getAllPaths();</span><br><span class="line">        Set&lt;String&gt; userPaths = resourceService.getPathsByUserId(UserContext.getCurrentUserId());</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 第一个判断：所有权限路径中包含该接口，才代表该接口需要权限处理，所以这是先决条件，</span></span><br><span class="line">        <span class="comment">// 第二个判断：判断该接口是不是属于当前用户的权限范围，如果不是，则代表该接口用户没有权限</span></span><br><span class="line">        <span class="keyword">if</span> (allPaths.contains(<span class="string">"DELETE:/API/user"</span>) &amp;&amp; !userPaths.contains(<span class="string">"DELETE:/API/user"</span>)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ApiException(ResultCode.FORBIDDEN);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 走到这代表该接口用户是有权限的，则进行正常的业务逻辑处理</span></span><br><span class="line">        userService.removeByIds(Arrays.asList(ids));</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"操作成功"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...省略其他接口声明</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>按钮是隐藏了，可如果用户篡改本地权限数据，导致不该显示的按钮显示了出来，或者用户知道了接口绕过页面自行调用怎么办？反正不管怎样，他最终都是要调用我们接口的，那我们就调用接口来试下效果：</p>
<img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/postman%E8%AF%B7%E6%B1%82.png" alt="postman请求" style="zoom:67%;">

<p>可以看到，绕过前端的安全判断也是没有用的！</p>
<p>然后还有一个我们之前说的问题，如果当前用户权限被人修改了，如何实时和前端同步呢？比如，一开始A用户的角色是有<code>删除权限</code>的，然后被一个管理员将他的该权限给去除了，可此时A用户不重新登录的话还是能看到删除按钮。</p>
<p>其实有了操作权限后，用户就算能看到不属于自己的按钮也不损害安全性，他点击后还是会提示无权限，只是说用户体验稍微差点罢了！ 页面也是一样，<strong>页面只是一个容器，用来承载数据的，而数据是要通过接口来调用的</strong>，比如图中演示的分页数据，我们就可以将分页查询接口也做一个权限管理嘛，这样用户就算绕过了页面权限，来到了<code>账户管理</code>板块，照样看不到丝毫数据！</p>
<p>至此，我们就完成了按钮级的操作权限，是不是很简单？再次啰嗦：只要掌握了核心思路，实现起来真的很简单，不要想复杂了。</p>
<p>我们现在都是手动添加的资源数据，写一个接口我就要手动加一个数据，要知道一个系统中成百上千个接口太正常了，那我手动添加不得起飞咯？那有什么办法，我写接口的同时就自动将资源数据给生成呢，那就是我接下来要讲的接口扫描！</p>
<h3 id="接口扫描"><a href="#接口扫描" class="headerlink" title="接口扫描"></a>接口扫描</h3><p><code>SpringMVC</code>提供了一个非常方便的类<code>RequestMappingInfoHandlerMapping</code>，这个类可以拿到所有你声明的web接口信息，这个拿到后剩下的事不就非常简单了，就是通过代码将接口信息批量添加到数据库呗！不过我们也不是要真的将<strong>所有</strong>接口都添加到权限资源中去，我们要的是那些需要权限处理的接口生成权限资源，有些接口不需要权限处理那自然就不生成了。所以我们得想一个办法来标记一下该接口是否需要被权限管理！</p>
<p>我们的接口都是通过方法来声明的，标记方法最方便的方式自然就是注解嘛！那我们先来自定义一个注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(&#123;ElementType.METHOD, ElementType.TYPE&#125;) <span class="comment">// 表明该注解可以加在类或方法上</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Auth &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 权限id，需要唯一</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">id</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 权限名称</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">String <span class="title">name</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个注解为啥这样设计我等下再说，现在只需要晓得，只要接口方法加上了这个注解，我们就被视其为是需要权限管理的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/API/user"</span>)</span><br><span class="line"><span class="meta">@Auth</span>(id = <span class="number">1000</span>, name = <span class="string">"用户管理"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span> </span>&#123;</span><br><span class="line">     ...省略自动注入的service代码</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span></span><br><span class="line">    <span class="meta">@Auth</span>(id = <span class="number">1</span>, name = <span class="string">"新增用户"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">createUser</span><span class="params">(@RequestBody UserParam param)</span> </span>&#123;</span><br><span class="line">        ...省略业务代码</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"操作成功"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@DeleteMapping</span></span><br><span class="line">    <span class="meta">@Auth</span>(id = <span class="number">2</span>, name = <span class="string">"删除用户"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">deleteUser</span><span class="params">(Long[] ids)</span> </span>&#123;</span><br><span class="line">        ...省略业务代码</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"操作成功"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PutMapping</span></span><br><span class="line">    <span class="meta">@Auth</span>(id = <span class="number">3</span>, name = <span class="string">"编辑用户"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">updateRoles</span><span class="params">(@RequestBody UserParam param)</span> </span>&#123;</span><br><span class="line">        ...省略业务代码</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"操作成功"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/test/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="meta">@Auth</span>(id = <span class="number">4</span>,name = <span class="string">"用于演示路径参数"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testInterface</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> String id) </span>&#123;</span><br><span class="line">        ...省略业务代码</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"操作成功"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ...省略其他接口声明</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在讲接口扫描和介绍注解设计前，我们先看一下最终的效果，看完效果后再去理解就事半功倍：</p>
<img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E6%8E%A5%E5%8F%A3%E6%B3%A8%E8%A7%A3%E7%BB%93%E6%9E%9C.png" alt="接口注解结果" style="zoom:50%;">

<p>可以看到，上面代码中我在类和方法上都加上了我们自定义的<code>Auth</code>注解，并在注解中设置了<code>id</code>和<code>name</code>的值，这个<code>name</code>好理解，就是资源数据中的资源名称嘛。可注解里为啥要设计<code>id</code>呢，数据库主键<code>id</code>不是一般都是用自增嘛。这是因为我们人为控制资源的主键<code>id</code>有很多好处。</p>
<p>首先是<code>id</code>和接口路径的映射特别稳定，如果要用自增的话，我一个接口一开始的权限<code>id</code>是<code>4</code>，一大堆角色绑定在这个资源<code>4</code>上面了，然后我业务需求有一段时间不需要该接口做权限管理，于是我将这个资源<code>4</code>删除一段时间，后续再加回来，可数据再加回来的时候<code>id</code>就变成<code>5</code>，之前与其绑定的角色又得重新设置资源，非常麻烦！如果这个<code>id</code>是固定的话，我将这个接口权限一加回来，之前所有设置好的权限都可以无感知地生效，非常非常方便。所以，<code>id</code>和接口路径的映射从一开始就要稳定下来，不要轻易变更！</p>
<p>至于类上加上<code>Auth</code>注解是方便模块化管理接口权限，一个<code>Controller</code>类咱们就视为一套接口模块，最终接口权限的<code>id</code>就是模块<code>id</code> + 方法<code>id</code>。大家想一想如果不这么做的话，我要保证每一个接口权限<code>id</code>唯一，我就得记得各个类中所有方法的<code>id</code>，一个一个累加地去设置新<code>id</code>。比如上一个方法我设置到了<code>101</code>，接着我就要设置<code>102</code>、<code>103</code>…，只要一没注意就设置重了。可如果按照<code>Controller</code>类分好组后就特别方便管理了，这个类是<code>1000</code>、下一个类是<code>2000</code>，然后类中所有方法就可以独立地按照<code>1</code>、<code>2</code>、<code>3</code>来设置，极大避免了心智负担！</p>
<p>介绍了这么久注解的设计，我们再讲解接口扫描的具体实现方式！这个扫描肯定是发生在我新接口写完了，重新编译打包重启程序的时候！并且就只在程序启动的时候做一次扫描，后续运行期间是不可能再重复扫描的，重复扫描没有任何意义嘛！既然是在程序启动时进行的逻辑操作，那么我们就可以使用SpringBoot提供的<code>ApplicationRunner</code>接口来进行处理，重写该接口的方法会在程序启动时被执行。（程序启动时执行指定逻辑有很多种办法，并不局限于这一个，具体使用根据需求来）</p>
<p>我们现在就来创建一个类实现该接口，并重写其中的<code>run</code>方法，在其中写上我们的接口扫描逻辑。<strong>注意，下面代码逻辑现在不用每一行都去理解，大概知道这么个写法就行，重点是看注释理解其大概意思，将来再慢慢研究</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationStartup</span> <span class="keyword">implements</span> <span class="title">ApplicationRunner</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RequestMappingInfoHandlerMapping requestMappingInfoHandlerMapping;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ResourceService resourceService;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(ApplicationArguments args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 扫描并获取所有需要权限处理的接口资源(该方法逻辑写在下面)</span></span><br><span class="line">        List&lt;Resource&gt; list = getAuthResources();</span><br><span class="line">        <span class="comment">// 先删除所有操作权限类型的权限资源，待会再新增资源，以实现全量更新（注意哦，数据库中不要设置外键，否则会删除失败）</span></span><br><span class="line">        resourceService.deleteResourceByType(<span class="number">1</span>);</span><br><span class="line">        <span class="comment">// 如果权限资源为空，就不用走后续数据插入步骤</span></span><br><span class="line">        <span class="keyword">if</span> (Collections.isEmpty(list)) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 将资源数据批量添加到数据库</span></span><br><span class="line">        resourceService.insertResources(list);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 扫描并返回所有需要权限处理的接口资源</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> List&lt;Resource&gt; <span class="title">getAuthResources</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 接下来要添加到数据库的资源</span></span><br><span class="line">        List&lt;Resource&gt; list = <span class="keyword">new</span> LinkedList&lt;&gt;();</span><br><span class="line">        <span class="comment">// 拿到所有接口信息，并开始遍历</span></span><br><span class="line">        Map&lt;RequestMappingInfo, HandlerMethod&gt; handlerMethods = requestMappingInfoHandlerMapping.getHandlerMethods();</span><br><span class="line">        handlerMethods.forEach((info, handlerMethod) -&gt; &#123;</span><br><span class="line">            <span class="comment">// 拿到类(模块)上的权限注解</span></span><br><span class="line">            Auth moduleAuth = handlerMethod.getBeanType().getAnnotation(Auth<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            <span class="comment">// 拿到接口方法上的权限注解</span></span><br><span class="line">            Auth methodAuth = handlerMethod.getMethod().getAnnotation(Auth<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            <span class="comment">// 模块注解和方法注解缺一个都代表不进行权限处理</span></span><br><span class="line">            <span class="keyword">if</span> (moduleAuth == <span class="keyword">null</span> || methodAuth == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 拿到该接口方法的请求方式(GET、POST等)</span></span><br><span class="line">            Set&lt;RequestMethod&gt; methods = info.getMethodsCondition().getMethods();</span><br><span class="line">            <span class="comment">// 如果一个接口方法标记了多个请求方式，权限id是无法识别的，不进行处理</span></span><br><span class="line">            <span class="keyword">if</span> (methods.size() != <span class="number">1</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 将请求方式和路径用`:`拼接起来，以区分接口。比如：GET:/user/&#123;id&#125;、POST:/user/&#123;id&#125;</span></span><br><span class="line">            String path = methods.toArray()[<span class="number">0</span>] + <span class="string">":"</span> + info.getPatternsCondition().getPatterns().toArray()[<span class="number">0</span>];</span><br><span class="line">            <span class="comment">// 将权限名、资源路径、资源类型组装成资源对象，并添加集合中</span></span><br><span class="line">            Resource resource = <span class="keyword">new</span> Resource();</span><br><span class="line">            resource.setType(<span class="number">1</span>)</span><br><span class="line">                .setPath(path)</span><br><span class="line">                .setName(methodAuth.name())</span><br><span class="line">                .setId(moduleAuth.id() + methodAuth.id());</span><br><span class="line">            list.add(resource);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，我们就完成了接口扫描啦！后续只要写新接口需要权限处理时，只要加上<code>Auth</code>注解就可以啦！最终插入的数据就是之前展示的数据效果图啦！</p>
<p>到这你以为就完了嘛，作为老套路人哪能这么轻易结束，我要继续优化！</p>
<p>咱们现在是核心逻辑 + 接口扫描，不过还不够。现在我们每一个权限安全判断都是写在方法内，且这个逻辑判断代码都是一样的，我有多少个接口需要权限处理我就得写多少重复代码，这太恶心了：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PutMapping</span></span><br><span class="line"><span class="meta">@Auth</span>(id = <span class="number">1</span>, name = <span class="string">"新增用户"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">deleteUser</span><span class="params">(@RequestBody UserParam param)</span> </span>&#123;</span><br><span class="line">    Set&lt;String&gt; allPaths = resourceService.getAllPaths();</span><br><span class="line">    Set&lt;String&gt; userPaths = resourceService.getPathsByUserId(UserContext.getCurrentUserId());</span><br><span class="line">    <span class="keyword">if</span> (allPaths.contains(<span class="string">"PUT:/API/user"</span>) &amp;&amp; !userPaths.contains(<span class="string">"PUT:/API/user"</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ApiException(ResultCode.FORBIDDEN);</span><br><span class="line">    &#125;</span><br><span class="line">    ...省略业务逻辑代码</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"操作成功"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@DeleteMapping</span></span><br><span class="line"><span class="meta">@Auth</span>(id = <span class="number">2</span>, name = <span class="string">"删除用户"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">deleteUser</span><span class="params">(Long[] ids)</span> </span>&#123;</span><br><span class="line">    Set&lt;String&gt; allPaths = resourceService.getAllPaths();</span><br><span class="line">    Set&lt;String&gt; userPaths = resourceService.getPathsByUserId(UserContext.getCurrentUserId());</span><br><span class="line">    <span class="keyword">if</span> (allPaths.contains(<span class="string">"DELETE:/API/user"</span>) &amp;&amp; !userPaths.contains(<span class="string">"DELETE:/API/user"</span>)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ApiException(ResultCode.FORBIDDEN);</span><br><span class="line">    &#125;</span><br><span class="line">    ...省略业务逻辑代码</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"操作成功"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这种重复代码，之前也提过一嘴了，当然要用拦截器来做统一处理嘛！</p>
<h4 id="拦截器"><a href="#拦截器" class="headerlink" title="拦截器"></a>拦截器</h4><p>拦截器中的代码和之前接口方法中写的逻辑判断大致一样，还是一样，看注释理解大概思路即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AuthInterceptor</span> <span class="keyword">extends</span> <span class="title">HandlerInterceptorAdapter</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ResourceService resourceService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">preHandle</span><span class="params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// 如果是静态资源，直接放行</span></span><br><span class="line">        <span class="keyword">if</span> (!(handler <span class="keyword">instanceof</span> HandlerMethod)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取请求的最佳匹配路径，这里的意思就是我之前数据演示的/API/user/test/&#123;id&#125;路径参数</span></span><br><span class="line">        <span class="comment">// 如果用uri判断的话就是/API/user/test/100，就和路径参数匹配不上了，所以要用这种方式获得</span></span><br><span class="line">        String pattern = (String)request.getAttribute(</span><br><span class="line">                HandlerMapping.BEST_MATCHING_PATTERN_ATTRIBUTE);</span><br><span class="line">        <span class="comment">// 将请求方式（GET、POST等）和请求路径用 : 拼接起来，等下好进行判断。最终拼成字符串的就像这样：DELETE:/API/user</span></span><br><span class="line">        String path = request.getMethod() + <span class="string">":"</span> + pattern;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 拿到所有权限路径 和 当前用户拥有的权限路径（注意：这里只是为了演示才走的数据库，实际开发中一定要将权限数据存到缓存中查询）</span></span><br><span class="line">        Set&lt;String&gt; allPaths = resourceService.list().stream().map(Resource::getPath).collect(Collectors.toSet());</span><br><span class="line">        Set&lt;String&gt; userPaths = resourceService.getPathsByUserId(UserContext.getCurrentUserId());</span><br><span class="line">        Set&lt;String&gt; userPaths = resource.stream()</span><br><span class="line">            .filter(e -&gt; e.getType() == <span class="number">1</span>)</span><br><span class="line">            .map(Resource::getPath)</span><br><span class="line">            .collect(Collectors.toSet());</span><br><span class="line">        <span class="comment">// 第一个判断：所有权限路径中包含该接口，才代表该接口需要权限处理，所以这是先决条件，</span></span><br><span class="line">        <span class="comment">// 第二个判断：判断该接口是不是属于当前用户的权限范围，如果不是，则代表该接口用户没有权限</span></span><br><span class="line">        <span class="keyword">if</span> (allPaths.contains(path) &amp;&amp; !userPaths.contains(path)) &#123;</span><br><span class="line">            <span class="comment">// 没有权限则抛出异常</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ApiException(ResultCode.FORBIDDEN);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 有权限就放行</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>拦截器类写好之后，别忘了要使其生效，这里我们直接让<code>SpringBoot</code>启动类实现<code>WevMvcConfigurer</code>接口来做：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RbacApplication</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(RbacApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 添加权限拦截器，并排除登录接口（如果有登录拦截器，权限拦截器记得放在登录拦截器后面）</span></span><br><span class="line">        registry.addInterceptor(authInterceptor()).excludePathPatterns(<span class="string">"/API/login"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// 这里一定要用如此方式创建拦截器，否则拦截器中的自动注入不会生效</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> AuthInterceptor <span class="title">authInterceptor</span><span class="params">()</span> </span>&#123;<span class="keyword">return</span> <span class="keyword">new</span> AuthInterceptor();&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样，我们之前接口方法中的权限判断的相关代码都可以去除啦！</p>
<p>至此，我们才算对页面级权限 + 按钮级权限有了一个比较不错的实现！</p>
<blockquote>
<p>注意，拦截器中获取权限数据现在是直接查的数据库，实际开发中<strong>一定一定</strong>要将权限数据存在缓存里（如Redis），否则每个接口都要访问一遍数据库，压力太大了！这里为了减少心智负担，我就不整合Redis了</p>
</blockquote>
<h3 id="数据权限"><a href="#数据权限" class="headerlink" title="数据权限"></a><strong>数据权限</strong></h3><p>前面所介绍的页面权限和操作权限都属于<strong>功能权限</strong>，我们接下来要讲的就是截然不同的<strong>数据权限</strong>。</p>
<p>功能权限和数据权限最大的不同就在于，前者是判断<strong>有没有</strong>某权限，后者是判断<strong>有多少</strong>权限。功能权限对资源的安全判断只有YES和NO两种结果，要么你就有这个权限要么你就没有。而资源权限所要求的是，在<strong>同一个数据请求</strong>中，根据不同的权限范围返回<strong>不同的数据集</strong>。</p>
<p>举一个最简单的数据权限例子就是：现在列表里本身有十条数据，其中有四条我没有权限，那么我就只能查询出六条数据。接下来我就带大家来实现这个功能！</p>
<h4 id="硬编码"><a href="#硬编码" class="headerlink" title="硬编码"></a>硬编码</h4><p>我们现在来模拟一个业务场景：一个公司在各个地方成立了分部，每个分部都有属于自己分公司的订单数据，没有相应权限是看不到的，每个人只能查看属于自己权限的订单，都是同样的分页列表页面，不同的人查出来了不同的结果。</p>
<p>这个分页查询功能没什么好说的，数据库表的设计也非常简单，我们建一个数据表<code>data</code>和一个公司表<code>company</code>，<code>data</code>数据表中其他字段不是重点，主要是要有一个<code>company_id</code>字段用来关联<code>company</code>公司表，这样才能将数据分类，才能后续进行权限的划分：</p>
<img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E5%85%AC%E5%8F%B8%E8%A1%A8.png" alt="公司表" style="zoom:60%;">

<p>我们权限划分也很简单，就和之前一样的，建一个中间表即可。这里为了演示，就直接将用户和公司直接挂钩了，建一个<code>user_company</code>表来表示用户拥有哪些公司数据权限：</p>
<img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E7%94%A8%E6%88%B7%E5%85%AC%E5%8F%B8%E8%A1%A8%E6%95%B0%E6%8D%AE.png" alt="用户公司表数据" style="zoom:67%;">

<p>上面数据表明id为<code>1</code>的用户拥有id为<code>1、2、3、4、5</code>的公司数据权限，id为<code>2</code>的用户拥有id为<code>4、5</code>的公司数据权限。</p>
<p>我相信大家经过了功能权限的学习后，这点表设计已经信手拈来了。表设计和数据准备好后，接下来就是我们关键的权限功能实现。</p>
<p>首先，我们得梳理一下普通的分页查询是怎样的。我们要对<code>data</code>进行分页查询，<code>SQL</code>语句会按照如下编写：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 按照创建时间降序排序</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="string">`data`</span> <span class="keyword">ORDER</span> <span class="keyword">BY</span> create_time <span class="keyword">DESC</span> <span class="keyword">LIMIT</span> ?,?</span><br></pre></td></tr></table></figure>

<p>这个没什么好说的，正常查询数据然后进行<code>limit</code>限制以达到分页的效果。那么我们要加上数据过滤功能，<strong>「只需要在<code>SQL</code>上进行过滤不就搞定了」</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 只查询指定公司的数据</span></span><br><span class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> <span class="string">`data`</span> <span class="keyword">where</span> company_id <span class="keyword">in</span> (?, ?, ?...) <span class="keyword">ORDER</span> <span class="keyword">BY</span> create_time <span class="keyword">DESC</span> <span class="keyword">LIMIT</span> ?,?</span><br></pre></td></tr></table></figure>

<p>我们只需要先将用户所属的公司<code>id</code>全部查出来，然后放到分页语句中的<code>in</code>中即可达到效果。</p>
<p>我们不用<code>in</code>条件判断，使用连表也是可以达到效果的：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 连接 用户-公司 关系表，查询指定用户关联的公司数据</span></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line"> *</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line"> <span class="string">`data`</span></span><br><span class="line"> <span class="keyword">INNER</span> <span class="keyword">JOIN</span> user_company uc <span class="keyword">ON</span> data.company_id = uc.company_id <span class="keyword">AND</span> uc.user_id = ? </span><br><span class="line"><span class="keyword">ORDER</span> <span class="keyword">BY</span></span><br><span class="line"> create_time <span class="keyword">DESC</span> </span><br><span class="line"><span class="keyword">LIMIT</span> ?,?</span><br></pre></td></tr></table></figure>

<p>当然，不用连表用子查询也可以实现，这里就不过多展开了。总之，能够达到过滤效果的<code>SQL</code>语句有很多，根据业务特点优化就好。</p>
<p>到这里我其实就已经介绍完一种非常简单粗暴的数据权限实现方式了：硬编码！即，直接修改我们原有的<code>SQL</code>语句，自然而然就达到效果了嘛~</p>
<p>不过这种方式对原有代码入侵太大了，每个要权限过滤的接口我都得修改，严重影响了开闭原则。有啥办法可以不对原有接口进行修改吗？当然是有的，这就是我接下来要介绍的<code>Mybatis</code>拦截插件。</p>
<h4 id="Mybatis拦截插件"><a href="#Mybatis拦截插件" class="headerlink" title="Mybatis拦截插件"></a>Mybatis拦截插件</h4><p><code>ybatis</code>提供了一个<code>Interceptor</code>接口，通过实现该接口可以定义我们自己的拦截器，这个拦截器可以对<code>SQL</code>语句进行拦截，然后扩展/修改。许多分页、分库分表、加密解密等插件都是通过该接口完成的！</p>
<p>我们只需要拦截到原有的<code>SQL</code>语句后，添加上我们额外的语句，不就和刚才硬编码一样实现了效果？这里我先给大家看一下我已经写好了的拦截器效果：</p>
<p><img src="https://authorityimages.oss-cn-guangzhou.aliyuncs.com/authorityimages/%E6%8B%A6%E6%88%AA%E5%90%8E%E7%9A%84sql.png" alt="拦截后的sql"></p>
<p>可以看到，红框框起来的部分就是在原<code>SQL</code>上添加的语句！这个拦截并不仅限于分页查询，只要我们写好语句扩展规则，其他语句都是可以拦截扩展的！</p>
<p>接下来我就贴上拦截器的代码，注意<strong>「这个代码大家不用过多地去纠结，大概瞟一眼知道有这么个玩意就行了」</strong>，因为现在我们的重点是整体思路，先跟着我的思路来，代码有的是时间再看：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">@Intercepts(&#123;@Signature(type = StatementHandler.class, method = "prepare", args = &#123;Connection.class, Integer.class&#125;)&#125;)</span><br><span class="line">public class DataInterceptor implements Interceptor &#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public Object intercept(Invocation invocation) throws Throwable &#123;</span><br><span class="line">        // 拿到mybatis的一些对象,等下要操作</span><br><span class="line">        StatementHandler statementHandler = PluginUtils.realTarget(invocation.getTarget());</span><br><span class="line">        MetaObject metaObject = SystemMetaObject.forObject(statementHandler);</span><br><span class="line">        MappedStatement mappedStatement = (MappedStatement) metaObject.getValue("delegate.mappedStatement");</span><br><span class="line"></span><br><span class="line">        // id为执行的mapper方法的全路径名，如com.rudecrab.mapper.UserMapper.insertUser</span><br><span class="line">        String id = mappedStatement.getId();</span><br><span class="line">        log.info("mapper: ==&gt; &#123;&#125;", id);</span><br><span class="line">        // 如果不是指定的方法，直接结束拦截</span><br><span class="line">        // 如果方法多可以存到一个集合里，然后判断当前拦截的是否存在集合中，这里为了演示只拦截一个mapper方法</span><br><span class="line">        if (!"com.rudecrab.rbac.mapper.DataMapper.selectPage".equals(id)) &#123;</span><br><span class="line">            return invocation.proceed();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 获取到原始sql语句</span><br><span class="line">        String sql = statementHandler.getBoundSql().getSql();</span><br><span class="line">        log.info("原始SQL语句： ==&gt; &#123;&#125;", sql);</span><br><span class="line">        // 解析并返回新的SQL语句</span><br><span class="line">        sql = getSql(sql);</span><br><span class="line">        // 修改sql</span><br><span class="line">        metaObject.setValue("delegate.boundSql.sql", sql);</span><br><span class="line">        log.info("拦截后SQL语句：==&gt;&#123;&#125;", sql);</span><br><span class="line"></span><br><span class="line">        return invocation.proceed();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 解析SQL语句，并返回新的SQL语句</span></span><br><span class="line"><span class="comment">     * 注意，该方法使用了JSqlParser来操作SQL，该依赖包Mybatis-plus已经集成了。如果要单独使用，请先自行导入依赖</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * @param sql 原SQL</span></span><br><span class="line"><span class="comment">     * @return 新SQL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    private String getSql(String sql) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            // 解析语句</span><br><span class="line">            Statement stmt = CCJSqlParserUtil.parse(sql);</span><br><span class="line">            <span class="keyword">Select</span> selectStatement = (<span class="keyword">Select</span>) stmt;</span><br><span class="line">            PlainSelect ps = (PlainSelect) selectStatement.getSelectBody();</span><br><span class="line">            // 拿到表信息</span><br><span class="line">            FromItem fromItem = ps.getFromItem();</span><br><span class="line">            Table table = (Table) fromItem;</span><br><span class="line">            String mainTable = table.getAlias() == null ? table.getName() : table.getAlias().getName();</span><br><span class="line">            List&lt;Join&gt; joins = ps.getJoins();</span><br><span class="line">            if (joins == null) &#123;</span><br><span class="line">                joins = new ArrayList&lt;&gt;(1);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // 创建连表join条件</span><br><span class="line">            Join join = new Join();</span><br><span class="line">            join.setInner(true);</span><br><span class="line">            join.setRightItem(new Table("user_company uc"));</span><br><span class="line">            // 第一个：两表通过company_id连接</span><br><span class="line">            EqualsTo joinExpression = new EqualsTo();</span><br><span class="line">            joinExpression.setLeftExpression(new Column(mainTable + ".company_id"));</span><br><span class="line">            joinExpression.setRightExpression(new Column("uc.company_id"));</span><br><span class="line">            // 第二个条件：和当前登录用户id匹配</span><br><span class="line">            EqualsTo userIdExpression = new EqualsTo();</span><br><span class="line">            userIdExpression.setLeftExpression(new Column("uc.user_id"));</span><br><span class="line">            userIdExpression.setRightExpression(new LongValue(UserContext.getCurrentUserId()));</span><br><span class="line">            // 将两个条件拼接起来</span><br><span class="line">            join.setOnExpression(new AndExpression(joinExpression, userIdExpression));</span><br><span class="line">            joins.add(join);</span><br><span class="line">            ps.setJoins(joins);</span><br><span class="line"></span><br><span class="line">            // 修改原语句</span><br><span class="line">            sql = ps.toString();</span><br><span class="line">        &#125; catch (JSQLParserException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        return sql;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>SQL</code>拦截器写好后就会非常方便了，之前写好的代码不用修改，直接用拦截器进行统一处理即可！如此，我们就完成了一个简单的数据权限功能！是不是感觉太简单了点，这么一会就将数据权限介绍完啦？</p>
<p>说简单也确实简单，其核心一句话就可以表明：<strong>对<code>SQL</code>进行拦截然后达到数据过滤的效果</strong>。但是！我这里只是演示了一个特别简单的案例，考虑的层面特别少，如果需求一旦复杂起来那需要考虑的东西我这篇文章再加几倍内容只怕也难以说完。</p>
<p>数据权限和业务关联性极强，有很多自己行业特点的权限划分维度，比如交易金额、交易时间、地区、年龄、用户标签等等等等，我们这只演示了一个部门维度的划分而已。有些数据权限甚至要做到多个维度交叉，还要做到到能对某个字段进行数据过滤（比如A管理员能看到手机号、交易金额，B管理员看不到），其难度和复杂度远超功能权限。</p>
<p>所以对于数据权限，一定是需求在先，技术手段再跟上。至于你是要用<code>Mybatis</code>还是其他什么框架，你是要用子查询还是用连表，都没有定式而言，一定得根据具体的业务需求来制定针对性的数据过滤方案！</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>到这里，关于权限的讲解就接近尾声了。其实本文说了那么多也就只是在阐述以下几点：</p>
<ol>
<li>权限的本质就是保护资源</li>
<li>权限设计的核心就是 保护什么资源、如何保护资源</li>
<li>核心掌握后，根据具体的业务需求来制定方案即可，万变不离其宗</li>
</ol>
<blockquote>
<p>文章主要来源：</p>
<p>作者：RudeCrab</p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzkyMjIxMTg2Mg==&amp;mid=2247485287&amp;idx=1&amp;sn=f387e61cc60d5bd8212f73fdd593161b&amp;chksm=c1f6841ef6810d08a4b8f47dad0aa5382be529145d5dcf978c11a41367733b202ac6efcce2c9&amp;scene=178&amp;cur_album_id=1773408485754339330#rd" target="_blank" rel="noopener">https://mp.weixin.qq.com/s?__biz=MzkyMjIxMTg2Mg==&amp;mid=2247485287&amp;idx=1&amp;sn=f387e61cc60d5bd8212f73fdd593161b&amp;chksm=c1f6841ef6810d08a4b8f47dad0aa5382be529145d5dcf978c11a41367733b202ac6efcce2c9&amp;scene=178&amp;cur_album_id=1773408485754339330#rd</a></p>
</blockquote>

      <blockquote class="mdui-m-t-5">
        
          <strong>本文遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">CC BY-NC-SA 4.0</a> 许可协议，转载请附上原文出处链接和本声明。</strong><br>
        
        <strong>本文链接：</strong><a href="https://yellowbp.github.io/2021/10/07/授权权限/">https://yellowbp.github.io/2021/10/07/授权权限/</a>
      </blockquote>
      
    </div>
    <footer class="mdui-card-actions">
      
        <a class="mdui-ripple article_categories-link" href="/categories/认证授权/">认证授权</a>
      
      
        <a class="mdui-ripple article_tags-link" href="/tags/Spring/">Spring</a>
      
    </footer>
    
  </article>
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script>$("#main article .mdui-card-content img.fancybox").on("click",function(e){$.fancybox.open({src:$(this).attr("src")});});</script>


  <nav id="paginator">
    
      <a rel="prev" class="extend prev" href="/2021/10/07/java代码优化小技巧/">
        <button aria-label="prev" class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_back</i></button>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上一篇
      </a>
    
    <div class="spacer"></div>
    
      <a rel="next" class="extend next" href="/2021/10/06/登录认证/">
        下一篇&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <button aria-label="next" class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_forward</i></button>
      </a>
    
  </nav>


  <div id="comment" class="mdui-m-t-5">
    <style>#pop_ad,#feedAv{display:none!important;position:absolute!important;z-index:-9999;left:-1000px;opacity:0!important}</style>
<div id="SOHUCS" sid="ckzr2vaod008aoktwqa56v4ek"></div>
<script type="text/javascript">
(function(){
var appid = 'cyubhC2Dq';
var conf = 'prod_e4cce65003c5bed049fefcb8a6f09e12';
var width = window.innerWidth || document.documentElement.clientWidth;
if (width < 960) {
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="http://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("http://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>
  </div>



  <div style="position: fixed !important; right: 16px; top: 30%;">
    <button class="mdui-fab mdui-fab-mini mdui-ripple" mdui-menu="{target: '#toc'}"><i class="mdui-icon material-icons">format_list_numbered</i></button>
    <ul class="mdui-menu" id="toc">
      <li class="mdui-menu-item" disabled><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#权限授权"><span class="toc-number">1.</span> <span class="toc-text">权限授权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#前言"><span class="toc-number">1.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#基础知识"><span class="toc-number">1.2.</span> <span class="toc-text">基础知识</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实现"><span class="toc-number">1.3.</span> <span class="toc-text">实现</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#页面权限（菜单级）"><span class="toc-number">1.3.1.</span> <span class="toc-text">页面权限（菜单级）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#权限核心"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">权限核心</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ACL模型"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">ACL模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#RBAC模型"><span class="toc-number">1.3.1.3.</span> <span class="toc-text">RBAC模型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#操作权限"><span class="toc-number">1.3.2.</span> <span class="toc-text">操作权限</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#基本实现"><span class="toc-number">1.3.2.1.</span> <span class="toc-text">基本实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#接口扫描"><span class="toc-number">1.3.3.</span> <span class="toc-text">接口扫描</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#拦截器"><span class="toc-number">1.3.3.1.</span> <span class="toc-text">拦截器</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数据权限"><span class="toc-number">1.3.4.</span> <span class="toc-text">数据权限</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#硬编码"><span class="toc-number">1.3.4.1.</span> <span class="toc-text">硬编码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Mybatis拦截插件"><span class="toc-number">1.3.4.2.</span> <span class="toc-text">Mybatis拦截插件</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#总结"><span class="toc-number">2.</span> <span class="toc-text">总结</span></a></li></ol></li>
    </ul>
  </div>
</main>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<footer id="footer" class="mdui-m-t-5 mdui-p-y-3 mdui-color-theme">
  <div class="mdui-p-y-0 mdui-text-center">
    
    
    
    
    
    
    
      <a href="https://github.com/yellowbp" target="_blank"><i class="mdui-p-a-1 mdui-icon iconfont mdui-text-color-theme-a100">&#xe7ab;</i></a>
    
    
    
    
    
      <a href="tencent://message/?uin=1432440963&Menu=yes" target="_blank"><i class="mdui-p-a-1 mdui-icon iconfont mdui-text-color-theme-a100">&#xe651;</i></a>
    
    
  </div>
  <div class="mdui-p-y-1 mdui-text-center">
    Copyright &copy; 2019 - 2022 hbp<br>
    Powered by <a href="https://hexo.io/" target="_blank" class="mdui-text-color-theme-accent">Hexo</a>hbp All rights reserved.
    
    <br>
    <span id="busuanzi_container_site_uv">
    本网站总访问量<span id="busuanzi_value_site_uv"></span>次
    </span>
  </div>
</footer>
  <button id="gotop" class="mdui-fab mdui-fab-fixed mdui-fab-hide mdui-ripple mdui-color-theme-accent"><i class="mdui-icon material-icons">arrow_upward</i></button>
  <script async src="http://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <script src="/js/mdui.js"></script>
<script src="/js/script.js"></script>
</body>
</html>