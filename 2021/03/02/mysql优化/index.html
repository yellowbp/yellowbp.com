<!DOCTYPE html>
<html lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
  <meta name="renderer" content="webkit">

  
  <title>mysql优化 | bp的Blog</title>

  <link rel="shortcut icon" href="/images/favicon.png">
  
  <meta name="description" content="Mysql高级Mysql逻辑架构介绍 mysql四层架构 连接层：最上层是一些客户端和连接服务，包含本地sock通信和大多数基于客户端/服务端工具实现的类似于tcp/ip的通信。主要完成一些类似于连接处理、授权认证、及相关的安全方案。在该层上引入了线程池的概念，为通过认证安全接入的客户端提供线程。同样在该层上可以实现基于SSL的安全链接。服务器也会为安全接入的每个客户端验证它所具有的操作权限。">
<meta name="keywords" content="mysql">
<meta property="og:type" content="article">
<meta property="og:title" content="mysql优化">
<meta property="og:url" content="https://yellowbp.github.io/2021/03/02/mysql优化/index.html">
<meta property="og:site_name" content="bp的Blog">
<meta property="og:description" content="Mysql高级Mysql逻辑架构介绍 mysql四层架构 连接层：最上层是一些客户端和连接服务，包含本地sock通信和大多数基于客户端/服务端工具实现的类似于tcp/ip的通信。主要完成一些类似于连接处理、授权认证、及相关的安全方案。在该层上引入了线程池的概念，为通过认证安全接入的客户端提供线程。同样在该层上可以实现基于SSL的安全链接。服务器也会为安全接入的每个客户端验证它所具有的操作权限。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/mysql%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84.png">
<meta property="og:image" content="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/sql%E6%9C%BA%E8%AF%BB%E9%A1%BA%E5%BA%8F.png">
<meta property="og:image" content="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/join%E7%9A%847%E7%A7%8D%E8%BF%9E%E6%8E%A5.jpg">
<meta property="og:image" content="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/explain%E5%88%86%E6%9E%90.png">
<meta property="og:image" content="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/id%E7%9B%B8%E5%90%8C.png">
<meta property="og:image" content="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/id%E4%B8%8D%E5%90%8C.png">
<meta property="og:image" content="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/id%E7%9B%B8%E5%90%8C%E4%B8%8D%E5%90%8C.png">
<meta property="og:image" content="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/const.png">
<meta property="og:image" content="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/eq_ref.png">
<meta property="og:image" content="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/ref.png">
<meta property="og:image" content="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/key_len.png">
<meta property="og:image" content="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/reff.png">
<meta property="og:image" content="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/rows.png">
<meta property="og:image" content="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/using%20filesort.png">
<meta property="og:image" content="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/using%20temporary.png">
<meta property="og:image" content="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/%E5%8D%95%E8%A1%A8%E5%88%9D%E6%AC%A1%E5%88%86%E6%9E%90.png">
<meta property="og:image" content="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/%E5%88%9D%E6%AC%A1%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95.png">
<meta property="og:image" content="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/%E5%86%8D%E6%AC%A1%E5%88%86%E6%9E%90sql.png">
<meta property="og:updated_time" content="2021-07-20T02:33:04.719Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="mysql优化">
<meta name="twitter:description" content="Mysql高级Mysql逻辑架构介绍 mysql四层架构 连接层：最上层是一些客户端和连接服务，包含本地sock通信和大多数基于客户端/服务端工具实现的类似于tcp/ip的通信。主要完成一些类似于连接处理、授权认证、及相关的安全方案。在该层上引入了线程池的概念，为通过认证安全接入的客户端提供线程。同样在该层上可以实现基于SSL的安全链接。服务器也会为安全接入的每个客户端验证它所具有的操作权限。">
<meta name="twitter:image" content="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/mysql%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84.png">

  <meta name="format-detection" content="telephone=no,email=no">
  <meta name="theme-color" content="#9C27B0">
  <meta name="description" content>
  <meta name="keywords" content=",mysql">

  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="bp的Blog">
  <meta name="msapplication-starturl" content="https://yellowbp.github.io/2021/03/02/mysql优化/">
  <meta name="msapplication-navbutton-color" content="#9C27B0">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-title" content="bp的Blog">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/images/favicon.png">

  
    <meta property="article:published_time" content="Tue Mar 02 2021 10:52:52 GMT+0800">
    <meta property="article:modified_time" content="Tue Jul 20 2021 10:33:04 GMT+0800">
  

  
    <link rel="canonical" href="https://yellowbp.github.io/2021/03/02/mysql优化/">
  

  <meta name="google-site-verification" content="fXjtlIfaDc_X-0P11rO3bEp1Nk4IKXphoJv0GqGZCco">
  <meta name="baidu-site-verification" content="I3t1wfwZvd">

  <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create','UA-139531378-1','auto');ga('send','pageview');
</script>
  <script>
  var _hmt = _hmt || [];
  (function() {var hm = document.createElement('script');
  hm.src = 'https://hm.baidu.com/hm.js?1054d51c0b66f1d168829173682c8159';
  var s = document.getElementsByTagName('script')[0];
  s.parentNode.insertBefore(hm, s);
  })();
</script>
  

  <link rel="stylesheet" href="/css/mdui.css">
<link rel="stylesheet" href="/css/style.css">
</head>
<body class="mdui-appbar-with-toolbar mdui-drawer-body-left mdui-theme-primary-brown mdui-theme-accent-blue">
  <script>var a=localStorage.getItem("mdui-theme-layout-dark");if(a){document.getElementsByTagName("body")[0].className+=" mdui-theme-layout-dark"};</script>
  <header id="header" class="mdui-appbar mdui-appbar-fixed mdui-appbar-scroll-hide mdui-appbar-inset">
  <div class="mdui-toolbar mdui-color-theme">
    <a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-drawer="{target: '#sidebar', swipe: true}"><i class="mdui-icon material-icons">menu</i></a>
    <a href="/" class="mdui-typo-headline">bp的Blog</a>
    <div class="mdui-toolbar-spacer"></div>
    <a href="javascript:;" class="mdui-btn mdui-btn-icon" mdui-dialog="{target: '#search'}" mdui-tooltip="{content: '搜索'}"><i class="mdui-icon material-icons">search</i></a>
    
  </div>
</header>
<div class="mdui-dialog" id="search">
  
    <div class="search-form">
      <input type="search" class="search-form-input" placeholder="请输入关键字">
    </div>
    <div class="search-result" data-resource="/search.xml"></div>
  
</div>
  <aside id="sidebar" class="mdui-drawer mdui-drawer-full-height">
  <div class="mdui-grid-tile">
    <img src="/images/Gradient1.jpg" style="height: 160px;">
    <img src="/images/headPic.jpg" class="avatar-animation" style="position: absolute; top: 10%; left: 24px; width: 64px; height: 64px; border: 2px solid #fff; border-radius: 50%;">
    <div class="mdui-grid-tile-actions">
      <div class="mdui-grid-tile-text">
        <div class="mdui-grid-tile-title">hbp
        </div>
        <div class="mdui-grid-tile-subtitle"><i class="mdui-icon material-icons">art_track</i>要想快，先会慢</div>
      </div>
      
        <div class="mdui-grid-tile-buttons">
          <a href="mailto:347070556@qq.com" class="mdui-btn mdui-btn-icon" mdui-tooltip="{content: '347070556@qq.com'}"><i class="mdui-icon material-icons">email</i></a>
        </div>
      
    </div>
  </div>

  <div class="mdui-list" mdui-collapse="{accordion: true}">
    <a href="/" class="mdui-list-item mdui-ripple">
      <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-blue">home</i>
      <div class="mdui-list-item-content">主页</div>
    </a>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-deep-orange">inbox</i>
        <div class="mdui-list-item-content">归档</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/archives/2021/07/">七月 2021<span class="mdui-ripple sidebar_archives-count">13</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/06/">六月 2021<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/05/">五月 2021<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/04/">四月 2021<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/03/">三月 2021<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/02/">二月 2021<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2021/01/">一月 2021<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2020/03/">三月 2020<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/12/">十二月 2019<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/11/">十一月 2019<span class="mdui-ripple sidebar_archives-count">5</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/10/">十月 2019<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/09/">九月 2019<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/archives/2019/08/">八月 2019<span class="mdui-ripple sidebar_archives-count">6</span></a>
        
      </div>
    </div>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-green">chrome_reader_mode</i>
        <div class="mdui-list-item-content">分类</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/categories/Spring/">Spring<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/Spring-Cloud-Alibaba/">Spring Cloud Alibaba<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/docker/">docker<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/git/">git<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/java基础/">java基础<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/linux/">linux<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/mybatis/">mybatis<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/redis/">redis<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/servlet/">servlet<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/基础/">基础<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/安全框架/">安全框架<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/工具类/">工具类<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/技术/">技术<span class="mdui-ripple sidebar_archives-count">24</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/搭建/">搭建<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/数据库/">数据库<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/服务器/">服务器<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/测试/">测试<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/电脑硬件/">电脑硬件<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/规范/">规范<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/部署/">部署<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/categories/重装/">重装<span class="mdui-ripple sidebar_archives-count">1</span></a>
        
      </div>
    </div>
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-brown">bookmark</i>
        <div class="mdui-list-item-content">标签</div>
        <i class="mdui-collapse-item-arrow mdui-icon material-icons">keyboard_arrow_down</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        <a class="mdui-ripple sidebar_archives-link" href="/tags/Spring/">Spring<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/algorithm/">algorithm<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/excel/">excel<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/git/">git<span class="mdui-ripple sidebar_archives-count">8</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/hexo/">hexo<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/javaWeb/">javaWeb<span class="mdui-ripple sidebar_archives-count">7</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/java基础/">java基础<span class="mdui-ripple sidebar_archives-count">3</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/linux/">linux<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/mysql/">mysql<span class="mdui-ripple sidebar_archives-count">4</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/nginx/">nginx<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/redis/">redis<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/servlet/">servlet<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/spring/">spring<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/win7/">win7<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/其他/">其他<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/分布式/">分布式<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/接口文档/">接口文档<span class="mdui-ripple sidebar_archives-count">2</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/笔记本选购/">笔记本选购<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/自动化构建工具/">自动化构建工具<span class="mdui-ripple sidebar_archives-count">1</span></a><a class="mdui-ripple sidebar_archives-link" href="/tags/设计模式/">设计模式<span class="mdui-ripple sidebar_archives-count">1</span></a>
        
      </div>
    </div>
    <a href="/about" class="mdui-list-item mdui-ripple">
      <i class="mdui-list-item-icon mdui-icon material-icons mdui-text-color-purple">person</i>
      <div class="mdui-list-item-content">关于</div>
    </a>
  </div>

  <div class="mdui-divider"></div>

  <div class="mdui-list" mdui-collapse="{accordion: true}">
    
    <div class="mdui-collapse-item">
      <div class="mdui-collapse-item-header mdui-list-item mdui-ripple">
        <div class="mdui-list-item-content">友情链接</div>
        <i class="mdui-list-item-icon mdui-icon material-icons">link</i>
      </div>
      <div class="mdui-collapse-item-body mdui-list mdui-list-dense">
        
        
          <a href="javascript:;" class="mdui-list-item mdui-ripple mdui-p-l-2 mdui-text-color-theme" style="justify-content: center;">链接为空</a>
        
      </div>
    </div>
  </div>
</aside>
  <main id="main" class="mdui-m-t-5 fadeIn animated">
  <link rel="stylesheet" href="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.css">
  <style>#main article .mdui-card-content .center-block{display:block!important;margin-right:auto!important;margin-left:auto!important}</style>
  <article class="mdui-card mdui-m-b-5">
    <header class="mdui-card-media">
      <img src="/images/random/material-18.png" style="max-height: 240px;">
      <div class="mdui-card-media-covered">
        <div class="mdui-card-primary">
          <div class="mdui-card-primary-title">mysql优化</div>
          <div class="mdui-card-primary-subtitle"><i class="iconfont">&#xe697;</i> 2021-03-02 / 
          <i class="iconfont">&#xe601;</i> hbp
          <span id="busuanzi_container_page_pv">
            本文总阅读量<span id="busuanzi_value_page_pv"></span>次
          </span>
          </div>
        </div>
      </div>
      <div class="mdui-card-menu">
        
        
      </div>
    </header>
    <div class="mdui-card-content mdui-typo">
      <h1 id="Mysql高级"><a href="#Mysql高级" class="headerlink" title="Mysql高级"></a>Mysql高级</h1><h2 id="Mysql逻辑架构介绍"><a href="#Mysql逻辑架构介绍" class="headerlink" title="Mysql逻辑架构介绍"></a>Mysql逻辑架构介绍</h2><p><img src="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/mysql%E5%88%86%E5%B1%82%E6%9E%B6%E6%9E%84.png" alt></p>
<h3 id="mysql四层架构"><a href="#mysql四层架构" class="headerlink" title="mysql四层架构"></a>mysql四层架构</h3><ol>
<li><p><strong>连接层：</strong>最上层是一些客户端和连接服务，包含本地sock通信和大多数基于客户端/服务端工具实现的类似于tcp/ip的通信。主要完成一些类似于连接处理、授权认证、及相关的安全方案。在该层上引入了线程池的概念，为通过认证安全接入的客户端提供线程。同样在该层上可以实现基于SSL的安全链接。服务器也会为安全接入的每个客户端验证它所具有的操作权限。</p>
</li>
<li><p><strong>服务层：</strong>第二层架构主要完成大多数的核心服务功能，如SQL接口，并完成缓存的查询，SQL的分析和优化及部分内置函数的执行。所有跨存储引擎的功能也在这一层实现，如过程、函数等。在该层，服务器会解析查询并创建相应的内部解析树，并对其完成相应的优化如确定查询表的顺序，是否利用索引等，最后生成相应的执行操作。如果是select语句，服务器还会查询内部的缓存。如果缓存空间足够大，这样在解决大量读操作的环境中能够很好的提升系统的性能。</p>
<table>
<thead>
<tr>
<th>模块</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Management Serveices &amp; Utilities</td>
<td>系统管理和控制工具（备份、容灾恢复、安全、复制、集群..）</td>
</tr>
<tr>
<td>SQL Interface</td>
<td>SQL 接口（DDL、DML、存储过程、视图、触发器..）。 接受用户的 SQL 命令， 并且返回用户需要查询的结果。 比如 select from 就是调用 SQL Interface</td>
</tr>
<tr>
<td>Parser</td>
<td>解析器。 SQL 命令传递到解析器的时候会被解析器验证和解析</td>
</tr>
<tr>
<td>Optimizer</td>
<td>查询优化器。 SQL 语句在查询之前会使用mysql中专门负责优化select语句的优化模块，通过计算分析系统中收集到的统计信息，为客户端请求的 query（sql语句）提供它认为最优的执行计划(由此可见，它认为最优的数据检索方式，不见得是DBA认为最优的)</td>
</tr>
<tr>
<td>Cache &amp; Buffer</td>
<td>查询缓存。 如果查询缓存有命中的查询结果， 查询语句就可以直接去查询缓存中取数据。 这个缓存机制是由一系列小缓存组成的。 比如表缓存， 记录缓存， key 缓存， 权限缓存等</td>
</tr>
</tbody></table>
<p>大致的过程就是：客户端发过来一个请求，SQL Interface来分类出此操作是写操作还是读操作，通过Parser转换以后，把注释去掉，处理成mysql能理解sql之后，再按照Optimizer自己认为最优的方式去运行，比如简单来说就是说你这个sql的查询和加载顺序是 1234，但经过优化之后可能变成了2314，通过这个优化，mysql就会运行自己认为最优的，而不是按照程序员认为最优。言下之意：这一模块块可以’拔’出来，然后换成自己认为最优的方式去运行，比如阿里的mysql就是如此进行优化的。</p>
</li>
<li><p><strong>引擎层：</strong>拔插式的存储引擎，存储引擎真正的负责了MySQL中数据的存储和提取，服务器通过APl与存储引擎进行通信。不同的存储引擎具有的功能不同，这样我们可以根据自己的实际需要进行选取。</p>
</li>
<li><p><strong>存储层：</strong>数据存储层，主要是将数据存储在运行于裸设备的文件系统之上，并完成与存储引擎的交互。</p>
</li>
</ol>
<p>大致运行流程：</p>
<ul>
<li>mysql 客户端通过协议与 mysql 服务器建连接， 发送查询语句， 先检查查询缓存， 如果命中， 直接返回结果，否则进行语句解析,也就是说， 在解析查询之前， 服务器会先访问查询缓存(query cache)——它存储 SELECT 语句以及相应的查询结果集。 如果某个查询结果已经位于缓存中， 服务器就不会再对查询进行解析、 优化、 以及执行。 它仅仅将缓存中的结果返回给用户即可， 这将大大提高系统的性能。</li>
<li>语法解析器和预处理： 首先 mysql 通过关键字将 SQL 语句进行解析， 并生成一颗对应的“解析树”。 mysql 解析器将使用 mysql 语法规则验证和解析查询； 预处理器则根据一些 mysql 规则进一步检查解析数是否合法。</li>
<li>查询优化器首先会对整条Query进行优化，处理掉一些常量表达式的预算，直接换算成常量值。并对Query中的查询条件进行简化和转换，如去掉一些无用或显而易见的条件、结构调整等。然后分析Query中的Hint信息（如果有），看显示Hint信息是否可以完全确定该Query的执行计划。如果没有Hint 或Hint信息还不足以完全确定执行计划，则会读取所涉及对象的统计信息，根据Query进行写相应的计算分析，然后再得出最后的执行计划。</li>
</ul>
<h3 id="mysql存储引擎"><a href="#mysql存储引擎" class="headerlink" title="mysql存储引擎"></a>mysql存储引擎</h3><blockquote>
<p>查看 mysql 支持的存储引擎(默认引擎为InnoDB)</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">show engines</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; mysql&gt; show engines;</span><br><span class="line">+<span class="comment">--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span></span><br><span class="line">| Engine             | Support | <span class="keyword">Comment</span>                                                        | Transactions | XA   | Savepoints |</span><br><span class="line">+<span class="comment">--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span></span><br><span class="line">| <span class="keyword">InnoDB</span>             | <span class="keyword">DEFAULT</span> | Supports transactions, <span class="keyword">row</span>-<span class="keyword">level</span> locking, <span class="keyword">and</span> <span class="keyword">foreign</span> <span class="keyword">keys</span>     | YES          | YES  | YES        |</span><br><span class="line">| MRG_MYISAM         | YES     | Collection <span class="keyword">of</span> identical MyISAM <span class="keyword">tables</span>                          | <span class="keyword">NO</span>           | <span class="keyword">NO</span>   | <span class="keyword">NO</span>         |</span><br><span class="line">| <span class="keyword">MEMORY</span>             | YES     | <span class="keyword">Hash</span> based, <span class="keyword">stored</span> <span class="keyword">in</span> <span class="keyword">memory</span>, useful <span class="keyword">for</span> <span class="keyword">temporary</span> <span class="keyword">tables</span>      | <span class="keyword">NO</span>           | <span class="keyword">NO</span>   | <span class="keyword">NO</span>         |</span><br><span class="line">| BLACKHOLE          | YES     | /dev/<span class="literal">null</span> <span class="keyword">storage</span> <span class="keyword">engine</span> (anything you write <span class="keyword">to</span> it disappears) | <span class="keyword">NO</span>           | <span class="keyword">NO</span>   | <span class="keyword">NO</span>         |</span><br><span class="line">| MyISAM             | YES     | MyISAM <span class="keyword">storage</span> <span class="keyword">engine</span>                                          | <span class="keyword">NO</span>           | <span class="keyword">NO</span>   | <span class="keyword">NO</span>         |</span><br><span class="line">| CSV                | YES     | CSV <span class="keyword">storage</span> <span class="keyword">engine</span>                                             | <span class="keyword">NO</span>           | <span class="keyword">NO</span>   | <span class="keyword">NO</span>         |</span><br><span class="line">| <span class="keyword">ARCHIVE</span>            | YES     | <span class="keyword">Archive</span> <span class="keyword">storage</span> <span class="keyword">engine</span>                                         | <span class="keyword">NO</span>           | <span class="keyword">NO</span>   | <span class="keyword">NO</span>         |</span><br><span class="line">| PERFORMANCE_SCHEMA | YES     | <span class="keyword">Performance</span> <span class="keyword">Schema</span>                                             | <span class="keyword">NO</span>           | <span class="keyword">NO</span>   | <span class="keyword">NO</span>         |</span><br><span class="line">| FEDERATED          | <span class="keyword">NO</span>      | Federated MySQL <span class="keyword">storage</span> <span class="keyword">engine</span>                                 | <span class="literal">NULL</span>         | <span class="literal">NULL</span> | <span class="literal">NULL</span>       |</span><br><span class="line">+<span class="comment">--------------------+---------+----------------------------------------------------------------+--------------+------+------------+</span></span><br><span class="line"><span class="number">9</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p><strong>MyISAM和InnoDB引擎的比较</strong></p>
<table>
<thead>
<tr>
<th>对比项</th>
<th>MyISAM</th>
<th>InnoDB</th>
</tr>
</thead>
<tbody><tr>
<td>主外键</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>事务</td>
<td>不支持</td>
<td>支持</td>
</tr>
<tr>
<td>行表锁</td>
<td>表锁，即使操作一条记录也会锁住整个表，不适合高并发的操作</td>
<td>行锁，操作时只锁某一行，不对其他行有影响，适合高并发操作</td>
</tr>
<tr>
<td>缓存</td>
<td>只缓存索引，不缓存真实数据</td>
<td>不仅缓存索引还要缓存真实数据，对内存要求较高，而且内存大小对性能有决定性的影响</td>
</tr>
<tr>
<td>表空间</td>
<td>小</td>
<td>大</td>
</tr>
<tr>
<td>关注点</td>
<td>性能</td>
<td>事务</td>
</tr>
<tr>
<td>## 索引优化分析</td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="性能下降、SQL慢、执行时间长、等待时间长的原因分析"><a href="#性能下降、SQL慢、执行时间长、等待时间长的原因分析" class="headerlink" title="性能下降、SQL慢、执行时间长、等待时间长的原因分析"></a>性能下降、SQL慢、执行时间长、等待时间长的原因分析</h3><ol>
<li>查询语句写的烂</li>
<li>索引失效<ol>
<li>单值索引：在表中给一个属性建索引 <ul>
<li>比如给user表中的name属性建个索引：create index idx_user_name on user(name)</li>
</ul>
</li>
<li>复合索引：在表中给多个属性建索引<ul>
<li>比如给user表中的name、phone属性建索引：create index idx_user_namePhone on user(name,phone)</li>
</ul>
</li>
</ol>
</li>
<li>关联查询太多join（设计缺陷或不得已的需求）</li>
<li>服务器调优及各个参数设置（缓冲、线程数）</li>
</ol>
<h3 id="常见的JOIN查询"><a href="#常见的JOIN查询" class="headerlink" title="常见的JOIN查询"></a>常见的JOIN查询</h3><h4 id="SQL执行顺序"><a href="#SQL执行顺序" class="headerlink" title="SQL执行顺序"></a>SQL执行顺序</h4><ul>
<li><p>手写的顺序（从上至下）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">distinct</span></span><br><span class="line">	&lt;select_list&gt;</span><br><span class="line"><span class="keyword">from</span> </span><br><span class="line">	&lt;left_table&gt;&lt;join_type&gt;</span><br><span class="line"><span class="keyword">join</span> &lt;right_table&gt; <span class="keyword">on</span> &lt;join_condition&gt;</span><br><span class="line"><span class="keyword">where</span> </span><br><span class="line">	&lt;where_condition&gt;</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">	&lt;group_by_list&gt;</span><br><span class="line"><span class="keyword">having</span> </span><br><span class="line">	&lt;having_condition&gt;</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> </span><br><span class="line">	&lt;order_by_condition&gt;</span><br><span class="line"><span class="keyword">limit</span> &lt;limit_number&gt;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>机读顺序</p>
<p><img src="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/sql%E6%9C%BA%E8%AF%BB%E9%A1%BA%E5%BA%8F.png" alt></p>
</li>
</ul>
<h4 id="JOIN理论图"><a href="#JOIN理论图" class="headerlink" title="JOIN理论图"></a>JOIN理论图</h4><p><img src="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/join%E7%9A%847%E7%A7%8D%E8%BF%9E%E6%8E%A5.jpg" alt></p>
<h3 id="索引简介"><a href="#索引简介" class="headerlink" title="索引简介"></a>索引简介</h3><h4 id="索引是什么"><a href="#索引是什么" class="headerlink" title="索引是什么"></a>索引是什么</h4><ol>
<li><p>MySQL官方对索引的定义为：索引(Index)是帮助MySQL高效获取数据的数据结构。即索引的本质：<strong>索引是数据结构</strong></p>
<p>在数据之外，数据库系统还维护着满足特定查找算法的数据结构，这些数据结构<strong>以某种方式引用（指向）数据</strong>，这样就可以在这些数据结构上实现高级查找算法。这种数据结构，就是索引。</p>
</li>
<li><p>简单理解为”<strong>排好序的能快速查找的数据结构</strong>“，即<strong>索引=排序+查找</strong></p>
<p>索引的目的在于提高查询效率，可以类比字典。比如如果要查询“mysql”这个单词，用了索引的话，我们肯定需要先定位到m字母，然后从下往上找到y字母，再找到剩下的sql。而如果没有索引，那么你可能需要a–z这样遍历的搜索。</p>
</li>
<li><p>一般来说索引本身占用内存空间也很大，不可能全部存储在内存中，因此<strong>索引往往以文件形式存储在硬盘上</strong></p>
</li>
<li><p>我们平时所说的索引，如果没有特别指明，都是指B树(多路搜索树，并不一定是二叉树)结构组织的索引。</p>
</li>
<li><p>聚集索引，次要索引，覆盖索引，复合索引，前缀索引，唯一索引默认都是使用B+树索引，统称索引。当然，除了B+树这种类型的索引之外，还有哈希索引(hash index)等</p>
</li>
</ol>
<h4 id="索引的优劣势"><a href="#索引的优劣势" class="headerlink" title="索引的优劣势"></a>索引的优劣势</h4><blockquote>
<p>优势</p>
</blockquote>
<ol>
<li>类似大学图书馆的书目索引，提高数据检索效率，降低数据库的IO成本</li>
<li>通过索引列对数据进行排序，降低数据排序成本，降低了CPU的消耗</li>
</ol>
<blockquote>
<p>劣势</p>
</blockquote>
<ol>
<li>实际上索引也是一张表，该表保存了主键和索引字段，并指向实体表的记录，所以索引列也是要占用空间的</li>
<li>虽然索引大大提高了查询速度，同时却会降低更新表的速度，如果对表insert，update和delete。因为更新表时，MySQL不仅要不存数据，还要保存一下索引文件每次更新添加了索引列的字段，都会调整因为更新所带来的键值变化后的索引信息</li>
<li>索引只是提高效率的一个因素，如果你的MySQL有大数据量的表，就需要花时间研究建立优秀的索引，或优化查询语句</li>
</ol>
<h3 id="mysql索引分类"><a href="#mysql索引分类" class="headerlink" title="mysql索引分类"></a>mysql索引分类</h3><ol>
<li>单值索引：是最基本的索引，它没有任何限制，即一个索引只包含单个列，一个表可以有多个单列索引；建议一张表索引不要超过5个，优先考虑复合索引</li>
<li>唯一索引：与前面的单值索引类似，不同的就是：索引列的值必须唯一，但允许有空值，如主键索引。如果是组合索引，则列值的组合必须唯一</li>
<li>复合索引：指一个索引包含多个字段，只有在查询条件中使用了创建索引时的<strong>第一个字段</strong>，索引才会被使用。使用组合索引时遵循最左前缀原则</li>
</ol>
<h3 id="索引基本语法"><a href="#索引基本语法" class="headerlink" title="索引基本语法"></a>索引基本语法</h3><p><strong>创建索引：</strong></p>
<ul>
<li>如果是char和varchar类型，length可以小于字段实际长度；</li>
<li>如果是blob和text类型，必须指定length。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> [<span class="keyword">unique</span>] <span class="keyword">index</span> indexName <span class="keyword">ON</span> tableName(columnname(<span class="keyword">length</span>));</span><br><span class="line"><span class="comment">--或者</span></span><br><span class="line"><span class="keyword">ALTER</span> <span class="keyword">table</span> tableName <span class="keyword">ADD</span> [<span class="keyword">UNIQUE</span>] <span class="keyword">INDEX</span> [indexName] <span class="keyword">ON</span>(columnname(<span class="keyword">length</span>));</span><br></pre></td></tr></table></figure>

<p><strong>删除索引</strong>：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DROP</span> <span class="keyword">INDEX</span> [indexName] <span class="keyword">ON</span> tableName;</span><br></pre></td></tr></table></figure>

<p><strong>查看索引</strong>（\G表示将查询到的横向表格纵向输出，sql结尾不需要加分号，方便阅读）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SHOW</span> <span class="keyword">INDEX</span> <span class="keyword">FROM</span> tableName\G</span><br></pre></td></tr></table></figure>

<p><strong>添加数据表的索引</strong></p>
<p>使用 ALTER 命令，有四种方式：</p>
<ol>
<li>ALTER TABLE tableName ADD PRIMARY KEY(column_list)：该语句添加一个主键，这意味着索引值必须是唯一的，且不能为NULL。</li>
<li>ALTER TABLE tableName ADD UNIQUE index_name(column_list)：这条语句创建索引的值必须是唯一的（除了NULL外，NULL可能会出现多次）。</li>
<li>ALTER TABLE tableName ADD INDEX index_name(column_list)：.添加（单值或复合）索引，索引值可出现多次。</li>
<li>ALTER TABLE tableName ADD FULLTEXT index_name(column_list)：该语句指定了索引为FULLTEXT，用于全文索引。</li>
</ol>
<h3 id="B-Tree搜索过程"><a href="#B-Tree搜索过程" class="headerlink" title="B+Tree搜索过程"></a>B+Tree搜索过程</h3><ol>
<li><p>B+Tree和BTree的区别</p>
<p> B树的关键字和数据记录是放在一起的； B+树的非叶子节点中只有关键字和指向下一个节点的索引， 数据记录只放在叶子节点中。</p>
</li>
<li><p>B+Tree 与 BTree 的查找过程</p>
<ol>
<li>在 B 树中， 越靠近根节点的记录查找时间越快， 只要找到关键字即可确定记录的存在； 而 B+ 树中每个记录的查找时间基本是一样的， 都需要从根节点走到叶子节点， 而且在叶子节点中还要再比较关键字。</li>
<li>从这个角度看 B 树的性能好像要比 B+ 树好， 而在实际应用中却是 B+ 树的性能要好些。 因为 B+ 树的非叶子节点不存放实际的数据，这样每个节点可容纳的关键字个数比 B 树多， 树高比 B 树小， 这样带来的好处是减少磁盘访问次数，即减少IO。</li>
<li>B+树的查询效率更加稳定：由于非终结点并不是最终指向文件内容的结点， 而只是叶子结点中关键字的索引。 所以任何关键字的查找必须走一条从根结点到叶子结点的路。 所有关键字查询的路径长度相同， 导致每一个数据的查询效率相当。 而且 B+树的叶子节点使用指针连接在一起， 方便顺序遍历（范围搜索）， 这也是很多数据库和文件系统使用 B+树的缘故。</li>
</ol>
</li>
<li><p>索引的性能提升</p>
<p>真实的情况是， 3 层的 B+ 树可以表示上百万的数据， 如果上百万的数据查找只需要三次 IO， 性能提高将是巨大的，如果没有索引， 每个数据项都要发生一次 IO， 那么总共需要百万次的 IO， 显然成本非常非常高。</p>
</li>
</ol>
<h3 id="何时需要建索引"><a href="#何时需要建索引" class="headerlink" title="何时需要建索引"></a>何时需要建索引</h3><blockquote>
<p><strong>那些情况适合建索引</strong></p>
</blockquote>
<ol>
<li>主键自动建立唯一索引</li>
<li>频繁作为查询的条件的字段应该创建索引</li>
<li>查询中与其他表关联的字段，外键关系建立索引</li>
<li>单值/组合索引的选择问题（在高并发下倾向创建组合索引）</li>
<li>查询中排序的字段，排序字段若通过索引去访问将大大提高排序的速度</li>
<li>查询中统计或者分组字段</li>
</ol>
<blockquote>
<p><strong>那些情况不要建索引</strong></p>
</blockquote>
<ol>
<li>表记录数据太少</li>
<li>Where 条件里用不到的字段不创建索引</li>
<li><strong>经常增删改的表</strong></li>
<li><strong>数据重复且分布平均的表字段</strong>，因此应该只为经常查询和经常排序的数据列建立索引。注意，如果某个数据列包含许多重复的内容，为它建立索引就没有太大的实际效果。</li>
</ol>
<h3 id="性能分析"><a href="#性能分析" class="headerlink" title="性能分析"></a>性能分析</h3><h4 id="mysql常见瓶颈"><a href="#mysql常见瓶颈" class="headerlink" title="mysql常见瓶颈"></a>mysql常见瓶颈</h4><ol>
<li>CPU 瓶颈：CPU在饱和的时候一般发生在数据装入在内存或从磁盘上读取数据时候</li>
<li>IO 瓶颈：磁盘I/O瓶颈发生在装入数据远大于内存容量时</li>
<li>服务器硬件的性能瓶颈：top、free、iostat和vmstat来查看系统的性能状态</li>
</ol>
<h4 id="Explain概述"><a href="#Explain概述" class="headerlink" title="Explain概述"></a>Explain概述</h4><ol>
<li><p><strong>Explain是什么</strong></p>
<p>使用EXPLAIN关键字可以模拟优化器执行SQL语句，从而知道MySQL是如何处理你的SQL语句的。分析你的查询语句或是结构的性能瓶颈</p>
</li>
<li><p><strong>Explain能做什么</strong></p>
<ol>
<li>表的读取顺序（id 字段）</li>
<li>数据读取操作的操作类型（select_type 字段）</li>
<li>哪些索引理论上可以使用（possible_keys 字段）</li>
<li>哪些索引被实际使用（keys 字段）</li>
<li>表之间的引用（ref 字段）</li>
<li>每张表有多少行被优化器查询（rows 字段）</li>
</ol>
</li>
<li><p><strong>Explain怎么用？</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> + <span class="keyword">sql</span>语句</span><br></pre></td></tr></table></figure>

<p><img src="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/explain%E5%88%86%E6%9E%90.png" alt></p>
</li>
<li><p><strong>Explain详细说明</strong></p>
<blockquote>
<p>id：<strong>select查询的序列号，包含一组数字，表示查询中执行select子句或操作表的顺序</strong></p>
</blockquote>
<p>id的取值有3种情况：</p>
<ol>
<li><p>id相同，表示执行顺序由上至下</p>
<p><img src="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/id%E7%9B%B8%E5%90%8C.png" alt></p>
<p>即此表中mysql执行的顺序是t1 t3 t2，并不是我们理解的t1 t2 t3</p>
</li>
<li><p>id不同，表示如果是子查询，id的序号会递增，<strong>id值越大优先级越高，越先被执行</strong></p>
<p><img src="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/id%E4%B8%8D%E5%90%8C.png" alt></p>
<p>即此表中mysql执行的顺序是t3 t1 t2   primary表示最外层查询，subquery表示子查询</p>
</li>
<li><p>id相同不同。id如果相同，可以认为是一组，从上往下执行。在所有组中，id值越大，优先级越高，越先被执行</p>
<p><img src="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/id%E7%9B%B8%E5%90%8C%E4%B8%8D%E5%90%8C.png" alt></p>
<p>from后面是虚表，并不是真实的表。derived表示衍生的意思。而这里的derived2是指向了id=2那个虚表，即s1。此表中mysql执行的顺序是t3 s1 t2</p>
</li>
</ol>
</li>
</ol>
<blockquote>
<p><strong>select_type：查询的类型，主要用于区别普通查询、联合查询、子查询等复杂查询</strong></p>
</blockquote>
<ol>
<li>SIMPLE：简单的select查询，查询中不包含子查询或者UNION</li>
<li>PRIMARY：查询中若包含任何复杂的子部分，最外层查询则被标记为PRIMARY</li>
<li>SUBQUERY：在SELECT或者WHERE列表中包含了子查询</li>
<li>DERIVED：在FROM列表中包含的子查询被标记为DERIVED（衍生）MySQL会递归执行这些子查询，把结果放在临时表里</li>
<li>UNION：若第二个SELECT出现在UNION之后，则被标记为UNION；若UNION包含在FROM子句的子查询中，外层SELECT将被标记为：DERIVED</li>
<li>UNION RESULT：从UNION表获取结果的SELECT</li>
</ol>
<blockquote>
<p><strong>table：显示这一行的数据是关于哪张表的</strong></p>
</blockquote>
<blockquote>
<p><strong>type：访问类型排列，显示查询使用了何种类型</strong></p>
</blockquote>
<p>type显示的是访问类型，是较为重要的一个指标，<strong>结果值从最好到最坏依次一般是</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">system&gt;const&gt;eq_ref&gt;ref&gt;range&gt;index&gt;ALL</span><br></pre></td></tr></table></figure>

<p><strong>一般来说，得保证查询至少达到range级别，最好能达到ref</strong>。而对于All来说，一般达到百万级别的才需要优化，没百万级别的，mysql优化得还是很好的。</p>
<hr>
<ol>
<li><p>system：表只有一行记录（等于系统表），这是const类型的特例，一般这种表跟业务没关系，平时不会出现，这个也可以忽略不计。</p>
</li>
<li><p>const：表示通过索引一次就找到了，const用于比较primary key或者unique索引。因为只匹配一行数据，所以很快。如将主键置于where列表中，MySQL就能将该查询转换为一个常量</p>
<p><img src="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/const.png" alt></p>
</li>
<li><p>eq_ref：唯一性索引，对于<code>每个索引键</code>，表中只有一条记录与之匹配，常见于主键或唯一索引扫描</p>
<p><img src="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/eq_ref.png" alt></p>
<p>【eq_ref与const的区别】：</p>
<ul>
<li>const是直接按主键或唯一键读取，而<code>eq_ref</code>用于联表查询的情况，按联表的主键或唯一键联合查询。</li>
<li>eq_ref通过主表的主键在从表中匹配后有唯一对应(一对一)。即eq_ref是可能有多条记录，但是A表的外键对应B表中只有一条记录</li>
<li>const只有一条记录</li>
</ul>
</li>
<li><p>ref：非唯一索引扫描，返回匹配某个单独值的所有行(一对多)。本质上也是一种索引访问，它返回所有匹配某个单独值的行，然而，它可能会找到多个符合条件的行，所以他应该属于查找和扫描的混合体</p>
<p><img src="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/ref.png" alt></p>
</li>
<li><p>range：只检索给定范围的行，使用一个索引来选择行。key列显示使用了哪个索引一般就是在你的where语句中出现了<code>between</code>、<code>&lt;</code>、<code>&gt;</code>、<code>in</code>等的查询这种范围扫描索引扫描比全表扫描要好，因为他只需要开始索引的某一点，而结束于另一点，不用扫描全部索引</p>
</li>
<li><p>index：Full Index Scan，index与ALL区别为index类型只遍历索引树。这通常比ALL快，因为索引文件通常比数据文件小。（也就是说虽然all和index都是读全表，但index是从索引中读取的（可以少一些io），而all是从硬盘数据库文件中读的）</p>
</li>
<li><p>all：FullTable Scan，将遍历全表以找到匹配的行（全表扫描）</p>
</li>
</ol>
<blockquote>
<p><strong>possible_keys 理论上的索引</strong>  </p>
</blockquote>
<ol>
<li>显示<strong>可能</strong>应用在这张表中的索引，一个或多个</li>
<li>若查询涉及的字段上存在索引，则该索引将被列出，但不一定被查询实际使用</li>
</ol>
<blockquote>
<p><strong>key  实际上的索引</strong> </p>
</blockquote>
<ol>
<li><strong>实际</strong>使用的索引，如果为null，则2种情况<ol>
<li>没有使用索引或者没建索引</li>
<li>建了之后索引失效</li>
</ol>
</li>
<li>若查询中使用了覆盖索引，则该索引仅出现在key列表中</li>
</ol>
<blockquote>
<p><strong>key_len</strong></p>
</blockquote>
<ol>
<li>表示索引中使用的字节数，可通过该列计算查询中使用的索引的长度。在不损失精确性的情况下，长度越短越好</li>
<li>key_len显示的值为索引最大可能长度，并非实际使用长度，即key_len是根据表定义计算而得，不是通过表内检索出的</li>
</ol>
<p><img src="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/key_len.png" alt></p>
<blockquote>
<p><strong>ref</strong></p>
</blockquote>
<p><strong>显示索引哪一列被使用了</strong>，如果可能的话，最好是一个常数。哪些列或常量被用于查找索引列上的值</p>
<p><img src="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/reff.png" alt></p>
<p>由key_len可知t1表的索引idx_col1_col2被充分使用，t1表的col1匹配t2表的col1，t1表的col2匹配了一个常量，即’ac’</p>
<blockquote>
<p><strong>row</strong></p>
</blockquote>
<p>根据表统计信息及索引选用情况，大致估算出找到所需的记录所需要读取的行数</p>
<p><img src="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/rows.png" alt></p>
<blockquote>
<p><strong>Extra：包含不适合在其他列中显示但十分重要的额外信息</strong></p>
</blockquote>
<ol>
<li><p><strong>using filesort（不好）</strong></p>
<p>MySQL中无法利用索引完成排序操作称为“文件排序”，说明mysql会对数据使用一个外部的索引排序，而不是按照表内的索引顺序进行读取。即你建好了索引，所谓的索引就是先排序再查找，可是某种情况下用不上你的索引，或者说使用过程中出现了其他问题，mysql只好把这些数据在内部再排序一次。<strong>需要尽快优化 SQL</strong></p>
<p>比如：</p>
<p><img src="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/using%20filesort.png" alt></p>
<ul>
<li>示例中第一个查询只使用了 col1 和 col3，原有索引派不上用场，所以进行了外部文件排序</li>
<li>示例中第二个查询使用了 col1、col2 和 col3，原有索引派上用场，无需进行文件排序</li>
</ul>
<p><strong>言下之意：排序的时候最好也遵守你所建索引的顺序和个数</strong></p>
</li>
<li><p><strong>using temporary</strong>（不好）</p>
<p>使用了临时表保存中间结果，MySQL在对查询结果排序时使用临时表。常见于排序 order by 和分组查询 group by，<strong>需要立即优化 SQL</strong></p>
<p><img src="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/using%20temporary.png" alt></p>
<ul>
<li>示例中第一个查询只使用了 col1，原有索引派不上用场，所以创建了临时表进行分组</li>
<li>示例中第二个查询使用了 col1、col2，原有索引派上用场，无需创建临时表</li>
<li><strong>言下之意：分组的时候最好也遵守你所建索引的顺序和个数</strong></li>
</ul>
</li>
<li><p><strong>using index</strong>(好)</p>
<p>表示相应的select操作中使用了覆盖索引（Coveing Index），避免访问了表的数据行，效率不错！</p>
<p>如果同时出现using where，表明索引被用来执行索引键值的查找</p>
<p>如果没有同时出现using where，表明索引用来读取数据而非执行查找动作</p>
<p>覆盖索引（Covering Index），select的字段和建索引的字段相同，则只从索引就可以获得数据。也说为索引覆盖：就是select的数据列只用从索引中就能够取得，不必读取数据行，MySQL可以利用索引返回select列表中的字段，而不必根据索引再次读取数据文件，换句话说查询列要被所建的索引覆盖。</p>
<p>注意：如果要使用覆盖索引，一定要注意select列表中只取出需要的列，不可select * </p>
<p>因为如果将所有字段一起做索引会导致索引文件过大，查询性能下降</p>
</li>
<li><p>using where </p>
<p>表明使用了where过滤</p>
</li>
<li><p>using join buffer</p>
<p>表明使用了连接缓存</p>
</li>
<li><p>impossible where</p>
<p>where子句的值总是false，不能用来获取任何元组</p>
</li>
</ol>
<h3 id="索引优化"><a href="#索引优化" class="headerlink" title="索引优化"></a>索引优化</h3><h4 id="单表索引优化"><a href="#单表索引优化" class="headerlink" title="单表索引优化"></a>单表索引优化</h4><p>创建表</p>
<ul>
<li><p>建表sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> article(</span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">not</span> <span class="literal">null</span> primary <span class="keyword">key</span> auto_increment,</span><br><span class="line">	author_id <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">	category_id <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">	views <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">	comments <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">	title <span class="built_in">varchar</span>(<span class="number">225</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">	<span class="keyword">content</span> <span class="built_in">text</span> <span class="keyword">not</span> <span class="literal">null</span> </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> article(author_id,category_id,views,comments,title,<span class="keyword">content</span>)</span><br><span class="line"><span class="keyword">values</span></span><br><span class="line">(<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="string">'java'</span>,<span class="string">'简单'</span>),</span><br><span class="line">(<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="number">2</span>,<span class="string">'mysql'</span>,<span class="string">'很简单'</span>),</span><br><span class="line">(<span class="number">1</span>,<span class="number">1</span>,<span class="number">3</span>,<span class="number">3</span>,<span class="string">'linux'</span>,<span class="string">'超简单'</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>表中的测试数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from article;</span><br><span class="line">+<span class="comment">----+-----------+-------------+-------+----------+-------+---------+</span></span><br><span class="line">| id | author_id | category_id | views | comments | title | content |</span><br><span class="line">+<span class="comment">----+-----------+-------------+-------+----------+-------+---------+</span></span><br><span class="line">|  1 |         1 |           1 |     1 |        1 | java  |         |</span><br><span class="line">|  2 |         2 |           2 |     2 |        2 | mysql |         |</span><br><span class="line">|  3 |         1 |           1 |     3 |        3 | linux |         |</span><br><span class="line">+<span class="comment">----+-----------+-------------+-------+----------+-------+---------+</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>查询案例</strong></p>
<ul>
<li><p>查询category_id为1且comments 大于1的情况下，views最多的article_id</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,author_id  <span class="keyword">from</span> article <span class="keyword">where</span> category_id = <span class="number">1</span> <span class="keyword">and</span> comments &gt; <span class="number">1</span> <span class="keyword">order</span> <span class="keyword">by</span> views <span class="keyword">desc</span> <span class="keyword">limit</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">+<span class="comment">----+-----------+</span></span><br><span class="line">| id | author_id |</span><br><span class="line">+<span class="comment">----+-----------+</span></span><br><span class="line">|  3 |         1 |</span><br><span class="line">+<span class="comment">----+-----------+</span></span><br></pre></td></tr></table></figure>

<p>好，那么现在对错的问题已经解决了，接下来得解决优化的问题（完成-&gt;完美，功能-&gt;性能的道理）</p>
</li>
<li><p>分析sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">explain</span> <span class="keyword">select</span> <span class="keyword">id</span>,author_id  <span class="keyword">from</span> article <span class="keyword">where</span> category_id = <span class="number">1</span> <span class="keyword">and</span> comments &gt; <span class="number">1</span> <span class="keyword">order</span> <span class="keyword">by</span> views <span class="keyword">desc</span> <span class="keyword">limit</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p><img src="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/%E5%8D%95%E8%A1%A8%E5%88%9D%E6%AC%A1%E5%88%86%E6%9E%90.png" alt></p>
<p>很明显：type为all全表扫描即最坏情况、using filesort产生了内部排序。那么此时是没有建立索引的</p>
</li>
<li><p>查看索引</p>
<p><img src="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/%E5%88%9D%E6%AC%A1%E6%9F%A5%E7%9C%8B%E7%B4%A2%E5%BC%95.png" alt></p>
</li>
<li><p>开始优化（一开始并不知道新建的索引好不好对不对之类的，所以我们得慢慢调整）</p>
<ol>
<li><p>新建索引(根据where后面的条件建立索引)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_article_ccv <span class="keyword">on</span> article(category_id,comments,views);</span><br><span class="line">或者</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> article <span class="keyword">add</span> <span class="keyword">index</span> idx_article_ccv(category_id,comments,views)</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; mysql&gt; show index from article;</span><br><span class="line">+<span class="comment">---------+------------+-----------------+--------------+-------------+-----------+</span></span><br><span class="line">| Table   | Non_unique | Key_name        | Seq_in_index | Column_name | Collation |</span><br><span class="line">+<span class="comment">---------+------------+-----------------+--------------+-------------+-----------+</span></span><br><span class="line">| article |          0 | PRIMARY         |            1 | id          | A         |</span><br><span class="line">| article |          1 | idx_article_ccv |            1 | category_id | A         |</span><br><span class="line">| article |          1 | idx_article_ccv |            2 | comments    | A         |</span><br><span class="line">| article |          1 | idx_article_ccv |            3 | views       | A         |</span><br><span class="line">+<span class="comment">---------+------------+-----------------+--------------+-------------+------------</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>再次分析sql</p>
<p><img src="https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/%E5%86%8D%E6%AC%A1%E5%88%86%E6%9E%90sql.png" alt></p>
<p>分析：此索引解决了type为all的问题，但using filesort没解决。但是我们已经建立的索引，但为什么没用呢？这是因为按照BTREE索引的工作原理：先排序category_id，如果遇到相同的category_id则再排序comments，如果遇到相同的comments则再排序views。当comments字段在联合索引里处于中间位置时，因comments&gt;1条件是一个范围值(所谓range)，会导致索引失效，mysql无法利用索引再对后面的views部分进行索引，即range类型查询字段后面的索引无效。相当于中间的梯子没了</p>
</li>
<li><p>删除索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">index</span> idx_article_ccv <span class="keyword">on</span> article;</span><br></pre></td></tr></table></figure>
</li>
<li><p>重新建立索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_article_cv <span class="keyword">on</span> article(category_id,views);</span><br></pre></td></tr></table></figure>


</li>
</ol>
</li>
</ul>
<pre><code>![](https://mysqloptimages.oss-cn-guangzhou.aliyuncs.com/%E5%86%8D%E5%86%8D%E5%88%86%E6%9E%90sql.png)

完美</code></pre><h4 id="两表索引优化"><a href="#两表索引优化" class="headerlink" title="两表索引优化"></a>两表索引优化</h4><p><strong>创建表</strong></p>
<ul>
<li><p>建表sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> <span class="keyword">class</span>(</span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="literal">null</span> primary <span class="keyword">key</span> auto_increment,</span><br><span class="line">card <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> book(</span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="literal">null</span> primary <span class="keyword">key</span> auto_increment,</span><br><span class="line">	card <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="literal">null</span> </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">class</span>(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> book(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>查询案例</strong></p>
<ul>
<li><p>实现两表的连接，连接条件是 class.card = book.card</p>
<p>mysql&gt; select * from class left join book on class.card = book.card;<br>+—-+——+——+——+<br>| id | card | id   | card |<br>+—-+——+——+——+<br>|  8 |    4 |    2 |    4 |<br>|  7 |    8 |    3 |    8 |<br>|  2 |    6 |    4 |    6 |<br>|  5 |    6 |    4 |    6 |<br>|  7 |    8 |    6 |    8 |<br>|  7 |    8 |    7 |    8 |<br>|  1 |    1 |    8 |    1 |<br>|  3 |    2 | NULL | NULL |<br>|  4 |    7 | NULL | NULL |<br>|  6 |    7 | NULL | NULL |<br>+—-+——+——+——+<br>10 rows in set (0.00 sec)</p>
</li>
<li><p>分析sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from class left join book on class.card = book.card;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+</span></span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                                              |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+</span></span><br><span class="line">|  1 | SIMPLE      | class | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    8 |   100.00 | NULL                                               |</span><br><span class="line">|  1 | SIMPLE      | book  | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    8 |   100.00 | Using where; Using join buffer (Block Nested Loop) |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+</span></span><br></pre></td></tr></table></figure>

<p>分析：type有all，说明 class 和 book 进行了全表检索</p>
</li>
<li><p>问题：</p>
<p>我们建立索引是要给class表中的card建立索引还是book表中的card</p>
</li>
<li><p>验证：</p>
<ol>
<li><strong>先给book表建立索引优化</strong></li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> book <span class="keyword">add</span> <span class="keyword">index</span> idx_bcard(card);</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>再次分析sql</strong></li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from class left join book on class.card = book.card;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+-----------+---------+----------------+------+----------+-------------+</span></span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key       | key_len | ref            | rows | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+-----------+---------+----------------+------+----------+-------------+</span></span><br><span class="line">|  1 | SIMPLE      | class | NULL       | ALL  | NULL          | NULL      | NULL    | NULL           |    8 |   100.00 | NULL        |</span><br><span class="line">|  1 | SIMPLE      | book  | NULL       | ref  | idx_bcard     | idx_bcard | 4       | opt.class.card |    1 |   100.00 | Using index |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+-----------+---------+----------------+------+----------+-------------+</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li><p><strong>此次测试结果：可以看到第二行的type变为了ref，rows也变成了优化比较明显。</strong></p>
</li>
<li><p><strong>删除原先索引，给class表建立索引优化</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">index</span> idx_bcard <span class="keyword">on</span> book;</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> <span class="keyword">class</span> <span class="keyword">add</span> <span class="keyword">index</span> idx_ccard(card);</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>分析sql</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from class left join book on class.card = book.card;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+-----------+---------+------+------+----------+----------------------------------------------------+</span></span><br><span class="line">| id | select_type | table | partitions | type  | possible_keys | key       | key_len | ref  | rows | filtered | Extra                                              |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+-----------+---------+------+------+----------+----------------------------------------------------+</span></span><br><span class="line">|  1 | SIMPLE      | class | NULL       | index | NULL          | idx_ccard | 4       | NULL |    8 |   100.00 | Using index                                        |</span><br><span class="line">|  1 | SIMPLE      | book  | NULL       | ALL   | NULL          | NULL      | NULL    | NULL |    8 |   100.00 | Using where; Using join buffer (Block Nested Loop) |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+-----------+---------+------+------+----------+----------------------------------------------------+</span></span><br></pre></td></tr></table></figure>

<p>测试结果：同样的索引，在左连接的情况下，索引加在左表和加载右表的情况是不一样的。</p>
</li>
<li><p><strong>结论</strong></p>
<ol>
<li>左连接相反加，同样右连接也是相反加。即左连接的话给右表加</li>
<li>这是由左连接特性决定的。LEFT JOIN条件用于确定如何从右表搜索行，左边一定都有，所以右边是我们的关键点，一定需要建立索引。</li>
<li>左表连接右表，则需要拿着左表的数据去右表里面查，索引需要在右表中建立索引</li>
</ol>
</li>
</ol>
</li>
</ul>
<h4 id="三表索引优化"><a href="#三表索引优化" class="headerlink" title="三表索引优化"></a>三表索引优化</h4><p><strong>创建表</strong></p>
<ul>
<li><p>建表sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span> phone(</span><br><span class="line">	phoneId <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="literal">null</span> primary <span class="keyword">key</span> auto_increment,</span><br><span class="line">	card <span class="built_in">int</span>(<span class="number">10</span>) <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> phone(card) <span class="keyword">VALUES</span>(<span class="keyword">FLOOR</span>(<span class="number">1</span>+(<span class="keyword">RAND</span>()*<span class="number">8</span>)));</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>查询案例</strong></p>
<ul>
<li><p>实现三表的连接查询</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from class</span><br><span class="line">    -&gt; left join book</span><br><span class="line">    -&gt; on class.card = book.card</span><br><span class="line">    -&gt; left join phone</span><br><span class="line">    -&gt; on book.card=phone.card;</span><br><span class="line">+<span class="comment">----+------+------+------+---------+------+</span></span><br><span class="line">| id | card | id   | card | phoneId | card |</span><br><span class="line">+<span class="comment">----+------+------+------+---------+------+</span></span><br><span class="line">|  1 |    1 |    8 |    1 |       1 |    1 |</span><br><span class="line">|  2 |    6 |    4 |    6 |       7 |    6 |</span><br><span class="line">|  5 |    6 |    4 |    6 |       7 |    6 |</span><br><span class="line">|  1 |    1 |    8 |    1 |       8 |    1 |</span><br><span class="line">|  7 |    8 |    3 |    8 |       9 |    8 |</span><br><span class="line">|  7 |    8 |    6 |    8 |       9 |    8 |</span><br><span class="line">|  7 |    8 |    7 |    8 |       9 |    8 |</span><br><span class="line">|  8 |    4 |    2 |    4 |    NULL | NULL |</span><br><span class="line">|  3 |    2 | NULL | NULL |    NULL | NULL |</span><br><span class="line">|  4 |    7 | NULL | NULL |    NULL | NULL |</span><br><span class="line">|  6 |    7 | NULL | NULL |    NULL | NULL |</span><br><span class="line">+<span class="comment">----+------+------+------+---------+------+</span></span><br><span class="line">11 rows in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>分析sql</p>
<p>先把上面的索引给去掉</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">index</span> <span class="keyword">from</span> <span class="keyword">class</span>;</span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">index</span> idx_ccard <span class="keyword">on</span> <span class="keyword">class</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from class left join book on class.card = book.card left join phone on book.card=phone.card;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+</span></span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra                                              |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+</span></span><br><span class="line">|  1 | SIMPLE      | class | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    8 |   100.00 | NULL                                               |</span><br><span class="line">|  1 | SIMPLE      | book  | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    8 |   100.00 | Using where; Using join buffer (Block Nested Loop) |</span><br><span class="line">|  1 | SIMPLE      | phone | NULL       | ALL  | NULL          | NULL | NULL    | NULL |   10 |   100.00 | Using where; Using join buffer (Block Nested Loop) |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+----------------------------------------------------+</span></span><br></pre></td></tr></table></figure>

<p>测试结果：type 有All ，rows 为表数据总行数，说明 class、 book 和 phone 表都进行了全表检索Extra 中 Using join buffer ，表明连接过程中使用了 join 缓冲区</p>
</li>
<li><p>索引优化</p>
<ol>
<li><p>相反原则：进行左连接时，永远都在右表的字段上建立索引</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> book <span class="keyword">add</span> <span class="keyword">index</span> idx_bcard(card);</span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> phone <span class="keyword">add</span> <span class="keyword">index</span> idx_pcard(card);</span><br></pre></td></tr></table></figure>
</li>
<li><p>分析sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from class left join book on class.card = book.card left join phone on book.card=phone.card;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+-----------+---------+----------------+------+----------+-------------+</span></span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key       | key_len | ref            | rows | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+-----------+---------+----------------+------+----------+-------------+</span></span><br><span class="line">|  1 | SIMPLE      | class | NULL       | ALL  | NULL          | NULL      | NULL    | NULL           |    8 |   100.00 | NULL        |</span><br><span class="line">|  1 | SIMPLE      | book  | NULL       | ref  | idx_bcard     | idx_bcard | 4       | opt.class.card |    1 |   100.00 | Using index |</span><br><span class="line">|  1 | SIMPLE      | phone | NULL       | ref  | idx_pcard     | idx_pcard | 4       | opt.book.card  |    1 |   100.00 | Using index |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+-----------+---------+----------------+------+----------+-------------+</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>测试结果：后2行的type都是ref且总rows优化很好，效果不错。因此索引设置在需要经常查询的字段中</p>
</li>
</ol>
</li>
</ul>
<blockquote>
<p>Join语句优化的结论</p>
</blockquote>
<p>将 left join 看作是两层嵌套 for 循环</p>
<ol>
<li>尽可能减少Join语句中的嵌套循环的循环总次数；</li>
<li>永远用小结果集驱动大的结果集（在大结果集中建立索引，在小结果集中遍历全表）；</li>
<li>优先优化嵌套循环的内层循环；（因为里面快了外面才能快）</li>
<li>保证Join语句中被驱动表上Join条件字段已经被索引；</li>
<li>当无法保证被驱动表的Join条件字段被索引且内存资源充足的前提下，不要太吝惜JoinBuffer的设置；</li>
</ol>
<h3 id="索引失效-应该避免"><a href="#索引失效-应该避免" class="headerlink" title="索引失效(应该避免)"></a>索引失效(应该避免)</h3><p>索引失效：建了索引，但是没用上</p>
<p><strong>创建表</strong></p>
<ul>
<li><p>建表sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> staffs(</span><br><span class="line">	<span class="keyword">id</span> <span class="built_in">int</span> primary <span class="keyword">key</span> AUTO_INCREMENT,</span><br><span class="line">	<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">24</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">default</span><span class="string">''</span> <span class="keyword">comment</span><span class="string">'姓名'</span>,</span><br><span class="line">	age <span class="built_in">int</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">default</span> <span class="number">0</span> <span class="keyword">comment</span><span class="string">'年龄'</span>,</span><br><span class="line">	pos <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">default</span><span class="string">''</span> <span class="keyword">comment</span><span class="string">'职位'</span>,</span><br><span class="line">	add_time <span class="built_in">timestamp</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">default</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">comment</span><span class="string">'入职时间'</span></span><br><span class="line">)<span class="keyword">CHARSET</span> utf8 <span class="keyword">comment</span><span class="string">'员工记录表'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">INTO</span> staffs(<span class="string">`name`</span>,<span class="string">`age`</span>,<span class="string">`pos`</span>,<span class="string">`add_time`</span>) <span class="keyword">VALUES</span>(<span class="string">'z3'</span>,<span class="number">22</span>,<span class="string">'manager'</span>,<span class="keyword">NOW</span>());</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">INTO</span> staffs(<span class="string">`name`</span>,<span class="string">`age`</span>,<span class="string">`pos`</span>,<span class="string">`add_time`</span>) <span class="keyword">VALUES</span>(<span class="string">'July'</span>,<span class="number">23</span>,<span class="string">'dev'</span>,<span class="keyword">NOW</span>());</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">INTO</span> staffs(<span class="string">`name`</span>,<span class="string">`age`</span>,<span class="string">`pos`</span>,<span class="string">`add_time`</span>) <span class="keyword">VALUES</span>(<span class="string">'2000'</span>,<span class="number">23</span>,<span class="string">'dev'</span>,<span class="keyword">NOW</span>());</span><br><span class="line"></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> staffs <span class="keyword">add</span> <span class="keyword">index</span> index_staffs_nameAgePos(<span class="keyword">name</span>,age,pos);</span><br></pre></td></tr></table></figure>
</li>
<li><p>staffs 表中的测试数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from staffs;</span><br><span class="line">+<span class="comment">----+------+-----+---------+---------------------+</span></span><br><span class="line">| id | name | age | pos     | add_time            |</span><br><span class="line">+<span class="comment">----+------+-----+---------+---------------------+</span></span><br><span class="line">|  1 | z3   |  22 | manager | 2021-03-05 16:47:10 |</span><br><span class="line">|  2 | July |  23 | dev     | 2021-03-05 16:47:10 |</span><br><span class="line">|  3 | 2000 |  23 | dev     | 2021-03-05 16:47:10 |</span><br><span class="line">+<span class="comment">----+------+-----+---------+---------------------+</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p>staffs 表中的复合索引：name、age、pos</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW INDEX FROM staffs;</span><br><span class="line">+<span class="comment">--------+------------+-------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span></span><br><span class="line">| Table  | Non_unique | Key_name                | Seq_in_index | Column_name | Collation | Cardinality | Sub_part | Packed | Null | Index_type | <span class="keyword">Comment</span> | Index_comment |</span><br><span class="line">+<span class="comment">--------+------------+-------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span></span><br><span class="line">| staffs |          <span class="number">0</span> | PRIMARY                 |            <span class="number">1</span> | <span class="keyword">id</span>          | A         |           <span class="number">2</span> |     <span class="literal">NULL</span> | <span class="literal">NULL</span>   |      | BTREE      |         |               |</span><br><span class="line">| staffs |          <span class="number">1</span> | index_staffs_nameAgePos |            <span class="number">1</span> | <span class="keyword">name</span>        | A         |           <span class="number">3</span> |     <span class="literal">NULL</span> | <span class="literal">NULL</span>   |      | BTREE      |         |               |</span><br><span class="line">| staffs |          <span class="number">1</span> | index_staffs_nameAgePos |            <span class="number">2</span> | age         | A         |           <span class="number">3</span> |     <span class="literal">NULL</span> | <span class="literal">NULL</span>   |      | BTREE      |         |               |</span><br><span class="line">| staffs |          <span class="number">1</span> | index_staffs_nameAgePos |            <span class="number">3</span> | pos         | A         |           <span class="number">3</span> |     <span class="literal">NULL</span> | <span class="literal">NULL</span>   |      | BTREE      |         |               |</span><br><span class="line">+<span class="comment">--------+------------+-------------------------+--------------+-------------+-----------+-------------+----------+--------+------+------------+---------+---------------+</span></span><br><span class="line"><span class="number">4</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="索引失效准则"><a href="#索引失效准则" class="headerlink" title="索引失效准则"></a>索引失效准则</h4><ol>
<li>全值匹配我最爱(相当于where后面的字段=某个值，即ref=const的时候，并且顺序没影响，因为mysql底层有优化器)</li>
<li>最佳左前缀法则：如果索引了多例，要遵守最左前缀法则。指的是查询从索引的最左前列开始并且不跳过索引中的列。</li>
<li>不在索引列上做任何操作（计算、函数、（自动or手动）类型转换），会导致索引失效而转向全表扫描</li>
<li>存储引擎不能使用索引中范围条件右边的列</li>
<li>尽量使用覆盖索引（只访问索引的查询（索引列和查询列一致）），减少select *</li>
<li>mysql在使用不等于（!=或者&lt;&gt;）的时候无法使用索引会导致全表扫描</li>
<li>is null，is not null 也无法使用索引（早期版本不能走索引，后续版本应该优化过，可以走索引）</li>
<li>like以通配符开头（’%abc…’）mysql索引失效会变成全表扫描操作</li>
<li>字符串不加单引号索引失效</li>
<li>少用or，用它连接时会索引失效 </li>
</ol>
<blockquote>
<p>最佳左前缀法则：带头大哥不能死，中间兄弟不能断</p>
</blockquote>
<p><strong>如果索引了多列，要遵守最左前缀法则。指的是从索引的最左前列开始并且不跳过索引中间的列</strong></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 只有带头大哥 name 时</span></span><br><span class="line"><span class="comment">--key = index_staffs_nameAgePos 表明索引生效</span></span><br><span class="line"><span class="comment">--ref = const ：这个常量就是查询时的 ‘July’ 字符串常量</span></span><br><span class="line">mysql&gt; explain select * from staffs where name = 'July';</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------+------+----------+-------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys           | key                     | key_len | ref   | rows | filtered | Extra |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------+------+----------+-------+</span></span><br><span class="line">|  1 | SIMPLE      | staffs | NULL       | ref  | index_staffs_nameAgePos | index_staffs_nameAgePos | 74      | const |    1 |   100.00 | NULL  |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------+------+----------+-------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">--带头大哥 name 带上中间的小弟 age</span></span><br><span class="line"><span class="comment">--key = index_staffs_nameAgePos 表明索引生效</span></span><br><span class="line"><span class="comment">--ref = const,const：两个常量分别为 ‘July’ 和 23</span></span><br><span class="line">mysql&gt; <span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> staffs <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">'July'</span> <span class="keyword">and</span> age = <span class="number">25</span>;</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------------+------+----------+-------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys           | key                     | key_len | ref         | rows | filtered | Extra |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------------+------+----------+-------+</span></span><br><span class="line">|  1 | SIMPLE      | staffs | NULL       | ref  | index_staffs_nameAgePos | index_staffs_nameAgePos | 78      | const,const |    1 |   100.00 | NULL  |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------------+------+----------+-------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">--带头大哥 name 带上中间小弟 age ，中间小弟 age 带上小小弟 pos</span></span><br><span class="line"><span class="comment">--key = index_staffs_nameAgePos 表明索引生效</span></span><br><span class="line"><span class="comment">--ref = const,const,const ：三个常量分别为 ‘July’、23 和 ‘dev’</span></span><br><span class="line">mysql&gt; <span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> staffs <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">'July'</span> <span class="keyword">and</span> age = <span class="number">25</span> <span class="keyword">and</span> pos = <span class="string">'dev'</span>;</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------------------+------+----------+-------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys           | key                     | key_len | ref               | rows | filtered | Extra |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------------------+------+----------+-------+</span></span><br><span class="line">|  1 | SIMPLE      | staffs | NULL       | ref  | index_staffs_nameAgePos | index_staffs_nameAgePos | 140     | const,const,const |    1 |   100.00 | NULL  |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------------------+------+----------+-------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">--带头大哥 name 挂了</span></span><br><span class="line"><span class="comment">--key = NULL 说明索引失效</span></span><br><span class="line"><span class="comment">--ref = null 表示 ref 也失效</span></span><br><span class="line">mysql&gt; <span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> staffs <span class="keyword">where</span> age = <span class="number">25</span> <span class="keyword">and</span> pos = <span class="string">'dev'</span>;</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+---------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+---------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line">|  1 | SIMPLE      | staffs | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    3 |    33.33 | Using where |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+---------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">--带头大哥 name 没挂，中间小弟 age 跑</span></span><br><span class="line"><span class="comment">--key = index_staffs_nameAgePos 说明索引没有失效</span></span><br><span class="line"><span class="comment">--但是ref = const 表明只使用了一个常量，即全值匹配中部分使用到了而已</span></span><br><span class="line">mysql&gt; <span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> staffs <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">'July'</span> <span class="keyword">and</span> pos = <span class="string">'dev'</span>;</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------+------+----------+-----------------------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys           | key                     | key_len | ref   | rows | filtered | Extra                 |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------+------+----------+-----------------------+</span></span><br><span class="line">|  1 | SIMPLE      | staffs | NULL       | ref  | index_staffs_nameAgePos | index_staffs_nameAgePos | 74      | const |    1 |    33.33 | Using index condition |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------+------+----------+-----------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>不在索引列上做任何操作（计算、函数、（自动or手动）类型转换），会导致索引失效而转向全表扫描</p>
</blockquote>
<ul>
<li><p>不对带头大哥 name 进行任何操作：key = index_staffs_nameAgePos 表明索引生效</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from staffs where name = 'July';</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------+------+----------+-------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys           | key                     | key_len | ref   | rows | filtered | Extra |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------+------+----------+-------+</span></span><br><span class="line">|  1 | SIMPLE      | staffs | NULL       | ref  | index_staffs_nameAgePos | index_staffs_nameAgePos | 74      | const |    1 |   100.00 | NULL  |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------+------+----------+-------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>对带头大哥 name 进行操作：使用 LEFT 函数截取子串（相当于java中的substr）</p>
<ul>
<li>key = NULL 表明索引生效</li>
<li>type = ALL 表明进行了全表扫描</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from staffs where left(name,4) = &apos;July&apos;;</span><br><span class="line">+----+-------------+--------+------------+------+---------------+------+---------+------+------+----------+-------------+</span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |</span><br><span class="line">+----+-------------+--------+------------+------+---------------+------+---------+------+------+----------+-------------+</span><br><span class="line">|  1 | SIMPLE      | staffs | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    3 |   100.00 | Using where |</span><br><span class="line">+----+-------------+--------+------------+------+---------------+------+---------+------+------+----------+-------------+</span><br><span class="line">1 row in set, 1 warning (0.00 sec)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<blockquote>
<p>存储引擎不能使用索引中范围条件右边的列（范围之后全失效，但是有范围的那个本身是用到索引的了（只用到排序，而没有用到查找））</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from staffs where name = 'July' and age = 23 and pos = 'dev';</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------------------+------+----------+-------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys           | key                     | key_len | ref               | rows | filtered | Extra |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------------------+------+----------+-------+</span></span><br><span class="line">|  1 | SIMPLE      | staffs | NULL       | ref  | index_staffs_nameAgePos | index_staffs_nameAgePos | 140     | const,const,const |    1 |   100.00 | NULL  |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------------------+------+----------+-------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>测试结果：</p>
<ul>
<li>type = ref 表示非唯一索引扫描，SQL 语句将返回匹配某个单独值的所有行。</li>
<li>key_len = 140 表明表示索引中使用的字节数</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from staffs where name = 'July' and age &gt; 23 and pos = 'dev';</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+-------+-------------------------+-------------------------+---------+------+------+----------+-----------------------+</span></span><br><span class="line">| id | select_type | table  | partitions | type  | possible_keys           | key                     | key_len | ref  | rows | filtered | Extra                 |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+-------+-------------------------+-------------------------+---------+------+------+----------+-----------------------+</span></span><br><span class="line">|  1 | SIMPLE      | staffs | NULL       | range | index_staffs_nameAgePos | index_staffs_nameAgePos | 78      | NULL |    1 |    33.33 | Using index condition |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+-------+-------------------------+-------------------------+---------+------+------+----------+-----------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

<p>测试结果</p>
<ul>
<li>type = range 表示范围扫描</li>
<li>key = index_staffs_nameAgePos 表示索引并没有失效</li>
<li>key_len = 78 ，ref = NULL 均表明范围搜索使其后面的索引(age和pos)均失效</li>
</ul>
<blockquote>
<p>尽量使用覆盖索引（只访问索引的查询（索引列和查询列一致）），减少select *</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--select * </span></span><br><span class="line">mysql&gt; explain select * from staffs where name = 'July' and age &gt; 23 and pos='dev';</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+-------+-------------------------+-------------------------+---------+------+------+----------+-----------------------+</span></span><br><span class="line">| id | select_type | table  | partitions | type  | possible_keys           | key                     | key_len | ref  | rows | filtered | Extra                 |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+-------+-------------------------+-------------------------+---------+------+------+----------+-----------------------+</span></span><br><span class="line">|  1 | SIMPLE      | staffs | NULL       | range | index_staffs_nameAgePos | index_staffs_nameAgePos | 78      | NULL |    1 |    33.33 | Using index condition |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+-------+-------------------------+-------------------------+---------+------+------+----------+-----------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">--覆盖索引的写法：Extra = Using where; Using index ，Using index 表示使用索引列进行查询，将大大提高查询的效率.虽然在查询条件中使用了范围搜索，但是由于我们只需要查找索引列，所以无需进行全表扫描</span></span><br><span class="line">mysql&gt; <span class="keyword">explain</span> <span class="keyword">select</span> <span class="keyword">name</span>,age,pos <span class="keyword">from</span> staffs <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">'July'</span> <span class="keyword">and</span> age &gt; <span class="number">23</span> <span class="keyword">and</span> pos=<span class="string">'dev'</span>;</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+-------+-------------------------+-------------------------+---------+------+------+----------+--------------------------+</span></span><br><span class="line">| id | select_type | table  | partitions | type  | possible_keys           | key                     | key_len | ref  | rows | filtered | Extra                    |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+-------+-------------------------+-------------------------+---------+------+------+----------+--------------------------+</span></span><br><span class="line">|  1 | SIMPLE      | staffs | NULL       | range | index_staffs_nameAgePos | index_staffs_nameAgePos | 78      | NULL |    1 |    33.33 | Using where; Using index |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+-------+-------------------------+-------------------------+---------+------+------+----------+--------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">--只要查询列&lt;索引列即可满足覆盖索引</span></span><br><span class="line">mysql&gt; <span class="keyword">explain</span> <span class="keyword">select</span> <span class="keyword">name</span>,age <span class="keyword">from</span> staffs <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">'July'</span> <span class="keyword">and</span> age = <span class="number">23</span> <span class="keyword">and</span> pos=<span class="string">'dev'</span>;</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------------------+------+----------+-------------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys           | key                     | key_len | ref               | rows | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------------------+------+----------+-------------+</span></span><br><span class="line">|  1 | SIMPLE      | staffs | NULL       | ref  | index_staffs_nameAgePos | index_staffs_nameAgePos | 140     | const,const,const |    1 |   100.00 | Using index |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------------------+------+----------+-------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>mysql在使用不等于（!=或者&lt;&gt;）的时候无法使用索引会导致全表扫描</p>
</blockquote>
<p>不过有时候该写还是要写，只不过你要知道这样写会导致索引失效，具体要看业务需求</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from staffs where name='July';</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------+------+----------+-------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys           | key                     | key_len | ref   | rows | filtered | Extra |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------+------+----------+-------+</span></span><br><span class="line">|  1 | SIMPLE      | staffs | NULL       | ref  | index_staffs_nameAgePos | index_staffs_nameAgePos | 74      | const |    1 |   100.00 | NULL  |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------+------+----------+-------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> staffs <span class="keyword">where</span> <span class="keyword">name</span>!=<span class="string">'July'</span>;</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys           | key  | key_len | ref  | rows | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line">|  1 | SIMPLE      | staffs | NULL       | ALL  | index_staffs_nameAgePos | NULL | NULL    | NULL |    3 |    66.67 | Using where |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>is null，is not null 也无法使用索引（早期版本不能走索引，后续版本应该优化过，可以走索引）</p>
</blockquote>
<p>可以=-1之类的</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from staffs where name is null;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+------------------+</span></span><br><span class="line">| id | select_type | table | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra            |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+------------------+</span></span><br><span class="line">|  1 | SIMPLE      | NULL  | NULL       | NULL | NULL          | NULL | NULL    | NULL | NULL |     NULL | Impossible WHERE |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+------+---------------+------+---------+------+------+----------+------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> staffs <span class="keyword">where</span> <span class="keyword">name</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">null</span>;</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys           | key  | key_len | ref  | rows | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line">|  1 | SIMPLE      | staffs | NULL       | ALL  | index_staffs_nameAgePos | NULL | NULL    | NULL |    3 |    66.67 | Using where |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>like以通配符开头（’%abc…’）mysql索引失效会变成全表扫描操作（百分like加右边）</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from staffs where name like '%July%';</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+---------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+---------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line">|  1 | SIMPLE      | staffs | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    3 |    33.33 | Using where |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+---------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> staffs <span class="keyword">where</span> <span class="keyword">name</span> <span class="keyword">like</span> <span class="string">'%July'</span>;</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+---------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys | key  | key_len | ref  | rows | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+---------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line">|  1 | SIMPLE      | staffs | NULL       | ALL  | NULL          | NULL | NULL    | NULL |    3 |    33.33 | Using where |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+---------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.01</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> staffs <span class="keyword">where</span> <span class="keyword">name</span> <span class="keyword">like</span> <span class="string">'July%'</span>;</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+-------+-------------------------+-------------------------+---------+------+------+----------+-----------------------+</span></span><br><span class="line">| id | select_type | table  | partitions | type  | possible_keys           | key                     | key_len | ref  | rows | filtered | Extra                 |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+-------+-------------------------+-------------------------+---------+------+------+----------+-----------------------+</span></span><br><span class="line">|  1 | SIMPLE      | staffs | NULL       | range | index_staffs_nameAgePos | index_staffs_nameAgePos | 74      | NULL |    1 |   100.00 | Using index condition |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+-------+-------------------------+-------------------------+---------+------+------+----------+-----------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>问题：<strong>解决【like ‘%str%’ 】索引失效的问题：使用覆盖索引</strong>，即查询的列要与索引列要一致（id也是索引）</p>
<blockquote>
<p>字符串不加单引号索引失效</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; mysql&gt; explain select * from staffs where name = '2000';</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------+------+----------+-------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys           | key                     | key_len | ref   | rows | filtered | Extra |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------+------+----------+-------+</span></span><br><span class="line">|  1 | SIMPLE      | staffs | NULL       | ref  | index_staffs_nameAgePos | index_staffs_nameAgePos | 74      | const |    1 |   100.00 | NULL  |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+-------------------------+---------+-------+------+----------+-------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line"><span class="comment">--不加单引号，mysql也是能查出结果的，因为它会为我们作隐式转换</span></span><br><span class="line">mysql&gt; <span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> staffs <span class="keyword">where</span> <span class="keyword">name</span> = <span class="number">2000</span>;</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys           | key  | key_len | ref  | rows | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line">|  1 | SIMPLE      | staffs | NULL       | ALL  | index_staffs_nameAgePos | NULL | NULL    | NULL |    3 |    33.33 | Using where |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">3</span> <span class="keyword">warnings</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>少用or，用它连接时会索引失效</p>
</blockquote>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from staffs where name ='z3' or name = 'July';</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys           | key  | key_len | ref  | rows | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+------+---------+------+------+----------+-------------+</span></span><br><span class="line">|  1 | SIMPLE      | staffs | NULL       | ALL  | index_staffs_nameAgePos | NULL | NULL    | NULL |    3 |    66.67 | Using where |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+-------------------------+------+---------+------+------+----------+-------------+</span></span><br></pre></td></tr></table></figure>

<h4 id="索引优化面试题"><a href="#索引优化面试题" class="headerlink" title="索引优化面试题"></a>索引优化面试题</h4><p><strong>创建表</strong></p>
<ul>
<li><p>建表sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> test01(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span> primary <span class="keyword">key</span> auto_increment,</span><br><span class="line">    c1 <span class="built_in">char</span>(<span class="number">10</span>),</span><br><span class="line">    c2 <span class="built_in">char</span>(<span class="number">10</span>),</span><br><span class="line">    c3 <span class="built_in">char</span>(<span class="number">10</span>),</span><br><span class="line">    c4 <span class="built_in">char</span>(<span class="number">10</span>),</span><br><span class="line">    c5 <span class="built_in">char</span>(<span class="number">10</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test01(c1,c2,c3,c4,c5) <span class="keyword">values</span> (<span class="string">'a1'</span>,<span class="string">'a2'</span>,<span class="string">'a3'</span>,<span class="string">'a4'</span>,<span class="string">'a5'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test01(c1,c2,c3,c4,c5) <span class="keyword">values</span> (<span class="string">'b1'</span>,<span class="string">'b2'</span>,<span class="string">'b3'</span>,<span class="string">'b4'</span>,<span class="string">'b5'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test01(c1,c2,c3,c4,c5) <span class="keyword">values</span> (<span class="string">'c1'</span>,<span class="string">'c2'</span>,<span class="string">'c3'</span>,<span class="string">'c4'</span>,<span class="string">'c5'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test01(c1,c2,c3,c4,c5) <span class="keyword">values</span> (<span class="string">'d1'</span>,<span class="string">'d2'</span>,<span class="string">'d3'</span>,<span class="string">'d4'</span>,<span class="string">'d5'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test01(c1,c2,c3,c4,c5) <span class="keyword">values</span> (<span class="string">'e1'</span>,<span class="string">'e2'</span>,<span class="string">'e3'</span>,<span class="string">'e4'</span>,<span class="string">'e5'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_test01_c1234 <span class="keyword">on</span> test01(c1,c2,c3,c4);</span><br></pre></td></tr></table></figure>
</li>
<li><p>test01表中的测试数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from test01;</span><br><span class="line">+<span class="comment">----+------+------+------+------+------+</span></span><br><span class="line">| id | c1   | c2   | c3   | c4   | c5   |</span><br><span class="line">+<span class="comment">----+------+------+------+------+------+</span></span><br><span class="line">|  1 | a1   | a2   | a3   | a4   | a5   |</span><br><span class="line">|  2 | b1   | b2   | b3   | b4   | b5   |</span><br><span class="line">|  3 | c1   | c2   | c3   | c4   | c5   |</span><br><span class="line">|  4 | d1   | d2   | d3   | d4   | d5   |</span><br><span class="line">|  5 | e1   | e2   | e3   | e4   | e5   |</span><br><span class="line">+<span class="comment">----+------+------+------+------+------+</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>我们创建了复合索引idx_test01_c1234，根据以下SQL分析下索引使用情况</p>
<ol>
<li>全值匹配</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from test01 where c1='a1' and c2='a2' and c3='a3' and c4='a4';</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------------------------+------+----------+-------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys    | key              | key_len | ref                     | rows | filtered | Extra |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------------------------+------+----------+-------+</span></span><br><span class="line">|  1 | SIMPLE      | test01 | NULL       | ref  | idx_test01_c1234 | idx_test01_c1234 | 124     | const,const,const,const |    1 |   100.00 | NULL  |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------------------------+------+----------+-------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>即使顺序不一样，mysql的优化器会为我们优化顺序，使得我们的查询列和索引列保持一致</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from test01 where c4='a4' and c3='a3' and c2='a2' and c1='a1';</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------------------------+------+----------+-------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys    | key              | key_len | ref                     | rows | filtered | Extra |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------------------------+------+----------+-------+</span></span><br><span class="line">|  1 | SIMPLE      | test01 | NULL       | ref  | idx_test01_c1234 | idx_test01_c1234 | 124     | const,const,const,const |    1 |   100.00 | NULL  |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------------------------+------+----------+-------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>c3 列使用了索引进行排序，并没有进行查找，即部分索引，导致 c4 无法用索引进行查找，也就是说范围之后全失效</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from test01 where c1='a1' and c2='a2' and c3&gt;'a3' and c4='a4';</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+-------+------------------+------------------+---------+------+------+----------+-----------------------+</span></span><br><span class="line">| id | select_type | table  | partitions | type  | possible_keys    | key              | key_len | ref  | rows | filtered | Extra                 |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+-------+------------------+------------------+---------+------+------+----------+-----------------------+</span></span><br><span class="line">|  1 | SIMPLE      | test01 | NULL       | range | idx_test01_c1234 | idx_test01_c1234 | 93      | NULL |    1 |    20.00 | Using index condition |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+-------+------------------+------------------+---------+------+------+----------+-----------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>mysql底层会自动优化顺序，按照1234的来</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from test01 where c1='a1' and c2='a2' and c4&gt;'c4' and c3='a3';</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+-------+------------------+------------------+---------+------+------+----------+-----------------------+</span></span><br><span class="line">| id | select_type | table  | partitions | type  | possible_keys    | key              | key_len | ref  | rows | filtered | Extra                 |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+-------+------------------+------------------+---------+------+------+----------+-----------------------+</span></span><br><span class="line">|  1 | SIMPLE      | test01 | NULL       | range | idx_test01_c1234 | idx_test01_c1234 | 124     | NULL |    1 |   100.00 | Using index condition |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+-------+------------------+------------------+---------+------+------+----------+-----------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>c3用到了部分索引（只用于排序，没有用于查找），c4 列没有用到索引</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from test01 where c1='a1' and c2='c2' and c4='a4' order by c3;</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------------+------+----------+-----------------------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys    | key              | key_len | ref         | rows | filtered | Extra                 |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------------+------+----------+-----------------------+</span></span><br><span class="line">|  1 | SIMPLE      | test01 | NULL       | ref  | idx_test01_c1234 | idx_test01_c1234 | 62      | const,const |    1 |    20.00 | Using index condition |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------------+------+----------+-----------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>跟上面一样，c4列本来就没用到</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from test01 where c1='a1' and c2='c2' order by c3;</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------------+------+----------+-----------------------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys    | key              | key_len | ref         | rows | filtered | Extra                 |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------------+------+----------+-----------------------+</span></span><br><span class="line">|  1 | SIMPLE      | test01 | NULL       | ref  | idx_test01_c1234 | idx_test01_c1234 | 62      | const,const |    1 |   100.00 | Using index condition |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------------+------+----------+-----------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>中间兄弟断了，导致了mysql动用了文件排序，using filesort说明此句需要优化</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; mysql&gt; explain select * from test01 where c1='a1' and c2='c2' order by c4;</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------------+------+----------+---------------------------------------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys    | key              | key_len | ref         | rows | filtered | Extra                                 |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------------+------+----------+---------------------------------------+</span></span><br><span class="line">|  1 | SIMPLE      | test01 | NULL       | ref  | idx_test01_c1234 | idx_test01_c1234 | 62      | const,const |    1 |   100.00 | Using index condition; Using filesort |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------------+------+----------+---------------------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>只用了c1一个字段索引，但是c2，c3用于排序，无filesort</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from test01 where c1='a' and c5='a5' order by c2,c3;</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------+------+----------+------------------------------------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys    | key              | key_len | ref   | rows | filtered | Extra                              |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------+------+----------+------------------------------------+</span></span><br><span class="line">|  1 | SIMPLE      | test01 | NULL       | ref  | idx_test01_c1234 | idx_test01_c1234 | 31      | const |    1 |    20.00 | Using index condition; Using where |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------+------+----------+------------------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>我们建的索引是1234，它没有按顺序来，3 2颠倒了，有filesort，跟上面对比</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from test01 where c1='a' and c5='a5' order by c3,c2;</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------+------+----------+----------------------------------------------------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys    | key              | key_len | ref   | rows | filtered | Extra                                              |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------+------+----------+----------------------------------------------------+</span></span><br><span class="line">|  1 | SIMPLE      | test01 | NULL       | ref  | idx_test01_c1234 | idx_test01_c1234 | 31      | const |    1 |    20.00 | Using index condition; Using where; Using filesort |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------+------+----------+----------------------------------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ol start="10">
<li>用c1、c2两个字段索引，但是c2、c3用于排序，无filesort</li>
</ol>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from test01 where c1='a1' and c2='a2' order by c2,c3;</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------------+------+----------+-----------------------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys    | key              | key_len | ref         | rows | filtered | Extra                 |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------------+------+----------+-----------------------+</span></span><br><span class="line">|  1 | SIMPLE      | test01 | NULL       | ref  | idx_test01_c1234 | idx_test01_c1234 | 62      | const,const |    1 |   100.00 | Using index condition |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------------+------+----------+-----------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<p>11.注意查询条件 c2=‘a2’ ，即c2 为常量，那么对c2排序就没有意思了，所以没有产生 filesort</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from test01 where c1='a1' and c2='a2' and c5='a5' order by c3,c2;</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------------+------+----------+------------------------------------+</span></span><br><span class="line">| id | select_type | table  | partitions | type | possible_keys    | key              | key_len | ref         | rows | filtered | Extra                              |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------------+------+----------+------------------------------------+</span></span><br><span class="line">|  1 | SIMPLE      | test01 | NULL       | ref  | idx_test01_c1234 | idx_test01_c1234 | 62      | const,const |    1 |    20.00 | Using index condition; Using where |</span><br><span class="line">+<span class="comment">----+-------------+--------+------------+------+------------------+------------------+---------+-------------+------+----------+------------------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<h4 id="索引失效总结"><a href="#索引失效总结" class="headerlink" title="索引失效总结"></a>索引失效总结</h4><ol>
<li>对于单键索引，尽量选择针对当前query过滤性更好的索引</li>
<li>在选择组合索引的时候，当前query中过滤性最好的字段在索引字段顺序中，位置越靠左越好。</li>
<li>在选择组合索引的时候，尽量选择可以能包含当前query中的where子句中更多字段的索引</li>
<li>尽可能通过分析统计信息和调整query的写法来达到选择合适索引的目的</li>
</ol>
<h2 id="查询截取分析"><a href="#查询截取分析" class="headerlink" title="查询截取分析"></a>查询截取分析</h2><h3 id="查询优化"><a href="#查询优化" class="headerlink" title="查询优化"></a>查询优化</h3><h4 id="mysql优化原则"><a href="#mysql优化原则" class="headerlink" title="mysql优化原则"></a>mysql优化原则</h4><blockquote>
<p>mysql的调优大纲</p>
</blockquote>
<ol>
<li>慢查询的开启并捕获</li>
<li>explain+慢SQL分析</li>
<li>show profile查询SQL在Mysql服务器里面的执行细节和生命周期情况</li>
<li>SQL数据库服务器的参数调优</li>
</ol>
<blockquote>
<p>永远小表驱动大表，类似嵌套循环</p>
</blockquote>
<p><strong>引入</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">5</span>...)&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">100</span>..)&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">--------------------</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">100</span>...)&#123;</span><br><span class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> j = <span class="number">5</span>..)&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们可以知道上面2种循环的循环次数是一样的，但对于数据库而言并非如此，我们会上面第1种情况。为什么？小表驱动大表，数据库在连接和释放资源比较耗时，第1种情况，只建立了5次连接，然后第2种情况，却建立了100次连接。</p>
<p>in和exist的说明 ：</p>
<p>EXISTS 语法：</p>
<ul>
<li><code>SELECT ... FROM table WHERE EXISTS(subquery)</code></li>
<li>该语法可以理解为：将查询的数据，放到子查询中做条件验证，根据验证结果（TRUE或FALSE）来决定主查询的数据结果是否得以保留。</li>
<li>EXISTS(subquery) 只返回TRUE或FALSE，因此子查询中的<code>SELECT *</code>也可以是<code>SELECT 1</code>或其他常数，官方说法是实际执行时会忽略SELECT清单，因此没有区别</li>
<li>EXISTS子查询的实际执行过程可能经过了优化而不是我们理解上的逐条对比，如果担忧效率问题，可进行实际检验以确定是否有效率问题。</li>
<li>EXISTS子查询往往也可以用条件表达式、其他子查询或者JOIN来替代，何种最优需要具体问题具体分析</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--优化原则：小表驱动大表，即小的数据集驱动大的数据集</span></span><br><span class="line"><span class="comment">--原理：</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> A <span class="keyword">where</span> <span class="keyword">id</span> <span class="keyword">in</span> (<span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> B)</span><br><span class="line">等价于</span><br><span class="line"><span class="keyword">for</span> <span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> B</span><br><span class="line"><span class="keyword">for</span> <span class="keyword">select</span> * <span class="keyword">from</span> A <span class="keyword">where</span> A.id = B.id</span><br><span class="line"><span class="comment">--当B表的数据集&lt;A表的数据集时，用in优于exists</span></span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> A <span class="keyword">where</span> <span class="keyword">exists</span> (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> B.id = A.id)</span><br><span class="line">等价于</span><br><span class="line"><span class="keyword">for</span> <span class="keyword">select</span> * <span class="keyword">from</span> A</span><br><span class="line"><span class="keyword">for</span> <span class="keyword">select</span> * <span class="keyword">from</span> B <span class="keyword">where</span> B.id = A.id</span><br><span class="line"><span class="comment">--当A表的数据集&lt;B表的数据集时，用exist优于in</span></span><br><span class="line"><span class="comment">--注意：A表与B表的ID字段应建立索引</span></span><br></pre></td></tr></table></figure>

<p>相当于我这两条语句是等价的：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tableA A <span class="keyword">where</span> A.deptId <span class="keyword">in</span> (<span class="keyword">select</span> <span class="keyword">id</span> <span class="keyword">from</span> tableB B)</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tableA A <span class="keyword">where</span> <span class="keyword">exists</span> (<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> tableB B)</span><br></pre></td></tr></table></figure>

<h4 id="order-by优化"><a href="#order-by优化" class="headerlink" title="order by优化"></a>order by优化</h4><p>ORDER BY子句，尽量使用Index方式排序，避免使用FileSort方式排序</p>
<p><strong>创建表</strong></p>
<ul>
<li><p>建表SQL</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> tblA(</span><br><span class="line">	age <span class="built_in">int</span>,</span><br><span class="line">	birth <span class="built_in">timestamp</span> <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tblA(age, birth) <span class="keyword">values</span>(<span class="number">22</span>, <span class="keyword">now</span>());</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tblA(age, birth) <span class="keyword">values</span>(<span class="number">23</span>, <span class="keyword">now</span>());</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> tblA(age, birth) <span class="keyword">values</span>(<span class="number">24</span>, <span class="keyword">now</span>());</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">index</span> idx_A_ageBirth <span class="keyword">on</span> tblA(age, birth);</span><br></pre></td></tr></table></figure>
</li>
<li><p>tblA表中的测试数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from tblA;</span><br><span class="line">+<span class="comment">------+---------------------+</span></span><br><span class="line">| age  | birth               |</span><br><span class="line">+<span class="comment">------+---------------------+</span></span><br><span class="line">|   22 | 2021-03-06 14:51:45 |</span><br><span class="line">|   23 | 2021-03-06 14:51:45 |</span><br><span class="line">|   24 | 2021-03-06 14:51:45 |</span><br><span class="line">+<span class="comment">------+---------------------+</span></span><br><span class="line">3 rows in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>case1：能使用索引进行排序的情况</strong></p>
<ul>
<li><p>只有带头大哥age</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from tblA where age&gt;20 order by age;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+------+----------+--------------------------+</span></span><br><span class="line">| id | select_type | table | partitions | type  | possible_keys  | key            | key_len | ref  | rows | filtered | Extra                    |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+------+----------+--------------------------+</span></span><br><span class="line">|  1 | SIMPLE      | tblA  | NULL       | index | idx_A_ageBirth | idx_A_ageBirth | 9       | NULL |    3 |   100.00 | Using where; Using index |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+------+----------+--------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> tblA <span class="keyword">where</span> birth&gt;<span class="string">'2021-03-06 00:00:00'</span> <span class="keyword">order</span> <span class="keyword">by</span> age;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+--------------------------+</span></span><br><span class="line">| id | select_type | table | partitions | type  | possible_keys | key            | key_len | ref  | rows | filtered | Extra                    |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+--------------------------+</span></span><br><span class="line">|  1 | SIMPLE      | tblA  | NULL       | index | NULL          | idx_A_ageBirth | 9       | NULL |    3 |    33.33 | Using where; Using index |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+--------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>带头大哥age + 小弟birth</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from tblA where age&gt;20 order by age,birth;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+------+----------+--------------------------+</span></span><br><span class="line">| id | select_type | table | partitions | type  | possible_keys  | key            | key_len | ref  | rows | filtered | Extra                    |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+------+----------+--------------------------+</span></span><br><span class="line">|  1 | SIMPLE      | tblA  | NULL       | index | idx_A_ageBirth | idx_A_ageBirth | 9       | NULL |    3 |   100.00 | Using where; Using index |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+------+----------+--------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>mysql 默认升序排列，全升序或者全降序，都扛得住</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from tblA order by age ASC,birth ASC;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+-------------+</span></span><br><span class="line">| id | select_type | table | partitions | type  | possible_keys | key            | key_len | ref  | rows | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+-------------+</span></span><br><span class="line">|  1 | SIMPLE      | tblA  | NULL       | index | NULL          | idx_A_ageBirth | 9       | NULL |    3 |   100.00 | Using index |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+-------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> tblA <span class="keyword">order</span> <span class="keyword">by</span> age <span class="keyword">DESC</span>,birth <span class="keyword">DESC</span>;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+-------------+</span></span><br><span class="line">| id | select_type | table | partitions | type  | possible_keys | key            | key_len | ref  | rows | filtered | Extra       |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+-------------+</span></span><br><span class="line">|  1 | SIMPLE      | tblA  | NULL       | index | NULL          | idx_A_ageBirth | 9       | NULL |    3 |   100.00 | Using index |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+-------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>CASE2：不能使用索引进行排序的情况</strong></p>
<ul>
<li><p>带头大哥age挂了</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from tblA where age &gt; 20 order by birth;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+------+----------+------------------------------------------+</span></span><br><span class="line">| id | select_type | table | partitions | type  | possible_keys  | key            | key_len | ref  | rows | filtered | Extra                                    |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+------+----------+------------------------------------------+</span></span><br><span class="line">|  1 | SIMPLE      | tblA  | NULL       | index | idx_A_ageBirth | idx_A_ageBirth | 9       | NULL |    3 |   100.00 | Using where; Using index; Using filesort |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+------+----------+------------------------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; <span class="keyword">explain</span> <span class="keyword">select</span> * <span class="keyword">from</span> tblA <span class="keyword">where</span> age &gt; <span class="number">20</span> <span class="keyword">order</span> <span class="keyword">by</span> birth,age;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+------+----------+------------------------------------------+</span></span><br><span class="line">| id | select_type | table | partitions | type  | possible_keys  | key            | key_len | ref  | rows | filtered | Extra                                    |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+------+----------+------------------------------------------+</span></span><br><span class="line">|  1 | SIMPLE      | tblA  | NULL       | index | idx_A_ageBirth | idx_A_ageBirth | 9       | NULL |    3 |   100.00 | Using where; Using index; Using filesort |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+----------------+----------------+---------+------+------+----------+------------------------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>mysql 默认升序排列，如果全升序或者全降序，都 ok ，但是一升一降 mysql 就扛不住了</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; explain select * from tblA order by age ASC,birth DESC;</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+-----------------------------+</span></span><br><span class="line">| id | select_type | table | partitions | type  | possible_keys | key            | key_len | ref  | rows | filtered | Extra                       |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+-----------------------------+</span></span><br><span class="line">|  1 | SIMPLE      | tblA  | NULL       | index | NULL          | idx_A_ageBirth | 9       | NULL |    3 |   100.00 | Using index; Using filesort |</span><br><span class="line">+<span class="comment">----+-------------+-------+------------+-------+---------------+----------------+---------+------+------+----------+-----------------------------+</span></span><br><span class="line">1 row in <span class="keyword">set</span>, <span class="number">1</span> <span class="keyword">warning</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>结论：</strong></p>
<ol>
<li>MySQL支持二种方式的排序，FileSort和Index，Index效率高，它指MySQL扫描索引本身完成排序，FileSort方式效率较低。</li>
<li>ORDER BY满足两情况（最佳左前缀原则），会使用Index方式排序<ol>
<li>ORDER BY语句使用索引最左前列</li>
<li>使用where子句与OrderBy子句条件列组合满足索引最左前列</li>
</ol>
</li>
<li>尽可能在索引列上完成排序操作，遵照索引建的最佳左前缀</li>
</ol>
<blockquote>
<p><strong>如果未在索引列上完成排序，mysql 会启动 filesort 的两种算法：双路排序和单路排序</strong></p>
</blockquote>
<ol>
<li>双路排序<ol>
<li>MySQL4.1之前是使用双路排序，字面意思是两次扫描磁盘，最终得到数据。读取行指针和将要进行order by操作的列，对他们进行排序，然后扫描已经排序好的列表，按照列表中的值重新从列表中读取对应的数据传输</li>
<li>从磁盘取排序字段，在buffer进行排序，再从磁盘取其他字段。</li>
</ol>
</li>
<li>单路排序<ol>
<li>取一批数据，要对磁盘进行两次扫描，众所周知，I/O是很耗时的，所以在mysql4.1之后，出现了改进的算法，就是单路排序。</li>
<li>从磁盘读取查询需要的所有列，按照将要进行orderby的列，在sort buffer对它们进行排序，然后扫描排序后的列表进行输出，它的效率更快一些，避免了第二次读取数据，并且把随机IO变成顺序IO，但是它会使用更多的空间，因为它把每一行都保存在内存中了。</li>
</ol>
</li>
<li>结论及引申出的问题：<ol>
<li>由于单路是改进的算法，总体而言好过双路</li>
<li>在sort_buffer中，方法B比方法A要多占用很多空间，因为方法B是把所有字段都取出，所以有可能取出的数据的总大小超出了sort_buffer的容量，导致每次只能取sort_buffer容量大小的数据，进行排序（创建tmp文件，多路合并），排完再取取sort_buffer容量大小，再排…… 从而会导致多次I/O。</li>
<li>结论：本来想省一次I/O操作，反而导致了大量的/O操作，反而得不偿失。</li>
</ol>
</li>
<li>更深层次的优化策略：<ol>
<li>增大sort_buffer_size参数的设置</li>
<li>增大max_length_for_sort_data参数的设置</li>
</ol>
</li>
<li>遵循如下规则，可提高Order By的速度<ol>
<li>Order by时select *是一个大忌，只Query需要的字段，这点非常重要。在这里的影响是：<ol>
<li>当Query的字段大小总和小于max_length_for_sort_data，而且排序字段不是TEXT|BLOB类型时，会用改进后的算法——单路排序，否则用老算法——多路排序。</li>
<li>两种算法的数据都有可能超出sort_buffer的容量，超出之后，会创建tmp文件进行合并排序，导致多次I/O，但是用单路排序算法的风险会更大一些，所以要提高sort_buffer_size。</li>
</ol>
</li>
<li>尝试提高 sort_buffer_size不管用哪种算法，提高这个参数都会提高效率，当然，要根据系统的能力去提高，因为这个参数是针对每个进程的</li>
<li>尝试提高max_length_for_sort_data提高这个参数，会增加用改进算法的概率。但是如果设的太高，数据总容量超出sort_buffer_size的概率就增大，明显症状是高的磁盘I/O活动和低的处理器使用率。</li>
</ol>
</li>
</ol>
<h4 id="group-by优化"><a href="#group-by优化" class="headerlink" title="group by优化"></a>group by优化</h4><ol>
<li>group by实质是先排序后进行分组，遵照索引的最佳左前缀</li>
<li>当无法使用索引列，增大max_length_for_sort_data参数的设置+增大sort_buffer_size参数的设置</li>
<li>where高于having，能写在where限定的条件就不要去having限定了</li>
<li>其余的规则均和 order by 一致</li>
</ol>
<h3 id="慢查询日志"><a href="#慢查询日志" class="headerlink" title="慢查询日志"></a>慢查询日志</h3><h4 id="慢查询日志介绍"><a href="#慢查询日志介绍" class="headerlink" title="慢查询日志介绍"></a>慢查询日志介绍</h4><ol>
<li>MySQL的慢查询日志是MySQL提供的一种日志记录，它用来记录在MySQL中响应时间超过阀值的语句，具体指运行时间超过long_query_time值的SQL，则会被记录到慢查询日志中。</li>
<li>long_query_time的默认值为10，意思是运行10秒以上的SQL语句会被记录下来</li>
<li>由他来查看哪些SQL超出了我们的最大忍耐时间值，比如一条sql执行超过5秒钟，我们就算慢SQL，希望能收集超过5秒的sql，结合之前explain进行全面分析。</li>
</ol>
<h4 id="慢查询日志开启"><a href="#慢查询日志开启" class="headerlink" title="慢查询日志开启"></a>慢查询日志开启</h4><p><strong>说明：</strong></p>
<ol>
<li>默认情况下，MySQL数据库没有开启慢查询日志，需要我们手动来设置这个参数。</li>
<li>当然，如果不是调优需要的话，一般不建议启动该参数，因为开启慢查询日志会或多或少带来一定的性能影响。慢查询日志支持将日志记录写入文件</li>
</ol>
<p><strong>查看是否开启及如何开启</strong></p>
<ul>
<li>查看慢查询日志是否开启：<ol>
<li>通过SHOW VARIABLES LIKE ‘%slow_query_log%’;查看 mysql 的慢查询日志是否开启</li>
<li>默认情况下slow_query_log的值为OFF，表示慢查询日志是禁用的</li>
</ol>
</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like'%slow_query_log%';</span><br><span class="line">+<span class="comment">---------------------+-------------------------------------------------+</span></span><br><span class="line">| Variable_name       | Value                                           |</span><br><span class="line">+<span class="comment">---------------------+-------------------------------------------------+</span></span><br><span class="line">| slow_query_log      | OFF                                             |</span><br><span class="line">| slow_query_log_file | /var/lib/mysql/iZwz9ick8j8tmsj93waiowZ-slow.log |</span><br><span class="line">+<span class="comment">---------------------+-------------------------------------------------+</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>开启慢查询日志：</p>
<ol>
<li><p>通过set global slow_query_log = 1;开启慢查询日志</p>
</li>
<li><p>使用<code>set global slow_query_log=1</code>开启了慢查询日志只对当前数据库生效，如果MySQL重启后则会失效。</p>
</li>
<li><p>关于slow_query_log_file这个参数，它指定慢查询日志文件的存放路径</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global slow_query_log = 1;</span><br><span class="line">Query OK, 0 rows affected (0.05 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show variables like'%slow_query_log%';</span><br><span class="line">+<span class="comment">---------------------+-------------------------------------------------+</span></span><br><span class="line">| Variable_name       | Value                                           |</span><br><span class="line">+<span class="comment">---------------------+-------------------------------------------------+</span></span><br><span class="line">| slow_query_log      | ON                                              |</span><br><span class="line">| slow_query_log_file | /var/lib/mysql/iZwz9ick8j8tmsj93waiowZ-slow.log |</span><br><span class="line">+<span class="comment">---------------------+-------------------------------------------------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>如果想永久生效，就必须修改配置文件my.cnf，然后重启mysql</p>
<p>修改my.cnf文件，[mysqld]下增加或修改参数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">show_query_log=1</span><br><span class="line">slow_query_log_file=/var/lib/mysql/主机名-slow.log</span><br></pre></td></tr></table></figure>



</li>
</ol>
</li>
</ul>
<p>  <strong>那么开启慢查询日志后，什么样的SQL参会记录到慢查询里面？</strong></p>
<p>  那么何为慢，得有个标准</p>
<ul>
<li><p>这个是由参数long_query_time控制，默认情况下long_query_time的值为10秒，这里的10是指&gt;，而非&gt;=</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--查看慢 SQL 的阈值:show variables like 'long_query_time%';</span></span><br><span class="line">mysql&gt; show variables like 'long_query_time%';</span><br><span class="line">+<span class="comment">-----------------+-----------+</span></span><br><span class="line">| Variable_name   | Value     |</span><br><span class="line">+<span class="comment">-----------------+-----------+</span></span><br><span class="line">| long_query_time | 10.000000 |</span><br><span class="line">+<span class="comment">-----------------+-----------+</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>可以使用命令修改，也可以在my.cnf参数里面修改。</p>
</li>
</ul>
<p>设置慢的阈值时间：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> long_query_time=<span class="number">3</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>为什么设置后阈值时间没变？</p>
<ul>
<li>需要重新连接或者新开一个回话才能看到修改值。</li>
<li>或者查看全局的 long_query_time 值：show global variables like ‘long_query_time’;发现已经生效</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global variables like 'long_query_time';</span><br><span class="line">+<span class="comment">-----------------+----------+</span></span><br><span class="line">| Variable_name   | Value    |</span><br><span class="line">+<span class="comment">-----------------+----------+</span></span><br><span class="line">| long_query_time | 3.000000 |</span><br><span class="line">+<span class="comment">-----------------+----------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>测试模拟</strong></p>
<ul>
<li><p>select sleep(4)：超过3s，会被记录到慢sql日志中</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">sleep</span>(<span class="number">4</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>查看日志：慢查询日志文件在 /var/lib/mysql/ 下，后缀为 -slow.log</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@iZwz9ick8j8tmsj93waiowZ ~]<span class="comment"># cd /var/lib/mysql</span></span><br><span class="line">[root@iZwz9ick8j8tmsj93waiowZ mysql]<span class="comment"># cat iZwz9ick8j8tmsj93waiowZ-slow.log</span></span><br><span class="line">/usr/sbin/mysqld, Version: 5.7.33 (MySQL Community Server (GPL)). started <span class="keyword">with</span>:</span><br><span class="line">Tcp port: <span class="number">3306</span>  Unix socket: /<span class="keyword">var</span>/lib/mysql/mysql.sock</span><br><span class="line"><span class="built_in">Time</span>                 <span class="keyword">Id</span> Command    Argument</span><br><span class="line"><span class="comment"># Time: 2021-03-06T08:12:44.093910Z</span></span><br><span class="line"><span class="comment"># User@Host: root[root] @ localhost []  Id:    49</span></span><br><span class="line"><span class="comment"># Query_time: 4.000279  Lock_time: 0.000000 Rows_sent: 1  Rows_examined: 0</span></span><br><span class="line"><span class="keyword">SET</span> <span class="built_in">timestamp</span>=<span class="number">1615018364</span>;</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">sleep</span>(<span class="number">4</span>);<span class="comment">#导致的sql</span></span><br><span class="line">[root@iZwz9ick8j8tmsj93waiowZ mysql]<span class="comment">#</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>查询当前系统中有多少条慢查询记录：show global status like ‘%Slow_queries%’;</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global status like '%Slow_queries%';</span><br><span class="line">+<span class="comment">---------------+-------+</span></span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+<span class="comment">---------------+-------+</span></span><br><span class="line">| Slow_queries  | 1     |</span><br><span class="line">+<span class="comment">---------------+-------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.01</span> sec)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>配置版的慢查询日志</strong></p>
<p>在 /etc/my.cnf 文件的 [mysqld] 节点下配置</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">slow_query_log=1；</span><br><span class="line">slow_query_log_file=/var/lib/mysql/Heygo-slow.log </span><br><span class="line">long_query_time=3；</span><br><span class="line">log_output=FILE</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>日志分析命令 mysqldumpslow</strong></p>
</blockquote>
<p><strong>mysqldumpslow是什么？</strong></p>
<p>在生产环境中，如果要手工分析日志，查找、分析SQL，显然是个体力活，MySQL提供了日志分析工具mysqldumpslow。</p>
<p><strong>mysqldumpshow 参数解释</strong></p>
<ol>
<li>s：是表示按何种方式排序</li>
<li>c：访问次数</li>
<li>l：锁定时间</li>
<li>r：返回记录</li>
<li>t：查询时间</li>
<li>al：平均锁定时间</li>
<li>ar：平均返回记录数</li>
<li>at：平均查询时间</li>
<li>t：即为返回前面多少条的数据</li>
<li>g：后边搭配一个正则匹配模式，大小写不敏感的</li>
</ol>
<p>常用参数手册</p>
<p>得到返回记录集最多的10个SQL</p>
<p>​    mysqldumpslow -s r -t 10 /var/lib/mysql/Heygo-slow.log</p>
<p>得到访问次数最多的10个SQL</p>
<p>​    mysqldumpslow -s c- t 10/var/lib/mysql/Heygo-slow.log</p>
<p>得到按照时间排序的前10条里面含有左连接的查询语句</p>
<p>​    mysqldumpslow -s t -t 10 -g “left join” /var/lib/mysql/Heygo-slow.log</p>
<p>另外建议在使用这些命令时结合 | 和more使用，否则有可能出现爆屏情况</p>
<p>​    mysqldumpslow -s r -t 10 /var/lib/mysql/Heygo-slow.log | more</p>
<h3 id="批量数据脚本"><a href="#批量数据脚本" class="headerlink" title="批量数据脚本"></a>批量数据脚本</h3><p>首先来说明什么是函数和存储过程：</p>
<p>说白了就是用sql脚本语言所写的数据库编程，那么他们两个的区别是：函数需要返回值，存储过程不需要返回值</p>
<p><strong>创建表</strong></p>
<ul>
<li><p>建表sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> dept</span><br><span class="line">(</span><br><span class="line">    deptno <span class="built_in">int</span> <span class="keyword">unsigned</span> primary <span class="keyword">key</span> auto_increment,</span><br><span class="line">    dname <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">default</span> <span class="string">""</span>,</span><br><span class="line">    loc <span class="built_in">varchar</span>(<span class="number">8</span>) <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">default</span> <span class="string">""</span></span><br><span class="line">)<span class="keyword">ENGINE</span>=<span class="keyword">INNODB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> emp</span><br><span class="line">(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">int</span> <span class="keyword">unsigned</span> primary <span class="keyword">key</span> auto_increment,</span><br><span class="line">    empno mediumint <span class="keyword">unsigned</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">default</span> <span class="number">0</span>,</span><br><span class="line">    ename <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">default</span> <span class="string">""</span>,</span><br><span class="line">    job <span class="built_in">varchar</span>(<span class="number">9</span>) <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">default</span> <span class="string">""</span>,</span><br><span class="line">    mgr mediumint <span class="keyword">unsigned</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">default</span> <span class="number">0</span>,</span><br><span class="line">    hiredate <span class="built_in">date</span> <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    sal <span class="built_in">decimal</span>(<span class="number">7</span>,<span class="number">2</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    comm <span class="built_in">decimal</span>(<span class="number">7</span>,<span class="number">2</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">    deptno mediumint <span class="keyword">unsigned</span> <span class="keyword">not</span> <span class="literal">null</span> <span class="keyword">default</span> <span class="number">0</span></span><br><span class="line">)<span class="keyword">ENGINE</span>=<span class="keyword">INNODB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br></pre></td></tr></table></figure>
</li>
<li><p>设置参数</p>
<ul>
<li><p>创建函数，假如报错：This function has none of DETERMINISTIC………</p>
</li>
<li><p>由于开启过慢查询日志，因为我们开启了bin-log，我们就必须为我们的function指定一个参数。</p>
<ul>
<li><code>log_bin_trust_function_creators = OFF</code>，默认必须为 function 传递一个参数</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like 'log_bin_trust_function_creators'; </span><br><span class="line">+<span class="comment">---------------------------------+-------+</span></span><br><span class="line">| Variable_name                   | Value |</span><br><span class="line">+<span class="comment">---------------------------------+-------+</span></span><br><span class="line">| log_bin_trust_function_creators | OFF   |</span><br><span class="line">+<span class="comment">---------------------------------+-------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

<ul>
<li>通过 <code>set global log_bin_trust_function_creators=1;</code>我们可以不用为 function 传参</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global log_bin_trust_function_creators=1; </span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show variables like 'log_bin_trust_function_creators';</span><br><span class="line">+<span class="comment">---------------------------------+-------+</span></span><br><span class="line">| Variable_name                   | Value |</span><br><span class="line">+<span class="comment">---------------------------------+-------+</span></span><br><span class="line">| log_bin_trust_function_creators | ON    |</span><br><span class="line">+<span class="comment">---------------------------------+-------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>这样添加了参数以后，如果mysqld重启，上述参数又会消失，永久方法在配置文件中修改</p>
<p>windows下：my.ini –&gt; [mysqld] 节点下加上 log_bin_trust_function_creators=1<br>linux下：/etc/my.cnf –&gt; [mysqld] 节点下加上 log_bin_trust_function_creators=1</p>
</li>
</ul>
</li>
</ul>
<p><strong>创建函数，保证每条数据都不同</strong></p>
<ul>
<li><p>随机产生字符串的函数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">delimiter $$ </span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> rand_string(n <span class="built_in">int</span>) <span class="keyword">returns</span> <span class="built_in">varchar</span>(<span class="number">255</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">declare</span> chars_str <span class="built_in">varchar</span>(<span class="number">100</span>) <span class="keyword">default</span> <span class="string">'abcdefghijklmnopqrstuvwxyz'</span>;</span><br><span class="line">    <span class="keyword">declare</span> return_str <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">default</span> <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">declare</span> i <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">    while i &lt; n do</span><br><span class="line">        <span class="keyword">set</span> return_str = <span class="keyword">concat</span>(return_str,<span class="keyword">substring</span>(chars_str,<span class="keyword">floor</span>(<span class="number">1</span>+<span class="keyword">rand</span>()*<span class="number">52</span>),<span class="number">1</span>));</span><br><span class="line">        <span class="keyword">set</span> i=i+<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">end</span> <span class="keyword">while</span>;</span><br><span class="line">    return return_str;</span><br><span class="line"><span class="keyword">end</span> $$</span><br></pre></td></tr></table></figure>

<ul>
<li>delimiter $$ 表示mysql语句得使用$$进行结束（默认是使用分号），因为要想执行一连串的sql语句，不能使用分号作为sql语句的结束符，否则执行一句就会结束</li>
</ul>
</li>
<li><p>随机产生部门编号的函数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">function</span> rand_num() <span class="keyword">returns</span> <span class="built_in">int</span>(<span class="number">5</span>)</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">declare</span> i <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">set</span> i=<span class="keyword">floor</span>(<span class="number">100</span>+<span class="keyword">rand</span>()*<span class="number">10</span>);</span><br><span class="line">    return i;</span><br><span class="line"><span class="keyword">end</span> $$</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>创建存储过程</strong></p>
<ul>
<li><p>创建往emp表中插入数据的存储过程</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> insert_emp(<span class="keyword">in</span> <span class="keyword">start</span> <span class="built_in">int</span>(<span class="number">10</span>),<span class="keyword">in</span> max_num <span class="built_in">int</span>(<span class="number">10</span>))</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">declare</span> i <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">set</span> autocommit = <span class="number">0</span>;</span><br><span class="line">    repeat</span><br><span class="line">        <span class="keyword">set</span> i = i+<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">insert</span> <span class="keyword">into</span> emp(empno,ename,job,mgr,hiredate,sal,comm,deptno) <span class="keyword">values</span>((<span class="keyword">start</span>+i),rand_string(<span class="number">6</span>),<span class="string">'salesman'</span>,<span class="number">0001</span>,<span class="keyword">curdate</span>(),<span class="number">2000</span>,<span class="number">400</span>,rand_num());</span><br><span class="line">        until i=max_num</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">repeat</span>;</span><br><span class="line">    <span class="keyword">commit</span>;</span><br><span class="line"><span class="keyword">end</span> $$</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建往dept表中插入数据的存储过程</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">delimiter $$</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">procedure</span> insert_dept(<span class="keyword">in</span> <span class="keyword">start</span> <span class="built_in">int</span>(<span class="number">10</span>),<span class="keyword">in</span> max_num <span class="built_in">int</span>(<span class="number">10</span>))</span><br><span class="line"><span class="keyword">begin</span></span><br><span class="line">    <span class="keyword">declare</span> i <span class="built_in">int</span> <span class="keyword">default</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">set</span> autocommit = <span class="number">0</span>;</span><br><span class="line">    repeat</span><br><span class="line">        <span class="keyword">set</span> i = i+<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">insert</span> <span class="keyword">into</span> dept(deptno,dname,loc) <span class="keyword">values</span>((<span class="keyword">start</span>+i),rand_string(<span class="number">10</span>),rand_string(<span class="number">8</span>));</span><br><span class="line">        until i=max_num</span><br><span class="line">        <span class="keyword">end</span> <span class="keyword">repeat</span>;</span><br><span class="line">    <span class="keyword">commit</span>;</span><br><span class="line"><span class="keyword">end</span> $$</span><br></pre></td></tr></table></figure>

<ul>
<li>这里为什么要<code>set autocommit = 0;</code>这是因为mysql中更新操作默认是自动提交的</li>
</ul>
</li>
</ul>
<p><strong>调用存储过程</strong></p>
<ul>
<li><p>向 dept 表中插入 10 条记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER ;</span><br><span class="line"><span class="keyword">CALL</span> insert_dept(<span class="number">100</span>, <span class="number">10</span>);</span><br></pre></td></tr></table></figure>



</li>
</ul>
<h3 id="showProfile"><a href="#showProfile" class="headerlink" title="showProfile"></a>showProfile</h3><p><strong>是什么？</strong></p>
<ol>
<li>了解SQL执行的线程的状态及资源消耗情况，可以用于SQL的调优测量</li>
<li>默认情况下，参数处于关闭状态，并保存最近15次的运行结果</li>
</ol>
<p><strong>分析步骤：</strong></p>
<ul>
<li><p>查看当前sql版本是否支持show profile</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show variables like 'profiling%';</span><br><span class="line">+<span class="comment">------------------------+-------+</span></span><br><span class="line">| Variable_name          | Value |</span><br><span class="line">+<span class="comment">------------------------+-------+</span></span><br><span class="line">| profiling              | OFF   |</span><br><span class="line">| profiling_history_size | 15    |</span><br><span class="line">+<span class="comment">------------------------+-------+</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>开启功能show profile，版本稍低的一般是默认关闭的，使用前需要开启。并且profile一般是保存15条sql记录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set profiling=on; </span><br><span class="line">Query OK, 0 rows affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; show variables like 'profiling%';</span><br><span class="line">+<span class="comment">------------------------+-------+</span></span><br><span class="line">| Variable_name          | Value |</span><br><span class="line">+<span class="comment">------------------------+-------+</span></span><br><span class="line">| profiling              | ON    |</span><br><span class="line">| profiling_history_size | 15    |</span><br><span class="line">+<span class="comment">------------------------+-------+</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>运行sql</p>
<ul>
<li><p>正常的sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tbl_emp;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tbl_emp e <span class="keyword">inner</span> <span class="keyword">join</span> tbl_dept d <span class="keyword">on</span> e.deptId = d.id;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> tbl_emp e <span class="keyword">left</span> <span class="keyword">join</span> tbl_dept d <span class="keyword">on</span> e.deptId = d.id;</span><br></pre></td></tr></table></figure>
</li>
<li><p>慢sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">id</span>%<span class="number">10</span> <span class="keyword">limit</span> <span class="number">150000</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">id</span>%<span class="number">10</span> <span class="keyword">limit</span> <span class="number">150000</span>;</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">id</span>%<span class="number">20</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">5</span>;</span><br></pre></td></tr></table></figure>

<p>%10 20只是对id进行求模，为了展示慢</p>
</li>
</ul>
</li>
</ul>
<ul>
<li><p>查看结果<code>show profiles;</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show profiles;</span><br><span class="line">+<span class="comment">----------+------------+----------------------------------------------------------------------+</span></span><br><span class="line">| Query_ID | Duration   | Query                                                                |</span><br><span class="line">+<span class="comment">----------+------------+----------------------------------------------------------------------+</span></span><br><span class="line">|        1 | 0.00052700 | <span class="keyword">show</span> <span class="keyword">variables</span> <span class="keyword">like</span> <span class="string">'profiling%'</span>                                     |</span><br><span class="line">|        <span class="number">2</span> | <span class="number">0.00030300</span> | <span class="keyword">select</span> * <span class="keyword">from</span> tbl_emp                                                |</span><br><span class="line">|        <span class="number">3</span> | <span class="number">0.00010650</span> | <span class="keyword">select</span> * <span class="keyword">from</span> tbl_emp e <span class="keyword">inner</span> <span class="keyword">join</span> tbl_dept d <span class="keyword">on</span> e.<span class="string">'deptId'</span> = d.<span class="string">'id'</span> |</span><br><span class="line">|        <span class="number">4</span> | <span class="number">0.00031625</span> | <span class="keyword">select</span> * <span class="keyword">from</span> tbl_emp e <span class="keyword">inner</span> <span class="keyword">join</span> tbl_dept d <span class="keyword">on</span> e.deptId = d.id     |</span><br><span class="line">|        <span class="number">5</span> | <span class="number">0.00042100</span> | <span class="keyword">select</span> * <span class="keyword">from</span> tbl_emp e <span class="keyword">left</span> <span class="keyword">join</span> tbl_dept d <span class="keyword">on</span> e.deptId = d.id      |</span><br><span class="line">|        <span class="number">6</span> | <span class="number">0.38621875</span> | <span class="keyword">select</span> * <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">id</span>%<span class="number">20</span> <span class="keyword">limit</span> <span class="number">150000</span>                        |</span><br><span class="line">|        <span class="number">7</span> | <span class="number">0.00014900</span> | <span class="keyword">select</span> * <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">id</span>%<span class="number">20</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">150000</span>                     |</span><br><span class="line">|        <span class="number">8</span> | <span class="number">0.38649000</span> | <span class="keyword">select</span> * <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">id</span>%<span class="number">20</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">5</span>                          |</span><br><span class="line">|        <span class="number">9</span> | <span class="number">0.06782700</span> | <span class="keyword">select</span> <span class="keyword">COUNT</span>(*) <span class="keyword">from</span> emp                                             |</span><br><span class="line">|       <span class="number">10</span> | <span class="number">0.35434400</span> | <span class="keyword">select</span> * <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">id</span>%<span class="number">10</span> <span class="keyword">limit</span> <span class="number">150000</span>                        |</span><br><span class="line">+<span class="comment">----------+------------+----------------------------------------------------------------------+</span></span><br></pre></td></tr></table></figure>



</li>
</ul>
<ul>
<li><p><strong>诊断SQL</strong></p>
<p><code>show profile cpu, block io for query SQL编号;</code> 查看 SQL 语句执行的具体流程以及每个步骤花费的时间，常用的参数是cpu和block io</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show profile cpu, block io for query 2;</span><br><span class="line">+<span class="comment">----------------------+----------+----------+------------+--------------+---------------+</span></span><br><span class="line">| Status               | Duration | CPU_user | CPU_system | Block_ops_in | Block_ops_out |</span><br><span class="line">+<span class="comment">----------------------+----------+----------+------------+--------------+---------------+</span></span><br><span class="line">| starting             | 0.000055 | 0.000000 |   0.000000 |            0 |             0 |</span><br><span class="line">| checking permissions | 0.000007 | 0.000000 |   0.000000 |            0 |             0 |</span><br><span class="line">| Opening tables       | 0.000011 | 0.000000 |   0.000000 |            0 |             0 |</span><br><span class="line">| init                 | 0.000024 | 0.000000 |   0.000000 |            0 |             0 |</span><br><span class="line">| System <span class="keyword">lock</span>          | <span class="number">0.000046</span> | <span class="number">0.000000</span> |   <span class="number">0.000000</span> |            <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| optimizing           | <span class="number">0.000018</span> | <span class="number">0.000000</span> |   <span class="number">0.000000</span> |            <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="keyword">statistics</span>           | <span class="number">0.000008</span> | <span class="number">0.000000</span> |   <span class="number">0.000000</span> |            <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| preparing            | <span class="number">0.000019</span> | <span class="number">0.000000</span> |   <span class="number">0.000000</span> |            <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| executing            | <span class="number">0.000003</span> | <span class="number">0.000000</span> |   <span class="number">0.000000</span> |            <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| Sending <span class="keyword">data</span>         | <span class="number">0.000089</span> | <span class="number">0.000000</span> |   <span class="number">0.000000</span> |            <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="keyword">end</span>                  | <span class="number">0.000004</span> | <span class="number">0.000000</span> |   <span class="number">0.000000</span> |            <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| <span class="keyword">query</span> <span class="keyword">end</span>            | <span class="number">0.000003</span> | <span class="number">0.000000</span> |   <span class="number">0.000000</span> |            <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| closing <span class="keyword">tables</span>       | <span class="number">0.000005</span> | <span class="number">0.000000</span> |   <span class="number">0.000000</span> |            <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| freeing items        | <span class="number">0.000006</span> | <span class="number">0.000000</span> |   <span class="number">0.000000</span> |            <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">| cleaning up          | <span class="number">0.000006</span> | <span class="number">0.000000</span> |   <span class="number">0.000000</span> |            <span class="number">0</span> |             <span class="number">0</span> |</span><br><span class="line">+<span class="comment">----------------------+----------+----------+------------+--------------+---------------+</span></span><br></pre></td></tr></table></figure>

<ul>
<li>其余参数<ol>
<li>ALL：显示所有的开销信息</li>
<li>BLOCK IO：显示块IO相关开销</li>
<li>CONTEXT SWITCHES：上下文切换相关开销</li>
<li>CPU：显示CPU相关开销信息</li>
<li>IPC：显示发送和接收相关开销信息</li>
<li>MEMORY：显示内存相关开销信息</li>
<li>PAGE FAULTS：显示页面错误相关开销信息</li>
<li>SOURCE：显示和Source_function，Source_file，Source_line相关的开销信息</li>
<li>SWAPS：显示交换次数相关开销的信息</li>
</ol>
</li>
</ul>
</li>
<li><p><strong>结论</strong>（如果status中出现了以下4个，便是有很大问题了）</p>
<ol>
<li>converting HEAP to MyISAM：查询结果太大，内存都不够用了往磁盘上搬了。</li>
<li>Creating tmp table：创建临时表，mysql 先将拷贝数据到临时表，然后用完再将临时表删除</li>
<li>Copying to tmp table on disk：把内存中临时表复制到磁盘，危险！！！</li>
<li>locked：锁表</li>
</ol>
</li>
</ul>
<h3 id="全局查询日志"><a href="#全局查询日志" class="headerlink" title="全局查询日志"></a>全局查询日志</h3><p><strong>永远不要在生产环境开启这个功能。</strong></p>
<ol>
<li><p>在mysql的my.cnf中，设置如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 开启</span></span><br><span class="line">general_log=1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 记录日志文件的路径</span></span><br><span class="line">general_log_file=/path/logfile</span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出格式</span></span><br><span class="line">log_output=FILE</span><br></pre></td></tr></table></figure>
</li>
<li><p>命令行启用全局查询日志</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> general_log=<span class="number">1</span>;</span><br><span class="line"><span class="keyword">set</span> <span class="keyword">global</span> log_output=<span class="string">'TABLE'</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>你所执行的sql语句，将会记录到mysql库里的general_log表，可以用下面的命令查看</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from mysql.general_log;</span><br><span class="line">+<span class="comment">---------------------+---------------------------+-----------+-----------+--------------+-----------------------------------------------+</span></span><br><span class="line">| event_time          | user_host                 | thread_id | server_id | command_type | argument                                      |</span><br><span class="line">+<span class="comment">---------------------+---------------------------+-----------+-----------+--------------+-----------------------------------------------+</span></span><br><span class="line">| 2020-08-05 14:41:07 | root[root] @ localhost [] |        14 |         0 | Query        | <span class="keyword">select</span> * <span class="keyword">from</span> emp <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">id</span>%<span class="number">10</span> <span class="keyword">limit</span> <span class="number">150000</span> |</span><br><span class="line">| <span class="number">2020</span><span class="number">-08</span><span class="number">-05</span> <span class="number">14</span>:<span class="number">41</span>:<span class="number">12</span> | root[root] @ localhost [] |        <span class="number">14</span> |         <span class="number">0</span> | <span class="keyword">Query</span>        | <span class="keyword">select</span> <span class="keyword">COUNT</span>(*) <span class="keyword">from</span> emp                      |</span><br><span class="line">| <span class="number">2020</span><span class="number">-08</span><span class="number">-05</span> <span class="number">14</span>:<span class="number">41</span>:<span class="number">30</span> | root[root] @ localhost [] |        <span class="number">14</span> |         <span class="number">0</span> | <span class="keyword">Query</span>        | <span class="keyword">select</span> * <span class="keyword">from</span> mysql.general_log               |</span><br><span class="line">+<span class="comment">---------------------+---------------------------+-----------+-----------+--------------+-----------------------------------------------+</span></span><br><span class="line"><span class="number">3</span> <span class="keyword">rows</span> <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

</li>
</ol>
<h2 id="SQL优化一般步骤"><a href="#SQL优化一般步骤" class="headerlink" title="SQL优化一般步骤"></a>SQL优化一般步骤</h2><ol>
<li>通过慢查日志等定位那些执行效率较低的SQL语句</li>
<li>explain 分析SQL的执行计划，需要重点关注type、rows、filtered、extra。</li>
<li>show profile 分析</li>
<li>确定问题并采用相应的措施</li>
</ol>
<h2 id="mysql锁机制"><a href="#mysql锁机制" class="headerlink" title="mysql锁机制"></a>mysql锁机制</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><h4 id="锁的定义"><a href="#锁的定义" class="headerlink" title="锁的定义"></a>锁的定义</h4><p>锁是计算机协调多个进程或线程并发访问某一资源的机制。<br>在数据库中，除传统的计算资源（如CPU、RAM、I/O等）的争用以外，数据也是一种供许多用户共享的资源。<br>如何保证数据并发访问的一致性、有效性是所有数据库必须解决的一个问题，锁冲突也是影响数据库并发访问性能的一个重要因素。<br>从这个角度来说，锁对数据库而言显得尤其重要，也更加复杂。</p>
<h4 id="锁的分类"><a href="#锁的分类" class="headerlink" title="锁的分类"></a>锁的分类</h4><ol>
<li>从数据操作的类型（读、写）分<ul>
<li><strong>读锁</strong>（共享锁）：针对同一份数据，多个读操作可以同时进行而不会互相影响</li>
<li><strong>写锁</strong>（排它锁）：当前写操作没有完成前，它会阻断其他写锁和读锁。</li>
</ul>
</li>
<li>从对数据操作的颗粒度<ul>
<li>表锁</li>
<li>行锁</li>
</ul>
</li>
</ol>
<h3 id="表锁"><a href="#表锁" class="headerlink" title="表锁"></a>表锁</h3><p>特点：</p>
<p>偏向MyISAM存储引擎，开销小，加锁快，无死锁，锁定粒度大，发生锁冲突的概率最高，并发最低</p>
<h4 id="案列"><a href="#案列" class="headerlink" title="案列"></a>案列</h4><p><strong>创建表：</strong></p>
<ul>
<li><p>建表sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> mylock (</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">int</span> <span class="keyword">not</span> <span class="literal">null</span> primary <span class="keyword">key</span> auto_increment,</span><br><span class="line">    <span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">default</span> <span class="string">''</span></span><br><span class="line">) <span class="keyword">engine</span> myisam;</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> mylock(<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="string">'a'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> mylock(<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="string">'b'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> mylock(<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="string">'c'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> mylock(<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="string">'d'</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> mylock(<span class="keyword">name</span>) <span class="keyword">values</span>(<span class="string">'e'</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>mylock 表中的测试数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from mylock;</span><br><span class="line">+<span class="comment">----+------+</span></span><br><span class="line">| id | name |</span><br><span class="line">+<span class="comment">----+------+</span></span><br><span class="line">|  1 | a    |</span><br><span class="line">|  2 | b    |</span><br><span class="line">|  3 | c    |</span><br><span class="line">|  4 | d    |</span><br><span class="line">|  5 | e    |</span><br><span class="line">+<span class="comment">----+------+</span></span><br><span class="line">5 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>加锁和释放锁</strong></p>
<ul>
<li>查看当前数据库中表的上锁情况：<code>show open tables;</code>，In_use 中的0 表示未上锁</li>
<li>添加锁<code>lock table 表名1 read(write), 表名2 read(write), ...;</code></li>
<li>释放锁<code>unlock tables;</code></li>
</ul>
<p><strong>读锁</strong></p>
<ul>
<li><p>在 session 1 会话中：给 mylock 表加个读锁</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">lock</span> <span class="keyword">table</span> mylock <span class="keyword">read</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 session1 会话中：可以读取mylock表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--session1 中的操作</span></span><br><span class="line">mysql&gt; select * from mylock;</span><br><span class="line">+<span class="comment">----+------+</span></span><br><span class="line">| id | name |</span><br><span class="line">+<span class="comment">----+------+</span></span><br><span class="line">|  1 | a    |</span><br><span class="line">|  2 | b    |</span><br><span class="line">|  3 | c    |</span><br><span class="line">|  4 | d    |</span><br><span class="line">|  5 | e    |</span><br><span class="line">+<span class="comment">----+------+</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在 session1 会话中：不能读取 book 表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--session1 中的操作</span></span><br><span class="line"></span><br><span class="line">mysql&gt; select * from book;</span><br><span class="line">ERROR 1100 (HY000): Table 'book' was not locked <span class="keyword">with</span> <span class="keyword">LOCK</span> <span class="keyword">TABLES</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在 session2 会话中：可以读取 mylock 表和book表的</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- session2 中的操作</span></span><br><span class="line">mysql&gt; select * from mylock;</span><br><span class="line">+<span class="comment">----+------+</span></span><br><span class="line">| id | name |</span><br><span class="line">+<span class="comment">----+------+</span></span><br><span class="line">|  1 | a    |</span><br><span class="line">|  2 | b    |</span><br><span class="line">|  3 | c    |</span><br><span class="line">|  4 | d    |</span><br><span class="line">|  5 | e    |</span><br><span class="line">+<span class="comment">----+------+</span></span><br><span class="line">5 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 session1 会话中：不能修改 mylock 表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--session1 中的操作</span></span><br><span class="line"></span><br><span class="line">mysql&gt; update mylock set name='a2' where id=1;</span><br><span class="line">ERROR 1099 (HY000): Table 'mylock' was locked <span class="keyword">with</span> a <span class="keyword">READ</span> <span class="keyword">lock</span> <span class="keyword">and</span> can<span class="string">'t be updated</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在 session2 会话中：暂时不能修改 mylock 表，处于阻塞态，一旦 mylock 表锁释放，则会执行修改操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--session2 中的操作 </span></span><br><span class="line"></span><br><span class="line">mysql&gt; update mylock set name='a2' where id=1;</span><br><span class="line"><span class="comment">--这里的结果是暂时没有反应的，处于阻塞态，如果再session1中将mylock表解锁，这里便会执行了</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>结论</strong></p>
<ol>
<li>当前 session 和其他 session 均可以读取加了读锁的表</li>
<li>当前 session 不能读取其他表，并且不能修改加了读锁的表</li>
<li>其他 session 想要修改加了读锁的表，必须等待其读锁释放</li>
</ol>
<p><strong>写锁</strong></p>
<ul>
<li><p>在 session 1 会话中：给 mylock 表加个写锁</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; lock table mylock write;</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 session1 会话中：可以读取 mylock 表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--session1 中的操作</span></span><br><span class="line"></span><br><span class="line">mysql&gt; select * from mylock;</span><br><span class="line">+<span class="comment">----+------+</span></span><br><span class="line">| id | name |</span><br><span class="line">+<span class="comment">----+------+</span></span><br><span class="line">|  1 | a2   |</span><br><span class="line">|  2 | b    |</span><br><span class="line">|  3 | c    |</span><br><span class="line">|  4 | d    |</span><br><span class="line">|  5 | e    |</span><br><span class="line">+<span class="comment">----+------+</span></span><br><span class="line">5 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 session1 会话中：不可以读取 book 表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--session1 中的操作</span></span><br><span class="line">mysql&gt; select * from book;</span><br><span class="line">ERROR 1100 (HY000): Table 'book' was not locked <span class="keyword">with</span> <span class="keyword">LOCK</span> <span class="keyword">TABLES</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在 session1 会话中：考研修改 mylock 表，因为加写锁就是为了修改</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--session1 中的操作</span></span><br><span class="line">mysql&gt; update mylock set name='a2' where id=1;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line">Rows matched: 1  Changed: 0  Warnings: 0</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 session2 会话中：不可以读取 mylock 表</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--session2 中的操作</span></span><br><span class="line"></span><br><span class="line">mysql&gt; select * from mylock;</span><br><span class="line">-阻塞</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>结论：</strong></p>
<ol>
<li>当前 session 可以读取和修改加了写锁的表</li>
<li>当前 session 不能读取其他表</li>
<li>其他 session 想要读取加了写锁的表，必须等待其读锁释放</li>
</ol>
<p><strong>总结：</strong>结合上述案例，所以对MyISAM表进行操作，会有以下情况：</p>
<ol>
<li>对MyISAM表的读操作（加读锁），不会阻塞其他进程对同一表的读请求，但会阻塞对同一表的写请求。只有当读锁释放后，才会执行其它进程的写操作。</li>
<li>对MyISAM表的写操作（加写锁），会阻塞其他进程对同一表的读和写操作，只有当写锁释放后，才会执行其它进程的读写操作</li>
<li><strong>简而言之，就是读锁会阻塞写，但是不会堵塞读。而写锁则会把读和写都堵塞。</strong></li>
</ol>
<h4 id="表锁分析"><a href="#表锁分析" class="headerlink" title="表锁分析"></a>表锁分析</h4><p>通过 show status like ‘table%’; 命令查看，检查table_locks_waited和table_locks_immediate状态变量来分析系统上的表锁定。</p>
<ul>
<li>Table_locks_immediate：产生表级锁定的次数，表示可以立即获取锁的查询次数，每立即获取锁值加1；</li>
<li>Table_locks_waited：出现表级锁定争用而发生等待的次数（不能立即获取锁的次数，每等待一次锁值加1），此值高则说明存在着较严重的表级锁争用情况；</li>
</ul>
<p><strong>此外，Myisam的读写锁调度是写优先，这也是myisam不适合做写为主表的引擎（偏读）。因为写锁后，其他线程不能做任何操作，大量的更新会使查询很难得到锁，从而造成永远阻塞</strong></p>
<h3 id="行锁"><a href="#行锁" class="headerlink" title="行锁"></a>行锁</h3><p>特点：</p>
<ol>
<li>偏向InnoDB存储引擎，开销大，加锁慢；会出现死锁；锁定粒度最小，发生锁冲突的概率最低，并发度也最高。</li>
<li>InnoDB与MyISAM的最大不同有两点：一是支持事务（TRANSACTION）；二是采用了行级锁</li>
</ol>
<h4 id="案例："><a href="#案例：" class="headerlink" title="案例："></a>案例：</h4><p><strong>创建表</strong></p>
<ul>
<li><p>建表sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> test_innodb_lock (a <span class="built_in">INT</span>(<span class="number">11</span>),b <span class="built_in">VARCHAR</span>(<span class="number">16</span>))<span class="keyword">ENGINE</span>=<span class="keyword">INNODB</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_innodb_lock <span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="string">'b2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_innodb_lock <span class="keyword">VALUES</span>(<span class="number">3</span>,<span class="string">'3'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_innodb_lock <span class="keyword">VALUES</span>(<span class="number">4</span>, <span class="string">'4000'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_innodb_lock <span class="keyword">VALUES</span>(<span class="number">5</span>,<span class="string">'5000'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_innodb_lock <span class="keyword">VALUES</span>(<span class="number">6</span>, <span class="string">'6000'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_innodb_lock <span class="keyword">VALUES</span>(<span class="number">7</span>,<span class="string">'7000'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_innodb_lock <span class="keyword">VALUES</span>(<span class="number">8</span>, <span class="string">'8000'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_innodb_lock <span class="keyword">VALUES</span>(<span class="number">9</span>,<span class="string">'9000'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> test_innodb_lock <span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="string">'b1'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> test_innodb_a_ind <span class="keyword">ON</span> test_innodb_lock(a);</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> test_innodb_lock_b_ind <span class="keyword">ON</span> test_innodb_lock(b);</span><br></pre></td></tr></table></figure>
</li>
<li><p>test_innodb_lock 表中的测试数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from test_innodb_lock;</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">| a    | b    |</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">|    1 | b2   |</span><br><span class="line">|    3 | 3    |</span><br><span class="line">|    4 | 4000 |</span><br><span class="line">|    5 | 5000 |</span><br><span class="line">|    6 | 6000 |</span><br><span class="line">|    7 | 7000 |</span><br><span class="line">|    8 | 8000 |</span><br><span class="line">|    9 | 9000 |</span><br><span class="line">|    1 | b1   |</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">9 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>操作同一行数据</strong></p>
<ul>
<li><p>session1 开启事务，修改 test_innodb_lock 中的数据</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set autocommit=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; update test_innodb_lock set b='4001' where a=4;</span><br></pre></td></tr></table></figure>
</li>
<li><p>session2 开启事务，修改 test_innodb_lock 中同一行数据，将导致 session2 发生阻塞，一旦 session1 提交事务，session2 将执行更新操作</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set autocommit=0;</span><br><span class="line"></span><br><span class="line">mysql&gt; update test_innodb_lock set b='4002' where a=4;</span><br><span class="line"><span class="comment"># 阻塞</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 时间太长，会报超时错误</span></span><br><span class="line">mysql&gt; update test_innodb_lock set b='4001' where a=4;</span><br><span class="line">ERROR 1205 (HY000): <span class="keyword">Lock</span> <span class="keyword">wait</span> <span class="keyword">timeout</span> exceeded; try restarting transaction</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>操作不同行的操作</strong></p>
<ul>
<li><p>session1 开启事务，修改 test_innodb_lock 中的数据</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set autocommit=0;</span><br><span class="line"></span><br><span class="line">mysql&gt; update test_innodb_lock set b='4001' where a=4;</span><br></pre></td></tr></table></figure>
</li>
<li><p>session2 开启事务，修改 test_innodb_lock 中不同行的数据</p>
<p>由于采用行锁，session2 和 session1 互不干涉，所以 session2 中的修改操作没有阻塞</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set autocommit=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; update test_innodb_lock set b='9001' where a=9;</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>无索引导致行锁升级为表锁</strong></p>
<ul>
<li><p>session1 开启事务，修改 test_innodb_lock 中的数据，varchar 不用 ’ ’ ，导致系统自动转换类型，导致索引失效</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set autocommit=0;</span><br><span class="line"></span><br><span class="line">mysql&gt; update test_innodb_lock set a=44 where b=4000;</span><br></pre></td></tr></table></figure>
</li>
<li><p>session2 开启事务，修改 test_innodb_lock 中不同行的数据，由于发生了自动类型转换，索引失效，导致行锁变为表锁</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set autocommit=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; update test_innodb_lock set b='9001' where a=9;</span><br><span class="line"><span class="comment">--阻塞</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="间隙锁"><a href="#间隙锁" class="headerlink" title="间隙锁"></a>间隙锁</h4><p><strong>什么是？</strong></p>
<ol>
<li>当我们用范围条件而不是相等条件检索数据，并请求共享或排他锁时，InnoDB会给符合条件的已有数据记录的索引项加锁；对于键值在条件范围内但并不存在的记录，叫做“间隙（GAP）”</li>
<li>InnoDB也会对这个“间隙”加锁，这种锁机制是所谓的间隙锁（Next-Key锁）</li>
</ol>
<p><strong>危害：</strong></p>
<p>因为Query执行过程中通过过范围查找的话，他会锁定整个范围内所有的索引键值，即使这个键值并不存在。<br>间隙锁有一个比较致命的弱点，就是当锁定一个范围键值之后，即使某些不存在的键值也会被无辜的锁定，而造成在锁定的时候无法插入锁定键值范围内的任何数据。在某些场景下这可能会对性能造成很大的危害</p>
<p><strong>案例：</strong></p>
<ul>
<li><p>test_innodb_lock 表中的数据</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; select * from test_innodb_lock;</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">| a    | b    |</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">|    1 | b2   |</span><br><span class="line">|    3 | 3    |</span><br><span class="line">|    4 | 4000 |</span><br><span class="line">|    5 | 5000 |</span><br><span class="line">|    6 | 6000 |</span><br><span class="line">|    7 | 7000 |</span><br><span class="line">|    8 | 8000 |</span><br><span class="line">|    9 | 9000 |</span><br><span class="line">|    1 | b1   |</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">9 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>session1 开启事务，执行修改 a &gt; 1 and a &lt; 6 的数据，这会导致 mysql 将 a = 2 的数据行锁住（虽然表中并没有这行数据）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set autocommit=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; update test_innodb_lock set b='Heygo' where a&gt;1 and a&lt;6;</span><br><span class="line">Query OK, 3 rows affected (0.00 sec)</span><br><span class="line">Rows matched: 3  Changed: 3  Warnings: 0</span><br></pre></td></tr></table></figure>
</li>
<li><p>session2 开启事务，修改 test_innodb_lock 中不同行的数据，也会导致阻塞，直至 session1 提交事务</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set autocommit=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; update test_innodb_lock set b='9001' where a=9;</span><br><span class="line"><span class="comment">--阻塞</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="手动行锁（悲观锁）"><a href="#手动行锁（悲观锁）" class="headerlink" title="手动行锁（悲观锁）"></a>手动行锁（悲观锁）</h4><p>如何锁定一行</p>
<ul>
<li><p><code>select xxx ... for update</code> 锁定某一行后，其它的操作会被阻塞，直到锁定行的会话提交</p>
</li>
<li><p>session1 开启事务，手动执行 for update 锁定指定行，待执行完指定操作时再将数据提交</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set autocommit=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; select * from test_innodb_lock  where a=8 for update;</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">| a    | b    |</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">|    8 | 8000 |</span><br><span class="line">+<span class="comment">------+------+</span></span><br><span class="line">1 row in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>
</li>
<li><p>session2 开启事务，修改 session1 中被锁定的行，会导致阻塞，直至 session1 提交事务</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set autocommit=0;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; update test_innodb_lock set b='XXX' where a=8;</span><br><span class="line"><span class="comment">--阻塞</span></span><br></pre></td></tr></table></figure>

</li>
</ul>
<h4 id="行锁分析"><a href="#行锁分析" class="headerlink" title="行锁分析"></a>行锁分析</h4><ol>
<li>Innodb存储引擎由于实现了行级锁定，虽然在锁定机制的实现方面所带来的性能损耗可能比表级锁定会要更高一些，但是在整体并发处理能力方面要远远优于MyISAM的表级锁定的。</li>
<li>当系统并发量较高的时候，Innodb的整体性能和MyISAM相比就会有比较明显的优势了。</li>
<li>但是，Innodb的行级锁定同样也有其脆弱的一面，当我们使用不当的时候（索引失效，导致行锁变表锁），可能会让Innodb的整体性能表现不仅不能比MyISAM高，甚至可能会更差。</li>
</ol>
<p><strong>如何分析行锁定</strong></p>
<ul>
<li><p>通过检查InnoDB_row_lock状态变量来分析系统上的行锁的争夺情况<code>show status like &#39;innodb_row_lock%&#39;;</code></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show status like 'innodb_row_lock%';</span><br><span class="line">+<span class="comment">-------------------------------+--------+</span></span><br><span class="line">| Variable_name                 | Value  |</span><br><span class="line">+<span class="comment">-------------------------------+--------+</span></span><br><span class="line">| Innodb_row_lock_current_waits | 0      |</span><br><span class="line">| Innodb_row_lock_time          | 212969 |</span><br><span class="line">| Innodb_row_lock_time_avg      | 42593  |</span><br><span class="line">| Innodb_row_lock_time_max      | 51034  |</span><br><span class="line">| Innodb_row_lock_waits         | 5      |</span><br><span class="line">+<span class="comment">-------------------------------+--------+</span></span><br><span class="line">5 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure>

</li>
</ul>
<p><strong>对各个状态量的说明如下：</strong></p>
<ol>
<li>Innodb_row_lock_current_waits：当前正在等待锁定的数量；</li>
<li>Innodb_row_lock_time：从系统启动到现在锁定总时间长度；</li>
<li>Innodb_row_lock_time_avg：每次等待所花平均时间；</li>
<li>Innodb_row_lock_time_max：从系统启动到现在等待最常的一次所花的时间；</li>
<li>Innodb_row_lock_waits：系统启动后到现在总共等待的次数；</li>
</ol>
<p><strong>对于这5个状态变量，比较重要的主要是</strong></p>
<ol>
<li>Innodb_row_lock_time_avg（等待平均时长）</li>
<li>Innodb_row_lock_waits（等待总次数）</li>
<li>Innodb_row_lock_time（等待总时长）</li>
</ol>
<p><strong>行锁优化</strong></p>
<ol>
<li>尽可能让所有数据检索都通过索引来完成，避免无索引行锁升级为表锁</li>
<li>合理设计索引，尽量缩小锁的范围</li>
<li>尽可能较少检索条件，避免间隙锁</li>
<li>尽量控制事务大小，减少锁定资源量和时间长度</li>
<li>尽可能低级别事务隔离</li>
</ol>
<h2 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h2><h3 id="复制的基本原理"><a href="#复制的基本原理" class="headerlink" title="复制的基本原理"></a><strong>复制的基本原理</strong></h3><ol>
<li>slave会从master读取binlog来进行数据同步，主从复制的三步骤</li>
<li>master将改变记录到二进制日志（binary log）。这些记录过程叫做二进制日志事件（binary log events）</li>
<li>slave将master的binary log events拷贝到它的中继日志（relay log）</li>
<li>slave重做中继日志中的事件，将改变应用到自己的数据库中。MySQL复制是异步的且串行化的</li>
</ol>
<h3 id="复制的基本原则"><a href="#复制的基本原则" class="headerlink" title="复制的基本原则"></a>复制的基本原则</h3><ol>
<li>每个slave只有一个master</li>
<li>每个slave只能有一个唯一的服务器ID</li>
<li>每个master可以有多个salve</li>
</ol>
<h3 id="复制最大问题"><a href="#复制最大问题" class="headerlink" title="复制最大问题"></a>复制最大问题</h3><p>因为发生多次 IO， 存在延时问题</p>

      <blockquote class="mdui-m-t-5">
        
          <strong>本文遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">CC BY-NC-SA 4.0</a> 许可协议，转载请附上原文出处链接和本声明。</strong><br>
        
        <strong>本文链接：</strong><a href="https://yellowbp.github.io/2021/03/02/mysql优化/">https://yellowbp.github.io/2021/03/02/mysql优化/</a>
      </blockquote>
      
    </div>
    <footer class="mdui-card-actions">
      
        <a class="mdui-ripple article_categories-link" href="/categories/数据库/">数据库</a>
      
      
        <a class="mdui-ripple article_tags-link" href="/tags/mysql/">mysql</a>
      
    </footer>
    
  </article>
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdn.bootcss.com/fancybox/3.5.7/jquery.fancybox.min.js"></script>
  <script>$("#main article .mdui-card-content img.fancybox").on("click",function(e){$.fancybox.open({src:$(this).attr("src")});});</script>


  <nav id="paginator">
    
      <a rel="prev" class="extend prev" href="/2021/03/10/redis/">
        <button aria-label="prev" class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_back</i></button>
        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;上一篇
      </a>
    
    <div class="spacer"></div>
    
      <a rel="next" class="extend next" href="/2021/02/19/ssm整合/">
        下一篇&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <button aria-label="next" class="mdui-btn mdui-btn-raised mdui-btn-dense mdui-btn-icon mdui-color-theme-accent mdui-ripple"><i class="mdui-icon material-icons">arrow_forward</i></button>
      </a>
    
  </nav>


  <div id="comment" class="mdui-m-t-5">
    <style>#pop_ad,#feedAv{display:none!important;position:absolute!important;z-index:-9999;left:-1000px;opacity:0!important}</style>
<div id="SOHUCS" sid="ckrq4sppv0065sctwf05j10ul"></div>
<script type="text/javascript">
(function(){
var appid = 'cyubhC2Dq';
var conf = 'prod_e4cce65003c5bed049fefcb8a6f09e12';
var width = window.innerWidth || document.documentElement.clientWidth;
if (width < 960) {
window.document.write('<script id="changyan_mobile_js" charset="utf-8" type="text/javascript" src="http://changyan.sohu.com/upload/mobile/wap-js/changyan_mobile.js?client_id=' + appid + '&conf=' + conf + '"><\/script>'); } else { var loadJs=function(d,a){var c=document.getElementsByTagName("head")[0]||document.head||document.documentElement;var b=document.createElement("script");b.setAttribute("type","text/javascript");b.setAttribute("charset","UTF-8");b.setAttribute("src",d);if(typeof a==="function"){if(window.attachEvent){b.onreadystatechange=function(){var e=b.readyState;if(e==="loaded"||e==="complete"){b.onreadystatechange=null;a()}}}else{b.onload=a}}c.appendChild(b)};loadJs("http://changyan.sohu.com/upload/changyan.js",function(){window.changyan.api.config({appid:appid,conf:conf})}); } })(); </script>
  </div>



  <div style="position: fixed !important; right: 16px; top: 30%;">
    <button class="mdui-fab mdui-fab-mini mdui-ripple" mdui-menu="{target: '#toc'}"><i class="mdui-icon material-icons">format_list_numbered</i></button>
    <ul class="mdui-menu" id="toc">
      <li class="mdui-menu-item" disabled><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Mysql高级"><span class="toc-number">1.</span> <span class="toc-text">Mysql高级</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Mysql逻辑架构介绍"><span class="toc-number">1.1.</span> <span class="toc-text">Mysql逻辑架构介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql四层架构"><span class="toc-number">1.1.1.</span> <span class="toc-text">mysql四层架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql存储引擎"><span class="toc-number">1.1.2.</span> <span class="toc-text">mysql存储引擎</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#性能下降、SQL慢、执行时间长、等待时间长的原因分析"><span class="toc-number">1.1.3.</span> <span class="toc-text">性能下降、SQL慢、执行时间长、等待时间长的原因分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#常见的JOIN查询"><span class="toc-number">1.1.4.</span> <span class="toc-text">常见的JOIN查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SQL执行顺序"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">SQL执行顺序</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#JOIN理论图"><span class="toc-number">1.1.4.2.</span> <span class="toc-text">JOIN理论图</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#索引简介"><span class="toc-number">1.1.5.</span> <span class="toc-text">索引简介</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#索引是什么"><span class="toc-number">1.1.5.1.</span> <span class="toc-text">索引是什么</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#索引的优劣势"><span class="toc-number">1.1.5.2.</span> <span class="toc-text">索引的优劣势</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql索引分类"><span class="toc-number">1.1.6.</span> <span class="toc-text">mysql索引分类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#索引基本语法"><span class="toc-number">1.1.7.</span> <span class="toc-text">索引基本语法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#B-Tree搜索过程"><span class="toc-number">1.1.8.</span> <span class="toc-text">B+Tree搜索过程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#何时需要建索引"><span class="toc-number">1.1.9.</span> <span class="toc-text">何时需要建索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#性能分析"><span class="toc-number">1.1.10.</span> <span class="toc-text">性能分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mysql常见瓶颈"><span class="toc-number">1.1.10.1.</span> <span class="toc-text">mysql常见瓶颈</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Explain概述"><span class="toc-number">1.1.10.2.</span> <span class="toc-text">Explain概述</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#索引优化"><span class="toc-number">1.1.11.</span> <span class="toc-text">索引优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#单表索引优化"><span class="toc-number">1.1.11.1.</span> <span class="toc-text">单表索引优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#两表索引优化"><span class="toc-number">1.1.11.2.</span> <span class="toc-text">两表索引优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#三表索引优化"><span class="toc-number">1.1.11.3.</span> <span class="toc-text">三表索引优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#索引失效-应该避免"><span class="toc-number">1.1.12.</span> <span class="toc-text">索引失效(应该避免)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#索引失效准则"><span class="toc-number">1.1.12.1.</span> <span class="toc-text">索引失效准则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#索引优化面试题"><span class="toc-number">1.1.12.2.</span> <span class="toc-text">索引优化面试题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#索引失效总结"><span class="toc-number">1.1.12.3.</span> <span class="toc-text">索引失效总结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#查询截取分析"><span class="toc-number">1.2.</span> <span class="toc-text">查询截取分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#查询优化"><span class="toc-number">1.2.1.</span> <span class="toc-text">查询优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#mysql优化原则"><span class="toc-number">1.2.1.1.</span> <span class="toc-text">mysql优化原则</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#order-by优化"><span class="toc-number">1.2.1.2.</span> <span class="toc-text">order by优化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#group-by优化"><span class="toc-number">1.2.1.3.</span> <span class="toc-text">group by优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#慢查询日志"><span class="toc-number">1.2.2.</span> <span class="toc-text">慢查询日志</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#慢查询日志介绍"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">慢查询日志介绍</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#慢查询日志开启"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">慢查询日志开启</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#批量数据脚本"><span class="toc-number">1.2.3.</span> <span class="toc-text">批量数据脚本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#showProfile"><span class="toc-number">1.2.4.</span> <span class="toc-text">showProfile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#全局查询日志"><span class="toc-number">1.2.5.</span> <span class="toc-text">全局查询日志</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL优化一般步骤"><span class="toc-number">1.3.</span> <span class="toc-text">SQL优化一般步骤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mysql锁机制"><span class="toc-number">1.4.</span> <span class="toc-text">mysql锁机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#概述"><span class="toc-number">1.4.1.</span> <span class="toc-text">概述</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#锁的定义"><span class="toc-number">1.4.1.1.</span> <span class="toc-text">锁的定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#锁的分类"><span class="toc-number">1.4.1.2.</span> <span class="toc-text">锁的分类</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#表锁"><span class="toc-number">1.4.2.</span> <span class="toc-text">表锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#案列"><span class="toc-number">1.4.2.1.</span> <span class="toc-text">案列</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#表锁分析"><span class="toc-number">1.4.2.2.</span> <span class="toc-text">表锁分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#行锁"><span class="toc-number">1.4.3.</span> <span class="toc-text">行锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#案例："><span class="toc-number">1.4.3.1.</span> <span class="toc-text">案例：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#间隙锁"><span class="toc-number">1.4.3.2.</span> <span class="toc-text">间隙锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#手动行锁（悲观锁）"><span class="toc-number">1.4.3.3.</span> <span class="toc-text">手动行锁（悲观锁）</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#行锁分析"><span class="toc-number">1.4.3.4.</span> <span class="toc-text">行锁分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#主从复制"><span class="toc-number">1.5.</span> <span class="toc-text">主从复制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#复制的基本原理"><span class="toc-number">1.5.1.</span> <span class="toc-text">复制的基本原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#复制的基本原则"><span class="toc-number">1.5.2.</span> <span class="toc-text">复制的基本原则</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#复制最大问题"><span class="toc-number">1.5.3.</span> <span class="toc-text">复制最大问题</span></a></li></ol></li></ol></li></ol></li>
    </ul>
  </div>
</main>
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
</script>
<footer id="footer" class="mdui-m-t-5 mdui-p-y-3 mdui-color-theme">
  <div class="mdui-p-y-0 mdui-text-center">
    
    
    
    
    
    
    
      <a href="https://github.com/yellowbp" target="_blank"><i class="mdui-p-a-1 mdui-icon iconfont mdui-text-color-theme-a100">&#xe7ab;</i></a>
    
    
    
    
    
      <a href="tencent://message/?uin=1432440963&Menu=yes" target="_blank"><i class="mdui-p-a-1 mdui-icon iconfont mdui-text-color-theme-a100">&#xe651;</i></a>
    
    
  </div>
  <div class="mdui-p-y-1 mdui-text-center">
    Copyright &copy; 2019 - 2021 hbp<br>
    Powered by <a href="https://hexo.io/" target="_blank" class="mdui-text-color-theme-accent">Hexo</a>hbp All rights reserved.
    
    <br>
    <span id="busuanzi_container_site_uv">
    本网站总访问量<span id="busuanzi_value_site_uv"></span>次
    </span>
  </div>
</footer>
  <button id="gotop" class="mdui-fab mdui-fab-fixed mdui-fab-hide mdui-ripple mdui-color-theme-accent"><i class="mdui-icon material-icons">arrow_upward</i></button>
  <script async src="http://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
  <script src="/js/mdui.js"></script>
<script src="/js/script.js"></script>
</body>
</html>